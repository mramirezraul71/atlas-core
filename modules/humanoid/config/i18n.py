"""Internacionalización: español (es) e inglés (en)."""
from __future__ import annotations

import os
from typing import Any, Dict, Optional

SUPPORTED_LOCALES = ("es", "en")
_DEFAULT_LOCALE = "es"

# Locale por defecto (env UI_LOCALE o es)
_current: str = os.getenv("UI_LOCALE", _DEFAULT_LOCALE).strip().lower() or _DEFAULT_LOCALE
if _current not in SUPPORTED_LOCALES:
    _current = _DEFAULT_LOCALE

# Cadenas por idioma. Clave: identificador; valor: texto.
_STRINGS: Dict[str, Dict[str, str]] = {
    "es": {
        "app.title": "ATLAS Dashboard",
        "app.refresh": "Actualizar",
        "app.updating": "Actualizando…",
        "app.last_update": "Última actualización",
        "card.status": "Estado",
        "card.version": "Versión",
        "card.health": "Salud",
        "card.metrics": "Métricas",
        "card.scheduler": "Programador",
        "card.update": "Actualización",
        "card.deploy": "Despliegue",
        "card.approvals": "Aprobaciones",
        "robot.title": "Interactuar con ATLAS",
        "robot.placeholder": "Escribe un comando (ej. /status) o un objetivo para la IA…",
        "robot.send": "Enviar",
        "robot.sending": "Enviando…",
        "robot.task_type": "Envergadura de la tarea",
        "robot.task_quick": "Rápida (comando)",
        "robot.task_quick_help": "Comando directo: /status, /doctor, /modules. Sin IA.",
        "robot.task_medium": "Media (IA plan)",
        "robot.task_medium_help": "La IA genera un plan; no ejecuta. Ideal para revisar pasos.",
        "robot.task_full": "Compleja (IA plan + ejecución)",
        "robot.task_full_help": "Plan y ejecución con aprobación. Mayor uso de recursos.",
        "robot.response": "Respuesta",
        "robot.error": "Error",
        "robot.no_input": "Escribe un comando o objetivo.",
        "approvals.none": "Ninguno",
        "jobs.count": "{n} trabajo(s)",
        "update.check": "Comprobar",
        "deploy.mode": "modo: {mode} · puerto: {port} · salud: {score} · {canary}",
        "deploy.canary_on": "Canary ON",
        "deploy.canary_off": "Canary OFF",
        # Governance
        "gov.label": "Gobernanza:",
        "gov.growth": "GROWTH",
        "gov.governed": "GOVERNED",
        "gov.emergency": "EMERGENCY STOP",
        "gov.emergency_on": "EMERGENCY STOP ON",
        "gov.panel": "Gobernanza",
        "gov.panel_help": "Log de cambios de modo, acciones bloqueadas, approvals creadas.",
        "gov.log": "Log",
        "gov.owner_required": "Inicia sesión owner para cambiar modo",
        "gov.emergency_owner": "Inicia sesión owner para Emergency Stop",
        "gov.confirm": "Confirma: pulsa de nuevo para Emergency Stop",
        # Owner Console
        "owner.panel": "Owner Console",
        "owner.help": "Sesiones activas, aprobaciones pendientes/expiradas, emergencia, integridad de cadena.",
        "owner.start": "Iniciar sesión owner",
        "owner.verify": "Verificar cadena",
        # Product
        "product.panel": "Producto",
        "product.help": "Versión, edición, licencia, servicio, cluster, gateway, salud, GA/Metalearn, support bundle.",
        "product.support": "Support bundle",
        # ANS
        "ans.panel": "ANS (Autonomic Nervous System)",
        "ans.help": "Auto-checks, auto-heals (SAFE), incidentes, reportes. Sin preguntar: actúa SAFE.",
        "ans.run": "Run Now",
        "ans.report": "Último reporte",
        # GA
        "ga.panel": "Autonomía gobernada",
        "ga.run": "Ejecutar",
        "ga.mode": "Modo",
        "ga.pending": "Pendientes",
        "ga.last_report": "Último reporte",
        "ga.report_label": "Reporte",
        "ga.no_reports": "Sin reportes",
        "ga.not_available": "GA no disponible",
        "ga.mode_plan_only": "Solo plan",
        "ga.mode_controlled": "Controlado",
        "ga.mode_auto": "Auto",
        # Cursor
        "cursor.panel": "Cursor",
        "cursor.goal": "Objetivo",
        "cursor.placeholder": "Escribe un objetivo…",
        "cursor.ejecutar": "Ejecutar",
        "cursor.response_placeholder": "La respuesta aparecerá aquí.",
        # Voice / Face
        "voice.panel": "Voz y rostro",
        "voice.face": "Verificar rostro (cámara)",
        "voice.disconnect": "Apagar cámara",
        "voice.speak": "Reproducir respuesta por PC",
        "voice.talk": "Hablar por voz",
        "voice.listening": "Escuchando…",
        "voice.help": "Reconocimiento de voz (micrófono) y detección de rostro (cámara).",
        # Cluster / Gateway
        "card.cluster": "Cluster",
        "card.gateway": "Gateway",
        "cluster.view": "Ver nodos",
        "gateway.view": "Ver",
        # Cursor Mode
        "cursor.mode_label": "Modo",
        "cursor.resources_label": "Recursos",
        "cursor.ai_label": "IA",
        "cursor.profile_label": "Perfil",
        "cursor.mode_plan_only": "Solo plan",
        "cursor.mode_controlled": "Controlado",
        "cursor.mode_auto": "Auto",
        "cursor.resources_lite": "Lite",
        "cursor.resources_pro": "Pro",
        "cursor.resources_ultra": "Ultra",
        "cursor.ai_free_only": "Solo gratis (Ollama)",
        "cursor.ai_auto": "Auto",
        "cursor.ai_allow_paid": "Permitir pago (Owner)",
        "cursor.profile_owner": "Owner",
        "cursor.profile_operario": "Operario",
        "cursor.profile_contadora": "Contadora",
        "cursor.help": "Objetivo único, plan con IA (free-first), pasos y evidencia.",
        # Owner Console extras
        "owner.emergency": "Emergency:",
        "owner.emergency_on": "ON",
        "owner.emergency_off": "OFF",
        "owner.pending": "Pendientes / Expiradas",
        "owner.history": "Historial críticos",
        "owner.ga_label": "Governed Autonomy",
        "ga.run_now": "Run GA Now",
        "gateway.stealth": "Gateway — Stealth",
        "gateway.help": "Modo actual, herramientas detectadas, último éxito, Check / Bootstrap / Set mode.",
        "gateway.check": "Check",
        "gateway.bootstrap": "Bootstrap",
        "gateway.disabled": "Desactivado",
        "gateway.last_success": "Último éxito",
        "gateway.no_success": "Sin último éxito",
        "gateway.checking": "Comprobando…",
        "cluster.command_center": "Cluster — Owner Command Center",
        "cluster.help": "Nodos registrados, heartbeat, ruta preferida y eventos.",
        "cluster.refresh": "Actualizar nodos",
        "cluster.ping": "Ping",
        "cluster.route_local": "Ruta: local",
        "cluster.route_remote": "Ruta: remote_preferred",
        "cluster.test_job": "Run test job (best node)",
        "cluster.events": "Últimos eventos",
        "cluster.no_nodes": "Sin nodos",
        "cluster.node_count": "{n} nodo(s)",
        "cursor.steps": "Pasos",
        "cursor.model": "Modelo",
        "cursor.evidence": "Evidencia",
        "face.capture": "Capturar y verificar",
        "face.camera_on": "Cámara encendida. Pulsa de nuevo para capturar.",
        "face.camera_off": "Cámara apagada.",
        "face.wait_video": "Espera a que cargue el video.",
        "face.detected": "✓ Rostro detectado ({n})",
        "face.not_detected": "No se detectó rostro.",
        "face.help_video": "Mira a la cámara y pulsa «Verificar rostro» para capturar. Pulsa «Apagar cámara» cuando termines.",
        "cursor.no_goal": "Escribe un objetivo.",
        "cursor.running": "Ejecutando…",
        "cursor.next_actions": "Siguientes:",
        "metrics.counters": "Contadores",
        "metrics.latencies": "Latencias",
        "update.has": "actualización",
        "update.yes": "Sí",
        "update.no": "No",
        "jobs.suffix": "trabajo(s)",
        "robot.no_response": "No hubo respuesta del robot.",
        "robot.status_prefix": "Estado:",
        "robot.cmd_done": "Comando ejecutado. Revisa los detalles abajo.",
        "robot.done": "Listo. Revisa los detalles si los hay.",
        "voice.browser_no_speech": "Tu navegador no soporta reconocimiento de voz. Usa Chrome o Edge.",
        "voice.no_response_play": "No hay respuesta que reproducir. Envía un comando primero.",
        "voice.tts_unavailable": "TTS no disponible en el servidor. Instala pyttsx3.",
    },
    "en": {
        "app.title": "ATLAS Dashboard",
        "app.refresh": "Refresh",
        "app.updating": "Updating…",
        "app.last_update": "Last update",
        "card.status": "Status",
        "card.version": "Version",
        "card.health": "Health",
        "card.metrics": "Metrics",
        "card.scheduler": "Scheduler",
        "card.update": "Update",
        "card.deploy": "Deploy",
        "card.approvals": "Approvals",
        "robot.title": "Interact with ATLAS",
        "robot.placeholder": "Type a command (e.g. /status) or a goal for AI…",
        "robot.send": "Send",
        "robot.sending": "Sending…",
        "robot.task_type": "Task scope",
        "robot.task_quick": "Quick (command)",
        "robot.task_quick_help": "Direct command: /status, /doctor. No AI.",
        "robot.task_medium": "Medium (AI plan)",
        "robot.task_medium_help": "AI generates a plan; does not execute. Review steps.",
        "robot.task_full": "Full (AI plan + execution)",
        "robot.task_full_help": "Plan and execution with approval. Higher resource use.",
        "robot.response": "Response",
        "robot.error": "Error",
        "robot.no_input": "Enter a command or goal.",
        "approvals.none": "None",
        "jobs.count": "{n} job(s)",
        "update.check": "Check",
        "deploy.mode": "mode: {mode} · port: {port} · health: {score} · {canary}",
        "deploy.canary_on": "Canary ON",
        "deploy.canary_off": "Canary OFF",
        # Governance
        "gov.label": "Governance:",
        "gov.growth": "GROWTH",
        "gov.governed": "GOVERNED",
        "gov.emergency": "EMERGENCY STOP",
        "gov.emergency_on": "EMERGENCY STOP ON",
        "gov.panel": "Governance",
        "gov.panel_help": "Mode change log, blocked actions, approvals created.",
        "gov.log": "Log",
        "gov.owner_required": "Start owner session to change mode",
        "gov.emergency_owner": "Start owner session for Emergency Stop",
        "gov.confirm": "Confirm: click again for Emergency Stop",
        # Owner Console
        "owner.panel": "Owner Console",
        "owner.help": "Active sessions, pending/expired approvals, emergency, chain integrity.",
        "owner.start": "Start owner session",
        "owner.verify": "Verify chain",
        # Product
        "product.panel": "Product",
        "product.help": "Version, edition, license, service, cluster, gateway, health, GA/Metalearn, support bundle.",
        "product.support": "Support bundle",
        # ANS
        "ans.panel": "ANS (Autonomic Nervous System)",
        "ans.help": "Auto-checks, auto-heals (SAFE), incidents, reports.",
        "ans.run": "Run Now",
        "ans.report": "Latest report",
        # GA
        "ga.panel": "Governed Autonomy",
        "ga.run": "Run Now",
        "ga.mode": "Mode",
        "ga.pending": "Pending",
        "ga.last_report": "Last report",
        "ga.report_label": "Report",
        "ga.no_reports": "No reports",
        "ga.not_available": "GA not available",
        "ga.mode_plan_only": "Plan only",
        "ga.mode_controlled": "Controlled",
        "ga.mode_auto": "Auto",
        # Cursor
        "cursor.panel": "Cursor",
        "cursor.goal": "Goal",
        "cursor.placeholder": "Enter a goal…",
        "cursor.ejecutar": "Execute",
        "cursor.response_placeholder": "The response will appear here.",
        # Voice / Face
        "voice.panel": "Voice and face",
        "voice.face": "Verify face (camera)",
        "voice.disconnect": "Disconnect camera",
        "voice.speak": "Play response on PC",
        "voice.talk": "Speak by voice",
        "voice.listening": "Listening…",
        "voice.help": "Voice recognition (microphone) and face detection (camera).",
        # Cluster / Gateway
        "card.cluster": "Cluster",
        "card.gateway": "Gateway",
        "cluster.view": "View nodes",
        "gateway.view": "View",
        # Cursor Mode
        "cursor.mode_label": "Mode",
        "cursor.resources_label": "Resources",
        "cursor.ai_label": "AI",
        "cursor.profile_label": "Profile",
        "cursor.mode_plan_only": "Plan only",
        "cursor.mode_controlled": "Controlled",
        "cursor.mode_auto": "Auto",
        "cursor.resources_lite": "Lite",
        "cursor.resources_pro": "Pro",
        "cursor.resources_ultra": "Ultra",
        "cursor.ai_free_only": "Free only (Ollama)",
        "cursor.ai_auto": "Auto",
        "cursor.ai_allow_paid": "Allow paid (Owner)",
        "cursor.profile_owner": "Owner",
        "cursor.profile_operario": "Operator",
        "cursor.profile_contadora": "Accountant",
        "cursor.help": "Single goal, AI plan (free-first), steps and evidence.",
        # Owner Console extras
        "owner.emergency": "Emergency:",
        "owner.emergency_on": "ON",
        "owner.emergency_off": "OFF",
        "owner.pending": "Pending / Expired",
        "owner.history": "Critical history",
        "owner.ga_label": "Governed Autonomy",
        "ga.run_now": "Run GA Now",
        "gateway.stealth": "Gateway — Stealth",
        "gateway.help": "Current mode, detected tools, last success, Check / Bootstrap / Set mode.",
        "gateway.check": "Check",
        "gateway.bootstrap": "Bootstrap",
        "gateway.disabled": "Disabled",
        "gateway.last_success": "Last success",
        "gateway.no_success": "No last success",
        "gateway.checking": "Checking…",
        "cluster.command_center": "Cluster — Owner Command Center",
        "cluster.help": "Registered nodes, heartbeat, preferred route and events.",
        "cluster.refresh": "Refresh nodes",
        "cluster.ping": "Ping",
        "cluster.route_local": "Route: local",
        "cluster.route_remote": "Route: remote_preferred",
        "cluster.test_job": "Run test job (best node)",
        "cluster.events": "Latest events",
        "cluster.no_nodes": "No nodes",
        "cluster.node_count": "{n} node(s)",
        "cursor.steps": "Steps",
        "cursor.model": "Model",
        "cursor.evidence": "Evidence",
        "face.capture": "Capture and verify",
        "face.camera_on": "Camera on. Click again to capture.",
        "face.camera_off": "Camera off.",
        "face.wait_video": "Wait for video to load.",
        "face.detected": "✓ Face detected ({n})",
        "face.not_detected": "No face detected.",
        "face.help_video": "Look at the camera and click «Verify face» to capture. Click «Disconnect camera» when done.",
        "cursor.no_goal": "Enter a goal.",
        "cursor.running": "Running…",
        "cursor.next_actions": "Next:",
        "metrics.counters": "Counters",
        "metrics.latencies": "Latencies",
        "update.has": "update",
        "update.yes": "Yes",
        "update.no": "No",
        "jobs.suffix": "job(s)",
        "robot.no_response": "No response from robot.",
        "robot.status_prefix": "Status:",
        "robot.cmd_done": "Command executed. Check details below.",
        "robot.done": "Done. Check details if any.",
        "voice.browser_no_speech": "Your browser does not support speech recognition. Use Chrome or Edge.",
        "voice.no_response_play": "No response to play. Send a command first.",
        "voice.tts_unavailable": "TTS not available on server. Install pyttsx3.",
    },
}


def get_locale() -> str:
    """Locale activo (es o en)."""
    return _current


def set_locale(locale: str) -> None:
    """Fija locale; si no es válido, se mantiene el actual."""
    global _current
    if locale.strip().lower() in SUPPORTED_LOCALES:
        _current = locale.strip().lower()


def get_text(key: str, locale: Optional[str] = None, **fmt: Any) -> str:
    """Devuelve la cadena para key en el locale dado (o el actual). fmt para sustituir {name}."""
    loc = (locale or _current).strip().lower()
    if loc not in SUPPORTED_LOCALES:
        loc = _DEFAULT_LOCALE
    s = (_STRINGS.get(loc) or _STRINGS[_DEFAULT_LOCALE]).get(key, key)
    if fmt:
        for k, v in fmt.items():
            s = s.replace("{" + k + "}", str(v))
    return s


def get_all_strings(locale: Optional[str] = None) -> Dict[str, str]:
    """Devuelve todas las cadenas del locale (para API /ui/lang)."""
    loc = (locale or _current).strip().lower()
    if loc not in SUPPORTED_LOCALES:
        loc = _DEFAULT_LOCALE
    return dict(_STRINGS.get(loc, _STRINGS[_DEFAULT_LOCALE]))

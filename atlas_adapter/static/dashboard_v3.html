<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ATLAS Dashboard v3.0.0</title>
  <style>
    :root {
      --bg: #0d1117;
      --bg-card: #161b22;
      --bg-elevated: #21262d;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-cyan: #39d3c4;
      --accent-green: #3fb950;
      --accent-purple: #a371f7;
      --accent-pink: #f778ba;
      --accent-orange: #d29922;
      --accent-red: #f85149;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* === TOP NAV BAR === */
    .top-nav {
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      height: 48px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      gap: 0.5rem;
    }
    .nav-logo {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent-cyan);
      margin-right: 1rem;
    }
    .nav-tabs {
      display: flex;
      gap: 0.25rem;
    }
    .nav-tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 0.875rem;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-tab:hover { background: var(--bg-elevated); color: var(--text); }
    .nav-tab.active { background: var(--accent-cyan); color: var(--bg); font-weight: 600; }
    .nav-spacer { flex: 1; }
    .nav-status {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
    }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
    }
    .status-dot.offline { background: var(--accent-red); }
    .nav-counter {
      background: var(--bg-elevated);
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-weight: 600;
    }
    .nav-time { color: var(--text-muted); }

    /* === MAIN CONTAINER === */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* === STATS BAR === */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }
    .stat-value.warning { color: var(--accent-orange); }
    .stat-value.error { color: var(--accent-red); }
    .stat-value.success { color: var(--accent-green); }
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.25rem;
    }

    /* === ACTION BAR === */
    .action-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--accent-cyan); color: var(--bg); }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-secondary { background: var(--accent-purple); color: white; }
    .btn-secondary:hover { filter: brightness(1.1); }

    /* === MODULES GRID === */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .module-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: all 0.2s;
      cursor: pointer;
    }
    .module-card:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-2px);
    }
    .module-card.connected { border-color: var(--accent-green); }
    .module-card.error { border-color: var(--accent-red); }
    .module-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    .module-name {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .module-status {
      font-size: 0.7rem;
      color: var(--accent-green);
    }
    .module-status.error { color: var(--accent-red); }

    /* === TAB PANELS === */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* === ACTIVITY LOG === */
    .activity-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
    }
    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .activity-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--accent-cyan);
      text-transform: uppercase;
    }
    .activity-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .activity-item {
      padding: 0.75rem;
      border-left: 3px solid var(--accent-cyan);
      background: var(--bg-elevated);
      margin-bottom: 0.5rem;
      border-radius: 0 6px 6px 0;
    }
    .activity-item.error { border-left-color: var(--accent-red); }
    .activity-item.success { border-left-color: var(--accent-green); }
    .activity-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }
    .activity-message { font-size: 0.85rem; }

    /* === CHAT PANEL === */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 250px);
      min-height: 400px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px 8px 0 0;
    }
    .chat-input-area {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 8px 8px;
    }
    .chat-input {
      flex: 1;
      padding: 0.75rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
    }
    .chat-input:focus { outline: none; border-color: var(--accent-cyan); }
    .chat-message {
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      max-width: 80%;
    }
    .chat-message.user {
      background: var(--accent-cyan);
      color: var(--bg);
      margin-left: auto;
    }
    .chat-message.assistant {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
    }

    /* === CONFIG PANEL === */
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    .config-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
    }
    .config-title {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--accent-purple);
    }
    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .config-item:last-child { border-bottom: none; }
    .config-label { font-size: 0.85rem; }
    .config-select {
      padding: 0.35rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
    }

    /* === VERSION FOOTER === */
    .version-footer {
      position: fixed;
      bottom: 0;
      right: 0;
      padding: 0.4rem 0.8rem;
      background: var(--bg-card);
      border-top-left-radius: 8px;
      border: 1px solid var(--border);
      border-right: none;
      border-bottom: none;
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .version-footer span { color: var(--accent-cyan); }
  </style>
</head>
<body>
  <!-- TOP NAVIGATION -->
  <nav class="top-nav">
    <div class="nav-logo">ATLAS</div>
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="chat">Chat</button>
      <button class="nav-tab" data-tab="modulos">Modulos</button>
      <button class="nav-tab" data-tab="comms">üì± Comms</button>
      <button class="nav-tab" data-tab="gobernanza">Gobernanza</button>
      <button class="nav-tab" data-tab="config">Config IA</button>
      <button class="nav-tab" data-tab="vision">üëÅ Vision</button>
      <button class="nav-tab" data-tab="nervioso">üîó Nervioso</button>
    </div>
    <div class="nav-spacer"></div>
    <div class="nav-status">
      <div class="status-indicator">
        <div class="status-dot" id="cerebro-dot"></div>
        <span>Cerebro</span>
      </div>
      <div class="nav-counter" id="modules-counter">0/15</div>
      <div class="nav-time" id="current-time">00:00:00</div>
    </div>
  </nav>

  <div class="main-container">
    <!-- ========== TAB: CHAT ========== -->
    <div class="tab-panel active" id="panel-chat">
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="chat-message assistant">
            Hola, soy ATLAS. Estoy conectado al Brain Coordinator y listo para ayudarte. Puedes escribir comandos como /status, /help o simplemente hablarme.
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="chat-input" placeholder="Escribe un mensaje o comando..." />
          <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
        </div>
      </div>
      <div class="activity-section">
        <div class="activity-header">
          <span class="activity-title">ACTIVIDAD</span>
          <button class="btn btn-secondary" onclick="clearActivity()">Limpiar</button>
        </div>
        <div class="activity-list" id="activity-list"></div>
      </div>
    </div>

    <!-- ========== TAB: MODULOS ========== -->
    <div class="tab-panel" id="panel-modulos">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value success" id="stat-connected">15</div>
          <div class="stat-label">CONECTADOS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total">15</div>
          <div class="stat-label">TOTAL</div>
        </div>
        <div class="stat-card">
          <div class="stat-value success" id="stat-health">100%</div>
          <div class="stat-label">SALUD</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-signals">0</div>
          <div class="stat-label">SE√ëALES</div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-primary" onclick="checkAllModules()">Check All</button>
        <button class="btn btn-secondary" onclick="runDiagnostic()">Diagn√≥stico</button>
      </div>

      <div class="modules-grid" id="modules-grid"></div>

      <div class="activity-section">
        <div class="activity-header">
          <span class="activity-title">ACTIVIDAD</span>
          <button class="btn btn-secondary" onclick="clearActivity()">Limpiar</button>
        </div>
        <div class="activity-list" id="modules-activity-list"></div>
      </div>
    </div>

    <!-- ========== TAB: COMUNICACIONES ========== -->
    <div class="tab-panel" id="panel-comms">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value success" id="comms-whatsapp">--</div>
          <div class="stat-label">WHATSAPP</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="comms-telegram">--</div>
          <div class="stat-label">TELEGRAM</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="comms-audio">--</div>
          <div class="stat-label">AUDIO</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="comms-messages">0</div>
          <div class="stat-label">MENSAJES HOY</div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-primary" onclick="refreshCommsStatus()">üîÑ Actualizar Estado</button>
        <button class="btn btn-secondary" onclick="openWahaDashboard()">üì± Abrir WAHA Dashboard</button>
        <button class="btn" style="background: var(--accent-purple); color: white;" onclick="testComms()">üì® Enviar Prueba</button>
      </div>

      <div class="config-grid">
        <!-- WhatsApp Card -->
        <div class="config-card" id="whatsapp-card">
          <div class="config-title">üì± WhatsApp (WAHA)</div>
          <div class="config-item">
            <span class="config-label">Estado</span>
            <span id="waha-status" style="color: var(--accent-green);">Conectando...</span>
          </div>
          <div class="config-item">
            <span class="config-label">Sesi√≥n</span>
            <span id="waha-session">default</span>
          </div>
          <div class="config-item">
            <span class="config-label">Tel√©fono</span>
            <span id="waha-phone">--</span>
          </div>
          <div class="config-item">
            <span class="config-label">Dashboard WAHA</span>
            <a href="#" id="waha-link" target="_blank" style="color: var(--accent-cyan); text-decoration: none;">Abrir ‚Üó</a>
          </div>
          <div style="margin-top: 1rem;">
            <button class="btn btn-primary" onclick="restartWahaSession()" style="width: 100%;">üîÑ Reiniciar Sesi√≥n</button>
          </div>
          <div id="waha-qr-container" style="display: none; margin-top: 1rem; text-align: center;">
            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 0.5rem;">Escanea este QR con WhatsApp:</p>
            <img id="waha-qr" style="max-width: 200px; border-radius: 8px;" />
          </div>
        </div>

        <!-- Telegram Card -->
        <div class="config-card" id="telegram-card">
          <div class="config-title">üì® Telegram</div>
          <div class="config-item">
            <span class="config-label">Bot Token</span>
            <span id="telegram-token-status">--</span>
          </div>
          <div class="config-item">
            <span class="config-label">Chat ID</span>
            <span id="telegram-chat-status">--</span>
          </div>
          <div style="margin-top: 1rem;">
            <button class="btn btn-secondary" onclick="testTelegram()" style="width: 100%;">üì® Probar Telegram</button>
          </div>
        </div>

        <!-- Audio Card -->
        <div class="config-card" id="audio-card">
          <div class="config-title">üîä Audio (TTS)</div>
          <div class="config-item">
            <span class="config-label">Motor</span>
            <span id="audio-engine">--</span>
          </div>
          <div class="config-item">
            <span class="config-label">Estado</span>
            <span id="audio-status">--</span>
          </div>
          <div style="margin-top: 1rem;">
            <button class="btn btn-secondary" onclick="testAudio()" style="width: 100%;">üîä Probar Audio</button>
          </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="config-card">
          <div class="config-title">‚ö° Acciones R√°pidas</div>
          <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="sendTestAll()">üì¢ Notificar en Todos los Canales</button>
            <button class="btn btn-secondary" onclick="showQRCode()">üì∑ Mostrar QR de WhatsApp</button>
            <button class="btn" style="background: var(--accent-orange); color: white;" onclick="refreshCommsStatus()">üîÑ Reconectar Servicios</button>
          </div>
        </div>
      </div>

      <div class="activity-section" style="margin-top: 1.5rem;">
        <div class="activity-header">
          <span class="activity-title">BIT√ÅCORA DE COMUNICACIONES</span>
          <button class="btn btn-secondary" onclick="loadCommsBitacora()">üîÑ Actualizar</button>
        </div>
        <div class="activity-list" id="comms-activity-list"></div>
      </div>
    </div>

    <!-- ========== TAB: GOBERNANZA ========== -->
    <div class="tab-panel" id="panel-gobernanza">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value" id="gov-mode">GOVERNED</div>
          <div class="stat-label">MODO ACTUAL</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="gov-approvals">0</div>
          <div class="stat-label">APROBACIONES PENDIENTES</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="gov-policies">5</div>
          <div class="stat-label">POL√çTICAS ACTIVAS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="gov-score">100</div>
          <div class="stat-label">SCORE SEGURIDAD</div>
        </div>
      </div>
      <div class="action-bar">
        <button class="btn btn-primary" onclick="setGovMode('growth')">GROWTH</button>
        <button class="btn btn-secondary" onclick="setGovMode('governed')">GOVERNED</button>
        <button class="btn" style="background: var(--accent-red); color: white;" onclick="emergencyStop()">EMERGENCY STOP</button>
      </div>
    </div>

    <!-- ========== TAB: CONFIG IA ========== -->
    <div class="tab-panel" id="panel-config">
      <div class="config-grid">
        <div class="config-card">
          <div class="config-title">üß† Proveedor de IA</div>
          <div class="config-item">
            <span class="config-label">Modo</span>
            <select class="config-select" id="ai-mode">
              <option value="auto">Autom√°tico</option>
              <option value="manual">Manual</option>
            </select>
          </div>
          <div class="config-item">
            <span class="config-label">Proveedor</span>
            <select class="config-select" id="ai-provider">
              <option value="ollama">Ollama (Local)</option>
              <option value="deepseek">DeepSeek</option>
              <option value="openai">OpenAI</option>
              <option value="anthropic">Anthropic</option>
              <option value="gemini">Google Gemini</option>
            </select>
          </div>
          <div class="config-item">
            <span class="config-label">Modelo</span>
            <select class="config-select" id="ai-model">
              <option value="llama3.2">llama3.2</option>
              <option value="deepseek-coder">deepseek-coder</option>
              <option value="mistral">mistral</option>
            </select>
          </div>
        </div>
        <div class="config-card">
          <div class="config-title">‚öôÔ∏è Par√°metros</div>
          <div class="config-item">
            <span class="config-label">Temperatura</span>
            <input type="range" min="0" max="100" value="70" style="width: 100px;">
          </div>
          <div class="config-item">
            <span class="config-label">Max Tokens</span>
            <input type="number" value="2048" style="width: 80px; padding: 0.25rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
          </div>
        </div>
      </div>
    </div>

    <!-- ========== TAB: VISION ========== -->
    <div class="tab-panel" id="panel-vision">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value" id="vision-cameras">3</div>
          <div class="stat-label">C√ÅMARAS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-active">1</div>
          <div class="stat-label">ACTIVAS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-fps">30</div>
          <div class="stat-label">FPS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-detections">0</div>
          <div class="stat-label">DETECCIONES</div>
        </div>
      </div>
      <div class="action-bar">
        <button class="btn btn-primary" onclick="captureSnapshot()">üì∑ Capturar</button>
        <button class="btn btn-secondary" onclick="startStream()">üé• Stream</button>
        <button class="btn" onclick="detectFaces()">üë§ Detectar Rostros</button>
      </div>
      <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 2rem; text-align: center; color: var(--text-muted);">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üì∑</div>
        <div>Vista previa de c√°mara</div>
        <div id="vision-preview"></div>
      </div>
    </div>

    <!-- ========== TAB: NERVIOSO ========== -->
    <div class="tab-panel" id="panel-nervioso">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value success" id="nervous-status">OK</div>
          <div class="stat-label">ESTADO</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-signals">0</div>
          <div class="stat-label">SE√ëALES/MIN</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-latency">12ms</div>
          <div class="stat-label">LATENCIA</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-uptime">99.9%</div>
          <div class="stat-label">UPTIME</div>
        </div>
      </div>
      <div class="action-bar">
        <button class="btn btn-primary" onclick="refreshNervous()">Actualizar</button>
        <button class="btn btn-secondary" onclick="nervousDiagnostic()">Diagn√≥stico</button>
      </div>
    </div>
  </div>

  <!-- VERSION FOOTER -->
  <div class="version-footer">
    <span>ATLAS</span> v3.0.0 | 2026-02-16
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ATLAS Dashboard v3.0.0 - JavaScript
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ATLAS_VERSION = '3.0.0';
    const ATLAS_BUILD_DATE = '2026-02-16';
    const API_BASE = window.location.origin;

    console.log(`%cüöÄ ATLAS Dashboard v${ATLAS_VERSION}`, 'color: #39d3c4; font-weight: bold; font-size: 14px;');

    // Modules definition
    const MODULES = [
      { id: 'brain', name: 'Brain', icon: 'üß†', status: 'ok' },
      { id: 'memory', name: 'Memory', icon: 'üíæ', status: 'ok' },
      { id: 'learning', name: 'Learning', icon: 'üìö', status: 'ok' },
      { id: 'analysis', name: 'Analysis', icon: 'üìä', status: 'ok' },
      { id: 'reaction', name: 'Reaction', icon: '‚ö°', status: 'ok' },
      { id: 'nervous', name: 'Nervous', icon: 'üîó', status: 'ok' },
      { id: 'ans', name: 'ANS', icon: '‚ù§Ô∏è', status: 'ok' },
      { id: 'vision', name: 'Vision', icon: 'üëÅÔ∏è', status: 'ok' },
      { id: 'ears', name: 'Ears', icon: 'üëÇ', status: 'ok' },
      { id: 'sensors', name: 'Sensors', icon: 'üì°', status: 'ok' },
      { id: 'voice', name: 'Voice', icon: 'üîä', status: 'ok' },
      { id: 'hands', name: 'Hands', icon: 'ü§ñ', status: 'ok' },
      { id: 'navigation', name: 'Navigation', icon: 'üß≠', status: 'ok' },
      { id: 'comms', name: 'Comms', icon: 'üì±', status: 'ok' },
      { id: 'quality', name: 'Quality', icon: '‚úÖ', status: 'ok' },
    ];

    // Activity log
    let activityLog = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initTabs();
      renderModules();
      updateTime();
      setInterval(updateTime, 1000);
      loadInitialData();
      addActivity('Dashboard iniciado', 'success');
    });

    // Tab navigation
    function initTabs() {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(`panel-${tabId}`).classList.add('active');
        });
      });
    }

    // Render modules grid
    function renderModules() {
      const grid = document.getElementById('modules-grid');
      grid.innerHTML = MODULES.map(mod => `
        <div class="module-card ${mod.status === 'ok' ? 'connected' : 'error'}" onclick="checkModule('${mod.id}')">
          <div class="module-icon">${mod.icon}</div>
          <div class="module-name">${mod.name}</div>
          <div class="module-status ${mod.status === 'ok' ? '' : 'error'}">${mod.status.toUpperCase()}</div>
        </div>
      `).join('');
      updateModuleCounter();
    }

    function updateModuleCounter() {
      const connected = MODULES.filter(m => m.status === 'ok').length;
      document.getElementById('modules-counter').textContent = `${connected}/${MODULES.length}`;
      document.getElementById('stat-connected').textContent = connected;
      document.getElementById('stat-total').textContent = MODULES.length;
      document.getElementById('stat-health').textContent = Math.round((connected / MODULES.length) * 100) + '%';
    }

    // Time update
    function updateTime() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleTimeString('es-ES');
    }

    // Activity log
    function addActivity(message, type = 'info') {
      const time = new Date().toLocaleTimeString('es-ES');
      activityLog.unshift({ time, message, type });
      if (activityLog.length > 50) activityLog.pop();
      renderActivity();
    }

    function renderActivity() {
      const lists = ['activity-list', 'modules-activity-list'];
      lists.forEach(listId => {
        const list = document.getElementById(listId);
        if (list) {
          list.innerHTML = activityLog.slice(0, 10).map(item => `
            <div class="activity-item ${item.type}">
              <div class="activity-time">${item.time}</div>
              <div class="activity-message">${item.message}</div>
            </div>
          `).join('');
        }
      });
    }

    function clearActivity() {
      activityLog = [];
      renderActivity();
    }

    // API calls
    async function loadInitialData() {
      try {
        addActivity('Probando conexi√≥n ollama...', 'info');
        const res = await fetch(`${API_BASE}/status`);
        if (res.ok) {
          addActivity('Ollama conectado', 'success');
          addActivity('Cerebro conectado', 'success');
          document.getElementById('cerebro-dot').classList.remove('offline');
        }
      } catch (e) {
        addActivity('Error: ' + e.message, 'error');
        document.getElementById('cerebro-dot').classList.add('offline');
      }
    }

    async function checkAllModules() {
      addActivity('Verificando todos los m√≥dulos...', 'info');
      try {
        const res = await fetch(`${API_BASE}/modules`);
        const data = await res.json();
        addActivity(`M√≥dulos verificados: ${MODULES.length} OK`, 'success');
      } catch (e) {
        addActivity('Error verificando m√≥dulos: ' + e.message, 'error');
      }
    }

    async function checkModule(moduleId) {
      addActivity(`Verificando m√≥dulo: ${moduleId}`, 'info');
    }

    async function runDiagnostic() {
      addActivity('Ejecutando diagn√≥stico completo...', 'info');
      try {
        const res = await fetch(`${API_BASE}/doctor`);
        const data = await res.json();
        addActivity('Diagn√≥stico completado', 'success');
      } catch (e) {
        addActivity('Error en diagn√≥stico: ' + e.message, 'error');
      }
    }

    // Chat
    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      const messagesDiv = document.getElementById('chat-messages');
      messagesDiv.innerHTML += `<div class="chat-message user">${message}</div>`;
      input.value = '';
      addActivity(`Usuario: ${message.substring(0, 30)}...`, 'info');

      try {
        const res = await fetch(`${API_BASE}/run`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: message })
        });
        const data = await res.json();
        const response = data.result || data.response || JSON.stringify(data);
        messagesDiv.innerHTML += `<div class="chat-message assistant">${response}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (e) {
        messagesDiv.innerHTML += `<div class="chat-message assistant" style="border-color: var(--accent-red);">Error: ${e.message}</div>`;
        addActivity('Error: ' + e.message, 'error');
      }
    }

    document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Governance
    function setGovMode(mode) {
      document.getElementById('gov-mode').textContent = mode.toUpperCase();
      addActivity(`Modo cambiado a: ${mode}`, 'success');
    }

    function emergencyStop() {
      if (confirm('¬øConfirmar EMERGENCY STOP?')) {
        addActivity('EMERGENCY STOP activado', 'error');
        document.getElementById('gov-mode').textContent = 'EMERGENCY';
      }
    }

    // Vision
    function captureSnapshot() {
      addActivity('Capturando snapshot...', 'info');
    }

    function startStream() {
      addActivity('Iniciando stream...', 'info');
    }

    function detectFaces() {
      addActivity('Detectando rostros...', 'info');
    }

    // Nervous
    function refreshNervous() {
      addActivity('Actualizando sistema nervioso...', 'info');
    }

    function nervousDiagnostic() {
      addActivity('Diagn√≥stico del sistema nervioso...', 'info');
    }

    // ========== COMUNICACIONES ==========
    const WAHA_DEFAULT_URL = 'http://localhost:3010';
    let wahaUrl = WAHA_DEFAULT_URL;

    async function refreshCommsStatus() {
      addActivity('Actualizando estado de comunicaciones...', 'info');
      try {
        const res = await fetch(`${API_BASE}/ans/comms/status`);
        const data = await res.json();
        
        // WhatsApp
        if (data.waha) {
          const wahaStatus = data.waha.status || 'unknown';
          const isWorking = wahaStatus === 'WORKING';
          document.getElementById('comms-whatsapp').textContent = isWorking ? 'OK' : wahaStatus;
          document.getElementById('comms-whatsapp').className = `stat-value ${isWorking ? 'success' : 'warning'}`;
          document.getElementById('waha-status').textContent = wahaStatus;
          document.getElementById('waha-status').style.color = isWorking ? 'var(--accent-green)' : 'var(--accent-orange)';
          document.getElementById('waha-session').textContent = data.waha.session_name || 'default';
          document.getElementById('waha-phone').textContent = data.waha.phone ? `+${data.waha.phone}` : '--';
          wahaUrl = data.waha.dashboard_url || WAHA_DEFAULT_URL;
          document.getElementById('waha-link').href = wahaUrl;
          
          // Show QR if not authenticated
          if (!isWorking) {
            showQRCode();
          } else {
            document.getElementById('waha-qr-container').style.display = 'none';
          }
        }
        
        // Telegram
        if (data.telegram) {
          const tgEnabled = data.telegram.enabled;
          document.getElementById('comms-telegram').textContent = tgEnabled ? 'OK' : 'OFF';
          document.getElementById('comms-telegram').className = `stat-value ${tgEnabled ? 'success' : ''}`;
          document.getElementById('telegram-token-status').textContent = data.telegram.token_configured ? '‚úì Configurado' : '‚úó No configurado';
          document.getElementById('telegram-token-status').style.color = data.telegram.token_configured ? 'var(--accent-green)' : 'var(--accent-red)';
          document.getElementById('telegram-chat-status').textContent = data.telegram.chat_id_configured ? '‚úì Configurado' : '‚úó No configurado';
          document.getElementById('telegram-chat-status').style.color = data.telegram.chat_id_configured ? 'var(--accent-green)' : 'var(--accent-red)';
        }
        
        // Audio
        if (data.audio) {
          const audioEnabled = data.audio.enabled;
          document.getElementById('comms-audio').textContent = audioEnabled ? 'OK' : 'OFF';
          document.getElementById('comms-audio').className = `stat-value ${audioEnabled ? 'success' : ''}`;
          document.getElementById('audio-engine').textContent = data.audio.engine || 'No disponible';
          document.getElementById('audio-status').textContent = audioEnabled ? '‚úì Activo' : '‚úó No disponible';
          document.getElementById('audio-status').style.color = audioEnabled ? 'var(--accent-green)' : 'var(--accent-red)';
        }
        
        addActivity('Estado de comunicaciones actualizado', 'success');
      } catch (e) {
        addActivity('Error actualizando comms: ' + e.message, 'error');
      }
    }

    function openWahaDashboard() {
      window.open(wahaUrl, '_blank');
      addActivity('Abriendo dashboard de WAHA...', 'info');
    }

    async function showQRCode() {
      try {
        const res = await fetch(`${API_BASE}/ans/comms/waha/qr`);
        const data = await res.json();
        if (data.ok && data.qr_base64) {
          const container = document.getElementById('waha-qr-container');
          const img = document.getElementById('waha-qr');
          img.src = `data:image/png;base64,${data.qr_base64}`;
          container.style.display = 'block';
          addActivity('QR de WhatsApp mostrado', 'info');
        } else {
          addActivity('WhatsApp ya est√° conectado', 'success');
        }
      } catch (e) {
        addActivity('Error obteniendo QR: ' + e.message, 'error');
      }
    }

    async function restartWahaSession() {
      addActivity('Reiniciando sesi√≥n de WAHA...', 'info');
      try {
        const res = await fetch(`${API_BASE}/ans/comms/waha/restart`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          addActivity('Sesi√≥n de WAHA reiniciada', 'success');
          setTimeout(refreshCommsStatus, 3000);
        } else {
          addActivity('Error reiniciando WAHA: ' + (data.error || 'unknown'), 'error');
        }
      } catch (e) {
        addActivity('Error reiniciando WAHA: ' + e.message, 'error');
      }
    }

    async function testComms() {
      addActivity('Enviando mensaje de prueba a todos los canales...', 'info');
      try {
        const res = await fetch(`${API_BASE}/ans/comms/test?channel=all&message=Prueba desde Dashboard ATLAS`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          addActivity('Mensaje de prueba enviado correctamente', 'success');
        } else {
          addActivity('Algunos canales fallaron: ' + JSON.stringify(data.results), 'warning');
        }
      } catch (e) {
        addActivity('Error enviando prueba: ' + e.message, 'error');
      }
    }

    async function testTelegram() {
      addActivity('Probando Telegram...', 'info');
      try {
        const res = await fetch(`${API_BASE}/ans/comms/test?channel=telegram&message=Prueba desde Dashboard ATLAS`, { method: 'POST' });
        const data = await res.json();
        addActivity(data.results?.telegram?.ok ? 'Telegram OK' : 'Telegram fall√≥', data.results?.telegram?.ok ? 'success' : 'error');
      } catch (e) {
        addActivity('Error: ' + e.message, 'error');
      }
    }

    async function testAudio() {
      addActivity('Probando Audio...', 'info');
      try {
        const res = await fetch(`${API_BASE}/ans/comms/test?channel=audio&message=Prueba de audio desde Dashboard ATLAS`, { method: 'POST' });
        const data = await res.json();
        addActivity(data.results?.audio?.ok ? 'Audio OK' : 'Audio fall√≥', data.results?.audio?.ok ? 'success' : 'error');
      } catch (e) {
        addActivity('Error: ' + e.message, 'error');
      }
    }

    async function sendTestAll() {
      await testComms();
    }

    async function loadCommsBitacora() {
      try {
        const res = await fetch(`${API_BASE}/ans/bitacora?limit=20`);
        const data = await res.json();
        const list = document.getElementById('comms-activity-list');
        if (data.ok && data.data) {
          // Filter only comms-related entries
          const commsEntries = data.data.filter(e => 
            ['telegram', 'whatsapp', 'comms', 'audio', 'evolution', 'startup', 'services'].includes(e.source)
          );
          list.innerHTML = commsEntries.slice(0, 10).map(e => {
            const time = e.timestamp ? new Date(e.timestamp).toLocaleTimeString('es-ES') : '--';
            const icon = e.icon || 'üìã';
            const typeClass = e.resultado === 'OK' ? 'success' : (e.resultado === 'Error' ? 'error' : 'info');
            return `
              <div class="activity-item ${typeClass}">
                <div class="activity-time">${time}</div>
                <div class="activity-message">${icon} ${e.detalle || e.problema || ''}</div>
              </div>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('Error loading comms bitacora:', e);
      }
    }

    // Load comms status on tab switch
    document.querySelector('[data-tab="comms"]')?.addEventListener('click', () => {
      refreshCommsStatus();
      loadCommsBitacora();
    });

    // Auto-refresh comms status every 30 seconds when on comms tab
    setInterval(() => {
      const commsPanel = document.getElementById('panel-comms');
      if (commsPanel && commsPanel.classList.contains('active')) {
        refreshCommsStatus();
      }
    }, 30000);
  </script>
</body>
</html>

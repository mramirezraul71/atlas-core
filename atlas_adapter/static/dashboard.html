<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ATLAS Dashboard v3.3.0</title>
  <style>
    /* === THEME: Default (Cyan) === */
    :root, [data-theme="cyan"] {
      --bg: #0d1117;
      --bg-card: #161b22;
      --bg-elevated: #21262d;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-cyan: #39d3c4;
      --accent-green: #3fb950;
      --accent-purple: #a371f7;
      --accent-pink: #f778ba;
      --accent-orange: #d29922;
      --accent-red: #f85149;
      --accent-primary: #39d3c4;
    }
    /* === THEME: Purple === */
    [data-theme="purple"] {
      --bg: #0f0a1a;
      --bg-card: #1a1225;
      --bg-elevated: #251a35;
      --border: #3d2a5a;
      --accent-cyan: #a371f7;
      --accent-primary: #a371f7;
    }
    /* === THEME: Green (Matrix) === */
    [data-theme="green"] {
      --bg: #0a1208;
      --bg-card: #0f1a0c;
      --bg-elevated: #162212;
      --border: #2a4020;
      --accent-cyan: #3fb950;
      --accent-primary: #3fb950;
    }
    /* === THEME: Orange === */
    [data-theme="orange"] {
      --bg: #1a1008;
      --bg-card: #221508;
      --bg-elevated: #2d1c0a;
      --border: #4a3010;
      --accent-cyan: #f59e0b;
      --accent-primary: #f59e0b;
    }
    /* === THEME: Pink === */
    [data-theme="pink"] {
      --bg: #1a0a14;
      --bg-card: #22101a;
      --bg-elevated: #2d1522;
      --border: #4a2040;
      --accent-cyan: #f778ba;
      --accent-primary: #f778ba;
    }
    /* === THEME: Blue === */
    [data-theme="blue"] {
      --bg: #0a101a;
      --bg-card: #0f1622;
      --bg-elevated: #152030;
      --border: #203050;
      --accent-cyan: #3b82f6;
      --accent-primary: #3b82f6;
    }
    /* === THEME: Red === */
    [data-theme="red"] {
      --bg: #1a0a0a;
      --bg-card: #221010;
      --bg-elevated: #2d1515;
      --border: #4a2020;
      --accent-cyan: #ef4444;
      --accent-primary: #ef4444;
    }
    /* === THEME: Gold === */
    [data-theme="gold"] {
      --bg: #12100a;
      --bg-card: #1a1608;
      --bg-elevated: #221c0a;
      --border: #3d3010;
      --accent-cyan: #fbbf24;
      --accent-primary: #fbbf24;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* === TOP NAV BAR === */
    .top-nav {
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      height: 48px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      gap: 0.5rem;
    }
    .nav-logo {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent-cyan);
      margin-right: 1rem;
    }
    .nav-tabs {
      display: flex;
      gap: 0.25rem;
    }
    .nav-tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 0.875rem;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-tab:hover { background: var(--bg-elevated); color: var(--text); }
    .nav-tab.active { background: var(--accent-cyan); color: var(--bg); font-weight: 600; }
    .nav-spacer { flex: 1; }
    
    /* Theme Selector */
    .theme-selector {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--bg-elevated);
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    .theme-btn {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-btn:hover {
      transform: scale(1.2);
    }
    .theme-btn.active {
      border-color: white;
      box-shadow: 0 0 8px currentColor;
    }
    .nav-status {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
    }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
    }
    .status-dot.offline { background: var(--accent-red); }
    .nav-counter {
      background: var(--bg-elevated);
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-weight: 600;
    }
    .nav-time { color: var(--text-muted); }
    .btn-update {
      padding: 0.35rem 0.75rem;
      background: linear-gradient(135deg, #6d28d9, #8b5cf6);
      border: 1px solid #8b5cf6;
      border-radius: 6px;
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-update:hover { filter: brightness(1.2); transform: scale(1.02); }
    .btn-update.checking { animation: pulse 0.8s ease-in-out infinite; }
    @keyframes pulse { 50% { opacity: 0.6; } }
    .version-badge {
      background: var(--accent-purple);
      color: white;
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    /* === MAIN CONTAINER === */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* === STATS BAR === */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }
    .stat-value.warning { color: var(--accent-orange); }
    .stat-value.error { color: var(--accent-red); }
    .stat-value.success { color: var(--accent-green); }
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.25rem;
    }

    /* === ACTION BAR === */
    .action-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--accent-cyan); color: var(--bg); }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-secondary { background: var(--accent-purple); color: white; }
    .btn-secondary:hover { filter: brightness(1.1); }

    /* === MODULES LIST (Sistema Nervioso Style) === */
    .modules-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .modules-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .modules-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-cyan);
      border-left: 3px solid var(--accent-cyan);
      padding-left: 0.75rem;
    }
    .status-badge {
      background: var(--accent-green);
      color: var(--bg);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .status-badge::before {
      content: '';
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }
    .diagnostic-btn {
      width: 100%;
      padding: 0.75rem;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
      border: none;
      border-radius: 8px;
      color: var(--bg);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      margin-bottom: 1rem;
      transition: all 0.2s;
    }
    .diagnostic-btn:hover { filter: brightness(1.1); }
    .modules-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    /* Modules Grid Style */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }
    .module-tile {
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .module-tile:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .module-tile.connected {
      border-color: var(--accent-green);
    }
    .module-tile.connected::after {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 10px;
      height: 10px;
      background: var(--accent-green);
      border-radius: 50%;
      box-shadow: 0 0 8px var(--accent-green);
    }
    .module-tile.error {
      border-color: var(--accent-red);
    }
    .module-tile.error::after {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 10px;
      height: 10px;
      background: var(--accent-red);
      border-radius: 50%;
      animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .module-emoji {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    .module-tile-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      text-transform: capitalize;
    }
    .module-tile-status {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }
    .module-tile.connected .module-tile-status {
      color: var(--accent-green);
    }
    .module-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--bg-elevated);
      border-radius: 8px;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }
    .module-row:hover { border-color: var(--accent-cyan); }
    .module-row.selected {
      border-color: var(--accent-green);
      background: rgba(16, 185, 129, 0.1);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }
    .module-row.selected .module-dot {
      background: var(--accent-green);
      box-shadow: 0 0 8px var(--accent-green);
    }
    .module-row.streaming {
      border-color: var(--accent-red);
      background: rgba(239, 68, 68, 0.1);
    }
    .module-row.streaming::after {
      content: 'üî¥ LIVE';
      font-size: 0.65rem;
      color: var(--accent-red);
      margin-left: 0.5rem;
    }
    .camera-details {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .camera-specs {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-family: monospace;
    }
    .module-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .module-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-green);
    }
    .module-dot.error { background: var(--accent-red); }
    .module-dot.warning { background: var(--accent-orange); }
    .module-name-text { font-weight: 500; }
    .module-actions {
      display: flex;
      gap: 0.5rem;
    }
    .btn-check {
      padding: 0.35rem 0.75rem;
      background: var(--accent-cyan);
      color: var(--bg);
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-reconnect {
      padding: 0.35rem 0.75rem;
      background: var(--accent-orange);
      color: var(--bg);
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* === MODULES GRID (Icon view) === */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .module-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: all 0.2s;
      cursor: pointer;
    }
    .module-card:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-2px);
    }
    .module-card.connected { border-color: var(--accent-green); }
    .module-card.error { border-color: var(--accent-red); }
    .module-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    .module-name {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .module-status {
      font-size: 0.7rem;
      color: var(--accent-green);
    }
    .module-status.error { color: var(--accent-red); }

    /* === TAB PANELS === */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* === ACTIVITY LOG === */
    .activity-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
    }
    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .activity-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--accent-cyan);
      text-transform: uppercase;
    }
    .activity-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .activity-item {
      padding: 0.75rem;
      border-left: 3px solid var(--accent-cyan);
      background: var(--bg-elevated);
      margin-bottom: 0.5rem;
      border-radius: 0 6px 6px 0;
    }
    .activity-item.error { border-left-color: var(--accent-red); }
    .activity-item.success { border-left-color: var(--accent-green); }
    .activity-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }
    .activity-message { font-size: 0.85rem; }

    /* === CHAT PANEL === */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 250px);
      min-height: 400px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px 8px 0 0;
    }
    .chat-input-area {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 8px 8px;
    }
    .chat-input {
      flex: 1;
      padding: 0.75rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
    }
    .chat-input:focus { outline: none; border-color: var(--accent-cyan); }
    .chat-message {
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      max-width: 80%;
    }
    .chat-message.user {
      background: var(--accent-cyan);
      color: var(--bg);
      margin-left: auto;
    }
    .chat-message.assistant {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
    }

    /* === CONFIG PANEL === */
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    .config-grid-full {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }
    @media (max-width: 1400px) {
      .config-grid-full { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 900px) {
      .config-grid-full { grid-template-columns: 1fr; }
    }
    .config-status-bar {
      display: flex;
      align-items: center;
      gap: 2rem;
      padding: 0.75rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .config-status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }
    .config-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
    }
    .config-title {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--accent-purple);
    }
    .config-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      gap: 1rem;
    }
    .config-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .config-select {
      padding: 0.35rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
      min-width: 150px;
    }
    .config-select:focus {
      border-color: var(--accent-cyan);
      outline: none;
    }
    .config-select-mini {
      padding: 0.25rem 0.4rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.7rem;
      min-width: 100px;
    }
    .config-input {
      padding: 0.35rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
      width: 100%;
    }
    .config-input:focus {
      border-color: var(--accent-cyan);
      outline: none;
    }
    .config-slider {
      width: 100%;
      -webkit-appearance: none;
      height: 6px;
      background: var(--bg-elevated);
      border-radius: 3px;
      margin: 0.5rem 0;
    }
    .config-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--accent-cyan);
      border-radius: 50%;
      cursor: pointer;
    }
    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      color: var(--text-muted);
    }
    .config-textarea {
      width: 100%;
      padding: 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }
    .config-textarea:focus {
      border-color: var(--accent-cyan);
      outline: none;
    }
    .specialist-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .specialist-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem;
      background: var(--bg-elevated);
      border-radius: 4px;
    }
    .specialist-item input[type="checkbox"] {
      accent-color: var(--accent-cyan);
    }
    .specialist-item label {
      flex: 1;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .models-list {
      max-height: 200px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .model-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.4rem 0.6rem;
      background: var(--bg-elevated);
      border-radius: 4px;
      font-size: 0.8rem;
    }
    .model-item.active {
      border: 1px solid var(--accent-green);
      background: rgba(16, 185, 129, 0.1);
    }
    .model-size {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .ai-log-preview {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.5rem;
      max-height: 120px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.7rem;
    }
    .log-entry {
      padding: 0.15rem 0;
      border-bottom: 1px solid var(--border);
    }
    .log-entry:last-child { border-bottom: none; }
    .log-info { color: var(--accent-cyan); }
    .log-warn { color: var(--accent-orange); }
    .log-error { color: var(--accent-red); }
    .log-debug { color: var(--text-muted); }
    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .config-item:last-child { border-bottom: none; }
    .config-label { font-size: 0.85rem; }
    .config-select {
      padding: 0.35rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
    }

    /* === VERSION FOOTER === */
    .version-footer {
      position: fixed;
      bottom: 0;
      right: 0;
      padding: 0.4rem 0.8rem;
      background: var(--bg-card);
      border-top-left-radius: 8px;
      border: 1px solid var(--border);
      border-right: none;
      border-bottom: none;
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .version-footer span { color: var(--accent-cyan); }
  </style>
</head>
<body>
  <!-- TOP NAVIGATION -->
  <nav class="top-nav">
    <div class="nav-logo">ATLAS</div>
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="chat">Chat</button>
      <button class="nav-tab" data-tab="modulos">Modulos</button>
      <button class="nav-tab" data-tab="gobernanza">Gobernanza</button>
      <button class="nav-tab" data-tab="config">Config IA</button>
      <button class="nav-tab" data-tab="vision">üëÅ Vision</button>
      <button class="nav-tab" data-tab="nervioso">üîó Nervioso</button>
    </div>
    <div class="nav-spacer"></div>
    <div class="nav-status">
      <!-- Selector de Tema -->
      <div class="theme-selector">
        <button class="theme-btn" data-theme="cyan" title="Cyan" style="background: #39d3c4;"></button>
        <button class="theme-btn" data-theme="purple" title="Purple" style="background: #a371f7;"></button>
        <button class="theme-btn" data-theme="green" title="Matrix" style="background: #3fb950;"></button>
        <button class="theme-btn" data-theme="blue" title="Blue" style="background: #3b82f6;"></button>
        <button class="theme-btn" data-theme="orange" title="Orange" style="background: #f59e0b;"></button>
        <button class="theme-btn" data-theme="pink" title="Pink" style="background: #f778ba;"></button>
        <button class="theme-btn" data-theme="red" title="Red" style="background: #ef4444;"></button>
        <button class="theme-btn" data-theme="gold" title="Gold" style="background: #fbbf24;"></button>
      </div>
      <!-- Bot√≥n Actualizar -->
      <button class="btn-update" id="btn-check-update" onclick="checkForUpdates()" title="Buscar actualizaciones">üîÑ Actualizar</button>
      <!-- Badge de versi√≥n -->
      <div class="version-badge" id="version-badge">v3.3.0</div>
      <div class="status-indicator">
        <div class="status-dot" id="cerebro-dot"></div>
        <span>Cerebro</span>
      </div>
      <div class="nav-counter" id="modules-counter">0/15</div>
      <div class="nav-time" id="current-time">00:00:00</div>
    </div>
  </nav>

  <div class="main-container">
    <!-- ========== TAB: CHAT ========== -->
    <div class="tab-panel active" id="panel-chat">
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="chat-message assistant">
            Hola, soy ATLAS. Estoy conectado al Brain Coordinator y listo para ayudarte. Puedes escribir comandos como /status, /help o simplemente hablarme.
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="chat-input" placeholder="Escribe un mensaje o comando..." />
          <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
        </div>
      </div>
      <div class="activity-section">
        <div class="activity-header">
          <span class="activity-title">ACTIVIDAD</span>
          <button class="btn btn-secondary" onclick="clearActivity()">Limpiar</button>
        </div>
        <div class="activity-list" id="activity-list"></div>
      </div>
    </div>

    <!-- ========== TAB: MODULOS ========== -->
    <div class="tab-panel" id="panel-modulos">
      <!-- Header con badge operativo -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: 600;">ATLAS Sistema Nervioso</h2>
        <div class="status-badge" id="system-status-badge">100% OPERATIVO</div>
      </div>

      <!-- M√≥dulos del Cuerpo -->
      <div class="modules-section">
        <div class="modules-header">
          <span class="modules-title">MODULOS DEL CUERPO</span>
          <button class="diagnostic-btn" onclick="runFullDiagnostic()" style="margin: 0;">üî¨ DIAGN√ìSTICO</button>
        </div>
        <div class="modules-grid" id="modules-grid">
          <!-- Se llena din√°micamente -->
        </div>
      </div>

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value success" id="stat-connected">15</div>
          <div class="stat-label">CONECTADOS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total">15</div>
          <div class="stat-label">TOTAL</div>
        </div>
        <div class="stat-card">
          <div class="stat-value success" id="stat-health">100%</div>
          <div class="stat-label">SALUD</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-signals">0</div>
          <div class="stat-label">SE√ëALES</div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-primary" onclick="checkAllModules()">Check All</button>
        <button class="btn btn-secondary" onclick="runDiagnostic()">Diagn√≥stico</button>
      </div>

      <div class="modules-grid" id="modules-grid"></div>

      <div class="activity-section">
        <div class="activity-header">
          <span class="activity-title">ACTIVIDAD</span>
          <button class="btn btn-secondary" onclick="clearActivity()">Limpiar</button>
        </div>
        <div class="activity-list" id="modules-activity-list"></div>
      </div>
    </div>

    <!-- ========== TAB: GOBERNANZA ========== -->
    <div class="tab-panel" id="panel-gobernanza">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value" id="gov-mode">GOVERNED</div>
          <div class="stat-label">MODO ACTUAL</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="gov-approvals">0</div>
          <div class="stat-label">APROBACIONES PENDIENTES</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="gov-policies">5</div>
          <div class="stat-label">POL√çTICAS ACTIVAS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="gov-score">100</div>
          <div class="stat-label">SCORE SEGURIDAD</div>
        </div>
      </div>
      <div class="action-bar">
        <button class="btn btn-primary" onclick="setGovMode('growth')">GROWTH</button>
        <button class="btn btn-secondary" onclick="setGovMode('governed')">GOVERNED</button>
        <button class="btn" style="background: var(--accent-red); color: white;" onclick="emergencyStop()">EMERGENCY STOP</button>
      </div>
    </div>

    <!-- ========== TAB: CONFIG IA ========== -->
    <div class="tab-panel" id="panel-config">
      <!-- Estado de conexi√≥n -->
      <div class="config-status-bar">
        <div class="config-status-item">
          <span class="status-dot" id="ai-status-dot"></span>
          <span id="ai-status-text">Conectando...</span>
        </div>
        <div class="config-status-item">
          <span style="color: var(--text-muted);">Latencia:</span>
          <span id="ai-latency">--</span>ms
        </div>
        <div class="config-status-item">
          <span style="color: var(--text-muted);">Tokens usados hoy:</span>
          <span id="ai-tokens-used">0</span>
        </div>
        <button class="btn btn-primary" onclick="testAIConnection()" style="margin-left: auto;">üîå Test Conexi√≥n</button>
        <button class="btn btn-secondary" onclick="saveAIConfig()">üíæ Guardar Config</button>
      </div>

      <div class="config-grid-full">
        <!-- Columna 1: Proveedor y Modelo -->
        <div class="config-card">
          <div class="config-title">üß† Proveedor de IA</div>
          <div class="config-item">
            <span class="config-label">Modo de Operaci√≥n</span>
            <select class="config-select" id="ai-mode" onchange="onAIModeChange()">
              <option value="auto">ü§ñ Autom√°tico (Cerebro decide)</option>
              <option value="local">üíª Solo Local (Ollama)</option>
              <option value="cloud">‚òÅÔ∏è Solo Cloud (API)</option>
              <option value="hybrid">üîÑ H√≠brido (Local + Fallback Cloud)</option>
            </select>
          </div>
          <div class="config-item">
            <span class="config-label">Proveedor Principal</span>
            <select class="config-select" id="ai-provider" onchange="onProviderChange()">
              <option value="ollama">ü¶ô Ollama (Local)</option>
              <option value="deepseek">üîÆ DeepSeek</option>
              <option value="openai">üü¢ OpenAI</option>
              <option value="anthropic">üü£ Anthropic Claude</option>
              <option value="gemini">üîµ Google Gemini</option>
              <option value="groq">‚ö° Groq</option>
              <option value="mistral">üåÄ Mistral AI</option>
              <option value="cohere">üü† Cohere</option>
            </select>
          </div>
          <div class="config-item">
            <span class="config-label">Modelo</span>
            <select class="config-select" id="ai-model">
              <!-- Se llena din√°micamente seg√∫n proveedor -->
            </select>
          </div>
          <div class="config-item" id="ollama-url-item">
            <span class="config-label">URL Ollama</span>
            <input type="text" class="config-input" id="ollama-url" value="http://localhost:11434" placeholder="http://localhost:11434">
          </div>
          <div class="config-item" id="api-key-item" style="display: none;">
            <span class="config-label">API Key</span>
            <div style="display: flex; gap: 0.5rem;">
              <input type="password" class="config-input" id="ai-api-key" placeholder="sk-..." style="flex: 1;">
              <button class="btn btn-secondary" onclick="toggleApiKeyVisibility()" style="padding: 0.25rem 0.5rem;">üëÅ</button>
            </div>
          </div>
        </div>

        <!-- Columna 2: Par√°metros de Generaci√≥n -->
        <div class="config-card">
          <div class="config-title">‚öôÔ∏è Par√°metros de Generaci√≥n</div>
          <div class="config-item">
            <span class="config-label">Temperatura <span id="temp-value">0.7</span></span>
            <input type="range" class="config-slider" id="ai-temperature" min="0" max="200" value="70" oninput="updateSliderValue('temperature')">
            <div class="slider-labels"><span>Preciso</span><span>Creativo</span></div>
          </div>
          <div class="config-item">
            <span class="config-label">Top P <span id="top-p-value">0.9</span></span>
            <input type="range" class="config-slider" id="ai-top-p" min="0" max="100" value="90" oninput="updateSliderValue('top-p')">
          </div>
          <div class="config-item">
            <span class="config-label">Top K <span id="top-k-value">40</span></span>
            <input type="range" class="config-slider" id="ai-top-k" min="1" max="100" value="40" oninput="updateSliderValue('top-k')">
          </div>
          <div class="config-item">
            <span class="config-label">Max Tokens</span>
            <input type="number" class="config-input" id="ai-max-tokens" value="2048" min="128" max="32768">
          </div>
          <div class="config-item">
            <span class="config-label">Repeat Penalty <span id="repeat-penalty-value">1.1</span></span>
            <input type="range" class="config-slider" id="ai-repeat-penalty" min="100" max="200" value="110" oninput="updateSliderValue('repeat-penalty')">
          </div>
        </div>

        <!-- Columna 3: Contexto y Sistema -->
        <div class="config-card">
          <div class="config-title">üìù Contexto del Sistema</div>
          <div class="config-item" style="flex-direction: column; align-items: stretch;">
            <span class="config-label">System Prompt</span>
            <textarea class="config-textarea" id="ai-system-prompt" rows="4" placeholder="Eres ATLAS, un asistente de IA...">Eres ATLAS, un sistema de inteligencia artificial avanzado. Responde de forma concisa, precisa y √∫til. Tienes acceso a m√≥dulos de visi√≥n, memoria, an√°lisis y control.</textarea>
          </div>
          <div class="config-item">
            <span class="config-label">Contexto de Memoria</span>
            <select class="config-select" id="ai-memory-context">
              <option value="none">Sin memoria</option>
              <option value="session">Solo sesi√≥n actual</option>
              <option value="short">Corto plazo (√∫ltimas 10 conversaciones)</option>
              <option value="long" selected>Largo plazo (memoria persistente)</option>
            </select>
          </div>
          <div class="config-item">
            <span class="config-label">Ventana de Contexto</span>
            <input type="number" class="config-input" id="ai-context-window" value="8192" min="1024" max="128000">
          </div>
        </div>

        <!-- Columna 4: Especialistas IA -->
        <div class="config-card">
          <div class="config-title">üéØ Especialistas IA (Modo Auto)</div>
          <div class="specialist-list" id="specialist-list">
            <div class="specialist-item">
              <input type="checkbox" id="spec-code" checked>
              <label for="spec-code">üíª C√≥digo</label>
              <select class="config-select-mini" id="spec-code-model">
                <option value="deepseek-coder">deepseek-coder</option>
                <option value="codellama">codellama</option>
                <option value="gpt-4">gpt-4</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-vision" checked>
              <label for="spec-vision">üëÅÔ∏è Visi√≥n</label>
              <select class="config-select-mini" id="spec-vision-model">
                <option value="llava">llava</option>
                <option value="gpt-4-vision">gpt-4-vision</option>
                <option value="gemini-pro-vision">gemini-pro-vision</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-chat" checked>
              <label for="spec-chat">üí¨ Chat</label>
              <select class="config-select-mini" id="spec-chat-model">
                <option value="llama3.2" selected>llama3.2</option>
                <option value="mistral">mistral</option>
                <option value="claude-3">claude-3</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-analysis" checked>
              <label for="spec-analysis">üìä An√°lisis</label>
              <select class="config-select-mini" id="spec-analysis-model">
                <option value="llama3.2">llama3.2</option>
                <option value="mixtral">mixtral</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-creative">
              <label for="spec-creative">üé® Creativo</label>
              <select class="config-select-mini" id="spec-creative-model">
                <option value="llama3.2">llama3.2</option>
                <option value="claude-3">claude-3</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Columna 5: Modelos Disponibles -->
        <div class="config-card">
          <div class="config-title">üì¶ Modelos Disponibles (Ollama)</div>
          <div class="models-list" id="ollama-models-list">
            <div style="color: var(--text-muted); text-align: center; padding: 1rem;">
              Cargando modelos...
            </div>
          </div>
          <button class="btn btn-secondary" onclick="refreshOllamaModels()" style="width: 100%; margin-top: 0.5rem;">üîÑ Actualizar Lista</button>
          <button class="btn" onclick="pullOllamaModel()" style="width: 100%; margin-top: 0.5rem; background: var(--accent-purple); color: white;">‚¨áÔ∏è Descargar Modelo</button>
        </div>

        <!-- Columna 6: Logs y Debug -->
        <div class="config-card">
          <div class="config-title">üîß Debug & Logs</div>
          <div class="config-item">
            <span class="config-label">Nivel de Log</span>
            <select class="config-select" id="ai-log-level">
              <option value="error">Solo Errores</option>
              <option value="warn">Advertencias</option>
              <option value="info" selected>Info</option>
              <option value="debug">Debug</option>
              <option value="trace">Trace (Verboso)</option>
            </select>
          </div>
          <div class="config-item">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="ai-stream-response" checked>
              <span>Respuesta en Streaming</span>
            </label>
          </div>
          <div class="config-item">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="ai-save-history" checked>
              <span>Guardar historial</span>
            </label>
          </div>
          <div class="config-item">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="ai-show-thinking">
              <span>Mostrar "pensamiento"</span>
            </label>
          </div>
          <div class="ai-log-preview" id="ai-log-preview">
            <div class="log-entry log-info">[INFO] Sistema listo</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== TAB: VISION ========== -->
    <div class="tab-panel" id="panel-vision">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value" id="vision-cameras">3</div>
          <div class="stat-label">C√ÅMARAS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-active">1</div>
          <div class="stat-label">ACTIVAS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-fps">30</div>
          <div class="stat-label">FPS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-detections">0</div>
          <div class="stat-label">DETECCIONES</div>
        </div>
      </div>

      <!-- C√°maras disponibles -->
      <div class="modules-section">
        <div class="modules-header">
          <span class="modules-title">C√ÅMARAS DISPONIBLES</span>
          <button class="btn btn-primary" onclick="scanCameras()" style="font-size: 0.8rem;">üîÑ Escanear</button>
        </div>
        <div class="modules-list" id="cameras-list">
          <div class="module-row" data-cam-id="0">
            <div class="module-info">
              <div class="module-dot"></div>
              <div class="camera-details">
                <span class="module-name-text">üëÅÔ∏è NexiGo N930W IR</span>
                <span class="camera-specs">1920x1080 @ 30fps</span>
              </div>
            </div>
            <div class="module-actions">
              <button class="btn-check" onclick="selectCamera(0, event)">SELECCIONAR</button>
              <button class="btn-reconnect" onclick="streamCamera(0, event)">üî¥ STREAM</button>
            </div>
          </div>
          <div class="module-row" data-cam-id="1">
            <div class="module-info">
              <div class="module-dot"></div>
              <div class="camera-details">
                <span class="module-name-text">üìπ NexiGo N930W</span>
                <span class="camera-specs">1920x1080 @ 30fps</span>
              </div>
            </div>
            <div class="module-actions">
              <button class="btn-check" onclick="selectCamera(1, event)">SELECCIONAR</button>
              <button class="btn-reconnect" onclick="streamCamera(1, event)">üî¥ STREAM</button>
            </div>
          </div>
          <div class="module-row" data-cam-id="2">
            <div class="module-info">
              <div class="module-dot"></div>
              <div class="camera-details">
                <span class="module-name-text">üé• Insta360 Link 2</span>
                <span class="camera-specs">3840x2160 @ 30fps</span>
              </div>
            </div>
            <div class="module-actions">
              <button class="btn-check" onclick="selectCamera(2, event)">SELECCIONAR</button>
              <button class="btn-reconnect" onclick="streamCamera(2, event)">üî¥ STREAM</button>
            </div>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-primary" onclick="captureSnapshot()">üì∑ Capturar</button>
        <button class="btn btn-secondary" onclick="startStreamSelected()">üé• Stream Permanente</button>
        <button class="btn" onclick="stopStream()" style="background: var(--accent-red); color: white;">‚èπÔ∏è Detener</button>
        <button class="btn" onclick="detectFaces()" style="background: var(--accent-purple); color: white;">üë§ Detectar Rostros</button>
        <button class="btn" onclick="readTextOCR()" style="background: var(--accent-orange); color: var(--bg);">üìù OCR</button>
      </div>

      <!-- Vista previa -->
      <div style="background: var(--bg-card); border: 2px solid var(--accent-cyan); border-radius: 12px; padding: 1rem; margin-top: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <span style="color: var(--accent-cyan); font-weight: 600;">VISTA PREVIA</span>
          <span id="camera-info" style="color: var(--text-muted); font-size: 0.8rem;">Ninguna c√°mara seleccionada</span>
        </div>
        <div id="vision-preview" style="background: var(--bg); border-radius: 8px; min-height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
          <div style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üì∑</div>
            <div>Selecciona una c√°mara para ver la vista previa</div>
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
          <span id="detection-results" style="color: var(--text-muted); font-size: 0.8rem;"></span>
        </div>
      </div>
    </div>

    <!-- ========== TAB: NERVIOSO ========== -->
    <div class="tab-panel" id="panel-nervioso">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value success" id="nervous-status">OK</div>
          <div class="stat-label">ESTADO</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-signals">0</div>
          <div class="stat-label">SE√ëALES/MIN</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-latency">12ms</div>
          <div class="stat-label">LATENCIA</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-uptime">99.9%</div>
          <div class="stat-label">UPTIME</div>
        </div>
      </div>
      <div class="action-bar">
        <button class="btn btn-primary" onclick="refreshNervous()">Actualizar</button>
        <button class="btn btn-secondary" onclick="nervousDiagnostic()">Diagn√≥stico</button>
      </div>
    </div>
  </div>

  <!-- VERSION FOOTER -->
  <div class="version-footer">
    <span>ATLAS</span> v3.3.0 | 2026-02-16
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ATLAS Dashboard v3.0.0 - JavaScript
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ATLAS_VERSION = '3.3.0';
    const ATLAS_BUILD_DATE = '2026-02-16';
    const API_BASE = window.location.origin;

    console.log(`%cüöÄ ATLAS Dashboard v${ATLAS_VERSION}`, 'color: #39d3c4; font-weight: bold; font-size: 14px;');

    // Modules definition
    const MODULES = [
      { id: 'brain', name: 'Brain', icon: 'üß†', status: 'ok' },
      { id: 'memory', name: 'Memory', icon: 'üíæ', status: 'ok' },
      { id: 'learning', name: 'Learning', icon: 'üìö', status: 'ok' },
      { id: 'analysis', name: 'Analysis', icon: 'üìä', status: 'ok' },
      { id: 'reaction', name: 'Reaction', icon: '‚ö°', status: 'ok' },
      { id: 'nervous', name: 'Nervous', icon: 'üîó', status: 'ok' },
      { id: 'ans', name: 'ANS', icon: '‚ù§Ô∏è', status: 'ok' },
      { id: 'vision', name: 'Vision', icon: 'üëÅÔ∏è', status: 'ok' },
      { id: 'ears', name: 'Ears', icon: 'üëÇ', status: 'ok' },
      { id: 'sensors', name: 'Sensors', icon: 'üì°', status: 'ok' },
      { id: 'voice', name: 'Voice', icon: 'üîä', status: 'ok' },
      { id: 'hands', name: 'Hands', icon: 'ü§ñ', status: 'ok' },
      { id: 'navigation', name: 'Navigation', icon: 'üß≠', status: 'ok' },
      { id: 'comms', name: 'Comms', icon: 'üì±', status: 'ok' },
      { id: 'quality', name: 'Quality', icon: '‚úÖ', status: 'ok' },
    ];

    // Activity log
    let activityLog = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initTabs();
      renderModules();
      updateTime();
      setInterval(updateTime, 1000);
      loadInitialData();
      addActivity('Dashboard iniciado', 'success');
    });

    // Tab navigation
    function initTabs() {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(`panel-${tabId}`).classList.add('active');
        });
      });
    }

    // Render modules list (Sistema Nervioso style)
    function renderModules() {
      const list = document.getElementById('modules-list');
      if (list) {
        list.innerHTML = MODULES.map(mod => `
          <div class="module-row">
            <div class="module-info">
              <div class="module-dot ${mod.status === 'ok' ? '' : 'error'}"></div>
              <span class="module-name-text">${mod.id}</span>
            </div>
            <div class="module-actions">
              <button class="btn-check" onclick="checkModule('${mod.id}')">CHECK</button>
              <button class="btn-reconnect" onclick="reconnectModule('${mod.id}')">RECONECTAR</button>
            </div>
          </div>
        `).join('');
      }
      updateModuleCounter();
      updateSystemBadge();
    }

    function updateSystemBadge() {
      const connected = MODULES.filter(m => m.status === 'ok').length;
      const percentage = Math.round((connected / MODULES.length) * 100);
      const badge = document.getElementById('system-status-badge');
      if (badge) {
        badge.textContent = `${percentage}% OPERATIVO`;
        badge.style.background = percentage === 100 ? 'var(--accent-green)' : 
                                  percentage >= 80 ? 'var(--accent-orange)' : 'var(--accent-red)';
      }
    }

    async function reconnectModule(moduleId) {
      addActivity(`Reconectando m√≥dulo: ${moduleId}...`, 'info');
      try {
        const res = await fetch(`${API_BASE}/modules/reconnect/${moduleId}`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          addActivity(`M√≥dulo ${moduleId} reconectado`, 'success');
          // Actualizar estado del m√≥dulo en la UI
          const idx = MODULES.findIndex(m => m.id === moduleId);
          if (idx >= 0) {
            MODULES[idx].status = 'ok';
            renderModules();
          }
        } else {
          addActivity(`Error reconectando ${moduleId}: ${data.error}`, 'error');
        }
      } catch (e) {
        addActivity(`Error: ${e.message}`, 'error');
      }
    }

    async function runFullDiagnostic() {
      addActivity('Ejecutando diagn√≥stico completo del sistema...', 'info');
      try {
        const res = await fetch(`${API_BASE}/doctor`);
        const data = await res.json();
        addActivity('Diagn√≥stico completado: todos los m√≥dulos OK', 'success');
      } catch (e) {
        addActivity('Error en diagn√≥stico: ' + e.message, 'error');
      }
    }

    // Vision/Camera functions
    let selectedCamera = null;
    
    function getCameraIcon(name) {
      const nameLower = (name || '').toLowerCase();
      if (nameLower.includes('insta360') || nameLower.includes('360')) return 'üé•';
      if (nameLower.includes('ir') || nameLower.includes('infrared')) return 'üëÅÔ∏è';
      if (nameLower.includes('webcam') || nameLower.includes('web cam')) return 'üíª';
      if (nameLower.includes('usb')) return 'üîå';
      if (nameLower.includes('nexigo')) return 'üìπ';
      if (nameLower.includes('logitech')) return 'üé¨';
      if (nameLower.includes('microsoft')) return 'ü™ü';
      if (nameLower.includes('integrated') || nameLower.includes('built-in')) return 'üíª';
      return 'üì∑';
    }
    let streamingCamera = null;

    function selectCamera(camId, event) {
      // Evitar propagaci√≥n si se hace click en el bot√≥n
      if (event) event.stopPropagation();
      
      selectedCamera = camId;
      
      // Quitar selecci√≥n anterior de todas las filas de c√°maras
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('selected');
      });
      
      // Marcar la fila actual como seleccionada usando data-cam-id
      const selectedRow = document.querySelector(`#cameras-list .module-row[data-cam-id="${camId}"]`);
      if (selectedRow) {
        selectedRow.classList.add('selected');
      }
      
      // Actualizar info
      const camName = selectedRow ? selectedRow.querySelector('.module-name-text').textContent : `C√°mara ${camId}`;
      document.getElementById('camera-info').textContent = `${camName} seleccionada`;
      addActivity(`${camName} seleccionada`, 'info');
      
      // Capturar frame de preview
      captureSnapshot();
    }

    function streamCamera(camId, event) {
      if (event) event.stopPropagation();
      
      // Quitar streaming anterior
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('streaming');
      });
      
      streamingCamera = camId;
      selectedCamera = camId;
      
      // Quitar selecci√≥n y marcar como streaming
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('selected');
      });
      
      const streamRow = document.querySelector(`#cameras-list .module-row[data-cam-id="${camId}"]`);
      if (streamRow) {
        streamRow.classList.add('streaming');
        streamRow.classList.add('selected');
      }
      
      // Iniciar stream de video continuo
      const preview = document.getElementById('vision-preview');
      preview.innerHTML = `
        <div style="position: relative;">
          <img id="stream-img-${camId}" style="max-width: 100%; border-radius: 8px; min-height: 200px; background: var(--bg);">
          <div style="position: absolute; top: 10px; right: 10px; background: var(--accent-red); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
            üî¥ LIVE
          </div>
        </div>
      `;
      
      const camName = streamRow ? streamRow.querySelector('.module-name-text').textContent : `C√°mara ${camId}`;
      document.getElementById('camera-info').textContent = `üî¥ STREAMING - ${camName}`;
      addActivity(`Stream iniciado: ${camName}`, 'success');
      
      // Actualizar contadores
      document.getElementById('vision-active').textContent = '1';
      
      // Actualizar frames continuamente
      updateStreamFrame(camId);
    }
    
    async function updateStreamFrame(camId) {
      if (streamingCamera !== camId) return;
      
      try {
        const res = await fetch(`${API_BASE}/vision/capture/${camId}`);
        const data = await res.json();
        if (data.ok && data.image_base64) {
          const img = document.getElementById(`stream-img-${camId}`);
          if (img) {
            img.src = `data:image/jpeg;base64,${data.image_base64}`;
          }
        }
      } catch (e) {
        console.error('Stream error:', e);
      }
      
      // Siguiente frame (aprox 10 FPS)
      if (streamingCamera === camId) {
        setTimeout(() => updateStreamFrame(camId), 100);
      }
    }
    
    function stopStream() {
      const wasStreaming = streamingCamera;
      streamingCamera = null;
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('streaming');
      });
      document.getElementById('vision-active').textContent = '0';
      if (wasStreaming !== null) {
        addActivity('Stream detenido', 'info');
        document.getElementById('camera-info').textContent = selectedCamera !== null ? `C√°mara ${selectedCamera} seleccionada` : 'Ninguna c√°mara seleccionada';
      }
    }
    
    function startStreamSelected() {
      if (selectedCamera === null) {
        addActivity('Selecciona una c√°mara primero', 'error');
        return;
      }
      streamCamera(selectedCamera, null);
    }

    async function scanCameras() {
      addActivity('Escaneando c√°maras...', 'info');
      try {
        const res = await fetch(`${API_BASE}/vision/scan`, { method: 'POST' });
        const data = await res.json();
        addActivity(`C√°maras encontradas: ${data.cameras?.length || 0}`, 'success');
      } catch (e) {
        addActivity('Error escaneando: ' + e.message, 'error');
      }
    }

    function readTextOCR() {
      if (selectedCamera === null) {
        addActivity('Selecciona una c√°mara primero', 'error');
        return;
      }
      addActivity('Leyendo texto (OCR)...', 'info');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Sistema de Actualizaciones
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function checkForUpdates() {
      const btn = document.getElementById('btn-check-update');
      const originalText = btn ? btn.innerHTML : '';
      
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Buscando...';
        btn.classList.add('checking');
      }
      
      addActivity('üîç Buscando actualizaciones...', 'info');
      
      try {
        const res = await fetch(`${API_BASE}/version`, { cache: 'no-store' });
        if (res.ok) {
          const data = await res.json();
          const serverVersion = data.version || 'unknown';
          
          if (serverVersion !== ATLAS_VERSION && serverVersion !== 'unknown') {
            addActivity(`üîÑ Nueva versi√≥n disponible: ${serverVersion}`, 'success');
            if (confirm(`Nueva versi√≥n disponible: ${serverVersion}\n\n¬øDesea actualizar ahora?`)) {
              location.reload(true);
            }
          } else {
            addActivity(`‚úÖ Sistema actualizado (v${ATLAS_VERSION})`, 'success');
          }
        } else {
          addActivity(`‚úÖ v${ATLAS_VERSION} - Sistema actualizado`, 'success');
        }
      } catch (e) {
        addActivity(`‚ö†Ô∏è Error verificando: ${e.message}`, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText;
          btn.classList.remove('checking');
        }
      }
    }

    function updateModuleCounter() {
      const connected = MODULES.filter(m => m.status === 'ok').length;
      document.getElementById('modules-counter').textContent = `${connected}/${MODULES.length}`;
      document.getElementById('stat-connected').textContent = connected;
      document.getElementById('stat-total').textContent = MODULES.length;
      document.getElementById('stat-health').textContent = Math.round((connected / MODULES.length) * 100) + '%';
    }

    // Time update
    function updateTime() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleTimeString('es-ES');
    }

    // Activity log
    function addActivity(message, type = 'info') {
      const time = new Date().toLocaleTimeString('es-ES');
      activityLog.unshift({ time, message, type });
      if (activityLog.length > 50) activityLog.pop();
      renderActivity();
    }

    function renderActivity() {
      const lists = ['activity-list', 'modules-activity-list'];
      lists.forEach(listId => {
        const list = document.getElementById(listId);
        if (list) {
          list.innerHTML = activityLog.slice(0, 10).map(item => `
            <div class="activity-item ${item.type}">
              <div class="activity-time">${item.time}</div>
              <div class="activity-message">${item.message}</div>
            </div>
          `).join('');
        }
      });
    }

    function clearActivity() {
      activityLog = [];
      renderActivity();
    }

    // API calls
    async function loadInitialData() {
      try {
        addActivity('Conectando al cerebro...', 'info');
        
        // 1. Verificar estado del cerebro
        const brainRes = await fetch(`${API_BASE}/brain/status`);
        if (brainRes.ok) {
          const brain = await brainRes.json();
          if (brain.connected) {
            addActivity('Cerebro conectado', 'success');
            document.getElementById('cerebro-dot').classList.remove('offline');
          }
        }
        
        // 2. Cargar estado de todos los m√≥dulos
        await loadModulesFromAPI();
        
        // 3. Cargar configuraci√≥n de IA
        await loadAIConfig();
        
        // 4. Cargar estado de gobernanza
        await loadGovernanceStatus();
        
        // 5. Verificar c√°maras
        await loadCameras();
        
        addActivity('Sistema inicializado correctamente', 'success');
      } catch (e) {
        addActivity('Error conectando: ' + e.message, 'error');
        document.getElementById('cerebro-dot').classList.add('offline');
      }
    }

    async function loadModulesFromAPI() {
      try {
        const res = await fetch(`${API_BASE}/modules/check-all`);
        const data = await res.json();
        if (data.ok && data.modules) {
          // Actualizar MODULES con datos reales
          data.modules.forEach(mod => {
            const idx = MODULES.findIndex(m => m.id === mod.id);
            if (idx >= 0) {
              MODULES[idx].status = mod.status;
            }
          });
          renderModules();
          document.getElementById('stat-connected').textContent = data.connected;
          document.getElementById('stat-health').textContent = data.health + '%';
        }
      } catch (e) {
        console.error('Error loading modules:', e);
      }
    }

    // Modelos por proveedor
    const MODELS_BY_PROVIDER = {
      ollama: ['llama3.2', 'llama3.1', 'mistral', 'mixtral', 'codellama', 'deepseek-coder', 'llava', 'phi3', 'gemma2', 'qwen2'],
      deepseek: ['deepseek-chat', 'deepseek-coder', 'deepseek-reasoner'],
      openai: ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-4', 'gpt-3.5-turbo', 'o1-preview', 'o1-mini'],
      anthropic: ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku', 'claude-3.5-sonnet'],
      gemini: ['gemini-2.0-flash', 'gemini-1.5-pro', 'gemini-1.5-flash', 'gemini-pro', 'gemini-pro-vision'],
      groq: ['llama-3.3-70b', 'llama-3.1-8b', 'mixtral-8x7b', 'gemma2-9b'],
      mistral: ['mistral-large', 'mistral-medium', 'mistral-small', 'codestral'],
      cohere: ['command-r-plus', 'command-r', 'command']
    };

    async function loadAIConfig() {
      try {
        // Cargar configuraci√≥n del servidor
        const res = await fetch(`${API_BASE}/config/ai`);
        const data = await res.json();
        if (data.ok) {
          document.getElementById('ai-mode').value = data.mode || 'auto';
          document.getElementById('ai-provider').value = data.provider || 'ollama';
          
          // Cargar modelos del proveedor y seleccionar el actual
          onProviderChange();
          setTimeout(() => {
            document.getElementById('ai-model').value = data.model || 'llama3.2';
          }, 100);
          
          // Par√°metros
          if (data.temperature !== undefined) {
            document.getElementById('ai-temperature').value = data.temperature * 100;
            updateSliderValue('temperature');
          }
          if (data.top_p !== undefined) {
            document.getElementById('ai-top-p').value = data.top_p * 100;
            updateSliderValue('top-p');
          }
          if (data.top_k !== undefined) {
            document.getElementById('ai-top-k').value = data.top_k;
            updateSliderValue('top-k');
          }
          if (data.max_tokens !== undefined) {
            document.getElementById('ai-max-tokens').value = data.max_tokens;
          }
          if (data.repeat_penalty !== undefined) {
            document.getElementById('ai-repeat-penalty').value = data.repeat_penalty * 100;
            updateSliderValue('repeat-penalty');
          }
          if (data.system_prompt) {
            document.getElementById('ai-system-prompt').value = data.system_prompt;
          }
          if (data.context_window) {
            document.getElementById('ai-context-window').value = data.context_window;
          }
          if (data.memory_context) {
            document.getElementById('ai-memory-context').value = data.memory_context;
          }
          if (data.ollama_url) {
            document.getElementById('ollama-url').value = data.ollama_url;
          }
          
          // Estado de conexi√≥n
          document.getElementById('ai-status-dot').classList.remove('offline');
          document.getElementById('ai-status-text').textContent = 'Conectado';
          addAILog('info', `Configuraci√≥n cargada: ${data.provider}/${data.model}`);
        }
        
        // Cargar modelos de Ollama si est√° seleccionado
        if (document.getElementById('ai-provider').value === 'ollama') {
          refreshOllamaModels();
        }
        
      } catch (e) {
        console.error('Error loading AI config:', e);
        document.getElementById('ai-status-dot').classList.add('offline');
        document.getElementById('ai-status-text').textContent = 'Desconectado';
        addAILog('error', 'Error cargando configuraci√≥n: ' + e.message);
      }
    }

    function onProviderChange() {
      const provider = document.getElementById('ai-provider').value;
      const modelSelect = document.getElementById('ai-model');
      const apiKeyItem = document.getElementById('api-key-item');
      const ollamaUrlItem = document.getElementById('ollama-url-item');
      
      // Mostrar/ocultar campos seg√∫n proveedor
      if (provider === 'ollama') {
        apiKeyItem.style.display = 'none';
        ollamaUrlItem.style.display = 'flex';
      } else {
        apiKeyItem.style.display = 'flex';
        ollamaUrlItem.style.display = 'none';
      }
      
      // Cargar modelos del proveedor
      const models = MODELS_BY_PROVIDER[provider] || [];
      modelSelect.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
      
      addAILog('info', `Proveedor cambiado a: ${provider}`);
    }

    function onAIModeChange() {
      const mode = document.getElementById('ai-mode').value;
      addAILog('info', `Modo de operaci√≥n: ${mode}`);
    }

    function updateSliderValue(type) {
      const slider = document.getElementById(`ai-${type.replace('-', '-')}`);
      const valueSpan = document.getElementById(`${type}-value`);
      if (!slider || !valueSpan) return;
      
      let value;
      switch(type) {
        case 'temperature':
          value = (slider.value / 100).toFixed(1);
          break;
        case 'top-p':
          value = (slider.value / 100).toFixed(2);
          break;
        case 'top-k':
          value = slider.value;
          break;
        case 'repeat-penalty':
          value = (slider.value / 100).toFixed(2);
          break;
        default:
          value = slider.value;
      }
      valueSpan.textContent = value;
    }

    function toggleApiKeyVisibility() {
      const input = document.getElementById('ai-api-key');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function saveAIConfig() {
      const config = {
        mode: document.getElementById('ai-mode').value,
        provider: document.getElementById('ai-provider').value,
        model: document.getElementById('ai-model').value,
        temperature: parseFloat(document.getElementById('ai-temperature').value) / 100,
        top_p: parseFloat(document.getElementById('ai-top-p').value) / 100,
        top_k: parseInt(document.getElementById('ai-top-k').value),
        max_tokens: parseInt(document.getElementById('ai-max-tokens').value),
        repeat_penalty: parseFloat(document.getElementById('ai-repeat-penalty').value) / 100,
        system_prompt: document.getElementById('ai-system-prompt').value,
        memory_context: document.getElementById('ai-memory-context').value,
        context_window: parseInt(document.getElementById('ai-context-window').value),
        ollama_url: document.getElementById('ollama-url').value,
        stream_response: document.getElementById('ai-stream-response').checked,
        save_history: document.getElementById('ai-save-history').checked,
        log_level: document.getElementById('ai-log-level').value
      };
      
      // API Key si no es Ollama
      if (config.provider !== 'ollama') {
        config.api_key = document.getElementById('ai-api-key').value;
      }
      
      try {
        const res = await fetch(`${API_BASE}/config/ai`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        const data = await res.json();
        if (data.ok) {
          addActivity('Configuraci√≥n de IA guardada', 'success');
          addAILog('info', 'Configuraci√≥n guardada correctamente');
        } else {
          addAILog('error', 'Error guardando: ' + (data.error || 'desconocido'));
        }
      } catch (e) {
        addAILog('error', 'Error de conexi√≥n: ' + e.message);
      }
    }

    async function testAIConnection() {
      const provider = document.getElementById('ai-provider').value;
      const statusDot = document.getElementById('ai-status-dot');
      const statusText = document.getElementById('ai-status-text');
      const latencyEl = document.getElementById('ai-latency');
      
      statusText.textContent = 'Probando...';
      addAILog('info', `Probando conexi√≥n a ${provider}...`);
      
      const startTime = Date.now();
      
      try {
        const res = await fetch(`${API_BASE}/config/ai/test`, { method: 'POST' });
        const data = await res.json();
        const latency = Date.now() - startTime;
        
        latencyEl.textContent = latency;
        
        if (data.ok) {
          statusDot.classList.remove('offline');
          statusText.textContent = 'Conectado';
          addAILog('info', `Conexi√≥n OK (${latency}ms)`);
          addActivity(`IA ${provider} conectada`, 'success');
        } else {
          statusDot.classList.add('offline');
          statusText.textContent = 'Error';
          addAILog('error', data.error || 'Conexi√≥n fallida');
        }
      } catch (e) {
        statusDot.classList.add('offline');
        statusText.textContent = 'Desconectado';
        latencyEl.textContent = '--';
        addAILog('error', 'Error: ' + e.message);
      }
    }

    async function refreshOllamaModels() {
      const listEl = document.getElementById('ollama-models-list');
      listEl.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 0.5rem;">Cargando...</div>';
      
      try {
        const res = await fetch(`${API_BASE}/config/ai/ollama-models`);
        const data = await res.json();
        
        if (data.ok && data.models && data.models.length > 0) {
          const currentModel = document.getElementById('ai-model').value;
          listEl.innerHTML = data.models.map(m => `
            <div class="model-item ${m.name === currentModel ? 'active' : ''}" onclick="selectOllamaModel('${m.name}')">
              <span>ü¶ô ${m.name}</span>
              <span class="model-size">${m.size || ''}</span>
            </div>
          `).join('');
          addAILog('info', `${data.models.length} modelos encontrados`);
        } else {
          listEl.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 0.5rem;">No hay modelos instalados</div>';
        }
      } catch (e) {
        listEl.innerHTML = `<div style="color: var(--accent-red); text-align: center; padding: 0.5rem;">Error: ${e.message}</div>`;
        addAILog('error', 'Error cargando modelos: ' + e.message);
      }
    }

    function selectOllamaModel(modelName) {
      document.getElementById('ai-model').value = modelName;
      document.querySelectorAll('#ollama-models-list .model-item').forEach(el => {
        el.classList.remove('active');
        if (el.textContent.includes(modelName)) {
          el.classList.add('active');
        }
      });
      addAILog('info', `Modelo seleccionado: ${modelName}`);
    }

    async function pullOllamaModel() {
      const modelName = prompt('Nombre del modelo a descargar (ej: llama3.2, mistral, codellama):');
      if (!modelName) return;
      
      addAILog('info', `Descargando modelo: ${modelName}...`);
      addActivity(`Descargando modelo ${modelName}...`, 'info');
      
      try {
        const res = await fetch(`${API_BASE}/config/ai/ollama-pull`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: modelName })
        });
        const data = await res.json();
        if (data.ok) {
          addAILog('info', `Modelo ${modelName} descargado`);
          addActivity(`Modelo ${modelName} instalado`, 'success');
          refreshOllamaModels();
        } else {
          addAILog('error', data.error || 'Error descargando');
        }
      } catch (e) {
        addAILog('error', 'Error: ' + e.message);
      }
    }

    function addAILog(level, message) {
      const logEl = document.getElementById('ai-log-preview');
      if (!logEl) return;
      
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${level}`;
      entry.textContent = `[${time}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      
      // Limitar a 50 entradas
      while (logEl.children.length > 50) {
        logEl.removeChild(logEl.firstChild);
      }
    }

    async function loadGovernanceStatus() {
      try {
        const res = await fetch(`${API_BASE}/governance/status`);
        const data = await res.json();
        if (data.ok) {
          document.getElementById('gov-mode').textContent = (data.mode || 'governed').toUpperCase();
          document.getElementById('gov-approvals').textContent = data.approvals_pending || 0;
          document.getElementById('gov-policies').textContent = data.policies_active || 0;
          document.getElementById('gov-score').textContent = data.security_score || 100;
        }
      } catch (e) {
        console.error('Error loading governance:', e);
      }
    }

    async function loadCameras() {
      try {
        const res = await fetch(`${API_BASE}/vision/cameras`);
        const data = await res.json();
        if (data.ok && data.cameras) {
          document.getElementById('vision-cameras').textContent = data.count || 0;
          // Renderizar lista de c√°maras
          const camerasList = document.getElementById('cameras-list');
          if (camerasList && data.cameras.length > 0) {
            camerasList.innerHTML = data.cameras.map(cam => `
              <div class="module-row" data-cam-id="${cam.id}">
                <div class="module-info">
                  <div class="module-dot"></div>
                  <div class="camera-details">
                    <span class="module-name-text">${getCameraIcon(cam.name)} ${cam.name}</span>
                    <span class="camera-specs">${cam.resolution || '1920x1080'} @ ${cam.fps || 30}fps</span>
                  </div>
                </div>
                <div class="module-actions">
                  <button class="btn-check" onclick="selectCamera(${cam.id}, event)">SELECCIONAR</button>
                  <button class="btn-reconnect" onclick="streamCamera(${cam.id}, event)">üî¥ STREAM</button>
                </div>
              </div>
            `).join('');
          }
        }
      } catch (e) {
        console.error('Error loading cameras:', e);
      }
    }

    async function checkAllModules() {
      addActivity('Verificando todos los m√≥dulos...', 'info');
      try {
        const res = await fetch(`${API_BASE}/modules/check-all`);
        const data = await res.json();
        if (data.ok) {
          // Actualizar MODULES con datos reales
          data.modules.forEach(mod => {
            const idx = MODULES.findIndex(m => m.id === mod.id);
            if (idx >= 0) {
              MODULES[idx].status = mod.status;
            }
          });
          renderModules();
          addActivity(`M√≥dulos verificados: ${data.connected}/${data.total} OK (${data.health}%)`, 'success');
        }
      } catch (e) {
        addActivity('Error verificando m√≥dulos: ' + e.message, 'error');
      }
    }

    async function checkModule(moduleId) {
      addActivity(`Verificando m√≥dulo: ${moduleId}`, 'info');
    }

    async function runDiagnostic() {
      addActivity('Ejecutando diagn√≥stico completo...', 'info');
      try {
        const res = await fetch(`${API_BASE}/doctor`);
        const data = await res.json();
        addActivity('Diagn√≥stico completado', 'success');
      } catch (e) {
        addActivity('Error en diagn√≥stico: ' + e.message, 'error');
      }
    }

    // Chat
    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      const messagesDiv = document.getElementById('chat-messages');
      messagesDiv.innerHTML += `<div class="chat-message user">${escapeHtml(message)}</div>`;
      input.value = '';
      addActivity(`Usuario: ${message.substring(0, 30)}...`, 'info');

      // Mostrar indicador de "pensando"
      const thinkingId = 'thinking-' + Date.now();
      messagesDiv.innerHTML += `<div class="chat-message assistant" id="${thinkingId}" style="opacity: 0.6;">üß† Pensando...</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      try {
        // Enviar al cerebro
        const res = await fetch(`${API_BASE}/brain/process`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: message })
        });
        const data = await res.json();
        
        // Remover indicador de pensando
        const thinkingEl = document.getElementById(thinkingId);
        if (thinkingEl) thinkingEl.remove();
        
        if (data.ok) {
          const response = data.response || data.result || 'Sin respuesta';
          messagesDiv.innerHTML += `<div class="chat-message assistant">${formatResponse(response)}</div>`;
          addActivity('Cerebro respondi√≥', 'success');
        } else {
          messagesDiv.innerHTML += `<div class="chat-message assistant" style="border-color: var(--accent-red);">Error: ${data.error || 'Sin respuesta'}</div>`;
          addActivity('Error del cerebro: ' + (data.error || 'desconocido'), 'error');
        }
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (e) {
        const thinkingEl = document.getElementById(thinkingId);
        if (thinkingEl) thinkingEl.remove();
        messagesDiv.innerHTML += `<div class="chat-message assistant" style="border-color: var(--accent-red);">Error de conexi√≥n: ${e.message}</div>`;
        addActivity('Error: ' + e.message, 'error');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatResponse(response) {
      if (typeof response === 'object') {
        return '<pre style="white-space: pre-wrap; font-size: 0.85rem;">' + JSON.stringify(response, null, 2) + '</pre>';
      }
      return escapeHtml(String(response));
    }

    document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Governance
    async function setGovMode(mode) {
      try {
        const res = await fetch(`${API_BASE}/governance/mode/${mode}`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          document.getElementById('gov-mode').textContent = mode.toUpperCase();
          addActivity(`Modo de gobernanza: ${mode.toUpperCase()}`, 'success');
        } else {
          addActivity(`Error: ${data.error}`, 'error');
        }
      } catch (e) {
        addActivity(`Error: ${e.message}`, 'error');
      }
    }

    async function emergencyStop() {
      if (confirm('‚ö†Ô∏è ¬øConfirmar EMERGENCY STOP?\n\nEsto detendr√° todas las operaciones autom√°ticas.')) {
        try {
          await fetch(`${API_BASE}/governance/mode/emergency`, { method: 'POST' });
          document.getElementById('gov-mode').textContent = 'EMERGENCY';
          document.getElementById('gov-mode').style.color = 'var(--accent-red)';
          addActivity('üö® EMERGENCY STOP ACTIVADO', 'error');
        } catch (e) {
          addActivity(`Error: ${e.message}`, 'error');
        }
      }
    }

    // Vision
    async function captureSnapshot() {
      if (selectedCamera === null) {
        addActivity('Selecciona una c√°mara primero', 'error');
        return;
      }
      addActivity(`Capturando de c√°mara ${selectedCamera}...`, 'info');
      try {
        const res = await fetch(`${API_BASE}/vision/capture/${selectedCamera}`);
        const data = await res.json();
        if (data.ok && data.image_base64) {
          const preview = document.getElementById('vision-preview');
          preview.innerHTML = `<img src="data:image/jpeg;base64,${data.image_base64}" style="max-width: 100%; border-radius: 8px;">`;
          document.getElementById('camera-info').textContent = `C√°mara ${selectedCamera} - ${data.width}x${data.height}`;
          addActivity('Captura exitosa', 'success');
        } else {
          addActivity(`Error: ${data.error || 'No se pudo capturar'}`, 'error');
        }
      } catch (e) {
        addActivity(`Error: ${e.message}`, 'error');
      }
    }

    function captureSnapshotOld() {
      addActivity('Capturando snapshot...', 'info');
    }

    function startStream() {
      addActivity('Iniciando stream...', 'info');
    }

    function detectFaces() {
      addActivity('Detectando rostros...', 'info');
    }

    // Nervous
    function refreshNervous() {
      addActivity('Actualizando sistema nervioso...', 'info');
    }

    function nervousDiagnostic() {
      addActivity('Diagn√≥stico del sistema nervioso...', 'info');
    }
  </script>
</body>
</html>

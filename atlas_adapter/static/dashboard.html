<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ATLAS Dashboard v3.8.0</title>
  <style>
    /* === THEME: Default (Cyan) === */
    :root, [data-theme="cyan"] {
      --bg: #0d1117;
      --bg-card: #161b22;
      --bg-elevated: #21262d;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-cyan: #39d3c4;
      --accent-green: #3fb950;
      --accent-purple: #a371f7;
      --accent-pink: #f778ba;
      --accent-orange: #d29922;
      --accent-red: #f85149;
      --accent-primary: #39d3c4;
    }
    /* === THEME: Purple === */
    [data-theme="purple"] {
      --bg: #0f0a1a;
      --bg-card: #1a1225;
      --bg-elevated: #251a35;
      --border: #3d2a5a;
      --accent-cyan: #a371f7;
      --accent-primary: #a371f7;
    }
    /* === THEME: Green (Matrix) === */
    [data-theme="green"] {
      --bg: #0a1208;
      --bg-card: #0f1a0c;
      --bg-elevated: #162212;
      --border: #2a4020;
      --accent-cyan: #3fb950;
      --accent-primary: #3fb950;
    }
    /* === THEME: Orange === */
    [data-theme="orange"] {
      --bg: #1a1008;
      --bg-card: #221508;
      --bg-elevated: #2d1c0a;
      --border: #4a3010;
      --accent-cyan: #f59e0b;
      --accent-primary: #f59e0b;
    }
    /* === THEME: Pink === */
    [data-theme="pink"] {
      --bg: #1a0a14;
      --bg-card: #22101a;
      --bg-elevated: #2d1522;
      --border: #4a2040;
      --accent-cyan: #f778ba;
      --accent-primary: #f778ba;
    }
    /* === THEME: Blue === */
    [data-theme="blue"] {
      --bg: #0a101a;
      --bg-card: #0f1622;
      --bg-elevated: #152030;
      --border: #203050;
      --accent-cyan: #3b82f6;
      --accent-primary: #3b82f6;
    }
    /* === THEME: Red === */
    [data-theme="red"] {
      --bg: #1a0a0a;
      --bg-card: #221010;
      --bg-elevated: #2d1515;
      --border: #4a2020;
      --accent-cyan: #ef4444;
      --accent-primary: #ef4444;
    }
    /* === THEME: Gold === */
    [data-theme="gold"] {
      --bg: #12100a;
      --bg-card: #1a1608;
      --bg-elevated: #221c0a;
      --border: #3d3010;
      --accent-cyan: #fbbf24;
      --accent-primary: #fbbf24;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex; flex-direction: column;
      min-height: 100vh;
    }

    /* === TOP NAV BAR === */
    .top-nav {
      display: flex;
      align-items: center;
      padding: 0 1rem;
      height: 48px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      gap: 0.5rem;
      position: sticky; top: 0; z-index: 900;
    }
    .hamburger-btn {
      background: none; border: none; color: var(--text); font-size: 1.4rem;
      cursor: pointer; padding: 6px 10px; border-radius: 6px; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .hamburger-btn:hover { background: var(--bg-elevated); color: var(--accent-primary, var(--accent-cyan)); }
    .nav-logo {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }
    .nav-quick {
      display: flex; gap: 4px; margin-left: 8px;
    }
    .nav-quick-btn {
      padding: 5px 12px; background: var(--bg-elevated); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text-muted); font-size: 0.75rem; cursor: pointer;
      font-weight: 600; transition: all 0.2s; text-decoration: none; white-space: nowrap;
    }
    .nav-quick-btn:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }
    .nav-quick-btn.primary { background: var(--accent-cyan); color: var(--bg); border-color: var(--accent-cyan); }
    .nav-quick-btn.primary:hover { filter: brightness(1.15); }
    .nav-spacer { flex: 1; }

    /* === SIDEBAR === */
    .sidebar-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .sidebar-overlay.open { opacity: 1; pointer-events: auto; }
    .sidebar {
      position: fixed; top: 0; left: -280px; width: 280px; height: 100vh;
      background: var(--bg-card); border-right: 1px solid var(--border);
      z-index: 1001; display: flex; flex-direction: column;
      transition: left 0.3s cubic-bezier(0.4,0,0.2,1);
      box-shadow: 4px 0 24px rgba(0,0,0,0.3);
    }
    .sidebar.open { left: 0; }
    .sidebar-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      background: var(--bg-elevated); flex-shrink: 0;
    }
    .sidebar-header-title { font-weight: 700; font-size: 1rem; color: var(--accent-cyan); }
    .sidebar-close {
      background: none; border: none; color: var(--text-muted); font-size: 1.2rem;
      cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.15s;
    }
    .sidebar-close:hover { background: var(--bg-elevated); color: var(--text); }
    .sidebar-nav {
      display: flex; flex-direction: column; gap: 2px; padding: 8px;
      flex: 1; overflow-y: auto;
    }
    .sidebar-tab {
      padding: 10px 16px; background: transparent; border: none; border-radius: 8px;
      color: var(--text-muted); font-size: 0.9rem; cursor: pointer;
      transition: all 0.15s; font-weight: 500; text-align: left;
      display: flex; align-items: center; gap: 10px;
    }
    .sidebar-tab:hover { background: var(--bg-elevated); color: var(--text); }
    .sidebar-tab.active { background: rgba(57,211,196,0.12); color: var(--accent-cyan); font-weight: 700; }
    .sidebar-content { display: none; }

    /* === FULL-PAGE PANELS === */
    .fullpage-panels {
      display: none; flex-direction: column; flex: 1; min-height: 0;
      background: var(--bg);
    }
    .fullpage-panels.active { display: flex; }
    .fullpage-panels .panel-topbar {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 16px; background: var(--bg-card);
      border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .fullpage-panels .btn-back {
      background: var(--bg-elevated); border: 1px solid var(--border); color: var(--accent-cyan);
      padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;
      font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .fullpage-panels .btn-back:hover { background: var(--accent-cyan); color: var(--bg); }
    .fullpage-panels .panel-title-bar {
      font-weight: 700; font-size: 1rem; color: var(--text);
    }
    .fullpage-panels .panel-body {
      flex: 1; overflow-y: auto; padding: 0;
    }
    .fullpage-panels .tab-panel { display: none; height: 100%; overflow-y: auto; }
    .fullpage-panels .tab-panel.active { display: block; }

    /* Keep original tab styles for panel interiors */
    .nav-tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 0.875rem;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-tab:hover { background: var(--bg-elevated); color: var(--text); }
    .nav-tab.active { background: var(--accent-cyan); color: var(--bg); font-weight: 600; }
    
    /* Theme Selector */
    .theme-selector {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--bg-elevated);
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    .theme-btn {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-btn:hover {
      transform: scale(1.2);
    }
    .theme-btn.active {
      border-color: white;
      box-shadow: 0 0 8px currentColor;
    }
    .nav-status {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
    }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
    }
    .status-dot.offline { background: var(--accent-red); }
    .nav-counter {
      background: var(--bg-elevated);
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-weight: 600;
    }
    .nav-time { color: var(--text-muted); }
    .btn-update {
      padding: 0.35rem 0.75rem;
      background: linear-gradient(135deg, #6d28d9, #8b5cf6);
      border: 1px solid #8b5cf6;
      border-radius: 6px;
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-update:hover { filter: brightness(1.2); transform: scale(1.02); }
    .btn-update.checking { animation: pulse 0.8s ease-in-out infinite; }
    @keyframes pulse { 50% { opacity: 0.6; } }
    .version-badge {
      background: var(--accent-purple);
      color: white;
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    /* === MAIN CONTAINER === */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* === STATS BAR === */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }
    .stat-value.warning { color: var(--accent-orange); }
    .stat-value.error { color: var(--accent-red); }
    .stat-value.success { color: var(--accent-green); }
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.25rem;
    }

    /* === HEALTH WIDGET === */
    .health-widget {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .health-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
    }
    .health-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent-cyan);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .health-score-badge {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 1.25rem;
      background: var(--bg-elevated);
      border: 2px solid var(--accent-green);
      border-radius: 999px;
      font-weight: 700;
    }
    .health-score-badge.warning { border-color: var(--accent-orange); }
    .health-score-badge.critical { border-color: var(--accent-red); }
    .health-score-value {
      font-size: 1.5rem;
      color: var(--accent-green);
    }
    .health-score-badge.warning .health-score-value { color: var(--accent-orange); }
    .health-score-badge.critical .health-score-value { color: var(--accent-red); }
    .health-score-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .health-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
    }
    .health-metric {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      transition: all 0.2s;
    }
    .health-metric:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-2px);
    }
    .health-metric-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .health-metric-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
    }
    .health-metric-value.ok { color: var(--accent-green); }
    .health-metric-value.warning { color: var(--accent-orange); }
    .health-metric-value.error { color: var(--accent-red); }
    .health-status-icon {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-green);
      box-shadow: 0 0 8px var(--accent-green);
      animation: pulse-glow 2s infinite;
    }
    .health-status-icon.warning {
      background: var(--accent-orange);
      box-shadow: 0 0 8px var(--accent-orange);
    }
    .health-status-icon.critical {
      background: var(--accent-red);
      box-shadow: 0 0 8px var(--accent-red);
    }
    @keyframes pulse-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* === MODULE MODAL === */
    .module-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s ease;
    }
    .module-modal-overlay.active {
      display: flex;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .module-modal {
      background: var(--bg-card);
      border: 2px solid var(--accent-cyan);
      border-radius: 16px;
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .module-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--bg-elevated), var(--bg-card));
      border-bottom: 2px solid var(--accent-cyan);
    }
    .module-modal-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }
    .module-modal-title-icon {
      font-size: 2rem;
    }
    .module-modal-close {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-muted);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .module-modal-close:hover {
      background: var(--accent-red);
      color: white;
      border-color: var(--accent-red);
    }
    .module-modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }
    .module-modal-section {
      margin-bottom: 1.5rem;
    }
    .module-modal-section-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--accent-cyan);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    .module-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .module-stat-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem;
      text-align: center;
    }
    .module-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }
    .module-stat-value.success { color: var(--accent-green); }
    .module-stat-value.warning { color: var(--accent-orange); }
    .module-stat-value.error { color: var(--accent-red); }
    .module-stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-top: 0.25rem;
    }
    .module-item-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .module-item {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }
    .module-item:hover {
      border-color: var(--accent-cyan);
      transform: translateX(4px);
    }
    .module-item-info {
      flex: 1;
    }
    .module-item-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
    }
    .module-item-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .module-item-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .module-item-badge.active {
      background: var(--accent-green);
      color: var(--bg);
    }
    .module-item-badge.inactive {
      background: var(--accent-red);
      color: white;
    }
    .module-item-badge.pending {
      background: var(--accent-orange);
      color: var(--bg);
    }
    .module-empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* === ACTION BAR === */
    .action-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--accent-cyan); color: var(--bg); }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-secondary { background: var(--accent-purple); color: white; }
    .btn-secondary:hover { filter: brightness(1.1); }

    /* === MODULES LIST (Sistema Nervioso Style) === */
    .modules-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .modules-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .modules-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-cyan);
      border-left: 3px solid var(--accent-cyan);
      padding-left: 0.75rem;
    }
    .status-badge {
      background: var(--accent-green);
      color: var(--bg);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .status-badge::before {
      content: '';
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }
    .diagnostic-btn {
      width: 100%;
      padding: 0.75rem;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
      border: none;
      border-radius: 8px;
      color: var(--bg);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      margin-bottom: 1rem;
      transition: all 0.2s;
    }
    .diagnostic-btn:hover { filter: brightness(1.1); }
    .modules-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    /* Modules Grid Style */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }
    .module-tile {
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .module-tile:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .module-tile.connected {
      border-color: var(--accent-green);
    }
    .module-tile.connected::after {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 10px;
      height: 10px;
      background: var(--accent-green);
      border-radius: 50%;
      box-shadow: 0 0 8px var(--accent-green);
    }
    .module-tile.error {
      border-color: var(--accent-red);
    }
    .module-tile.error::after {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 10px;
      height: 10px;
      background: var(--accent-red);
      border-radius: 50%;
      animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .module-emoji {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    .module-tile-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      text-transform: capitalize;
    }
    .module-tile-status {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }
    .module-tile.connected .module-tile-status {
      color: var(--accent-green);
    }
    .module-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--bg-elevated);
      border-radius: 8px;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }
    .module-row:hover { border-color: var(--accent-cyan); }
    .module-row.selected {
      border-color: var(--accent-green);
      background: rgba(16, 185, 129, 0.1);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }
    .module-row.selected .module-dot {
      background: var(--accent-green);
      box-shadow: 0 0 8px var(--accent-green);
    }
    .module-row.streaming {
      border-color: var(--accent-red);
      background: rgba(239, 68, 68, 0.1);
    }
    .module-row.streaming::after {
      content: 'ðŸ”´ LIVE';
      font-size: 0.65rem;
      color: var(--accent-red);
      margin-left: 0.5rem;
    }
    .camera-details {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .camera-specs {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-family: monospace;
    }
    .module-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .module-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-green);
    }
    .module-dot.error { background: var(--accent-red); }
    .module-dot.warning { background: var(--accent-orange); }
    .module-name-text { font-weight: 500; }
    .module-actions {
      display: flex;
      gap: 0.5rem;
    }
    .btn-check {
      padding: 0.35rem 0.75rem;
      background: var(--accent-cyan);
      color: var(--bg);
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-reconnect {
      padding: 0.35rem 0.75rem;
      background: var(--accent-orange);
      color: var(--bg);
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* === MODULES GRID (Icon view) === */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .module-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: all 0.2s;
      cursor: pointer;
    }
    .module-card:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-2px);
    }
    .module-card.connected { border-color: var(--accent-green); }
    .module-card.error { border-color: var(--accent-red); }
    .module-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    .module-name {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .module-status {
      font-size: 0.7rem;
      color: var(--accent-green);
    }
    .module-status.error { color: var(--accent-red); }

    /* === TAB PANELS === */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* === ACTIVITY LOG === */
    .activity-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
    }
    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .activity-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--accent-cyan);
      text-transform: uppercase;
    }
    .activity-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .activity-item {
      padding: 0.75rem;
      border-left: 3px solid var(--accent-cyan);
      background: var(--bg-elevated);
      margin-bottom: 0.5rem;
      border-radius: 0 6px 6px 0;
    }
    .activity-item.error { border-left-color: var(--accent-red); }
    .activity-item.success { border-left-color: var(--accent-green); }
    .activity-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }
    .activity-message { font-size: 0.85rem; }

    /* === CHAT PANEL === */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 250px);
      min-height: 400px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px 8px 0 0;
    }
    .chat-input-area {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 8px 8px;
    }
    .chat-input {
      flex: 1;
      padding: 0.75rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
    }
    .chat-input:focus { outline: none; border-color: var(--accent-cyan); }
    .chat-message {
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      max-width: 80%;
    }
    .chat-message.user {
      background: var(--accent-cyan);
      color: var(--bg);
      margin-left: auto;
    }
    .chat-message.assistant {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
    }

    /* === CONFIG PANEL === */
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    .config-grid-full {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }
    @media (max-width: 1400px) {
      .config-grid-full { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 900px) {
      .config-grid-full { grid-template-columns: 1fr; }
    }
    .config-status-bar {
      display: flex;
      align-items: center;
      gap: 2rem;
      padding: 0.75rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .config-status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }
    .config-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
    }
    .config-title {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--accent-purple);
    }
    .config-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      gap: 1rem;
    }
    .config-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .config-select {
      padding: 0.35rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
      min-width: 150px;
    }
    .config-select:focus {
      border-color: var(--accent-cyan);
      outline: none;
    }
    .config-select-mini {
      padding: 0.25rem 0.4rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.7rem;
      min-width: 100px;
    }
    .config-input {
      padding: 0.35rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
      width: 100%;
    }
    .config-input:focus {
      border-color: var(--accent-cyan);
      outline: none;
    }
    .config-slider {
      width: 100%;
      -webkit-appearance: none;
      height: 6px;
      background: var(--bg-elevated);
      border-radius: 3px;
      margin: 0.5rem 0;
    }
    .config-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--accent-cyan);
      border-radius: 50%;
      cursor: pointer;
    }
    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      color: var(--text-muted);
    }
    .config-textarea {
      width: 100%;
      padding: 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }
    .config-textarea:focus {
      border-color: var(--accent-cyan);
      outline: none;
    }
    .specialist-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .specialist-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem;
      background: var(--bg-elevated);
      border-radius: 4px;
    }
    .specialist-item input[type="checkbox"] {
      accent-color: var(--accent-cyan);
    }
    .specialist-item label {
      flex: 1;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .models-list {
      max-height: 200px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .model-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.4rem 0.6rem;
      background: var(--bg-elevated);
      border-radius: 4px;
      font-size: 0.8rem;
    }
    .model-item.active {
      border: 1px solid var(--accent-green);
      background: rgba(16, 185, 129, 0.1);
    }
    .model-size {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .ai-log-preview {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.5rem;
      max-height: 120px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.7rem;
    }
    .log-entry {
      padding: 0.15rem 0;
      border-bottom: 1px solid var(--border);
    }
    .log-entry:last-child { border-bottom: none; }
    .log-info { color: var(--accent-cyan); }
    .log-warn { color: var(--accent-orange); }
    .log-error { color: var(--accent-red); }
    .log-debug { color: var(--text-muted); }
    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .config-item:last-child { border-bottom: none; }
    .config-label { font-size: 0.85rem; }
    .config-select {
      padding: 0.35rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
    }

    /* version-footer (legacy, replaced by .main-footer) */
    .version-footer {
      display: none;
    }
    .version-footer span { color: var(--accent-cyan); }

    /* === NERVOUS SYSTEM PANEL === */
    .nervous-diagram {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .nervous-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
    }
    .nervous-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-cyan);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    .nervous-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
    }
    .nervous-node {
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .nervous-node:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    .nervous-node.connected {
      border-color: var(--accent-green);
    }
    .nervous-node.connected::before {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      box-shadow: 0 0 6px var(--accent-green);
    }
    .nervous-node.error {
      border-color: var(--accent-red);
    }
    .nervous-node.error::before {
      background: var(--accent-red);
      box-shadow: 0 0 6px var(--accent-red);
      animation: pulse-red 1s infinite;
    }
    .nervous-node.active {
      border-color: var(--accent-cyan);
      background: rgba(57, 211, 196, 0.1);
      box-shadow: 0 0 15px rgba(57, 211, 196, 0.3);
    }
    .nervous-node-icon {
      font-size: 2rem;
      display: block;
      margin-bottom: 0.5rem;
    }
    .nervous-node-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      display: block;
    }
    .nervous-node-desc {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: block;
      margin-top: 0.25rem;
    }
    
    /* Mini modules inside nodes */
    .node-modules {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
      justify-content: center;
    }
    .mini-module {
      font-size: 0.6rem;
      padding: 2px 6px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .mini-module.active {
      background: var(--accent-cyan);
      color: var(--bg);
      border-color: var(--accent-cyan);
    }
    .mini-module.error {
      background: var(--accent-red);
      color: white;
      border-color: var(--accent-red);
    }
    .cognitive-signal {
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan));
    }
    
    /* Signals Monitor */
    .nervous-signals-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      margin-top: 1.5rem;
    }
    .signals-monitor {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .signal-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .signal-name {
      min-width: 180px;
      font-size: 0.85rem;
      color: var(--text);
    }
    .signal-bar {
      flex: 1;
      height: 12px;
      background: var(--bg-elevated);
      border-radius: 6px;
      overflow: hidden;
    }
    .signal-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
      border-radius: 6px;
      transition: width 0.5s ease;
    }
    .signal-fill.warning {
      background: linear-gradient(90deg, var(--accent-orange), var(--accent-red));
    }
    .signal-value {
      min-width: 50px;
      text-align: right;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent-cyan);
    }
    
    /* Nervous Log */
    .nervous-log {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
    }
    .nervous-log-list {
      max-height: 150px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.8rem;
    }
    .nervous-log-entry {
      padding: 0.35rem 0.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 1rem;
    }
    .nervous-log-entry:last-child { border-bottom: none; }
    .nervous-log-entry .log-time {
      color: var(--text-muted);
      min-width: 70px;
    }
    .nervous-log-entry .log-msg {
      color: var(--text);
    }
    .nervous-log-entry.error .log-msg { color: var(--accent-red); }
    .nervous-log-entry.success .log-msg { color: var(--accent-green); }
    .nervous-log-entry.warning .log-msg { color: var(--accent-orange); }

    /* === BITACORA CENTRAL (MAIN CONTENT) === */
    .bitacora-main {
      display: flex; flex-direction: column;
      flex: 1; min-height: 0;
      background: var(--bg);
    }
    .bitacora-header {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .bitacora-title {
      font-weight: 700; font-size: 1.1rem; color: var(--accent-cyan);
      display: flex; align-items: center; gap: 8px;
    }
    .bitacora-title .live-dot {
      width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green);
      animation: livePulse 1.5s infinite;
    }
    @keyframes livePulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(63,185,80,0.4)} 50%{opacity:0.7;box-shadow:0 0 8px 2px rgba(63,185,80,0.2)} }
    .bitacora-controls {
      display: flex; gap: 4px; margin-left: auto;
    }
    .bitacora-btn {
      background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-muted);
      font-size: 0.75rem; cursor: pointer; padding: 4px 10px; border-radius: 4px;
      transition: all 0.2s; font-weight: 500;
    }
    .bitacora-btn:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }
    .bitacora-filters {
      display: flex; gap: 4px; padding: 8px 20px;
      border-bottom: 1px solid var(--border); flex-wrap: wrap;
      background: var(--bg-card); flex-shrink: 0;
    }
    .bitacora-filter {
      padding: 4px 12px; background: var(--bg-elevated); border: 1px solid var(--border);
      border-radius: 6px; font-size: 0.75rem; cursor: pointer; color: var(--text-muted);
      transition: all 0.2s; font-weight: 500;
    }
    .bitacora-filter:hover, .bitacora-filter.active {
      border-color: var(--accent-cyan); color: var(--accent-cyan); background: rgba(57,211,196,0.06);
    }
    .bitacora-content {
      flex: 1; overflow-y: auto; padding: 8px 16px; min-height: 200px;
    }
    .bitacora-entry {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 10px 14px; border-radius: 6px; margin-bottom: 4px;
      font-size: 0.85rem; background: var(--bg-card);
      border-left: 3px solid var(--accent-cyan);
      animation: slideIn 0.2s ease; transition: background 0.15s;
    }
    .bitacora-entry:hover { background: var(--bg-elevated); }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .bitacora-entry.success { border-left-color: var(--accent-green); }
    .bitacora-entry.error { border-left-color: var(--accent-red); }
    .bitacora-entry.warning { border-left-color: var(--accent-orange); }
    .bitacora-entry.brain { border-left-color: var(--accent-purple); }
    .bitacora-entry.vision { border-left-color: var(--accent-pink); }
    .bitacora-entry.nervous { border-left-color: var(--accent-orange); }
    .bitacora-entry.approved {
      border-left-color: var(--accent-green); background: rgba(63,185,80,0.08);
    }
    .bitacora-entry.approved .entry-status { display: inline-block; }
    .bitacora-entry.rejected {
      border-left-color: var(--accent-red); background: rgba(248,81,73,0.06); opacity: 0.65;
    }
    .bitacora-entry.rejected .entry-status { display: inline-block; }
    .bitacora-time {
      color: var(--text-muted); font-size: 0.75rem; min-width: 65px;
      font-family: 'Consolas','Monaco',monospace; padding-top: 1px;
      font-variant-numeric: tabular-nums;
    }
    .bitacora-source { font-size: 0.85rem; min-width: 22px; flex-shrink: 0; }
    .bitacora-msg { flex: 1; color: var(--text); word-break: break-word; line-height: 1.4; }
    .entry-status {
      display: none; font-size: 0.7rem; font-weight: 700; padding: 2px 8px;
      border-radius: 4px; margin-left: 6px; vertical-align: middle;
    }
    .entry-status.st-approved { background: var(--accent-green); color: var(--bg); }
    .entry-status.st-rejected { background: var(--accent-red); color: white; }
    .bitacora-entry.needs-approval {
      border-left-color: var(--accent-orange); border-left-width: 4px;
      background: rgba(245,158,11,0.06);
    }
    .bitacora-entry.telegram { border-left-color: #2AABEE; }
    .bitacora-entry.whatsapp { border-left-color: #25D366; }
    .entry-actions {
      display: flex; gap: 4px; flex-shrink: 0; margin-left: auto;
    }
    .entry-actions button {
      background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-muted);
      padding: 4px 10px; border-radius: 6px; cursor: pointer;
      font-size: 0.75rem; transition: all 0.15s; font-weight: 600;
      white-space: nowrap;
    }
    .entry-actions .btn-approve { border-color: rgba(63,185,80,0.4); color: var(--accent-green); }
    .entry-actions .btn-approve:hover { background: var(--accent-green); color: var(--bg); border-color: var(--accent-green); transform: scale(1.05); }
    .entry-actions .btn-reject { border-color: rgba(248,81,73,0.4); color: var(--accent-red); }
    .entry-actions .btn-reject:hover { background: var(--accent-red); color: white; border-color: var(--accent-red); transform: scale(1.05); }
    .bitacora-stats {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 20px; font-size: 0.75rem; color: var(--text-muted);
      border-top: 1px solid var(--border); background: var(--bg-card);
      flex-shrink: 0;
    }
    /* === UNIFIED FOOTER === */
    .main-footer {
      display: flex; align-items: center; justify-content: center;
      height: 32px; padding: 0 16px;
      background: var(--bg-card); border-top: 1px solid var(--border);
      font-size: 0.7rem; color: var(--text-muted);
      position: sticky; bottom: 0; z-index: 800;
    }
    .main-footer span { color: var(--accent-cyan); font-weight: 600; }

    @media (max-width: 768px) {
      .sidebar { width: 85vw; left: -85vw; }
      .nav-quick-btn span.label { display: none; }
      .fullpage-panels .panel-topbar { padding: 6px 10px; }
    }
  </style>
</head>
<body>
  <!-- TOP NAVIGATION (Compact) -->
  <nav class="top-nav">
    <button class="hamburger-btn" onclick="toggleSidebar()" title="Menu">&#9776;</button>
    <div class="nav-logo">ATLAS</div>
    <div class="nav-quick">
      <button class="nav-quick-btn primary" onclick="window.location.href='/workspace'" title="ATLAS Agent Workspace">&#9889; Workspace</button>
      <button class="nav-quick-btn" onclick="window.open('/nexus','_blank')" title="Panel de Control ATLAS">&#127760; Panel</button>
      <button class="nav-quick-btn" onclick="window.open('http://'+location.hostname+':8002/dashboard','_blank')" title="ATLAS Robot 3D (puerto 8002)">&#129302; Robot</button>
    </div>
    <div class="nav-spacer"></div>
    <div class="nav-status">
      <div class="theme-selector">
        <button class="theme-btn" data-theme="cyan" title="Cyan" style="background:#39d3c4;"></button>
        <button class="theme-btn" data-theme="purple" title="Purple" style="background:#a371f7;"></button>
        <button class="theme-btn" data-theme="green" title="Matrix" style="background:#3fb950;"></button>
        <button class="theme-btn" data-theme="blue" title="Blue" style="background:#3b82f6;"></button>
        <button class="theme-btn" data-theme="orange" title="Orange" style="background:#f59e0b;"></button>
        <button class="theme-btn" data-theme="pink" title="Pink" style="background:#f778ba;"></button>
        <button class="theme-btn" data-theme="red" title="Red" style="background:#ef4444;"></button>
        <button class="theme-btn" data-theme="gold" title="Gold" style="background:#fbbf24;"></button>
      </div>
      <button class="btn-update" id="btn-check-update" onclick="checkForUpdates()" title="Buscar actualizaciones">&#128260;</button>
      <div class="version-badge" id="version-badge">v3.8.0</div>
      <div class="atlas-mini-robot" id="mini-robot" onclick="window.open('http://'+location.hostname+':8002/dashboard','_blank')" title="Robot 3D" style="cursor:pointer;position:relative;width:28px;height:40px;margin:0 2px;">
        <svg viewBox="0 0 36 52" width="28" height="40" style="display:block;">
          <line x1="18" y1="3" x2="18" y2="8" stroke="var(--accent-cyan)" stroke-width="1" opacity="0.5"/>
          <circle cx="18" cy="3" r="1.5" fill="var(--accent-cyan)" id="mr-comm" opacity="0.8"/>
          <circle cx="18" cy="12" r="5" fill="none" stroke="var(--accent-cyan)" stroke-width="0.7" opacity="0.3"/>
          <circle cx="18" cy="12" r="3" id="mr-ai" fill="var(--accent-cyan)" opacity="0.7"/>
          <circle cx="15.5" cy="11" r="1.2" id="mr-cam" fill="var(--accent-cyan)" opacity="0.8"/>
          <circle cx="20.5" cy="11" r="1.2" id="mr-vis" fill="var(--accent-cyan)" opacity="0.8"/>
          <rect x="12" y="18" width="12" height="14" rx="2" fill="none" stroke="var(--accent-cyan)" stroke-width="0.7" opacity="0.3"/>
          <circle cx="18" cy="22" r="2.5" id="mr-yolo" fill="var(--accent-orange)" opacity="0.6"/>
          <circle cx="18" cy="28" r="1.5" id="mr-ctrl" fill="var(--accent-green)" opacity="0.6"/>
        </svg>
        <style>
          .atlas-mini-robot:hover svg circle,.atlas-mini-robot:hover svg rect{filter:drop-shadow(0 0 3px var(--accent-cyan))}
          @keyframes mr-pulse{0%,100%{opacity:0.7}50%{opacity:0.3}}
          #mr-ai{animation:mr-pulse 2s infinite}
          #mr-yolo{animation:mr-pulse 2.5s infinite}
        </style>
      </div>
      <div class="status-indicator">
        <div class="status-dot" id="cerebro-dot"></div>
        <span>Cerebro</span>
      </div>
      <div class="nav-counter" id="modules-counter">0/15</div>
      <button id="tts-toggle" onclick="toggleAtlasTTS()" title="ATLAS habla (click para silenciar)" style="background:none;border:1px solid var(--border);color:var(--text);font-size:1.1rem;cursor:pointer;padding:2px 8px;border-radius:6px;transition:all 0.2s;">&#128266;</button>
      <div class="nav-time" id="current-time">00:00:00</div>
    </div>
  </nav>

  <!-- SIDEBAR (Menu Hamburguesa) -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-header-title">&#9881; Menu ATLAS</span>
      <button class="sidebar-close" onclick="toggleSidebar()">&#10005;</button>
    </div>
    <div class="sidebar-nav">
      <button class="sidebar-tab" data-tab="chat">&#128172; Chat</button>
      <button class="sidebar-tab" data-tab="modulos">&#128230; Modulos</button>
      <button class="sidebar-tab" data-tab="gobernanza">&#128737; Gobernanza &amp; AutonomÃ­a</button>
      <button class="sidebar-tab" data-tab="config">&#129302; Config IA</button>
      <button class="sidebar-tab" data-tab="vision">&#128065; Vision</button>
      <button class="sidebar-tab" data-tab="nervioso">&#128279; Nervioso</button>
      <button class="sidebar-tab" data-tab="comms">&#128241; Comms</button>
      <button class="sidebar-tab" data-tab="tutorias">&#128203; Tutorias</button>
    </div>
    <div class="sidebar-content" id="sidebar-content"></div>
  </aside>

  <!-- FULL-PAGE PANEL AREA (oculto por defecto, aparece al seleccionar menu) -->
  <div class="fullpage-panels" id="fullpage-panels">
    <div class="panel-topbar">
      <button class="btn-back" onclick="backToBitacora()">&#8592; Bitacora</button>
      <span class="panel-title-bar" id="panel-title-bar"></span>
    </div>
    
    <!-- Module Detail Modal -->
    <div class="module-modal-overlay" id="module-modal-overlay" onclick="closeModuleModal(event)">
      <div class="module-modal" onclick="event.stopPropagation()">
        <div class="module-modal-header">
          <div class="module-modal-title">
            <span class="module-modal-title-icon" id="modal-icon">ðŸ”§</span>
            <span id="modal-title">MÃ³dulo</span>
          </div>
          <button class="module-modal-close" onclick="closeModuleModal()">âœ•</button>
        </div>
        <div class="module-modal-body" id="modal-body">
          <!-- Contenido dinÃ¡mico -->
        </div>
      </div>
    </div>
    
    <div class="panel-body" id="panel-body">
    <!-- ========== TAB: CHAT ========== -->
    <div class="tab-panel" id="panel-chat">
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="chat-message assistant">
            Hola, soy ATLAS. Estoy conectado al Brain Coordinator y listo para ayudarte. Puedes escribir comandos como /status, /help o simplemente hablarme.
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="chat-input" placeholder="Escribe un mensaje o comando..." />
          <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
        </div>
      </div>
      <div class="activity-section">
        <div class="activity-header">
          <span class="activity-title">ACTIVIDAD</span>
          <button class="btn btn-secondary" onclick="clearActivity()">Limpiar</button>
        </div>
        <div class="activity-list" id="activity-list"></div>
      </div>
    </div>

    <!-- ========== TAB: MODULOS ========== -->
    <div class="tab-panel" id="panel-modulos">
      <!-- Header con badge operativo -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: 600;">ATLAS Sistema Nervioso</h2>
        <div class="status-badge" id="system-status-badge">100% OPERATIVO</div>
      </div>

      <!-- MÃ³dulos del Cuerpo -->
      <div class="modules-section">
        <div class="modules-header">
          <span class="modules-title">MODULOS DEL CUERPO</span>
          <button class="diagnostic-btn" onclick="runFullDiagnostic()" style="margin: 0;">ðŸ”¬ DIAGNÃ“STICO</button>
        </div>
        <div class="modules-grid" id="modules-grid">
          <!-- Se llena dinÃ¡micamente -->
        </div>
      </div>

      <!-- Health Widget -->
      <div class="health-widget" id="health-widget">
        <div class="health-header">
          <div class="health-title">
            <span>ðŸ¥</span>
            <span>SALUD DEL SISTEMA</span>
          </div>
          <div class="health-score-badge" id="health-score-badge">
            <div class="health-status-icon" id="health-status-icon"></div>
            <div>
              <div class="health-score-value" id="health-score-value">--</div>
              <div class="health-score-label">Score</div>
            </div>
          </div>
        </div>
        <div class="health-metrics" id="health-metrics">
          <div class="health-metric">
            <div class="health-metric-label">Servicios</div>
            <div class="health-metric-value" id="health-services">--</div>
          </div>
          <div class="health-metric">
            <div class="health-metric-label">Memoria</div>
            <div class="health-metric-value" id="health-memory">--</div>
          </div>
          <div class="health-metric">
            <div class="health-metric-label">ANS Ciclos</div>
            <div class="health-metric-value" id="health-ans">--</div>
          </div>
          <div class="health-metric">
            <div class="health-metric-label">Uptime</div>
            <div class="health-metric-value" id="health-uptime">--</div>
          </div>
          <div class="health-metric">
            <div class="health-metric-label">Lifelog</div>
            <div class="health-metric-value" id="health-lifelog">--</div>
          </div>
          <div class="health-metric">
            <div class="health-metric-label">Incidentes</div>
            <div class="health-metric-value" id="health-incidents">--</div>
          </div>
        </div>
      </div>

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value success" id="stat-connected">15</div>
          <div class="stat-label">CONECTADOS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total">15</div>
          <div class="stat-label">TOTAL</div>
        </div>
        <div class="stat-card">
          <div class="stat-value success" id="stat-health">100%</div>
          <div class="stat-label">SALUD</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-signals">0</div>
          <div class="stat-label">SEÃ‘ALES</div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-primary" onclick="checkAllModules()">Check All</button>
        <button class="btn btn-secondary" onclick="runDiagnostic()">DiagnÃ³stico</button>
      </div>

      <div class="modules-grid" id="modules-grid"></div>

      <div class="activity-section">
        <div class="activity-header">
          <span class="activity-title">ACTIVIDAD</span>
          <button class="btn btn-secondary" onclick="clearActivity()">Limpiar</button>
        </div>
        <div class="activity-list" id="modules-activity-list"></div>
      </div>
    </div>

    <!-- ========== TAB: GOBERNANZA ========== -->
    <div class="tab-panel" id="panel-gobernanza">
      <!-- ===== GOBERNANZA: Controles ===== -->
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;padding:8px 16px;border-radius:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);">
          <span style="font-size:11px;opacity:.6;text-transform:uppercase;">Modo</span>
          <span id="gov-mode" style="font-weight:700;font-size:15px;color:var(--accent-green);">GOVERNED</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;padding:8px 16px;border-radius:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);">
          <span style="font-size:11px;opacity:.6;text-transform:uppercase;">Aprobaciones</span>
          <span id="gov-approvals" style="font-weight:700;font-size:15px;">0</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;padding:8px 16px;border-radius:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);">
          <span style="font-size:11px;opacity:.6;text-transform:uppercase;">PolÃ­ticas</span>
          <span id="gov-policies" style="font-weight:700;font-size:15px;">5</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;padding:8px 16px;border-radius:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);">
          <span style="font-size:11px;opacity:.6;text-transform:uppercase;">Seguridad</span>
          <span id="gov-score" style="font-weight:700;font-size:15px;color:var(--accent-green);">100</span>
        </div>
        <div style="display:flex;gap:6px;margin-left:auto;">
          <button class="btn btn-primary" onclick="setGovMode('growth')" style="font-size:11px;padding:6px 14px;">GROWTH</button>
          <button class="btn btn-secondary" onclick="setGovMode('governed')" style="font-size:11px;padding:6px 14px;">GOVERNED</button>
          <button class="btn" style="background:var(--accent-red);color:white;font-size:11px;padding:6px 14px;" onclick="emergencyStop()">EMERGENCY STOP</button>
        </div>
      </div>

      <!-- ===== AUTONOMÃA: Gauge + KPIs ===== -->
      <div style="display:grid;grid-template-columns:200px 1fr;gap:16px;margin-bottom:16px;">
        <!-- Gauge circular -->
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;border-radius:14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);">
          <div style="position:relative;width:140px;height:140px;">
            <svg viewBox="0 0 140 140" style="width:140px;height:140px;transform:rotate(-90deg);">
              <circle cx="70" cy="70" r="60" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="10"/>
              <circle id="auto-gauge-ring" cx="70" cy="70" r="60" fill="none" stroke="var(--accent-green)" stroke-width="10"
                stroke-dasharray="377" stroke-dashoffset="377" stroke-linecap="round" style="transition:stroke-dashoffset 1s ease,stroke .3s;"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span id="auto-gauge-pct" style="font-size:32px;font-weight:800;letter-spacing:-1px;">0%</span>
              <span style="font-size:10px;opacity:.5;text-transform:uppercase;">AutonomÃ­a</span>
            </div>
          </div>
          <span id="auto-gauge-label" style="margin-top:8px;font-size:11px;opacity:.6;">Calculando...</span>
        </div>

        <!-- KPIs grid -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
          <div class="stat-card" style="padding:12px;">
            <div class="stat-value" id="auto-kpi-uptime" style="font-size:18px;">0h</div>
            <div class="stat-label" style="font-size:10px;">UPTIME</div>
          </div>
          <div class="stat-card" style="padding:12px;">
            <div class="stat-value" id="auto-kpi-success" style="font-size:18px;">0%</div>
            <div class="stat-label" style="font-size:10px;">TASA Ã‰XITO</div>
          </div>
          <div class="stat-card" style="padding:12px;">
            <div class="stat-value" id="auto-kpi-modules" style="font-size:18px;">0/0</div>
            <div class="stat-label" style="font-size:10px;">MÃ“DULOS</div>
          </div>
          <div class="stat-card" style="padding:12px;">
            <div class="stat-value" id="auto-kpi-ai" style="font-size:18px;">0/0</div>
            <div class="stat-label" style="font-size:10px;">MODELOS IA</div>
          </div>
          <div class="stat-card" style="padding:12px;">
            <div class="stat-value" id="auto-kpi-incidents" style="font-size:18px;">0</div>
            <div class="stat-label" style="font-size:10px;">INCIDENTES RESUELTOS</div>
          </div>
          <div class="stat-card" style="padding:12px;">
            <div class="stat-value" id="auto-kpi-mttr" style="font-size:18px;">0m</div>
            <div class="stat-label" style="font-size:10px;">MTTR</div>
          </div>
          <div class="stat-card" style="padding:12px;">
            <div class="stat-value" id="auto-kpi-rules" style="font-size:18px;">0</div>
            <div class="stat-label" style="font-size:10px;">REGLAS APRENDIDAS</div>
          </div>
          <div class="stat-card" style="padding:12px;">
            <div class="stat-value" id="auto-kpi-alerts" style="font-size:18px;">0</div>
            <div class="stat-label" style="font-size:10px;">ALERTAS ACTIVAS</div>
          </div>
        </div>
      </div>

      <!-- ===== SUBSISTEMAS ===== -->
      <div style="margin-bottom:16px;">
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;opacity:.5;margin-bottom:8px;">Subsistemas AutÃ³nomos</div>
        <div id="auto-subsystems" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;">
          <div style="padding:10px 14px;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);font-size:12px;opacity:.4;">Cargando subsistemas...</div>
        </div>
      </div>

      <!-- ===== TAREAS + TIMELINE ===== -->
      <div style="display:grid;grid-template-columns:1fr 320px;gap:16px;">
        <!-- Tareas de seguimiento -->
        <div>
          <div style="font-size:12px;font-weight:700;text-transform:uppercase;opacity:.5;margin-bottom:8px;">Tareas de Seguimiento</div>
          <div id="auto-tasks" style="display:flex;flex-direction:column;gap:6px;max-height:280px;overflow-y:auto;padding-right:4px;">
            <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.03);font-size:12px;opacity:.4;">Sin tareas pendientes</div>
          </div>
        </div>
        <!-- Timeline -->
        <div>
          <div style="font-size:12px;font-weight:700;text-transform:uppercase;opacity:.5;margin-bottom:8px;">Timeline Reciente</div>
          <div id="auto-timeline" style="display:flex;flex-direction:column;gap:4px;max-height:280px;overflow-y:auto;padding-right:4px;">
            <div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);font-size:11px;opacity:.4;">Sin eventos</div>
          </div>
        </div>
      </div>

      <!-- ===== ALERTAS ===== -->
      <div id="auto-alerts" style="margin-top:12px;display:none;">
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;opacity:.5;margin-bottom:8px;">Alertas Activas</div>
        <div id="auto-alerts-list" style="display:flex;flex-direction:column;gap:4px;"></div>
      </div>
    </div>

    <!-- ========== TAB: CONFIG IA ========== -->
    <div class="tab-panel" id="panel-config">
      <!-- Estado de conexiÃ³n -->
      <div class="config-status-bar">
        <div class="config-status-item">
          <span class="status-dot" id="ai-status-dot"></span>
          <span id="ai-status-text">Conectando...</span>
        </div>
        <div class="config-status-item">
          <span style="color: var(--text-muted);">Latencia:</span>
          <span id="ai-latency">--</span>ms
        </div>
        <div class="config-status-item">
          <span style="color: var(--text-muted);">Tokens usados hoy:</span>
          <span id="ai-tokens-used">0</span>
        </div>
        <button class="btn btn-primary" onclick="testAIConnection()" style="margin-left: auto;">ðŸ”Œ Test ConexiÃ³n</button>
        <button class="btn btn-secondary" onclick="saveAIConfig()">ðŸ’¾ Guardar Config</button>
      </div>

      <div class="config-grid-full">
        <!-- Columna 1: Proveedor y Modelo -->
        <div class="config-card">
          <div class="config-title">ðŸ§  Proveedor de IA</div>
          <div class="config-item">
            <span class="config-label">Modo de OperaciÃ³n</span>
            <select class="config-select" id="ai-mode" onchange="onAIModeChange()">
              <option value="auto">ðŸ¤– AutomÃ¡tico (Cerebro decide)</option>
              <option value="local">ðŸ’» Solo Local (Ollama)</option>
              <option value="cloud">â˜ï¸ Solo Cloud (API)</option>
              <option value="hybrid">ðŸ”„ HÃ­brido (Local + Fallback Cloud)</option>
            </select>
          </div>
          <div class="config-item">
            <span class="config-label">Proveedor Principal</span>
            <select class="config-select" id="ai-provider" onchange="onProviderChange()">
              <option value="ollama">ðŸ¦™ Ollama (Local)</option>
              <option value="deepseek">ðŸ”® DeepSeek</option>
              <option value="openai">ðŸŸ¢ OpenAI</option>
              <option value="anthropic">ðŸŸ£ Anthropic Claude</option>
              <option value="gemini">ðŸ”µ Google Gemini</option>
              <option value="groq">âš¡ Groq</option>
              <option value="mistral">ðŸŒ€ Mistral AI</option>
              <option value="cohere">ðŸŸ  Cohere</option>
            </select>
          </div>
          <div class="config-item">
            <span class="config-label">Modelo</span>
            <select class="config-select" id="ai-model">
              <!-- Se llena dinÃ¡micamente segÃºn proveedor -->
            </select>
          </div>
          <div class="config-item" id="ollama-url-item">
            <span class="config-label">URL Ollama</span>
            <input type="text" class="config-input" id="ollama-url" value="http://localhost:11434" placeholder="http://localhost:11434">
          </div>
          <div class="config-item" id="api-key-item" style="display: none;">
            <span class="config-label">API Key</span>
            <div style="display: flex; gap: 0.5rem;">
              <input type="password" class="config-input" id="ai-api-key" placeholder="sk-..." style="flex: 1;">
              <button class="btn btn-secondary" onclick="toggleApiKeyVisibility()" style="padding: 0.25rem 0.5rem;">ðŸ‘</button>
            </div>
          </div>
        </div>

        <!-- Columna 2: ParÃ¡metros de GeneraciÃ³n -->
        <div class="config-card">
          <div class="config-title">âš™ï¸ ParÃ¡metros de GeneraciÃ³n</div>
          <div class="config-item">
            <span class="config-label">Temperatura <span id="temp-value">0.7</span></span>
            <input type="range" class="config-slider" id="ai-temperature" min="0" max="200" value="70" oninput="updateSliderValue('temperature')">
            <div class="slider-labels"><span>Preciso</span><span>Creativo</span></div>
          </div>
          <div class="config-item">
            <span class="config-label">Top P <span id="top-p-value">0.9</span></span>
            <input type="range" class="config-slider" id="ai-top-p" min="0" max="100" value="90" oninput="updateSliderValue('top-p')">
          </div>
          <div class="config-item">
            <span class="config-label">Top K <span id="top-k-value">40</span></span>
            <input type="range" class="config-slider" id="ai-top-k" min="1" max="100" value="40" oninput="updateSliderValue('top-k')">
          </div>
          <div class="config-item">
            <span class="config-label">Max Tokens</span>
            <input type="number" class="config-input" id="ai-max-tokens" value="2048" min="128" max="32768">
          </div>
          <div class="config-item">
            <span class="config-label">Repeat Penalty <span id="repeat-penalty-value">1.1</span></span>
            <input type="range" class="config-slider" id="ai-repeat-penalty" min="100" max="200" value="110" oninput="updateSliderValue('repeat-penalty')">
          </div>
        </div>

        <!-- Columna 3: Contexto y Sistema -->
        <div class="config-card">
          <div class="config-title">ðŸ“ Contexto del Sistema</div>
          <div class="config-item" style="flex-direction: column; align-items: stretch;">
            <span class="config-label">System Prompt</span>
            <textarea class="config-textarea" id="ai-system-prompt" rows="4" placeholder="Eres ATLAS, un asistente de IA...">Eres ATLAS, un sistema de inteligencia artificial avanzado. Responde de forma concisa, precisa y Ãºtil. Tienes acceso a mÃ³dulos de visiÃ³n, memoria, anÃ¡lisis y control.</textarea>
          </div>
          <div class="config-item">
            <span class="config-label">Contexto de Memoria</span>
            <select class="config-select" id="ai-memory-context">
              <option value="none">Sin memoria</option>
              <option value="session">Solo sesiÃ³n actual</option>
              <option value="short">Corto plazo (Ãºltimas 10 conversaciones)</option>
              <option value="long" selected>Largo plazo (memoria persistente)</option>
            </select>
          </div>
          <div class="config-item">
            <span class="config-label">Ventana de Contexto</span>
            <input type="number" class="config-input" id="ai-context-window" value="8192" min="1024" max="128000">
          </div>
        </div>

        <!-- Columna 4: Especialistas IA -->
        <div class="config-card">
          <div class="config-title">ðŸŽ¯ Especialistas IA (Modo Auto)</div>
          <div class="specialist-list" id="specialist-list">
            <div class="specialist-item">
              <input type="checkbox" id="spec-code" checked>
              <label for="spec-code">ðŸ’» CÃ³digo</label>
              <select class="config-select-mini" id="spec-code-model">
                <option value="deepseek-coder">deepseek-coder</option>
                <option value="codellama">codellama</option>
                <option value="gpt-4">gpt-4</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-vision" checked>
              <label for="spec-vision">ðŸ‘ï¸ VisiÃ³n</label>
              <select class="config-select-mini" id="spec-vision-model">
                <option value="llava">llava</option>
                <option value="gpt-4-vision">gpt-4-vision</option>
                <option value="gemini-pro-vision">gemini-pro-vision</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-chat" checked>
              <label for="spec-chat">ðŸ’¬ Chat</label>
              <select class="config-select-mini" id="spec-chat-model">
                <option value="llama3.2" selected>llama3.2</option>
                <option value="mistral">mistral</option>
                <option value="claude-3">claude-3</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-analysis" checked>
              <label for="spec-analysis">ðŸ“Š AnÃ¡lisis</label>
              <select class="config-select-mini" id="spec-analysis-model">
                <option value="llama3.2">llama3.2</option>
                <option value="mixtral">mixtral</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-creative">
              <label for="spec-creative">ðŸŽ¨ Creativo</label>
              <select class="config-select-mini" id="spec-creative-model">
                <option value="llama3.2">llama3.2</option>
                <option value="claude-3">claude-3</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Columna 5: Modelos Disponibles -->
        <div class="config-card">
          <div class="config-title">ðŸ“¦ Modelos Disponibles (Ollama)</div>
          <div class="models-list" id="ollama-models-list">
            <div style="color: var(--text-muted); text-align: center; padding: 1rem;">
              Cargando modelos...
            </div>
          </div>
          <button class="btn btn-secondary" onclick="refreshOllamaModels()" style="width: 100%; margin-top: 0.5rem;">ðŸ”„ Actualizar Lista</button>
          <button class="btn" onclick="pullOllamaModel()" style="width: 100%; margin-top: 0.5rem; background: var(--accent-purple); color: white;">â¬‡ï¸ Descargar Modelo</button>
        </div>

        <!-- Columna 6: Logs y Debug -->
        <div class="config-card">
          <div class="config-title">ðŸ”§ Debug & Logs</div>
          <div class="config-item">
            <span class="config-label">Nivel de Log</span>
            <select class="config-select" id="ai-log-level">
              <option value="error">Solo Errores</option>
              <option value="warn">Advertencias</option>
              <option value="info" selected>Info</option>
              <option value="debug">Debug</option>
              <option value="trace">Trace (Verboso)</option>
            </select>
          </div>
          <div class="config-item">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="ai-stream-response" checked>
              <span>Respuesta en Streaming</span>
            </label>
          </div>
          <div class="config-item">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="ai-save-history" checked>
              <span>Guardar historial</span>
            </label>
          </div>
          <div class="config-item">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="ai-show-thinking">
              <span>Mostrar "pensamiento"</span>
            </label>
          </div>
          <div class="ai-log-preview" id="ai-log-preview">
            <div class="log-entry log-info">[INFO] Sistema listo</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== TAB: VISION ========== -->
    <div class="tab-panel" id="panel-vision">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value" id="vision-cameras">3</div>
          <div class="stat-label">CÃMARAS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-active">1</div>
          <div class="stat-label">ACTIVAS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-fps">30</div>
          <div class="stat-label">FPS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-detections">0</div>
          <div class="stat-label">DETECCIONES</div>
        </div>
      </div>

      <!-- CÃ¡maras disponibles -->
      <div class="modules-section">
        <div class="modules-header">
          <span class="modules-title">CÃMARAS DISPONIBLES</span>
          <button class="btn btn-primary" onclick="scanCameras()" style="font-size: 0.8rem;">ðŸ”„ Escanear</button>
        </div>
        <div class="modules-list" id="cameras-list">
          <div class="module-row" data-cam-id="0">
            <div class="module-info">
              <div class="module-dot"></div>
              <div class="camera-details">
                <span class="module-name-text">ðŸ‘ï¸ NexiGo N930W IR</span>
                <span class="camera-specs">1920x1080 @ 30fps</span>
              </div>
            </div>
            <div class="module-actions">
              <button class="btn-check" onclick="selectCamera(0, event)">SELECCIONAR</button>
              <button class="btn-reconnect" onclick="streamCamera(0, event)">ðŸ”´ STREAM</button>
            </div>
          </div>
          <div class="module-row" data-cam-id="1">
            <div class="module-info">
              <div class="module-dot"></div>
              <div class="camera-details">
                <span class="module-name-text">ðŸ“¹ NexiGo N930W</span>
                <span class="camera-specs">1920x1080 @ 30fps</span>
              </div>
            </div>
            <div class="module-actions">
              <button class="btn-check" onclick="selectCamera(1, event)">SELECCIONAR</button>
              <button class="btn-reconnect" onclick="streamCamera(1, event)">ðŸ”´ STREAM</button>
            </div>
          </div>
          <div class="module-row" data-cam-id="2">
            <div class="module-info">
              <div class="module-dot"></div>
              <div class="camera-details">
                <span class="module-name-text">ðŸŽ¥ Insta360 Link 2</span>
                <span class="camera-specs">3840x2160 @ 30fps</span>
              </div>
            </div>
            <div class="module-actions">
              <button class="btn-check" onclick="selectCamera(2, event)">SELECCIONAR</button>
              <button class="btn-reconnect" onclick="streamCamera(2, event)">ðŸ”´ STREAM</button>
            </div>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-primary" onclick="captureSnapshot()">ðŸ“· Capturar</button>
        <button class="btn btn-secondary" onclick="startStreamSelected()">ðŸŽ¥ Stream Permanente</button>
        <button class="btn" onclick="stopStream()" style="background: var(--accent-red); color: white;">â¹ï¸ Detener</button>
        <button class="btn" onclick="detectFaces()" style="background: var(--accent-purple); color: white;">ðŸ‘¤ Detectar Rostros</button>
        <button class="btn" onclick="readTextOCR()" style="background: var(--accent-orange); color: var(--bg);">ðŸ“ OCR</button>
      </div>

      <!-- Vista previa -->
      <div style="background: var(--bg-card); border: 2px solid var(--accent-cyan); border-radius: 12px; padding: 1rem; margin-top: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <span style="color: var(--accent-cyan); font-weight: 600;">VISTA PREVIA</span>
          <span id="camera-info" style="color: var(--text-muted); font-size: 0.8rem;">Ninguna cÃ¡mara seleccionada</span>
        </div>
        <div id="vision-preview" style="background: var(--bg); border-radius: 8px; min-height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
          <div style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸ“·</div>
            <div>Selecciona una cÃ¡mara para ver la vista previa</div>
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
          <span id="detection-results" style="color: var(--text-muted); font-size: 0.8rem;"></span>
        </div>
      </div>
    </div>

    <!-- ========== TAB: NERVIOSO ========== -->
    <div class="tab-panel" id="panel-nervioso">
      <!-- Header con estado general -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: 600;">ðŸ§  Arquitectura Cognitiva Atlas</h2>
        <div class="status-badge" id="nervous-main-status">OPERATIVO</div>
      </div>

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value success" id="nervous-status">OK</div>
          <div class="stat-label">ESTADO</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-signals">0</div>
          <div class="stat-label">SEÃ‘ALES/MIN</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-latency">12</div>
          <div class="stat-label">LATENCIA (ms)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-uptime">99.9%</div>
          <div class="stat-label">UPTIME</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-goals">0</div>
          <div class="stat-label">GOALS ACTIVOS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-memory">0</div>
          <div class="stat-label">EPISODIOS</div>
        </div>
      </div>

      <!-- Diagrama de Arquitectura Cognitiva -->
      <div class="nervous-diagram">
        <!-- CORTEX -->
        <div class="nervous-section">
          <div class="nervous-section-title">ðŸ§  Cortex (Procesamiento Cognitivo)</div>
          <div class="nervous-grid">
            <div class="nervous-node connected" id="node-frontal" onclick="inspectCognitiveNode('cortex/frontal')">
              <span class="nervous-node-icon">ðŸŽ¯</span>
              <span class="nervous-node-name">Frontal</span>
              <span class="nervous-node-desc">PlanificaciÃ³n y decisiÃ³n</span>
              <div class="node-modules" id="frontal-modules">
                <span class="mini-module">TaskPlanner</span>
                <span class="mini-module">DecisionMaker</span>
                <span class="mini-module">InhibitoryControl</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-parietal" onclick="inspectCognitiveNode('cortex/parietal')">
              <span class="nervous-node-icon">ðŸ—ºï¸</span>
              <span class="nervous-node-name">Parietal</span>
              <span class="nervous-node-desc">FusiÃ³n sensorial</span>
              <div class="node-modules" id="parietal-modules">
                <span class="mini-module">SensoryFusion</span>
                <span class="mini-module">SpatialMap</span>
                <span class="mini-module">BodySchema</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-temporal" onclick="inspectCognitiveNode('cortex/temporal')">
              <span class="nervous-node-icon">ðŸ‘‚</span>
              <span class="nervous-node-name">Temporal</span>
              <span class="nervous-node-desc">Audio y lenguaje</span>
              <div class="node-modules" id="temporal-modules">
                <span class="mini-module">AudioProcessor</span>
                <span class="mini-module">LanguageUnderstanding</span>
                <span class="mini-module">EpisodicRecall</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-occipital" onclick="inspectCognitiveNode('cortex/occipital')">
              <span class="nervous-node-icon">ðŸ‘ï¸</span>
              <span class="nervous-node-name">Occipital</span>
              <span class="nervous-node-desc">VisiÃ³n y profundidad</span>
              <div class="node-modules" id="occipital-modules">
                <span class="mini-module">VisionPipeline</span>
                <span class="mini-module">DepthEstimation</span>
                <span class="mini-module">ObjectRecognition</span>
              </div>
            </div>
          </div>
        </div>

        <!-- SISTEMAS SUBCORTICALES -->
        <div class="nervous-section">
          <div class="nervous-section-title">ðŸ’œ Sistemas Subcorticales</div>
          <div class="nervous-grid">
            <div class="nervous-node connected" id="node-limbic" onclick="inspectCognitiveNode('limbic')">
              <span class="nervous-node-icon">â¤ï¸</span>
              <span class="nervous-node-name">Sistema LÃ­mbico</span>
              <span class="nervous-node-desc">MotivaciÃ³n y emociones</span>
              <div class="node-modules" id="limbic-modules">
                <span class="mini-module">GoalManager</span>
                <span class="mini-module">RewardEngine</span>
                <span class="mini-module">StateRegulator</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-hippo" onclick="inspectCognitiveNode('hippo')">
              <span class="nervous-node-icon">ðŸ§©</span>
              <span class="nervous-node-name">Hipocampo</span>
              <span class="nervous-node-desc">Memoria episÃ³dica</span>
              <div class="node-modules" id="hippo-modules">
                <span class="mini-module">EpisodicMemory</span>
                <span class="mini-module">SemanticMemory</span>
                <span class="mini-module">Consolidator</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-basal" onclick="inspectCognitiveNode('basal')">
              <span class="nervous-node-icon">âš¡</span>
              <span class="nervous-node-name">Ganglios Basales</span>
              <span class="nervous-node-desc">SelecciÃ³n de acciones</span>
              <div class="node-modules" id="basal-modules">
                <span class="mini-module">ActionSelector</span>
                <span class="mini-module">Inhibitor</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-learning" onclick="inspectCognitiveNode('learning')">
              <span class="nervous-node-icon">ðŸ“š</span>
              <span class="nervous-node-name">Aprendizaje</span>
              <span class="nervous-node-desc">LfD, RL, NL Feedback</span>
              <div class="node-modules" id="learning-modules">
                <span class="mini-module">Demonstration</span>
                <span class="mini-module">Reinforcement</span>
                <span class="mini-module">NLFeedback</span>
              </div>
            </div>
          </div>
        </div>

        <!-- SISTEMAS VITALES -->
        <div class="nervous-section">
          <div class="nervous-section-title">ðŸ©º Sistemas Vitales y Control</div>
          <div class="nervous-grid">
            <div class="nervous-node connected" id="node-brainstem" onclick="inspectCognitiveNode('brainstem')">
              <span class="nervous-node-icon">ðŸ«€</span>
              <span class="nervous-node-name">Tronco EncefÃ¡lico</span>
              <span class="nervous-node-desc">Funciones vitales</span>
              <div class="node-modules" id="brainstem-modules">
                <span class="mini-module">VitalsMonitor</span>
                <span class="mini-module">SafetyPolicy</span>
                <span class="mini-module">GlobalState</span>
                <span class="mini-module">Watchdog</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-medulla" onclick="inspectCognitiveNode('medulla')">
              <span class="nervous-node-icon">ðŸ”Œ</span>
              <span class="nervous-node-name">MÃ©dula Atlas</span>
              <span class="nervous-node-desc">Bus de comunicaciÃ³n</span>
              <div class="node-modules" id="medulla-modules">
                <span class="mini-module">ZeroMQ Bus</span>
                <span class="mini-module">SharedState</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-motor" onclick="inspectCognitiveNode('motor')">
              <span class="nervous-node-icon">ðŸ¦¾</span>
              <span class="nervous-node-name">Control Motor</span>
              <span class="nervous-node-desc">Trayectorias y PID</span>
              <div class="node-modules" id="motor-modules">
                <span class="mini-module">TrajectoryPlanner</span>
                <span class="mini-module">MotorController</span>
                <span class="mini-module">MotorInterface</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-snp" onclick="inspectCognitiveNode('snp')">
              <span class="nervous-node-icon">ðŸŒ</span>
              <span class="nervous-node-name">SNP (Sensores)</span>
              <span class="nervous-node-desc">Drivers hardware</span>
              <div class="node-modules" id="snp-modules">
                <span class="mini-module">Vision</span>
                <span class="mini-module">Audio</span>
                <span class="mini-module">IMU</span>
                <span class="mini-module">F/T</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel de SeÃ±ales en Tiempo Real -->
      <div class="nervous-signals-panel">
        <div class="nervous-section-title">ðŸ“Š MÃ³dulos en Tiempo Real</div>
        <div class="signals-monitor">
          <div class="signal-row">
            <span class="signal-name">ðŸ§  Cortex Frontal</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-frontal" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-frontal-val">--</span>
          </div>
          <div class="signal-row">
            <span class="signal-name">ðŸ‘ï¸ Cortex Occipital</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-occipital" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-occipital-val">--</span>
          </div>
          <div class="signal-row">
            <span class="signal-name">â¤ï¸ Sistema LÃ­mbico</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-limbic" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-limbic-val">--</span>
          </div>
          <div class="signal-row">
            <span class="signal-name">ðŸ§© Hipocampo</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-hippo" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-hippo-val">--</span>
          </div>
          <div class="signal-row">
            <span class="signal-name">ðŸ«€ Brainstem</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-brainstem" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-brainstem-val">--</span>
          </div>
          <div class="signal-row">
            <span class="signal-name">ðŸ¦¾ Motor Control</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-motor-ctrl" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-motor-ctrl-val">--</span>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="action-bar" style="margin-top: 1rem;">
        <button class="btn btn-primary" onclick="refreshCognitive()">ðŸ”„ Actualizar</button>
        <button class="btn btn-secondary" onclick="cognitiveDiagnostic()">ðŸ”¬ DiagnÃ³stico Completo</button>
        <button class="btn" onclick="connectCognitiveWS()" style="background: var(--accent-purple); color: white;">ðŸ“¡ WebSocket Live</button>
        <button class="btn" onclick="showGoals()" style="background: var(--accent-orange); color: var(--bg);">ðŸŽ¯ Ver Goals</button>
        <button class="btn" onclick="showMemories()" style="background: var(--accent-green); color: var(--bg);">ðŸ§© Ver Memorias</button>
      </div>

      <!-- Log de eventos del sistema nervioso -->
      <div class="nervous-log" style="margin-top: 1rem;">
        <div class="nervous-section-title">ðŸ“‹ Log de Eventos Cognitivos</div>
        <div class="nervous-log-list" id="nervous-log-list">
          <div class="nervous-log-entry">
            <span class="log-time">--:--:--</span>
            <span class="log-msg">Sistema cognitivo Atlas inicializado</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- TAB: COMUNICACIONES -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" id="panel-comms">
      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: 600;">ðŸ“± Centro de Comunicaciones</h2>
        <div class="status-badge" id="comms-status">VERIFICANDO...</div>
      </div>

      <!-- Stats Bar -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
        <div class="metric-card">
          <div class="metric-label">WhatsApp</div>
          <div class="metric-value" id="comms-whatsapp-status" style="color: var(--accent-cyan);">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Telegram</div>
          <div class="metric-value" id="comms-telegram-status" style="color: var(--accent-cyan);">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Audio TTS</div>
          <div class="metric-value" id="comms-audio-status" style="color: var(--accent-cyan);">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Mensajes Hoy</div>
          <div class="metric-value" id="comms-messages-today" style="color: var(--accent-green);">--</div>
        </div>
      </div>

      <!-- Action Bar -->
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
        <button class="action-btn" onclick="refreshCommsStatus()">ðŸ”„ Actualizar Estado</button>
        <button class="action-btn" onclick="openWahaDashboard()">ðŸŒ WAHA Dashboard</button>
        <button class="action-btn" onclick="showQRCode()">ðŸ“· Mostrar QR</button>
        <button class="action-btn" onclick="testAllComms()">ðŸ§ª Test Canales</button>
      </div>

      <!-- Main Grid -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <!-- WhatsApp Card -->
        <div class="card" style="padding: 1.5rem;">
          <h3 style="color: var(--accent-green); margin-bottom: 1rem;">ðŸ’¬ WhatsApp (WAHA)</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Estado:</span>
              <span id="waha-connection-status">--</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">SesiÃ³n:</span>
              <span id="waha-session-name">default</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">TelÃ©fono:</span>
              <span id="waha-phone-number">--</span>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
              <button class="action-btn" style="flex: 1;" onclick="restartWahaSession()">ðŸ”„ Reiniciar SesiÃ³n</button>
              <button class="action-btn" style="flex: 1;" onclick="testWhatsApp()">ðŸ§ª Test</button>
            </div>
            <!-- QR Container -->
            <div id="waha-qr-container" style="display: none; text-align: center; padding: 1rem; background: #fff; border-radius: 8px; margin-top: 0.5rem;">
              <img id="waha-qr-image" style="max-width: 200px;" alt="QR WhatsApp"/>
              <p style="color: #333; font-size: 0.8rem; margin-top: 0.5rem;">Escanea con WhatsApp</p>
            </div>
          </div>
        </div>

        <!-- Telegram Card -->
        <div class="card" style="padding: 1.5rem;">
          <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">ðŸ“¨ Telegram</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Estado:</span>
              <span id="telegram-connection-status">--</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Token:</span>
              <span id="telegram-token-status">--</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Chat ID:</span>
              <span id="telegram-chat-id">--</span>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
              <button class="action-btn" style="flex: 1;" onclick="testTelegram()">ðŸ§ª Test Mensaje</button>
            </div>
          </div>
        </div>

        <!-- Audio & Voice Card -->
        <div class="card" style="padding: 1.5rem;">
          <h3 style="color: var(--accent-orange); margin-bottom: 1rem;">ðŸŽ¤ Audio & Voz Interactiva</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">TTS:</span>
              <span id="audio-connection-status">--</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Motor:</span>
              <span id="audio-engine">pyttsx3</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Asistente:</span>
              <span id="voice-assistant-status">--</span>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
              <button class="action-btn" style="flex: 1;" onclick="testAudio()">ðŸ§ª Test</button>
              <button class="action-btn" style="flex: 1;" id="voice-toggle-btn" onclick="toggleVoiceAssistant()">ðŸŽ¤ Iniciar Voz</button>
            </div>
            <div style="margin-top: 0.5rem;">
              <input type="text" id="speak-text-input" placeholder="Escribe para que ATLAS hable..." 
                     style="width: 100%; padding: 0.5rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              <button class="action-btn" style="width: 100%; margin-top: 0.5rem;" onclick="speakCustomText()">ðŸ”Š Hablar</button>
            </div>
          </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="card" style="padding: 1.5rem;">
          <h3 style="color: var(--accent-cyan); margin-bottom: 1rem;">âš¡ Acciones RÃ¡pidas</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <button class="action-btn" onclick="sendTestAll()">ðŸ“¢ Notificar en Todos los Canales</button>
            <button class="action-btn" onclick="showQRCode()">ðŸ“· Mostrar QR de WhatsApp</button>
            <button class="action-btn" onclick="reconnectAllComms()">ðŸ”Œ Reconectar Servicios</button>
          </div>
        </div>
      </div>

      <!-- BitÃ¡cora de Comunicaciones -->
      <div class="card" style="padding: 1.5rem; margin-top: 1.5rem;">
        <h3 style="color: var(--accent-cyan); margin-bottom: 1rem;">ðŸ“‹ BitÃ¡cora de Comunicaciones</h3>
        <div id="comms-activity-list" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
          <p style="color: var(--text-muted);">Cargando eventos...</p>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- TAB: TUTORÃAS Y VISITAS -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" id="panel-tutorias">
      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: 600;">ðŸ“‹ Sistema de TutorÃ­as y Visitas</h2>
        <div class="status-badge" id="tutorias-status">ACTIVO</div>
      </div>

      <!-- EstadÃ­sticas rÃ¡pidas -->
      <div class="ai-config-grid" style="margin-bottom: 1.5rem;">
        <div class="ai-config-card">
          <h3>ðŸ‘¤ Especialistas</h3>
          <div style="text-align: center; padding: 1rem;">
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent-cyan);" id="tut-stat-especialistas">0</div>
            <div style="color: var(--text-muted);">Registrados</div>
          </div>
        </div>
        <div class="ai-config-card">
          <h3>ðŸ“… Visitas</h3>
          <div style="text-align: center; padding: 1rem;">
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent-green);" id="tut-stat-visitas">0</div>
            <div style="color: var(--text-muted);">Realizadas</div>
          </div>
        </div>
        <div class="ai-config-card">
          <h3>ðŸ“ Informes</h3>
          <div style="text-align: center; padding: 1rem;">
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent-purple);" id="tut-stat-informes">0</div>
            <div style="color: var(--text-muted);">Firmados</div>
          </div>
        </div>
        <div class="ai-config-card">
          <h3>â­ PuntuaciÃ³n</h3>
          <div style="text-align: center; padding: 1rem;">
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent-orange);" id="tut-stat-puntuacion">0.0</div>
            <div style="color: var(--text-muted);">Promedio</div>
          </div>
        </div>
      </div>

      <!-- Registrar Especialista -->
      <div class="ai-config-card" style="margin-bottom: 1rem;">
        <h3>ðŸ‘¤ Registrar Nuevo Especialista</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Nombre</label>
            <input type="text" id="esp-nombre" placeholder="Nombre completo" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Rol</label>
            <select id="esp-rol" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
              <option value="Arquitecto de IA">Arquitecto de IA</option>
              <option value="Desarrollador Senior">Desarrollador Senior</option>
              <option value="QA Engineer">QA Engineer</option>
              <option value="DevOps">DevOps</option>
              <option value="Data Scientist">Data Scientist</option>
              <option value="Security Analyst">Security Analyst</option>
              <option value="UX Designer">UX Designer</option>
              <option value="Project Manager">Project Manager</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Especialidad</label>
            <input type="text" id="esp-especialidad" placeholder="Ej: Vision, NLP, Robotics" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Email</label>
            <input type="email" id="esp-email" placeholder="email@ejemplo.com" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
        </div>
        <div style="padding: 0 1rem 1rem;">
          <button class="btn btn-primary" onclick="registrarEspecialista()">âž• Registrar Especialista</button>
        </div>
      </div>

      <!-- Lista de Especialistas -->
      <div class="ai-config-card" style="margin-bottom: 1rem;">
        <h3>ðŸ‘¥ Especialistas Registrados</h3>
        <div id="lista-especialistas" style="padding: 1rem; max-height: 200px; overflow-y: auto;">
          <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
            Cargando especialistas...
          </div>
        </div>
      </div>

      <!-- Iniciar Nueva Visita -->
      <div class="ai-config-card" style="margin-bottom: 1rem;">
        <h3>ðŸ“… Iniciar Nueva Visita</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Especialista</label>
            <select id="visita-especialista" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
              <option value="">Seleccionar especialista...</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Tipo de Visita</label>
            <select id="visita-tipo" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
              <option value="tutoria">ðŸ“š TutorÃ­a</option>
              <option value="revision">ðŸ” RevisiÃ³n</option>
              <option value="auditoria">ðŸ“Š AuditorÃ­a</option>
              <option value="capacitacion">ðŸŽ“ CapacitaciÃ³n</option>
              <option value="mantenimiento">ðŸ”§ Mantenimiento</option>
              <option value="emergencia">ðŸš¨ Emergencia</option>
              <option value="seguimiento">ðŸ“Œ Seguimiento</option>
            </select>
          </div>
          <div style="grid-column: span 2;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Motivo de la Visita</label>
            <input type="text" id="visita-motivo" placeholder="Describir el motivo de la visita..." style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
          <div style="grid-column: span 2;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">MÃ³dulos a Revisar</label>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="brain"> ðŸ§  Brain
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="vision"> ðŸ‘ï¸ Vision
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="nervous"> ðŸ”— Nervous
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="memory"> ðŸ’¾ Memory
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="quality"> âœ… Quality
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="comms"> ðŸ“¡ Comms
              </label>
            </div>
          </div>
        </div>
        <div style="padding: 0 1rem 1rem;">
          <button class="btn btn-primary" onclick="iniciarVisita()">ðŸš€ Iniciar Visita</button>
        </div>
      </div>

      <!-- Visita en Curso -->
      <div class="ai-config-card" id="visita-en-curso" style="margin-bottom: 1rem; display: none; border: 2px solid var(--accent-cyan);">
        <h3>â±ï¸ Visita en Curso</h3>
        <div style="padding: 1rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <div>
              <strong id="visita-actual-tipo">TutorÃ­a</strong>
              <span style="color: var(--text-muted);"> por </span>
              <strong id="visita-actual-esp">Especialista</strong>
            </div>
            <div style="color: var(--accent-cyan); font-weight: bold;" id="visita-timer">00:00:00</div>
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Notas de la Visita</label>
            <textarea id="visita-notas" rows="3" placeholder="Agregar notas durante la visita..." style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text); resize: vertical;"></textarea>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button class="btn btn-primary" onclick="mostrarFormularioInforme()">ðŸ“ Crear Informe</button>
            <button class="btn" style="background: var(--accent-red); color: white;" onclick="cancelarVisita()">âŒ Cancelar Visita</button>
          </div>
        </div>
      </div>

      <!-- Historial de Visitas -->
      <div class="ai-config-card" style="margin-bottom: 1rem;">
        <h3>ðŸ“š Historial de Visitas</h3>
        <div id="historial-visitas" style="padding: 1rem; max-height: 300px; overflow-y: auto;">
          <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
            Cargando historial...
          </div>
        </div>
      </div>

      <!-- Recomendaciones Pendientes -->
      <div class="ai-config-card" style="margin-bottom: 1rem;">
        <h3>ðŸ’¡ Recomendaciones Pendientes</h3>
        <div id="lista-recomendaciones" style="padding: 1rem; max-height: 250px; overflow-y: auto;">
          <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
            Cargando recomendaciones...
          </div>
        </div>
      </div>

      <!-- Seguimientos Activos -->
      <div class="ai-config-card">
        <h3>ðŸ“Œ Seguimientos de Mejora</h3>
        <div id="lista-seguimientos" style="padding: 1rem; max-height: 250px; overflow-y: auto;">
          <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
            Cargando seguimientos...
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="action-bar" style="margin-top: 1rem;">
        <button class="btn btn-primary" onclick="refreshTutorias()">ðŸ”„ Actualizar</button>
        <button class="btn btn-secondary" onclick="generarDashboardTutorias()">ðŸ“Š Generar Dashboard</button>
        <button class="btn" style="background: var(--accent-orange); color: var(--bg);" onclick="exportarRecomendaciones()">ðŸ“‹ Exportar Recomendaciones</button>
      </div>
    </div>

    </div><!-- /panel-body -->
  </div><!-- /fullpage-panels -->

  <!-- BITACORA CENTRAL (contenido principal full-width) -->
  <div class="bitacora-main" id="bitacora-panel">
    <div class="bitacora-header">
      <span class="bitacora-title">
        <span class="live-dot"></span>
        BITACORA CENTRAL
      </span>
      <div class="bitacora-controls">
        <button class="bitacora-btn" onclick="clearBitacora()" title="Limpiar registro">&#128465; Limpiar</button>
        <button class="bitacora-btn" onclick="exportBitacora()" title="Exportar">&#128190; Exportar</button>
      </div>
    </div>
    <div class="bitacora-filters">
      <button class="bitacora-filter active" data-filter="all">Todos</button>
      <button class="bitacora-filter" data-filter="success">&#10004; OK</button>
      <button class="bitacora-filter" data-filter="info">&#8505; Info</button>
      <button class="bitacora-filter" data-filter="error">&#10060; Error</button>
      <button class="bitacora-filter" data-filter="warning">&#9888; Warning</button>
      <button class="bitacora-filter" data-filter="brain">&#129504; Cerebro</button>
      <button class="bitacora-filter" data-filter="vision">&#128065; Vision</button>
      <button class="bitacora-filter" data-filter="nervous">&#128279; Nervioso</button>
      <button class="bitacora-filter" data-filter="pending" style="border-color:rgba(245,158,11,0.4)">&#9888; Pendientes</button>
      <button class="bitacora-filter" data-filter="telegram" style="border-color:rgba(42,171,238,0.3)">&#9992; Telegram</button>
      <button class="bitacora-filter" data-filter="whatsapp" style="border-color:rgba(37,211,102,0.3)">&#128172; WhatsApp</button>
      <button class="bitacora-filter" data-filter="robot">&#129302; Robot</button>
      <button class="bitacora-filter" data-filter="healing" style="border-color:rgba(168,85,247,0.3)">&#128138; Healing</button>
      <button class="bitacora-filter" data-filter="governance" style="border-color:rgba(239,68,68,0.3)">&#128737; Gobernanza</button>
    </div>
    <div class="bitacora-content" id="bitacora-content">
    </div>
    <div class="bitacora-stats">
      <span id="bitacora-count">0 eventos</span>
      <span id="bitacora-session">Sesion: 00:00:00</span>
    </div>
  </div>

  <!-- FOOTER UNIFICADO -->
  <div class="main-footer" id="main-footer">
    <span>ATLAS</span>&nbsp;v3.8.0 &nbsp;|&nbsp; 2026-02-16
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ATLAS Dashboard v3.0.0 - JavaScript
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const ATLAS_VERSION = '3.8.0';
    const ATLAS_BUILD_DATE = '2026-02-16';
    const API_BASE = window.location.origin;

    console.log(`%cðŸš€ ATLAS Dashboard v${ATLAS_VERSION}`, 'color: #39d3c4; font-weight: bold; font-size: 14px;');

    // Modules definition
    const MODULES = [
      { id: 'brain', name: 'Brain', icon: 'ðŸ§ ', status: 'ok' },
      { id: 'memory', name: 'Memory', icon: 'ðŸ’¾', status: 'ok' },
      { id: 'learning', name: 'Learning', icon: 'ðŸ“š', status: 'ok' },
      { id: 'analysis', name: 'Analysis', icon: 'ðŸ“Š', status: 'ok' },
      { id: 'reaction', name: 'Reaction', icon: 'âš¡', status: 'ok' },
      { id: 'nervous', name: 'Nervous', icon: 'ðŸ”—', status: 'ok' },
      { id: 'ans', name: 'ANS', icon: 'â¤ï¸', status: 'ok' },
      { id: 'vision', name: 'Vision', icon: 'ðŸ‘ï¸', status: 'ok' },
      { id: 'ears', name: 'Ears', icon: 'ðŸ‘‚', status: 'ok' },
      { id: 'sensors', name: 'Sensors', icon: 'ðŸ“¡', status: 'ok' },
      { id: 'voice', name: 'Voice', icon: 'ðŸ”Š', status: 'ok' },
      { id: 'hands', name: 'Hands', icon: 'ðŸ¤–', status: 'ok' },
      { id: 'navigation', name: 'Navigation', icon: 'ðŸ§­', status: 'ok' },
      { id: 'comms', name: 'Comms', icon: 'ðŸ“±', status: 'ok' },
      { id: 'quality', name: 'Quality', icon: 'âœ…', status: 'ok' },
    ];

    // Activity log
    let activityLog = [];
    
    // BitÃ¡cora central
    let bitacoraLog = [];
    let bitacoraFilter = 'all';
    let sessionStartTime = Date.now();
    let unreadCount = 0;

    let _prevRobotOnline = null;
    let _prevRobotMods = {};
    async function updateMiniRobot() {
      const modMap = {ai:'mr-ai',camera:'mr-cam',vision:'mr-vis',yolo:'mr-yolo',control:'mr-ctrl',sensors:'mr-sens',actuators:'mr-act',communication:'mr-comm'};
      try {
        const r = await fetch('http://'+location.hostname+':8002/status',{signal:AbortSignal.timeout(3000)});
        const d = await r.json();
        const mods = d.modules || {};
        for (const [mod, elId] of Object.entries(modMap)) {
          const el = document.getElementById(elId);
          if (el) el.setAttribute('opacity', mods[mod] ? '0.85' : '0.15');
          if (_prevRobotMods[mod] !== undefined && _prevRobotMods[mod] !== !!mods[mod]) {
            addToBitacora(`Robot modulo ${mod}: ${mods[mod] ? 'ACTIVO' : 'INACTIVO'}`, mods[mod] ? 'success' : 'warning', 'robot');
          }
          _prevRobotMods[mod] = !!mods[mod];
        }
        if (_prevRobotOnline === false) {
          addToBitacora('Robot reconectado', 'success', 'robot');
        }
        _prevRobotOnline = true;
      } catch(e) {
        Object.values(modMap).forEach(id => {const el=document.getElementById(id);if(el)el.setAttribute('opacity','0.1')});
        if (_prevRobotOnline === true) {
          addToBitacora('Robot desconectado', 'error', 'robot');
        }
        _prevRobotOnline = false;
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initTabs();
      initThemeSelector();
      initBitacora();
      renderModules();
      updateTime();
      setInterval(updateTime, 1000);
      loadInitialData();
      updateMiniRobot();
      setInterval(updateMiniRobot, 10000);
    });
    
    // Theme selector
    function initThemeSelector() {
      // Cargar tema guardado
      const savedTheme = localStorage.getItem('atlas-theme') || 'cyan';
      setTheme(savedTheme);
      
      // Event listeners para botones de tema
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const theme = btn.getAttribute('data-theme');
          setTheme(theme);
          localStorage.setItem('atlas-theme', theme);
          addActivity(`Tema cambiado: ${theme}`, 'info');
        });
      });
    }
    
    function setTheme(themeName) {
      document.documentElement.setAttribute('data-theme', themeName);
      
      // Actualizar botÃ³n activo
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-theme') === themeName) {
          btn.classList.add('active');
        }
      });
    }

    // Tab navigation
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const open = sidebar.classList.toggle('open');
      overlay.classList.toggle('open', open);
      document.body.style.overflow = open ? 'hidden' : '';
    }

    const TAB_LABELS = {
      chat: '&#128172; Chat', modulos: '&#128230; Modulos', gobernanza: '&#128737; Gobernanza &amp; AutonomÃ­a',
      config: '&#129302; Config IA', vision: '&#128065; Vision', nervioso: '&#128279; Nervioso',
      comms: '&#128241; Comms', tutorias: '&#128203; Tutorias'
    };

    function openPanel(tabId) {
      if (!tabId) return;
      toggleSidebar();
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      const activeTab = document.querySelector(`.sidebar-tab[data-tab="${tabId}"]`);
      if (activeTab) activeTab.classList.add('active');

      document.querySelectorAll('#panel-body .tab-panel').forEach(p => p.classList.remove('active'));
      const panel = document.getElementById(`panel-${tabId}`);
      if (panel) panel.classList.add('active');

      const titleBar = document.getElementById('panel-title-bar');
      if (titleBar) titleBar.innerHTML = TAB_LABELS[tabId] || tabId;

      document.getElementById('bitacora-panel').style.display = 'none';
      document.getElementById('fullpage-panels').classList.add('active');
    }

    function backToBitacora() {
      document.getElementById('fullpage-panels').classList.remove('active');
      document.getElementById('bitacora-panel').style.display = 'flex';
    }

    function initTabs() {
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.addEventListener('click', () => openPanel(tab.dataset.tab));
      });
    }

    // Render modules list (Sistema Nervioso style)
    function renderModules() {
      const grid = document.getElementById('modules-grid');
      if (grid) {
        grid.innerHTML = MODULES.map(mod => `
          <div class="module-tile ${mod.status === 'ok' ? 'connected' : 'error'}" 
               onclick="openModuleDetail('${mod.id}')" 
               id="tile-${mod.id}">
            <span class="module-emoji">${mod.icon}</span>
            <div class="module-tile-name">${mod.name}</div>
            <div class="module-tile-status">${mod.status === 'ok' ? 'Conectado' : 'Error'}</div>
          </div>
        `).join('');
      }
      updateModuleCounter();
      updateSystemBadge();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MODULE DETAIL MODALS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function openModuleDetail(moduleId) {
      const mod = MODULES.find(m => m.id === moduleId);
      if (!mod) return;
      
      const overlay = document.getElementById('module-modal-overlay');
      const modalTitle = document.getElementById('modal-title');
      const modalIcon = document.getElementById('modal-icon');
      const modalBody = document.getElementById('modal-body');
      
      modalTitle.textContent = mod.name;
      modalIcon.textContent = mod.icon;
      
      // Generar contenido especÃ­fico por mÃ³dulo
      modalBody.innerHTML = '<div style="text-align:center;padding:2rem;"><div style="font-size:2rem;">â³</div><div>Cargando datos...</div></div>';
      overlay.classList.add('active');
      
      try {
        const content = await generateModuleContent(moduleId, mod);
        modalBody.innerHTML = content;
      } catch (e) {
        modalBody.innerHTML = `<div class="module-empty-state">âŒ Error cargando datos: ${e.message}</div>`;
      }
    }
    
    function closeModuleModal(event) {
      if (event && event.target !== document.getElementById('module-modal-overlay')) return;
      document.getElementById('module-modal-overlay').classList.remove('active');
    }
    
    async function generateModuleContent(moduleId, mod) {
      const generators = {
        quality: generateQualityContent,
        brain: generateBrainContent,
        memory: generateMemoryContent,
        ans: generateANSContent,
        nervous: generateNervousContent,
        vision: generateVisionContent,
        hands: generateHandsContent,
        voice: generateVoiceContent,
        comms: generateCommsContent,
        navigation: generateNavigationContent,
      };
      
      const generator = generators[moduleId] || generateGenericContent;
      return await generator(mod);
    }
    
    async function generateQualityContent(mod) {
      let html = '<div class="module-modal-section"><div class="module-modal-section-title">ðŸ“Š EstadÃ­sticas</div><div class="module-stats-grid">';
      
      try {
        const potsRes = await fetch('/quality/pots/list');
        const potsData = await potsRes.json();
        const pots = potsData.pots || [];
        
        const execRes = await fetch('/quality/executions/recent?limit=10');
        const execData = await execRes.json();
        const execs = execData.executions || [];
        
        const active = pots.filter(p => p.enabled !== false).length;
        const total = pots.length;
        const recentSuccess = execs.filter(e => e.ok).length;
        const recentTotal = execs.length;
        
        html += `
          <div class="module-stat-card">
            <div class="module-stat-value success">${active}</div>
            <div class="module-stat-label">POTs Activos</div>
          </div>
          <div class="module-stat-card">
            <div class="module-stat-value">${total}</div>
            <div class="module-stat-label">Total POTs</div>
          </div>
          <div class="module-stat-card">
            <div class="module-stat-value ${recentSuccess === recentTotal ? 'success' : 'warning'}">${recentSuccess}/${recentTotal}</div>
            <div class="module-stat-label">Ã‰xito Reciente</div>
          </div>
          <div class="module-stat-card">
            <div class="module-stat-value">${total - active}</div>
            <div class="module-stat-label">Deshabilitados</div>
          </div>
        </div></div>
        
        <div class="module-modal-section">
          <div class="module-modal-section-title">ðŸ“‹ POTs Registrados</div>
          <div class="module-item-list">`;
        
        if (pots.length === 0) {
          html += '<div class="module-empty-state">No hay POTs registrados</div>';
        } else {
          pots.slice(0, 8).forEach(pot => {
            const status = pot.enabled === false ? 'inactive' : 'active';
            html += `
              <div class="module-item">
                <div class="module-item-info">
                  <div class="module-item-name">${pot.id || pot.name}</div>
                  <div class="module-item-desc">${pot.description || 'Sin descripciÃ³n'} â€¢ Severidad: ${pot.severity || 'N/A'}</div>
                </div>
                <span class="module-item-badge ${status}">${status === 'active' ? 'Activo' : 'Inactivo'}</span>
              </div>`;
          });
        }
        
        html += `</div></div>
        
        <div class="module-modal-section">
          <div class="module-modal-section-title">âš¡ Ejecuciones Recientes</div>
          <div class="module-item-list">`;
        
        if (execs.length === 0) {
          html += '<div class="module-empty-state">No hay ejecuciones recientes</div>';
        } else {
          execs.forEach(exec => {
            const status = exec.ok ? 'active' : 'inactive';
            const time = exec.timestamp ? new Date(exec.timestamp).toLocaleString() : 'N/A';
            html += `
              <div class="module-item">
                <div class="module-item-info">
                  <div class="module-item-name">${exec.pot_id || 'Unknown'}</div>
                  <div class="module-item-desc">${time} â€¢ DuraciÃ³n: ${exec.elapsed_ms || 0}ms</div>
                </div>
                <span class="module-item-badge ${status}">${exec.ok ? 'OK' : 'Error'}</span>
              </div>`;
          });
        }
        
        html += '</div></div>';
      } catch (e) {
        html += `<div class="module-stat-card"><div class="module-stat-value error">N/A</div><div class="module-stat-label">Error cargando</div></div></div></div>`;
      }
      
      return html;
    }
    
    async function generateBrainContent(mod) {
      let html = '<div class="module-modal-section"><div class="module-modal-section-title">ðŸ§  Estado del Cerebro</div><div class="module-stats-grid">';
      
      try {
        const res = await fetch('/brain/status');
        const data = await res.json();
        
        html += `
          <div class="module-stat-card">
            <div class="module-stat-value ${data.online ? 'success' : 'error'}">${data.online ? 'Online' : 'Offline'}</div>
            <div class="module-stat-label">Estado</div>
          </div>
          <div class="module-stat-card">
            <div class="module-stat-value">${data.active_goals || 0}</div>
            <div class="module-stat-label">Goals Activos</div>
          </div>
          <div class="module-stat-card">
            <div class="module-stat-value">${data.memory_entries || 0}</div>
            <div class="module-stat-label">Memorias</div>
          </div>
          <div class="module-stat-card">
            <div class="module-stat-value success">${data.uptime_hours || 0}h</div>
            <div class="module-stat-label">Uptime</div>
          </div>
        </div></div>`;
      } catch (e) {
        html += '<div class="module-stat-card"><div class="module-stat-value error">Error</div><div class="module-stat-label">No disponible</div></div></div></div>';
      }
      
      return html;
    }
    
    async function generateMemoryContent(mod) {
      let html = '<div class="module-modal-section"><div class="module-modal-section-title">ðŸ’¾ Memoria Cognitiva</div><div class="module-stats-grid">';
      
      try {
        const res = await fetch('/api/cognitive-memory/lifelog/status');
        const data = await res.json();
        
        if (data.ok) {
          html += `
            <div class="module-stat-card">
              <div class="module-stat-value success">${data.total_entries || 0}</div>
              <div class="module-stat-label">Entradas</div>
            </div>
            <div class="module-stat-card">
              <div class="module-stat-value">${Math.round((data.success_rate || 0) * 100)}%</div>
              <div class="module-stat-label">Tasa Ã‰xito</div>
            </div>
            <div class="module-stat-card">
              <div class="module-stat-value">${data.categories?.length || 0}</div>
              <div class="module-stat-label">CategorÃ­as</div>
            </div>
            <div class="module-stat-card">
              <div class="module-stat-value success">${data.db_size_mb || 0} MB</div>
              <div class="module-stat-label">TamaÃ±o DB</div>
            </div>
          </div></div>`;
        }
      } catch (e) {
        html += '<div class="module-stat-card"><div class="module-stat-value error">N/A</div></div></div></div>';
      }
      
      return html;
    }
    
    async function generateANSContent(mod) {
      let html = '<div class="module-modal-section"><div class="module-modal-section-title">â¤ï¸ Sistema Nervioso AutÃ³nomo</div><div class="module-stats-grid">';
      
      try {
        const res = await fetch('/ans/status');
        const data = await res.json();
        
        if (data.ok) {
          html += `
            <div class="module-stat-card">
              <div class="module-stat-value success">${data.cycles_completed || 0}</div>
              <div class="module-stat-label">Ciclos</div>
            </div>
            <div class="module-stat-card">
              <div class="module-stat-value">${data.active_monitors || 0}</div>
              <div class="module-stat-label">Monitores</div>
            </div>
            <div class="module-stat-card">
              <div class="module-stat-value ${data.health_score >= 80 ? 'success' : 'warning'}">${data.health_score || 0}%</div>
              <div class="module-stat-label">Salud</div>
            </div>
            <div class="module-stat-card">
              <div class="module-stat-value">${data.incidents_resolved || 0}</div>
              <div class="module-stat-label">Incidentes</div>
            </div>
          </div></div>`;
        }
      } catch (e) {
        html += '<div class="module-stat-card"><div class="module-stat-value error">N/A</div></div></div></div>';
      }
      
      return html;
    }
    
    async function generateNervousContent(mod) {
      let html = '<div class="module-modal-section"><div class="module-modal-section-title">ðŸ”— Sistema Nervioso</div><div class="module-stats-grid">';
      
      try {
        const res = await fetch('/nervous/status');
        const data = await res.json();
        
        if (data.ok) {
          html += `
            <div class="module-stat-card">
              <div class="module-stat-value success">Activo</div>
              <div class="module-stat-label">Estado</div>
            </div>
            <div class="module-stat-card">
              <div class="module-stat-value">${data.signals_per_min || 0}</div>
              <div class="module-stat-label">SeÃ±ales/min</div>
            </div>
            <div class="module-stat-card">
              <div class="module-stat-value success">${data.latency_ms || 0}ms</div>
              <div class="module-stat-label">Latencia</div>
            </div>
            <div class="module-stat-card">
              <div class="module-stat-value">${data.uptime_pct || 99.9}%</div>
              <div class="module-stat-label">Uptime</div>
            </div>
          </div></div>`;
        }
      } catch (e) {
        html += '<div class="module-stat-card"><div class="module-stat-value error">N/A</div></div></div></div>';
      }
      
      return html;
    }
    
    async function generateVisionContent(mod) {
      return `<div class="module-modal-section">
        <div class="module-modal-section-title">ðŸ‘ï¸ Sistema de VisiÃ³n</div>
        <div class="module-stats-grid">
          <div class="module-stat-card"><div class="module-stat-value success">3</div><div class="module-stat-label">CÃ¡maras</div></div>
          <div class="module-stat-card"><div class="module-stat-value">1</div><div class="module-stat-label">Activas</div></div>
          <div class="module-stat-card"><div class="module-stat-value success">30</div><div class="module-stat-label">FPS</div></div>
          <div class="module-stat-card"><div class="module-stat-value">0</div><div class="module-stat-label">Detecciones</div></div>
        </div>
      </div>`;
    }
    
    async function generateHandsContent(mod) {
      return `<div class="module-modal-section">
        <div class="module-modal-section-title">ðŸ¤– Manos (EjecuciÃ³n)</div>
        <div class="module-stats-grid">
          <div class="module-stat-card"><div class="module-stat-value success">OK</div><div class="module-stat-label">Shell Executor</div></div>
          <div class="module-stat-card"><div class="module-stat-value">5</div><div class="module-stat-label">PolÃ­ticas</div></div>
          <div class="module-stat-card"><div class="module-stat-value success">100%</div><div class="module-stat-label">Seguridad</div></div>
          <div class="module-stat-card"><div class="module-stat-value">0</div><div class="module-stat-label">Comandos Activos</div></div>
        </div>
      </div>`;
    }
    
    async function generateVoiceContent(mod) {
      return `<div class="module-modal-section">
        <div class="module-modal-section-title">ðŸ”Š Sistema de Voz</div>
        <div class="module-stats-grid">
          <div class="module-stat-card"><div class="module-stat-value success">Activo</div><div class="module-stat-label">TTS Engine</div></div>
          <div class="module-stat-card"><div class="module-stat-value">pyttsx3</div><div class="module-stat-label">Motor</div></div>
          <div class="module-stat-card"><div class="module-stat-value success">OK</div><div class="module-stat-label">Audio Out</div></div>
          <div class="module-stat-card"><div class="module-stat-value">0</div><div class="module-stat-label">Cola</div></div>
        </div>
      </div>`;
    }
    
    async function generateCommsContent(mod) {
      let html = '<div class="module-modal-section"><div class="module-modal-section-title">ðŸ“± Comunicaciones</div><div class="module-stats-grid">';
      
      try {
        const res = await fetch('/ans/comms/status');
        const data = await res.json();
        
        html += `
          <div class="module-stat-card">
            <div class="module-stat-value ${data.whatsapp?.connected ? 'success' : 'error'}">${data.whatsapp?.connected ? 'OK' : 'OFF'}</div>
            <div class="module-stat-label">WhatsApp</div>
          </div>
          <div class="module-stat-card">
            <div class="module-stat-value ${data.telegram?.configured ? 'success' : 'warning'}">${data.telegram?.configured ? 'OK' : 'N/C'}</div>
            <div class="module-stat-label">Telegram</div>
          </div>
          <div class="module-stat-card">
            <div class="module-stat-value ${data.audio?.available ? 'success' : 'error'}">${data.audio?.available ? 'OK' : 'OFF'}</div>
            <div class="module-stat-label">Audio</div>
          </div>
          <div class="module-stat-card">
            <div class="module-stat-value">${data.messages_today || 0}</div>
            <div class="module-stat-label">Mensajes Hoy</div>
          </div>
        </div></div>`;
      } catch (e) {
        html += '<div class="module-stat-card"><div class="module-stat-value error">Error</div></div></div></div>';
      }
      
      return html;
    }
    
    async function generateNavigationContent(mod) {
      return `<div class="module-modal-section">
        <div class="module-modal-section-title">ðŸ§­ NavegaciÃ³n Digital</div>
        <div class="module-stats-grid">
          <div class="module-stat-card"><div class="module-stat-value success">Playwright</div><div class="module-stat-label">Driver</div></div>
          <div class="module-stat-card"><div class="module-stat-value">0</div><div class="module-stat-label">Sesiones</div></div>
          <div class="module-stat-card"><div class="module-stat-value success">OK</div><div class="module-stat-label">PolÃ­ticas</div></div>
          <div class="module-stat-card"><div class="module-stat-value">0</div><div class="module-stat-label">Navegaciones</div></div>
        </div>
      </div>`;
    }
    
    async function generateGenericContent(mod) {
      return `<div class="module-modal-section">
        <div class="module-modal-section-title">â„¹ï¸ InformaciÃ³n del MÃ³dulo</div>
        <div class="module-stats-grid">
          <div class="module-stat-card">
            <div class="module-stat-value ${mod.status === 'ok' ? 'success' : 'error'}">${mod.status === 'ok' ? 'Conectado' : 'Error'}</div>
            <div class="module-stat-label">Estado</div>
          </div>
          <div class="module-stat-card">
            <div class="module-stat-value">N/A</div>
            <div class="module-stat-label">Detalles no disponibles</div>
          </div>
        </div>
      </div>`;
    }

    function updateSystemBadge() {
      const connected = MODULES.filter(m => m.status === 'ok').length;
      const percentage = Math.round((connected / MODULES.length) * 100);
      const badge = document.getElementById('system-status-badge');
      if (badge) {
        badge.textContent = `${percentage}% OPERATIVO`;
        badge.style.background = percentage === 100 ? 'var(--accent-green)' : 
                                  percentage >= 80 ? 'var(--accent-orange)' : 'var(--accent-red)';
      }
    }

    async function reconnectModule(moduleId) {
      addActivity(`Reconectando mÃ³dulo: ${moduleId}...`, 'info');
      try {
        const res = await fetch(`${API_BASE}/modules/reconnect/${moduleId}`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          addActivity(`MÃ³dulo ${moduleId} reconectado`, 'success');
          // Actualizar estado del mÃ³dulo en la UI
          const idx = MODULES.findIndex(m => m.id === moduleId);
          if (idx >= 0) {
            MODULES[idx].status = 'ok';
            renderModules();
          }
        } else {
          addActivity(`Error reconectando ${moduleId}: ${data.error}`, 'error');
        }
      } catch (e) {
        addActivity(`Error: ${e.message}`, 'error');
      }
    }

    async function runFullDiagnostic() {
      addActivity('Ejecutando diagnÃ³stico completo del sistema...', 'info');
      try {
        const res = await fetch(`${API_BASE}/doctor`);
        const data = await res.json();
        addActivity('DiagnÃ³stico completado: todos los mÃ³dulos OK', 'success');
      } catch (e) {
        addActivity('Error en diagnÃ³stico: ' + e.message, 'error');
      }
    }

    // Vision/Camera functions
    let selectedCamera = null;
    
    function getCameraIcon(name) {
      const nameLower = (name || '').toLowerCase();
      if (nameLower.includes('insta360') || nameLower.includes('360')) return 'ðŸŽ¥';
      if (nameLower.includes('ir') || nameLower.includes('infrared')) return 'ðŸ‘ï¸';
      if (nameLower.includes('webcam') || nameLower.includes('web cam')) return 'ðŸ’»';
      if (nameLower.includes('usb')) return 'ðŸ”Œ';
      if (nameLower.includes('nexigo')) return 'ðŸ“¹';
      if (nameLower.includes('logitech')) return 'ðŸŽ¬';
      if (nameLower.includes('microsoft')) return 'ðŸªŸ';
      if (nameLower.includes('integrated') || nameLower.includes('built-in')) return 'ðŸ’»';
      return 'ðŸ“·';
    }
    let streamingCamera = null;

    function selectCamera(camId, event) {
      // Evitar propagaciÃ³n si se hace click en el botÃ³n
      if (event) event.stopPropagation();
      
      selectedCamera = camId;
      
      // Quitar selecciÃ³n anterior de todas las filas de cÃ¡maras
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('selected');
      });
      
      // Marcar la fila actual como seleccionada usando data-cam-id
      const selectedRow = document.querySelector(`#cameras-list .module-row[data-cam-id="${camId}"]`);
      if (selectedRow) {
        selectedRow.classList.add('selected');
      }
      
      // Actualizar info
      const camName = selectedRow ? selectedRow.querySelector('.module-name-text').textContent : `CÃ¡mara ${camId}`;
      document.getElementById('camera-info').textContent = `${camName} seleccionada`;
      addActivity(`${camName} seleccionada`, 'info');
      
      // Capturar frame de preview
      captureSnapshot();
    }

    function streamCamera(camId, event) {
      if (event) event.stopPropagation();
      
      // Quitar streaming anterior
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('streaming');
      });
      
      streamingCamera = camId;
      selectedCamera = camId;
      
      // Quitar selecciÃ³n y marcar como streaming
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('selected');
      });
      
      const streamRow = document.querySelector(`#cameras-list .module-row[data-cam-id="${camId}"]`);
      if (streamRow) {
        streamRow.classList.add('streaming');
        streamRow.classList.add('selected');
      }
      
      // Iniciar stream de video continuo
      const preview = document.getElementById('vision-preview');
      preview.innerHTML = `
        <div style="position: relative;">
          <img id="stream-img-${camId}" style="max-width: 100%; border-radius: 8px; min-height: 200px; background: var(--bg);">
          <div style="position: absolute; top: 10px; right: 10px; background: var(--accent-red); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
            ðŸ”´ LIVE
          </div>
        </div>
      `;
      
      const camName = streamRow ? streamRow.querySelector('.module-name-text').textContent : `CÃ¡mara ${camId}`;
      document.getElementById('camera-info').textContent = `ðŸ”´ STREAMING - ${camName}`;
      addActivity(`Stream iniciado: ${camName}`, 'success');
      
      // Actualizar contadores
      document.getElementById('vision-active').textContent = '1';
      
      // Actualizar frames continuamente
      updateStreamFrame(camId);
    }
    
    async function updateStreamFrame(camId) {
      if (streamingCamera !== camId) return;
      
      try {
        const res = await fetch(`${API_BASE}/vision/capture/${camId}`);
        const data = await res.json();
        if (data.ok && data.image_base64) {
          const img = document.getElementById(`stream-img-${camId}`);
          if (img) {
            img.src = `data:image/jpeg;base64,${data.image_base64}`;
          }
        }
      } catch (e) {
        console.error('Stream error:', e);
      }
      
      // Siguiente frame (aprox 10 FPS)
      if (streamingCamera === camId) {
        setTimeout(() => updateStreamFrame(camId), 100);
      }
    }
    
    function stopStream() {
      const wasStreaming = streamingCamera;
      streamingCamera = null;
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('streaming');
      });
      document.getElementById('vision-active').textContent = '0';
      if (wasStreaming !== null) {
        addActivity('Stream detenido', 'info');
        document.getElementById('camera-info').textContent = selectedCamera !== null ? `CÃ¡mara ${selectedCamera} seleccionada` : 'Ninguna cÃ¡mara seleccionada';
      }
    }
    
    function startStreamSelected() {
      if (selectedCamera === null) {
        addActivity('Selecciona una cÃ¡mara primero', 'error');
        return;
      }
      streamCamera(selectedCamera, null);
    }

    async function scanCameras() {
      addActivity('Escaneando cÃ¡maras...', 'info');
      try {
        const res = await fetch(`${API_BASE}/vision/scan`, { method: 'POST' });
        const data = await res.json();
        addActivity(`CÃ¡maras encontradas: ${data.cameras?.length || 0}`, 'success');
      } catch (e) {
        addActivity('Error escaneando: ' + e.message, 'error');
      }
    }

    function readTextOCR() {
      if (selectedCamera === null) {
        addActivity('Selecciona una cÃ¡mara primero', 'error');
        return;
      }
      addActivity('Leyendo texto (OCR)...', 'info');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Sistema de Actualizaciones
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function checkForUpdates() {
      const btn = document.getElementById('btn-check-update');
      const originalText = btn ? btn.innerHTML : '';
      
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = 'â³ Buscando...';
        btn.classList.add('checking');
      }
      
      addActivity('ðŸ” Buscando actualizaciones...', 'info');
      
      try {
        const res = await fetch(`${API_BASE}/version`, { cache: 'no-store' });
        if (res.ok) {
          const data = await res.json();
          const serverVersion = data.version || 'unknown';
          
          if (serverVersion !== ATLAS_VERSION && serverVersion !== 'unknown') {
            addActivity(`ðŸ”„ Nueva versiÃ³n disponible: ${serverVersion}`, 'success');
            if (confirm(`Nueva versiÃ³n disponible: ${serverVersion}\n\nÂ¿Desea actualizar ahora?`)) {
              location.reload(true);
            }
          } else {
            addActivity(`âœ… Sistema actualizado (v${ATLAS_VERSION})`, 'success');
          }
        } else {
          addActivity(`âœ… v${ATLAS_VERSION} - Sistema actualizado`, 'success');
        }
      } catch (e) {
        addActivity(`âš ï¸ Error verificando: ${e.message}`, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText;
          btn.classList.remove('checking');
        }
      }
    }

    function updateModuleCounter() {
      const connected = MODULES.filter(m => m.status === 'ok').length;
      document.getElementById('modules-counter').textContent = `${connected}/${MODULES.length}`;
      document.getElementById('stat-connected').textContent = connected;
      document.getElementById('stat-total').textContent = MODULES.length;
      document.getElementById('stat-health').textContent = Math.round((connected / MODULES.length) * 100) + '%';
    }

    // Time update
    function updateTime() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleTimeString('es-ES');
    }

    // Activity log
    function addActivity(message, type = 'info', source = 'system') {
      const time = new Date().toLocaleTimeString('es-ES');
      activityLog.unshift({ time, message, type });
      if (activityLog.length > 50) activityLog.pop();
      renderActivity();
      
      // TambiÃ©n agregar a la bitÃ¡cora central
      addToBitacora(message, type, source);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TTS - ATLAS habla eventos importantes
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let atlasTTSEnabled = localStorage.getItem('atlas-tts') !== 'off';
    let _dashIsSpeaking = false;

    const _MUTE_KEY = 'atlas-global-voice-mute-until';
    const _MUTE_MS = 30000;

    function _dashGlobalMute() {
      const until = Date.now() + _MUTE_MS;
      try { localStorage.setItem(_MUTE_KEY, String(until)); } catch(e) {}
      if (_dashIsSpeaking) { window.speechSynthesis.cancel(); _dashIsSpeaking = false; }
    }

    function _dashShouldSuppress() {
      try {
        const until = parseInt(localStorage.getItem(_MUTE_KEY) || '0', 10);
        if (Date.now() < until) return true;
      } catch(e) {}
      if (!document.hasFocus()) return true;
      const el = document.activeElement;
      if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' ||
          (el.closest && el.closest('[contenteditable]')))) return true;
      return false;
    }

    document.addEventListener('keydown', (e) => {
      if (!e.ctrlKey && !e.altKey && !e.metaKey) _dashGlobalMute();
    });
    document.addEventListener('mousedown', (e) => {
      if (e.target.closest('input,textarea,button,[contenteditable]')) _dashGlobalMute();
    });

    function atlasSpeak(text) {
      if (!atlasTTSEnabled || !window.speechSynthesis || !text) return;
      if (_dashShouldSuppress()) return;
      if (_dashIsSpeaking) return;
      let clean = String(text)
        .replace(/```[\s\S]*?```/g, '. Codigo. ')
        .replace(/`[^`]*`/g, '').replace(/\*\*/g, '').replace(/\*/g, '')
        .replace(/#{1,6}\s?/g, '').replace(/\[([^\]]*)\]\([^)]*\)/g, '$1')
        .replace(/[_~>|]/g, ' ').replace(/\n+/g, '. ')
        .replace(/\.{2,}/g, '.').replace(/\s{2,}/g, ' ')
        .trim().substring(0, 300);
      if (!clean) return;
      _dashDoSpeak(clean);
    }

    function _dashDoSpeak(clean) {
      if (_dashShouldSuppress() || !atlasTTSEnabled || !window.speechSynthesis) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(clean);
      utter.lang = 'es-ES'; utter.rate = 1.05; utter.pitch = 1.0; utter.volume = 1.0;
      const voices = window.speechSynthesis.getVoices();
      const esVoice = voices.find(v => v.lang.startsWith('es') && v.name.includes('Google')) ||
                      voices.find(v => v.lang.startsWith('es') && !v.localService) ||
                      voices.find(v => v.lang.startsWith('es'));
      if (esVoice) utter.voice = esVoice;
      _dashIsSpeaking = true;
      utter.onend = () => { _dashIsSpeaking = false; };
      utter.onerror = () => { _dashIsSpeaking = false; };
      window.speechSynthesis.speak(utter);
    }

    function toggleAtlasTTS() {
      atlasTTSEnabled = !atlasTTSEnabled;
      localStorage.setItem('atlas-tts', atlasTTSEnabled ? 'on' : 'off');
      const btn = document.getElementById('tts-toggle');
      if (btn) {
        btn.textContent = atlasTTSEnabled ? '\uD83D\uDD0A' : '\uD83D\uDD07';
        btn.title = atlasTTSEnabled ? 'ATLAS habla (click para silenciar)' : 'ATLAS silenciado (click para activar)';
      }
      atlasSpeak(atlasTTSEnabled ? 'Voz activada' : '');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BitÃ¡cora Central
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const SPEAK_TYPES = ['error', 'warning', 'critical'];
    const SPEAK_SOURCES = ['telegram', 'whatsapp', 'governance', 'healing', 'audit'];
    const APPROVAL_RE = /\b(deploy|git push|npm install|pip install|delete|eliminar|borrar|drop table|drop database|factory reset|migration|production|publish|release|aprobar|permiso|confirm|critical|destructi)/i;
    const ROUTINE_RE = /Ciclo finalizado|Ciclo de monitoreo|Sistema inicializado|Dashboard v|Sistema ATLAS iniciado|Conectando al cerebro|cargado$|Arquitectura cognitiva|nothing to install|Sistema cognitivo/i;

    function addToBitacora(message, type = 'info', source = 'system', syncToServer = true) {
      const time = new Date().toLocaleTimeString('es-ES');
      const isRoutine = ROUTINE_RE.test(message);
      const needsApproval = !isRoutine && APPROVAL_RE.test(message);

      // Deduplicar: si el mismo mensaje llego en los ultimos 30s, ignorar
      const isDupe = bitacoraLog.length > 0 && bitacoraLog.some(e =>
        e.message === message && (Date.now() - e.timestamp) < 30000
      );
      if (isDupe) return;

      const entry = {
        id: Date.now(),
        time,
        message,
        type,
        source,
        timestamp: Date.now(),
        approval: needsApproval
      };
      
      bitacoraLog.unshift(entry);
      if (bitacoraLog.length > 200) bitacoraLog.pop();

      renderBitacora();
      updateBitacoraStats();

      if (SPEAK_TYPES.includes(type) || SPEAK_SOURCES.includes(source) || needsApproval) {
        atlasSpeak(message);
      }

      if (syncToServer && source !== 'server') {
        syncBitacoraToServer(message, type, source);
      }
    }
    
    function renderBitacora() {
      const content = document.getElementById('bitacora-content');
      if (!content) return;
      
      let filtered = bitacoraLog;
      if (bitacoraFilter === 'pending') {
        filtered = bitacoraLog.filter(e => !e.state && (e.approval || APPROVAL_RE.test(e.message)));
      } else if (bitacoraFilter !== 'all') {
        filtered = bitacoraLog.filter(e => e.type === bitacoraFilter || e.source === bitacoraFilter);
      }
      
      const html = [];
      filtered.slice(0, 200).forEach((entry, idx) => {
        try {
          const realIdx = bitacoraLog.indexOf(entry);
          const sourceIcon = getSourceIcon(entry.source || 'system');
          const stateClass = entry.state || '';
          const msg = escapeHtml(String(entry.message || ''));
          const needsApproval = !entry.state && (entry.approval || APPROVAL_RE.test(entry.message));
          let statusBadge = '';
          let actionBtns = '';
          if (entry.state === 'approved') {
            statusBadge = '<span class="entry-status st-approved">APROBADO</span>';
          } else if (entry.state === 'rejected') {
            statusBadge = '<span class="entry-status st-rejected">RECHAZADO</span>';
          } else if (needsApproval) {
            actionBtns = `<div class="entry-actions">
              <button class="btn-approve" onclick="approveBitacoraEntry(${realIdx})" title="Aprobar">&#10003; OK</button>
              <button class="btn-reject" onclick="rejectBitacoraEntry(${realIdx})" title="Rechazar">&#10007; No</button>
            </div>`;
          }
          html.push(`<div class="bitacora-entry ${entry.type || ''} ${entry.source || ''} ${stateClass}${needsApproval ? ' needs-approval' : ''}" id="bentry-${idx}">
            <span class="bitacora-time">${entry.time || ''}</span>
            <span class="bitacora-source">${sourceIcon}</span>
            <span class="bitacora-msg">${msg}${statusBadge}</span>
            ${actionBtns}
          </div>`);
        } catch(e) { console.error('Bitacora render error:', e); }
      });
      content.innerHTML = html.join('');
      
      if (content.scrollTop < 50) {
        content.scrollTop = 0;
      }
    }

    function approveBitacoraEntry(idx) {
      if (!bitacoraLog[idx] || bitacoraLog[idx].state) return;
      bitacoraLog[idx].state = 'approved';
      renderBitacora();
      syncBitacoraAction(idx, 'approved');
      atlasSpeak('Operacion aprobada');
    }

    function rejectBitacoraEntry(idx) {
      if (!bitacoraLog[idx] || bitacoraLog[idx].state) return;
      bitacoraLog[idx].state = 'rejected';
      renderBitacora();
      syncBitacoraAction(idx, 'rejected');
      atlasSpeak('Operacion rechazada');
    }

    function syncBitacoraAction(idx, action) {
      const entry = bitacoraLog[idx];
      if (!entry) return;
      fetch('/bitacora/log', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ message: entry.message, type: entry.type, source: entry.source, action })
      }).catch(() => {});
    }

    function exportBitacora() {
      const data = bitacoraLog.map(e => `[${e.time}] [${e.source}] [${e.type}] ${e.message} ${e.state ? '(' + e.state + ')' : ''}`).join('\n');
      const blob = new Blob([data], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `atlas_bitacora_${new Date().toISOString().slice(0,10)}.txt`;
      a.click();
    }
    
    function getSourceIcon(source) {
      const icons = {
        system: 'âš™ï¸',
        brain: 'ðŸ§ ',
        vision: 'ðŸ‘ï¸',
        nervous: 'âš¡',
        modules: 'ðŸ“¦',
        chat: 'ðŸ’¬',
        ai: 'ðŸ¤–',
        governance: 'ðŸ›¡ï¸',
        update: 'ðŸ”„',
        telegram: 'âœˆï¸',
        whatsapp: 'ðŸ“±',
        comms: 'ðŸ“¡',
        robot: 'ðŸ¤–',
        healing: 'ðŸ’Š',
        audit: 'ðŸ”’',
        scheduler: 'â°',
        incident: 'ðŸ”§',
        evolution: 'ðŸ§¬',
        ops: 'ðŸ§¾'
      };
      return icons[source] || 'ðŸ“‹';
    }
    
    function updateBitacoraStats() {
      const countEl = document.getElementById('bitacora-count');
      const sessionEl = document.getElementById('bitacora-session');
      
      if (countEl) {
        countEl.textContent = `${bitacoraLog.length} eventos`;
      }
      
      if (sessionEl) {
        const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const mins = Math.floor((elapsed % 3600) / 60);
        const secs = elapsed % 60;
        sessionEl.textContent = `SesiÃ³n: ${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
    }
    
    function toggleBitacora() { }
    function toggleBitacoraSize() { }
    function showBitacora() { }
    function hideBitacora() { }
    
    function clearBitacora() {
      if (confirm('Â¿Limpiar toda la bitÃ¡cora?')) {
        bitacoraLog = [];
        renderBitacora();
        updateBitacoraStats();
        addToBitacora('BitÃ¡cora limpiada', 'info', 'system');
      }
    }
    
    function initBitacora() {
      // Event listeners para filtros
      document.querySelectorAll('.bitacora-filter').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.bitacora-filter').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          bitacoraFilter = btn.getAttribute('data-filter');
          renderBitacora();
        });
      });
      
      // Actualizar tiempo de sesiÃ³n cada segundo
      setInterval(updateBitacoraStats, 1000);
      
      // Cargar bitÃ¡cora del servidor
      loadBitacoraFromServer();
      
      // Polling para nuevas entradas cada 15 segundos
      setInterval(pollBitacora, 15000);

      // Polling Telegram/WhatsApp cada 20 segundos
      pollComms();
      setInterval(pollComms, 20000);

      // Polling centralizado: todos los sistemas vitales
      setTimeout(pollAllSystems, 3000);
      setInterval(pollAllSystems, 30000);

      // Kernel Event Bus: eventos internos
      pollEventBus();
      setInterval(pollEventBus, 25000);

      // Audit trail
      pollAudit();
      setInterval(pollAudit, 45000);

      // Healing / anomalias
      pollHealing();
      setInterval(pollHealing, 60000);

      // Cognitive Memory systems status
      pollCognitiveMemory();
      setInterval(pollCognitiveMemory, 120000);

      // Reactor autonomo
      pollReactor();
      setInterval(pollReactor, 60000);

      // Autonomia (cada 10s)
      loadAutonomia();
      setInterval(loadAutonomia, 10000);

      // Entrada inicial
      addToBitacora('Sistema ATLAS iniciado', 'success', 'system');
      addToBitacora(`Dashboard v${ATLAS_VERSION} cargado`, 'info', 'system');

      // Saludo de voz al cargar
      setTimeout(() => atlasSpeak('Atlas en linea. Dashboard cargado.'), 1500);

      // TTS button state
      const ttsBtn = document.getElementById('tts-toggle');
      if (ttsBtn) {
        ttsBtn.textContent = atlasTTSEnabled ? '\uD83D\uDD0A' : '\uD83D\uDD07';
        ttsBtn.title = atlasTTSEnabled ? 'ATLAS habla (click para silenciar)' : 'ATLAS silenciado (click para activar)';
      }

      // Footer y badge con version dinamica
      const footer = document.getElementById('main-footer');
      if (footer) footer.innerHTML = `<span>ATLAS</span>&nbsp;v${ATLAS_VERSION} &nbsp;|&nbsp; ${ATLAS_BUILD_DATE}`;
      const badge = document.getElementById('version-badge');
      if (badge) badge.textContent = `v${ATLAS_VERSION}`;
    }
    
    let lastBitacoraId = 0;
    
    async function loadBitacoraFromServer() {
      try {
        const res = await fetch(`${API_BASE}/ans/bitacora?limit=100`);
        const data = await res.json();
        if (data.ok && data.entries) {
          // Combinar con entradas locales, evitando duplicados
          data.entries.forEach(entry => {
            // Convertir formato del servidor al formato local
            const ts = entry.timestamp ? new Date(entry.timestamp) : new Date();
            const localEntry = {
              id: ts.getTime(),
              time: ts.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit', second: '2-digit'}),
              message: entry.message || '',
              type: entry.level || 'info',
              source: entry.source || 'system',
              timestamp: ts.getTime()
            };
            const isDupe = bitacoraLog.some(e => 
              Math.abs(e.timestamp - localEntry.timestamp) < 30000 && 
              e.message === localEntry.message
            );
            if (!isDupe) {
              localEntry.approval = !ROUTINE_RE.test(localEntry.message) && APPROVAL_RE.test(localEntry.message);
              bitacoraLog.push(localEntry);
            }
          });
          // Ordenar por timestamp (mÃ¡s reciente primero)
          bitacoraLog.sort((a, b) => b.timestamp - a.timestamp);
          if (bitacoraLog.length > 0) {
            lastBitacoraId = bitacoraLog[0].id;
          }
          renderBitacora();
          updateBitacoraStats();
        }
      } catch (e) {
        console.error('Error loading bitacora:', e);
      }
    }
    
    async function pollBitacora() {
      try {
        const res = await fetch(`${API_BASE}/ans/bitacora?limit=20`);
        const data = await res.json();
        if (data.ok && data.entries && data.entries.length > 0) {
          let newEntries = 0;
          data.entries.forEach(entry => {
            const ts = entry.timestamp ? new Date(entry.timestamp) : new Date();
            const localEntry = {
              id: ts.getTime(),
              time: ts.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit', second: '2-digit'}),
              message: entry.message || '',
              type: entry.level || 'info',
              source: entry.source || 'system',
              timestamp: ts.getTime()
            };
            const isDupe = bitacoraLog.some(e => 
              Math.abs(e.timestamp - localEntry.timestamp) < 30000 && 
              e.message === localEntry.message
            );
            if (!isDupe && !ROUTINE_RE.test(localEntry.message)) {
              localEntry.approval = !ROUTINE_RE.test(localEntry.message) && APPROVAL_RE.test(localEntry.message);
              bitacoraLog.unshift(localEntry);
              newEntries++;
            }
          });
          
          if (newEntries > 0) {
            bitacoraLog.sort((a, b) => b.timestamp - a.timestamp);
            renderBitacora();
            updateBitacoraStats();
          }
        }
      } catch (e) {
        // Silenciar errores de polling
      }
    }
    
    let lastCommsTs = 0;
    async function pollComms() {
      try {
        const res = await fetch(`${API_BASE}/api/comms/recent?limit=30`);
        const data = await res.json();
        const msgs = data.messages || data.recent || data.entries || [];
        if (!Array.isArray(msgs) || msgs.length === 0) return;
        let added = 0;
        msgs.forEach(m => {
          const ts = m.timestamp ? new Date(m.timestamp).getTime() : Date.now();
          if (ts <= lastCommsTs) return;
          const channel = (m.channel || m.source || '').toLowerCase();
          let src = 'comms';
          if (channel.includes('telegram')) src = 'telegram';
          else if (channel.includes('whatsapp') || channel.includes('wha')) src = 'whatsapp';
          const direction = m.direction === 'out' ? 'â†’' : 'â†';
          const text = `${direction} ${m.text || m.message || m.body || '(sin contenido)'}`;
          const isDupe = bitacoraLog.some(e => Math.abs(e.timestamp - ts) < 2000 && e.message === text);
          if (!isDupe) {
            bitacoraLog.unshift({
              id: ts, timestamp: ts, source: src, type: 'info',
              time: new Date(ts).toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit',second:'2-digit'}),
              message: text
            });
            added++;
            if (m.direction !== 'out') {
              atlasSpeak(`Mensaje de ${src}: ${m.text || m.message || m.body || ''}`);
            }
          }
        });
        if (added > 0) {
          lastCommsTs = Math.max(...msgs.map(m => new Date(m.timestamp || 0).getTime()));
          bitacoraLog.sort((a, b) => b.timestamp - a.timestamp);
          renderBitacora();
          updateBitacoraStats();
        }
      } catch(e) {}
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // POLLING CENTRALIZADO - Todos los sistemas vitales
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _prevSystemState = {};

    async function pollAllSystems() {
      try {
        const [statusRes, brainRes, govRes, nervRes, healRes] = await Promise.allSettled([
          fetch(`${API_BASE}/status`).then(r => r.json()),
          fetch(`${API_BASE}/brain/status`).then(r => r.json()),
          fetch(`${API_BASE}/governance/status`).then(r => r.json()),
          fetch(`${API_BASE}/api/nerve/status`).then(r => r.json()),
          fetch(`${API_BASE}/api/health/comprehensive`).then(r => r.json())
        ]);

        // NEXUS connection changes
        if (statusRes.status === 'fulfilled') {
          const s = statusRes.value;
          if (_prevSystemState.nexus !== undefined && _prevSystemState.nexus !== s.nexus_connected) {
            addToBitacora(s.nexus_connected ? 'NEXUS reconectado' : 'NEXUS desconectado', s.nexus_connected ? 'success' : 'error', 'nervous');
          }
          if (_prevSystemState.robot !== undefined && _prevSystemState.robot !== s.robot_connected) {
            addToBitacora(s.robot_connected ? 'Robot reconectado' : 'Robot desconectado', s.robot_connected ? 'success' : 'error', 'nervous');
          }
          _prevSystemState.nexus = s.nexus_connected;
          _prevSystemState.robot = s.robot_connected;
        }

        // Brain state changes
        if (brainRes.status === 'fulfilled') {
          const b = brainRes.value;
          if (_prevSystemState.brainMode && _prevSystemState.brainMode !== b.mode) {
            addToBitacora(`Cerebro cambio a modo: ${b.mode}`, 'info', 'brain');
          }
          _prevSystemState.brainMode = b.mode;
        }

        // Governance mode changes
        if (govRes.status === 'fulfilled') {
          const g = govRes.value;
          if (_prevSystemState.govMode && _prevSystemState.govMode !== g.mode) {
            addToBitacora(`Gobernanza: modo cambiado a ${g.mode}`, 'warning', 'governance');
          }
          if (g.emergency_stop && !_prevSystemState.emergency) {
            addToBitacora('EMERGENCY STOP activado', 'error', 'governance');
          }
          _prevSystemState.govMode = g.mode;
          _prevSystemState.emergency = g.emergency_stop;
        }

        // Health score drops
        if (healRes.status === 'fulfilled') {
          const h = healRes.value;
          const score = h.score || h.system_score;
          if (score !== undefined) {
            if (_prevSystemState.healthScore && score < _prevSystemState.healthScore - 10) {
              addToBitacora(`Salud del sistema bajo: ${score}% (era ${_prevSystemState.healthScore}%)`, 'warning', 'system');
            }
            _prevSystemState.healthScore = score;
          }
          if (h.anomalies && h.anomalies.length > 0 && h.anomalies.length !== _prevSystemState.anomalyCount) {
            h.anomalies.slice(0, 3).forEach(a => {
              addToBitacora(`Anomalia: ${a.message || a.description || JSON.stringify(a).substring(0,80)}`, 'warning', 'system');
            });
            _prevSystemState.anomalyCount = h.anomalies.length;
          }
        }
      } catch(e) {}
    }

    let _lastEventBusTs = 0;
    async function pollEventBus() {
      try {
        const res = await fetch(`${API_BASE}/api/kernel/event-bus/history?limit=15`);
        const data = await res.json();
        const events = data.events || [];
        events.forEach(ev => {
          const ts = ev.timestamp ? new Date(ev.timestamp).getTime() : 0;
          if (ts <= _lastEventBusTs) return;
          const msg = `[${ev.type || ev.event || 'event'}] ${ev.data?.message || ev.message || ev.description || ''}`.trim();
          if (msg.length > 10 && !ROUTINE_RE.test(msg)) {
            addToBitacora(msg, ev.level || 'info', ev.source || 'system');
          }
        });
        if (events.length > 0) {
          const maxTs = Math.max(...events.map(e => new Date(e.timestamp || 0).getTime()));
          if (maxTs > _lastEventBusTs) _lastEventBusTs = maxTs;
        }
      } catch(e) {}
    }

    let _lastAuditTs = 0;
    async function pollAudit() {
      try {
        const res = await fetch(`${API_BASE}/audit/tail?n=10`);
        const data = await res.json();
        const entries = data.entries || [];
        entries.forEach(entry => {
          const ts = entry.timestamp ? new Date(entry.timestamp).getTime() : 0;
          if (ts <= _lastAuditTs) return;
          const success = entry.success !== false;
          const msg = `[AUDIT] ${entry.module || ''}.${entry.action || ''} ${!success ? 'FALLO' : ''} ${entry.error || ''}`.trim();
          if (!success) {
            addToBitacora(msg, 'error', 'governance');
          }
        });
        if (entries.length > 0) {
          const maxTs = Math.max(...entries.map(e => new Date(e.timestamp || 0).getTime()));
          if (maxTs > _lastAuditTs) _lastAuditTs = maxTs;
        }
      } catch(e) {}
    }

    let _lastHealingCount = 0;
    async function pollHealing() {
      try {
        const res = await fetch(`${API_BASE}/api/healing/history?limit=5`);
        const data = await res.json();
        const history = data.history || [];
        if (history.length > _lastHealingCount && _lastHealingCount > 0) {
          history.slice(0, history.length - _lastHealingCount).forEach(h => {
            addToBitacora(`[HEALING] ${h.strategy || ''}: ${h.result || h.message || 'auto-reparacion'}`, h.success ? 'success' : 'warning', 'system');
          });
        }
        _lastHealingCount = history.length;
      } catch(e) {}
    }

    let _prevCogMemState = {};
    async function pollCognitiveMemory() {
      try {
        const [wmRes, llRes, abRes] = await Promise.allSettled([
          fetch(`${API_BASE}/api/cognitive-memory/world-model/status`).then(r => r.json()),
          fetch(`${API_BASE}/api/cognitive-memory/lifelog/status`).then(r => r.json()),
          fetch(`${API_BASE}/api/cognitive-memory/autobiographical/status`).then(r => r.json()),
        ]);

        if (wmRes.status === 'fulfilled' && wmRes.value.ok) {
          const wm = wmRes.value;
          if (_prevCogMemState.wmEntities !== undefined && wm.total_entities > _prevCogMemState.wmEntities + 5) {
            addToBitacora(`World Model: ${wm.total_entities} entidades (+${wm.total_entities - _prevCogMemState.wmEntities})`, 'info', 'brain');
          }
          _prevCogMemState.wmEntities = wm.total_entities;
        }

        if (llRes.status === 'fulfilled' && llRes.value.ok) {
          const ll = llRes.value;
          const prevF = _prevCogMemState.llFailures || 0;
          if (ll.failure_count > prevF) {
            const newFails = ll.failure_count - prevF;
            addToBitacora(`Lifelog: ${newFails} nuevo(s) fallo(s) detectados (total: ${ll.failure_count})`, 'warning', 'healing');
            addToBitacora(`Reactor activado para analizar ${newFails} fallo(s)`, 'info', 'healing');
            pollReactor();
          }
          _prevCogMemState.llFailures = ll.failure_count;
        }

        if (abRes.status === 'fulfilled' && abRes.value.ok) {
          const ab = abRes.value;
          if (ab.milestones > (_prevCogMemState.abMilestones || 0)) {
            addToBitacora(`Nuevo hito autobiografico registrado (total: ${ab.milestones})`, 'success', 'brain');
          }
          _prevCogMemState.abMilestones = ab.milestones;
        }
      } catch(e) {}
    }

    let _prevReactorActions = 0;
    async function pollReactor() {
      try {
        const res = await fetch(`${API_BASE}/ans/reactor/run`, { method: 'POST' });
        const data = await res.json();
        if (!data.ok) return;
        if (data.issues_found > 0) {
          for (const issue of (data.issues || [])) {
            const sev = issue.severity === 'critical' ? 'error' : (issue.severity === 'high' ? 'warning' : 'info');
            addToBitacora(`Reactor detectÃ³: ${issue.message}`, sev, 'healing');
          }
          for (const action of (data.actions_taken || [])) {
            if (action.ok) {
              addToBitacora(`Reactor reparÃ³: ${action.message}`, 'success', 'healing');
              atlasSpeak(`ReparaciÃ³n automÃ¡tica: ${action.message}`);
            } else {
              addToBitacora(`Reactor fallÃ³ al reparar: ${action.message}`, 'error', 'healing');
              atlasSpeak(`AtenciÃ³n: no pude reparar ${action.action}`);
            }
          }
        }
      } catch(e) {}
    }

    async function syncBitacoraToServer(message, level, source) {
      try {
        await fetch(`${API_BASE}/bitacora/log`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, level, source })
        });
      } catch (e) {
        // Silenciar errores
      }
    }

    function renderActivity() {
      const lists = ['activity-list', 'modules-activity-list'];
      lists.forEach(listId => {
        const list = document.getElementById(listId);
        if (list) {
          list.innerHTML = activityLog.slice(0, 10).map(item => `
            <div class="activity-item ${item.type}">
              <div class="activity-time">${item.time}</div>
              <div class="activity-message">${item.message}</div>
            </div>
          `).join('');
        }
      });
    }

    function clearActivity() {
      activityLog = [];
      renderActivity();
    }

    // API calls
    async function loadInitialData() {
      try {
        addActivity('Conectando al cerebro...', 'info');
        
        // 1. Verificar estado del cerebro
        const brainRes = await fetch(`${API_BASE}/brain/status`);
        if (brainRes.ok) {
          const brain = await brainRes.json();
          if (brain.connected) {
            addActivity('Cerebro conectado', 'success', 'brain');
            document.getElementById('cerebro-dot').classList.remove('offline');
          }
        }
        
        // 2. Cargar estado de todos los mÃ³dulos
        await loadModulesFromAPI();
        
        // 3. Cargar configuraciÃ³n de IA
        await loadAIConfig();
        
        // 4. Cargar estado de gobernanza + autonomÃ­a
        await loadGovernanceStatus();
        await loadAutonomia();
        
        // 5. Verificar cÃ¡maras
        await loadCameras();
        
        addActivity('Sistema inicializado correctamente', 'success');
      } catch (e) {
        addActivity('Error conectando: ' + e.message, 'error');
        document.getElementById('cerebro-dot').classList.add('offline');
      }
    }

    let _prevModuleStates = {};
    async function loadModulesFromAPI() {
      try {
        const res = await fetch(`${API_BASE}/modules/check-all`);
        const data = await res.json();
        if (data.ok && data.modules) {
          data.modules.forEach(mod => {
            const idx = MODULES.findIndex(m => m.id === mod.id);
            if (idx >= 0) {
              MODULES[idx].status = mod.status;
            }
            if (_prevModuleStates[mod.id] !== undefined && _prevModuleStates[mod.id] !== mod.status) {
              const isUp = mod.status === 'online' || mod.status === 'active';
              addToBitacora(`Modulo ${mod.id}: ${mod.status}`, isUp ? 'success' : 'warning', 'system');
            }
            _prevModuleStates[mod.id] = mod.status;
          });
          renderModules();
          document.getElementById('stat-connected').textContent = data.connected;
          document.getElementById('stat-health').textContent = data.health + '%';
        }
      } catch (e) {
        console.error('Error loading modules:', e);
      }
    }

    // Modelos por proveedor
    const MODELS_BY_PROVIDER = {
      ollama: ['llama3.2', 'llama3.1', 'mistral', 'mixtral', 'codellama', 'deepseek-coder', 'llava', 'phi3', 'gemma2', 'qwen2'],
      deepseek: ['deepseek-chat', 'deepseek-coder', 'deepseek-reasoner'],
      openai: ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-4', 'gpt-3.5-turbo', 'o1-preview', 'o1-mini'],
      anthropic: ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku', 'claude-3.5-sonnet'],
      gemini: ['gemini-2.0-flash', 'gemini-1.5-pro', 'gemini-1.5-flash', 'gemini-pro', 'gemini-pro-vision'],
      groq: ['llama-3.3-70b', 'llama-3.1-8b', 'mixtral-8x7b', 'gemma2-9b'],
      mistral: ['mistral-large', 'mistral-medium', 'mistral-small', 'codestral'],
      cohere: ['command-r-plus', 'command-r', 'command']
    };

    async function loadAIConfig() {
      try {
        // Cargar configuraciÃ³n del servidor
        const res = await fetch(`${API_BASE}/config/ai`);
        const data = await res.json();
        if (data.ok) {
          document.getElementById('ai-mode').value = data.mode || 'auto';
          document.getElementById('ai-provider').value = data.provider || 'ollama';
          
          // Cargar modelos del proveedor y seleccionar el actual
          onProviderChange();
          setTimeout(() => {
            document.getElementById('ai-model').value = data.model || 'llama3.2';
          }, 100);
          
          // ParÃ¡metros
          if (data.temperature !== undefined) {
            document.getElementById('ai-temperature').value = data.temperature * 100;
            updateSliderValue('temperature');
          }
          if (data.top_p !== undefined) {
            document.getElementById('ai-top-p').value = data.top_p * 100;
            updateSliderValue('top-p');
          }
          if (data.top_k !== undefined) {
            document.getElementById('ai-top-k').value = data.top_k;
            updateSliderValue('top-k');
          }
          if (data.max_tokens !== undefined) {
            document.getElementById('ai-max-tokens').value = data.max_tokens;
          }
          if (data.repeat_penalty !== undefined) {
            document.getElementById('ai-repeat-penalty').value = data.repeat_penalty * 100;
            updateSliderValue('repeat-penalty');
          }
          if (data.system_prompt) {
            document.getElementById('ai-system-prompt').value = data.system_prompt;
          }
          if (data.context_window) {
            document.getElementById('ai-context-window').value = data.context_window;
          }
          if (data.memory_context) {
            document.getElementById('ai-memory-context').value = data.memory_context;
          }
          if (data.ollama_url) {
            document.getElementById('ollama-url').value = data.ollama_url;
          }
          
          // Estado de conexiÃ³n
          document.getElementById('ai-status-dot').classList.remove('offline');
          document.getElementById('ai-status-text').textContent = 'Conectado';
          addAILog('info', `ConfiguraciÃ³n cargada: ${data.provider}/${data.model}`);
        }
        
        // Cargar modelos de Ollama si estÃ¡ seleccionado
        if (document.getElementById('ai-provider').value === 'ollama') {
          refreshOllamaModels();
        }
        
      } catch (e) {
        console.error('Error loading AI config:', e);
        document.getElementById('ai-status-dot').classList.add('offline');
        document.getElementById('ai-status-text').textContent = 'Desconectado';
        addAILog('error', 'Error cargando configuraciÃ³n: ' + e.message);
      }
    }

    function onProviderChange() {
      const provider = document.getElementById('ai-provider').value;
      const modelSelect = document.getElementById('ai-model');
      const apiKeyItem = document.getElementById('api-key-item');
      const ollamaUrlItem = document.getElementById('ollama-url-item');
      
      // Mostrar/ocultar campos segÃºn proveedor
      if (provider === 'ollama') {
        apiKeyItem.style.display = 'none';
        ollamaUrlItem.style.display = 'flex';
      } else {
        apiKeyItem.style.display = 'flex';
        ollamaUrlItem.style.display = 'none';
      }
      
      // Cargar modelos del proveedor
      const models = MODELS_BY_PROVIDER[provider] || [];
      modelSelect.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
      
      addAILog('info', `Proveedor cambiado a: ${provider}`);
    }

    function onAIModeChange() {
      const mode = document.getElementById('ai-mode').value;
      addAILog('info', `Modo de operaciÃ³n: ${mode}`);
    }

    function updateSliderValue(type) {
      const slider = document.getElementById(`ai-${type.replace('-', '-')}`);
      const valueSpan = document.getElementById(`${type}-value`);
      if (!slider || !valueSpan) return;
      
      let value;
      switch(type) {
        case 'temperature':
          value = (slider.value / 100).toFixed(1);
          break;
        case 'top-p':
          value = (slider.value / 100).toFixed(2);
          break;
        case 'top-k':
          value = slider.value;
          break;
        case 'repeat-penalty':
          value = (slider.value / 100).toFixed(2);
          break;
        default:
          value = slider.value;
      }
      valueSpan.textContent = value;
    }

    function toggleApiKeyVisibility() {
      const input = document.getElementById('ai-api-key');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function saveAIConfig() {
      const config = {
        mode: document.getElementById('ai-mode').value,
        provider: document.getElementById('ai-provider').value,
        model: document.getElementById('ai-model').value,
        temperature: parseFloat(document.getElementById('ai-temperature').value) / 100,
        top_p: parseFloat(document.getElementById('ai-top-p').value) / 100,
        top_k: parseInt(document.getElementById('ai-top-k').value),
        max_tokens: parseInt(document.getElementById('ai-max-tokens').value),
        repeat_penalty: parseFloat(document.getElementById('ai-repeat-penalty').value) / 100,
        system_prompt: document.getElementById('ai-system-prompt').value,
        memory_context: document.getElementById('ai-memory-context').value,
        context_window: parseInt(document.getElementById('ai-context-window').value),
        ollama_url: document.getElementById('ollama-url').value,
        stream_response: document.getElementById('ai-stream-response').checked,
        save_history: document.getElementById('ai-save-history').checked,
        log_level: document.getElementById('ai-log-level').value
      };
      
      // API Key si no es Ollama
      if (config.provider !== 'ollama') {
        config.api_key = document.getElementById('ai-api-key').value;
      }
      
      try {
        const res = await fetch(`${API_BASE}/config/ai`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        const data = await res.json();
        if (data.ok) {
          addActivity('ConfiguraciÃ³n de IA guardada', 'success');
          addAILog('info', 'ConfiguraciÃ³n guardada correctamente');
        } else {
          addAILog('error', 'Error guardando: ' + (data.error || 'desconocido'));
        }
      } catch (e) {
        addAILog('error', 'Error de conexiÃ³n: ' + e.message);
      }
    }

    async function testAIConnection() {
      const provider = document.getElementById('ai-provider').value;
      const statusDot = document.getElementById('ai-status-dot');
      const statusText = document.getElementById('ai-status-text');
      const latencyEl = document.getElementById('ai-latency');
      
      statusText.textContent = 'Probando...';
      addAILog('info', `Probando conexiÃ³n a ${provider}...`);
      
      const startTime = Date.now();
      
      try {
        const res = await fetch(`${API_BASE}/config/ai/test`, { method: 'POST' });
        const data = await res.json();
        const latency = Date.now() - startTime;
        
        latencyEl.textContent = latency;
        
        if (data.ok) {
          statusDot.classList.remove('offline');
          statusText.textContent = 'Conectado';
          addAILog('info', `ConexiÃ³n OK (${latency}ms)`);
          addActivity(`IA ${provider} conectada`, 'success');
        } else {
          statusDot.classList.add('offline');
          statusText.textContent = 'Error';
          addAILog('error', data.error || 'ConexiÃ³n fallida');
        }
      } catch (e) {
        statusDot.classList.add('offline');
        statusText.textContent = 'Desconectado';
        latencyEl.textContent = '--';
        addAILog('error', 'Error: ' + e.message);
      }
    }

    async function refreshOllamaModels() {
      const listEl = document.getElementById('ollama-models-list');
      listEl.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 0.5rem;">Cargando...</div>';
      
      try {
        const res = await fetch(`${API_BASE}/config/ai/ollama-models`);
        const data = await res.json();
        
        if (data.ok && data.models && data.models.length > 0) {
          const currentModel = document.getElementById('ai-model').value;
          listEl.innerHTML = data.models.map(m => `
            <div class="model-item ${m.name === currentModel ? 'active' : ''}" onclick="selectOllamaModel('${m.name}')">
              <span>ðŸ¦™ ${m.name}</span>
              <span class="model-size">${m.size || ''}</span>
            </div>
          `).join('');
          addAILog('info', `${data.models.length} modelos encontrados`);
        } else {
          listEl.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 0.5rem;">No hay modelos instalados</div>';
        }
      } catch (e) {
        listEl.innerHTML = `<div style="color: var(--accent-red); text-align: center; padding: 0.5rem;">Error: ${e.message}</div>`;
        addAILog('error', 'Error cargando modelos: ' + e.message);
      }
    }

    function selectOllamaModel(modelName) {
      document.getElementById('ai-model').value = modelName;
      document.querySelectorAll('#ollama-models-list .model-item').forEach(el => {
        el.classList.remove('active');
        if (el.textContent.includes(modelName)) {
          el.classList.add('active');
        }
      });
      addAILog('info', `Modelo seleccionado: ${modelName}`);
    }

    async function pullOllamaModel() {
      const modelName = prompt('Nombre del modelo a descargar (ej: llama3.2, mistral, codellama):');
      if (!modelName) return;
      
      addAILog('info', `Descargando modelo: ${modelName}...`);
      addActivity(`Descargando modelo ${modelName}...`, 'info');
      
      try {
        const res = await fetch(`${API_BASE}/config/ai/ollama-pull`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: modelName })
        });
        const data = await res.json();
        if (data.ok) {
          addAILog('info', `Modelo ${modelName} descargado`);
          addActivity(`Modelo ${modelName} instalado`, 'success');
          refreshOllamaModels();
        } else {
          addAILog('error', data.error || 'Error descargando');
        }
      } catch (e) {
        addAILog('error', 'Error: ' + e.message);
      }
    }

    function addAILog(level, message) {
      const logEl = document.getElementById('ai-log-preview');
      if (!logEl) return;
      
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${level}`;
      entry.textContent = `[${time}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      
      // Limitar a 50 entradas
      while (logEl.children.length > 50) {
        logEl.removeChild(logEl.firstChild);
      }
    }

    let _prevGovMode = null;
    async function loadGovernanceStatus() {
      try {
        const res = await fetch(`${API_BASE}/governance/status`);
        const data = await res.json();
        if (data.ok) {
          const mode = (data.mode || 'governed').toUpperCase();
          document.getElementById('gov-mode').textContent = mode;
          // Aprobaciones y polÃ­ticas ahora vienen de /api/autonomy/status
          // Se actualizan en loadAutonomia()
          document.getElementById('gov-score').textContent = data.security_score || 100;

          if (_prevGovMode && _prevGovMode !== mode) {
            addToBitacora(`Gobernanza: modo cambiado a ${mode}`, 'warning', 'governance');
          }
          _prevGovMode = mode;
        }
      } catch (e) {
        console.error('Error loading governance:', e);
      }
    }

    // â•â•â• AUTONOMÃA: Carga completa de datos â•â•â•
    let _autoInterval = null;
    async function loadAutonomia() {
      try {
        const [statusRes, tasksRes] = await Promise.allSettled([
          fetch(`${API_BASE}/api/autonomy/status`).then(r=>r.json()),
          fetch(`${API_BASE}/api/autonomy/tasks`).then(r=>r.json())
        ]);
        const status = statusRes.status==='fulfilled' ? statusRes.value : null;
        const tasks  = tasksRes.status==='fulfilled' ? tasksRes.value : null;

        if (status && status.ok) {
          const lvl = status.level || 0;
          // Gauge
          const ring = document.getElementById('auto-gauge-ring');
          if (ring) { ring.style.strokeDashoffset = 377 - (377 * lvl / 100); ring.style.stroke = lvl>70?'var(--accent-green)':lvl>40?'var(--accent-yellow)':'var(--accent-red)'; }
          const pct = document.getElementById('auto-gauge-pct');
          if (pct) pct.textContent = lvl + '%';
          const lbl = document.getElementById('auto-gauge-label');
          if (lbl) lbl.textContent = lvl>80?'OperaciÃ³n autÃ³noma':lvl>50?'AutonomÃ­a parcial':'SupervisiÃ³n requerida';
          // KPIs
          const k = status.kpis || {};
          const se = (id,v) => { const e=document.getElementById(id); if(e) e.textContent=v; };
          // Gov data from status
          const govSub = status.subsystems?.governance;
          if (govSub) {
            const modeEl = document.getElementById('gov-mode');
            const modeStr = (govSub.detail||'').replace('Modo: ','').toUpperCase();
            if (modeEl && modeStr) { modeEl.textContent = modeStr; modeEl.style.color = modeStr==='EMERGENCY'?'var(--accent-red)':'var(--accent-green)'; }
          }
          // Actualizar contadores de aprobaciones y polÃ­ticas
          se('gov-approvals', k.approvals_pending || 0);
          se('gov-policies', k.policies_count || 0);
          se('auto-kpi-uptime', k.uptime_hours ? k.uptime_hours+'h' : '0h');
          se('auto-kpi-success', (k.success_rate||0)+'%');
          se('auto-kpi-modules', (k.modules_connected||0)+'/'+(k.modules_total||0));
          se('auto-kpi-ai', (k.ai_available||0)+'/'+(k.ai_total||0));
          se('auto-kpi-incidents', k.incidents_resolved||0);
          se('auto-kpi-mttr', (k.mttr_minutes||0)+'m');
          se('auto-kpi-rules', k.rules_learned||0);
          se('auto-kpi-alerts', k.alerts_active||0);
          // Subsistemas
          const subEl = document.getElementById('auto-subsystems');
          if (subEl && status.subsystems) {
            subEl.innerHTML = Object.entries(status.subsystems).map(([k,s]) => {
              const color = s.active ? 'var(--accent-green)' : 'var(--accent-red)';
              return `<div style="padding:10px 14px;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid ${s.active?'rgba(0,255,136,0.15)':'rgba(255,68,68,0.15)'};display:flex;align-items:center;gap:10px;">
                <div style="width:8px;height:8px;border-radius:50%;background:${color};box-shadow:0 0 6px ${color};flex-shrink:0;"></div>
                <div><div style="font-size:12px;font-weight:600;">${s.label}</div><div style="font-size:10px;opacity:.5;">${s.detail}</div></div>
              </div>`;
            }).join('');
          }
          // Alertas
          const alertsBox = document.getElementById('auto-alerts');
          const alertsList = document.getElementById('auto-alerts-list');
          if (alertsBox && alertsList && status.alerts && status.alerts.length > 0) {
            alertsBox.style.display = 'block';
            alertsList.innerHTML = status.alerts.map(a => {
              const c = a.level==='critical'?'var(--accent-red)':a.level==='warning'?'var(--accent-yellow)':'rgba(255,255,255,0.3)';
              return `<div style="padding:6px 12px;border-radius:8px;background:rgba(255,255,255,0.03);border-left:3px solid ${c};font-size:11px;">${a.msg}</div>`;
            }).join('');
          } else if (alertsBox) { alertsBox.style.display = 'none'; }
          // Timeline
          const tlEl = document.getElementById('auto-timeline');
          if (tlEl && status.timeline && status.timeline.length > 0) {
            tlEl.innerHTML = status.timeline.map(t => {
              const c = t.result==='ok'?'var(--accent-green)':'var(--accent-red)';
              const ts = t.ts ? t.ts.split(' ')[1] || t.ts : '';
              return `<div style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.03);font-size:11px;display:flex;gap:8px;align-items:center;">
                <span style="color:${c};font-size:9px;">&#9679;</span>
                <span style="opacity:.5;min-width:50px;">${ts}</span>
                <span>${t.event}</span>
              </div>`;
            }).join('');
          }
        }

        // Tareas
        if (tasks && tasks.ok && tasks.tasks) {
          const tEl = document.getElementById('auto-tasks');
          if (tEl) {
            if (tasks.tasks.length === 0) {
              tEl.innerHTML = '<div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.03);font-size:12px;opacity:.4;">Sin tareas pendientes</div>';
            } else {
              tEl.innerHTML = tasks.tasks.map(t => {
                const pc = {critical:'var(--accent-red)',high:'#f59e0b',medium:'var(--accent-cyan)',low:'rgba(255,255,255,0.3)'}[t.priority]||'rgba(255,255,255,0.3)';
                const sc = {pending:'#f59e0b',in_progress:'var(--accent-cyan)',done:'var(--accent-green)',failed:'var(--accent-red)'}[t.status]||'rgba(255,255,255,0.3)';
                const showActions = t.status === 'pending' || t.status === 'in_progress';
                const actions = showActions ? `<div style="display:flex;gap:4px;margin-top:6px;">
                  <button onclick="autoTaskAction('${t.id}','approve')" style="font-size:9px;padding:2px 8px;border-radius:4px;background:rgba(0,255,136,0.15);color:var(--accent-green);border:1px solid rgba(0,255,136,0.2);cursor:pointer;">Aprobar</button>
                  <button onclick="autoTaskAction('${t.id}','reject')" style="font-size:9px;padding:2px 8px;border-radius:4px;background:rgba(255,68,68,0.15);color:var(--accent-red);border:1px solid rgba(255,68,68,0.2);cursor:pointer;">Rechazar</button>
                  <button onclick="autoTaskAction('${t.id}','close')" style="font-size:9px;padding:2px 8px;border-radius:4px;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.5);border:1px solid rgba(255,255,255,0.1);cursor:pointer;">Cerrar</button>
                </div>` : '';
                return `<div style="padding:10px 14px;border-radius:10px;background:rgba(255,255,255,0.03);border-left:3px solid ${pc};">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:12px;font-weight:600;">${t.title||t.id}</span>
                    <span style="font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.06);color:${sc};">${t.status}</span>
                  </div>
                  <div style="font-size:10px;opacity:.4;margin-top:2px;">${t.source||''} &middot; ${t.created_at||''}</div>
                  ${actions}
                </div>`;
              }).join('');
            }
          }
        }
      } catch (e) {
        console.error('Error loading autonomia:', e);
      }
    }

    async function autoTaskAction(taskId, action) {
      try {
        const res = await fetch(`${API_BASE}/api/autonomy/task/${taskId}/action`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({action})
        });
        const data = await res.json();
        if (data.ok) {
          addActivity(`Tarea ${taskId}: ${action}`, 'success');
          addToBitacora(`Autonomia: tarea ${taskId} â†’ ${action}`, 'info', 'governance');
          loadAutonomia();
        }
      } catch(e) { console.error('autoTaskAction error:', e); }
    }

    async function loadCameras() {
      try {
        const res = await fetch(`${API_BASE}/vision/cameras`);
        const data = await res.json();
        if (data.ok && data.cameras) {
          document.getElementById('vision-cameras').textContent = data.count || 0;
          // Renderizar lista de cÃ¡maras
          const camerasList = document.getElementById('cameras-list');
          if (camerasList && data.cameras.length > 0) {
            camerasList.innerHTML = data.cameras.map(cam => `
              <div class="module-row" data-cam-id="${cam.id}">
                <div class="module-info">
                  <div class="module-dot"></div>
                  <div class="camera-details">
                    <span class="module-name-text">${getCameraIcon(cam.name)} ${cam.name}</span>
                    <span class="camera-specs">${cam.resolution || '1920x1080'} @ ${cam.fps || 30}fps</span>
                  </div>
                </div>
                <div class="module-actions">
                  <button class="btn-check" onclick="selectCamera(${cam.id}, event)">SELECCIONAR</button>
                  <button class="btn-reconnect" onclick="streamCamera(${cam.id}, event)">ðŸ”´ STREAM</button>
                </div>
              </div>
            `).join('');
          }
        }
      } catch (e) {
        console.error('Error loading cameras:', e);
      }
    }

    async function checkAllModules() {
      addActivity('Verificando todos los mÃ³dulos...', 'info');
      try {
        const res = await fetch(`${API_BASE}/modules/check-all`);
        const data = await res.json();
        if (data.ok) {
          // Actualizar MODULES con datos reales
          data.modules.forEach(mod => {
            const idx = MODULES.findIndex(m => m.id === mod.id);
            if (idx >= 0) {
              MODULES[idx].status = mod.status;
            }
          });
          renderModules();
          addActivity(`MÃ³dulos verificados: ${data.connected}/${data.total} OK (${data.health}%)`, 'success');
        }
      } catch (e) {
        addActivity('Error verificando mÃ³dulos: ' + e.message, 'error');
      }
    }

    async function checkModule(moduleId) {
      addActivity(`Verificando mÃ³dulo: ${moduleId}`, 'info');
    }

    async function runDiagnostic() {
      addActivity('Ejecutando diagnÃ³stico completo...', 'info');
      try {
        const res = await fetch(`${API_BASE}/doctor`);
        const data = await res.json();
        addActivity('DiagnÃ³stico completado', 'success');
      } catch (e) {
        addActivity('Error en diagnÃ³stico: ' + e.message, 'error');
      }
    }

    // Chat
    async function sendMessage() {
      _dashGlobalMute();
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      const messagesDiv = document.getElementById('chat-messages');
      messagesDiv.innerHTML += `<div class="chat-message user">${escapeHtml(message)}</div>`;
      input.value = '';
      addActivity(`Usuario: ${message.substring(0, 30)}...`, 'info');

      // Mostrar indicador de "pensando"
      const thinkingId = 'thinking-' + Date.now();
      messagesDiv.innerHTML += `<div class="chat-message assistant" id="${thinkingId}" style="opacity: 0.6;">ðŸ§  Pensando...</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      try {
        // Enviar al cerebro
        const res = await fetch(`${API_BASE}/brain/process`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: message })
        });
        const data = await res.json();
        
        // Remover indicador de pensando
        const thinkingEl = document.getElementById(thinkingId);
        if (thinkingEl) thinkingEl.remove();
        
        if (data.ok) {
          const response = data.response || data.result || 'Sin respuesta';
          messagesDiv.innerHTML += `<div class="chat-message assistant">${formatResponse(response)}</div>`;
          addActivity('Cerebro respondiÃ³', 'success', 'brain');
        } else {
          messagesDiv.innerHTML += `<div class="chat-message assistant" style="border-color: var(--accent-red);">Error: ${data.error || 'Sin respuesta'}</div>`;
          addActivity('Error del cerebro: ' + (data.error || 'desconocido'), 'error');
        }
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (e) {
        const thinkingEl = document.getElementById(thinkingId);
        if (thinkingEl) thinkingEl.remove();
        messagesDiv.innerHTML += `<div class="chat-message assistant" style="border-color: var(--accent-red);">Error de conexiÃ³n: ${e.message}</div>`;
        addActivity('Error: ' + e.message, 'error');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatResponse(response) {
      if (typeof response === 'object') {
        return '<pre style="white-space: pre-wrap; font-size: 0.85rem;">' + JSON.stringify(response, null, 2) + '</pre>';
      }
      return escapeHtml(String(response));
    }

    const _dashChatEl = document.getElementById('chat-input');
    if (_dashChatEl) {
      _dashChatEl.addEventListener('keypress', (e) => {
        _dashGlobalMute();
        if (e.key === 'Enter') sendMessage();
      });
      _dashChatEl.addEventListener('focus', _dashGlobalMute);
      _dashChatEl.addEventListener('input', _dashGlobalMute);
    }

    // Governance
    async function setGovMode(mode) {
      try {
        const res = await fetch(`${API_BASE}/governance/mode`, { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: mode })
        });
        const data = await res.json();
        if (data.ok) {
          document.getElementById('gov-mode').textContent = mode.toUpperCase();
          addActivity(`Modo de gobernanza: ${mode.toUpperCase()}`, 'success');
        } else {
          addActivity(`Error: ${data.error || 'No se pudo cambiar modo'}`, 'error');
        }
      } catch (e) {
        addActivity(`Error: ${e.message}`, 'error');
      }
    }

    async function emergencyStop() {
      if (confirm('âš ï¸ Â¿Confirmar EMERGENCY STOP?\n\nEsto detendrÃ¡ todas las operaciones automÃ¡ticas.')) {
        try {
          const res = await fetch(`${API_BASE}/governance/emergency`, { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ activate: true, reason: 'Manual emergency stop' })
          });
          const data = await res.json();
          if (data.ok) {
            document.getElementById('gov-mode').textContent = 'EMERGENCY';
            document.getElementById('gov-mode').style.color = 'var(--accent-red)';
            addActivity('ðŸš¨ EMERGENCY STOP ACTIVADO', 'error');
          } else {
            addActivity(`Error: ${data.error || 'No se pudo activar'}`, 'error');
          }
        } catch (e) {
          addActivity(`Error: ${e.message}`, 'error');
        }
      }
    }

    // Vision
    async function captureSnapshot() {
      if (selectedCamera === null) {
        addActivity('Selecciona una cÃ¡mara primero', 'error');
        return;
      }
      addActivity(`Capturando de cÃ¡mara ${selectedCamera}...`, 'info');
      try {
        const res = await fetch(`${API_BASE}/vision/capture/${selectedCamera}`);
        const data = await res.json();
        if (data.ok && data.image_base64) {
          const preview = document.getElementById('vision-preview');
          preview.innerHTML = `<img src="data:image/jpeg;base64,${data.image_base64}" style="max-width: 100%; border-radius: 8px;">`;
          document.getElementById('camera-info').textContent = `CÃ¡mara ${selectedCamera} - ${data.width}x${data.height}`;
          addActivity('Captura exitosa', 'success');
        } else {
          addActivity(`Error: ${data.error || 'No se pudo capturar'}`, 'error');
        }
      } catch (e) {
        addActivity(`Error: ${e.message}`, 'error');
      }
    }

    function captureSnapshotOld() {
      addActivity('Capturando snapshot...', 'info');
    }

    function startStream() {
      addActivity('Iniciando stream...', 'info');
    }

    function detectFaces() {
      addActivity('Detectando rostros...', 'info');
    }

    // Nervous
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Sistema Nervioso Functions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const NERVOUS_NODES = [
      'cerebro', 'cerebelo', 'tronco', 'medula',
      'sensorial', 'motor', 'craneal', 'espinal',
      'simpatico', 'parasimpatico', 'enterico', 'cardiaco'
    ];
    
    let nervousState = {
      mode: 'normal', // normal, stress, calm
      heartbeat: 72,
      signalsPerMin: 0,
      latency: 12,
      uptime: 99.9
    };

    // ============ COGNITIVE ARCHITECTURE API ============
    let cognitiveWS = null;
    let cognitiveState = {
      connected: false,
      lastUpdate: null
    };

    // ActualizaciÃ³n silenciosa (auto-refresh, sin logs)
    let _prevNervousStatus = null;
    async function refreshCognitiveSilent() {
      try {
        const res = await fetch(`${API_BASE}/cognitive/status`);
        const data = await res.json();
        
        if (data.ok !== false) {
          document.getElementById('nervous-signals').textContent = data.signals_per_minute || 0;
          document.getElementById('nervous-latency').textContent = data.avg_latency_ms?.toFixed(1) || '0.0';
          document.getElementById('nervous-uptime').textContent = ((data.uptime_seconds || 0) / 3600).toFixed(1) + 'h';
          document.getElementById('nervous-goals').textContent = data.active_goals || 0;
          document.getElementById('nervous-memory').textContent = data.memory_episodes || 0;
          
          updateCortexModules(data.cortex || {});
          updateCognitiveSignals(data);
          
          updateNodeStatus('limbic', data.limbic);
          updateNodeStatus('hippo', data.hippo);
          updateNodeStatus('brainstem', data.brainstem);
          updateNodeStatus('basal', data.basal);
          updateNodeStatus('motor', data.motor);
          updateNodeStatus('medulla', data.medulla);
          updateNodeStatus('learning', data.learning);
          
          cognitiveState.lastUpdate = Date.now();
          document.getElementById('nervous-main-status').textContent = 'OPERATIVO';
          document.getElementById('nervous-main-status').className = 'status-badge';

          if (_prevNervousStatus === 'ERROR') {
            addToBitacora('Sistema nervioso recuperado: OPERATIVO', 'success', 'nervous');
          }
          _prevNervousStatus = 'OK';
        }
      } catch (e) {
        document.getElementById('nervous-main-status').textContent = 'ERROR';
        document.getElementById('nervous-main-status').className = 'status-badge warning';
        if (_prevNervousStatus === 'OK') {
          addToBitacora('Sistema nervioso: ERROR de comunicacion', 'error', 'nervous');
        }
        _prevNervousStatus = 'ERROR';
      }
    }

    // ActualizaciÃ³n manual (con logs para el usuario)
    async function refreshCognitive() {
      addNervousLog('Actualizando arquitectura cognitiva...', 'info');
      addActivity('Actualizando sistema cognitivo...', 'info');
      
      try {
        const res = await fetch(`${API_BASE}/cognitive/status`);
        const data = await res.json();
        
        if (data.ok !== false) {
          // Actualizar stats principales
          document.getElementById('nervous-signals').textContent = data.signals_per_minute || 0;
          document.getElementById('nervous-latency').textContent = data.avg_latency_ms?.toFixed(1) || '0.0';
          document.getElementById('nervous-uptime').textContent = ((data.uptime_seconds || 0) / 3600).toFixed(1) + 'h';
          document.getElementById('nervous-goals').textContent = data.active_goals || 0;
          document.getElementById('nervous-memory').textContent = data.memory_episodes || 0;
          
          // Actualizar estado de mÃ³dulos del Cortex
          updateCortexModules(data.cortex || {});
          
          // Actualizar seÃ±ales de mÃ³dulos
          updateCognitiveSignals(data);
          
          // Actualizar estado de nodos
          updateNodeStatus('limbic', data.limbic);
          updateNodeStatus('hippo', data.hippo);
          updateNodeStatus('brainstem', data.brainstem);
          updateNodeStatus('basal', data.basal);
          updateNodeStatus('motor', data.motor);
          updateNodeStatus('medulla', data.medulla);
          updateNodeStatus('learning', data.learning);
          
          addNervousLog('Sistema cognitivo actualizado', 'success');
          addActivity('Arquitectura cognitiva OK', 'success');
          
          cognitiveState.lastUpdate = Date.now();
          document.getElementById('nervous-main-status').textContent = 'OPERATIVO';
          document.getElementById('nervous-main-status').className = 'status-badge';
        }
      } catch (e) {
        addNervousLog('Error: ' + e.message, 'error');
        document.getElementById('nervous-main-status').textContent = 'ERROR';
        document.getElementById('nervous-main-status').className = 'status-badge warning';
      }
    }

    function updateCortexModules(cortex) {
      // Frontal
      const frontalCount = Object.keys(cortex.frontal || {}).length;
      updateNodeModuleCount('frontal', frontalCount);
      
      // Parietal  
      const parietalCount = Object.keys(cortex.parietal || {}).length;
      updateNodeModuleCount('parietal', parietalCount);
      
      // Temporal
      const temporalCount = Object.keys(cortex.temporal || {}).length;
      updateNodeModuleCount('temporal', temporalCount);
      
      // Occipital
      const occipitalCount = Object.keys(cortex.occipital || {}).length;
      updateNodeModuleCount('occipital', occipitalCount);
    }

    function updateNodeModuleCount(nodeId, count) {
      const node = document.getElementById(`node-${nodeId}`);
      if (node) {
        if (count > 0) {
          node.classList.add('connected');
          node.classList.remove('error');
        } else {
          node.classList.remove('connected');
        }
      }
    }

    function updateCognitiveSignals(data) {
      // Frontal
      const frontalOk = Object.keys(data.cortex?.frontal || {}).filter(k => data.cortex.frontal[k]?.status === 'ok').length;
      const frontalTotal = Object.keys(data.cortex?.frontal || {}).length || 1;
      updateSignalBar('frontal', (frontalOk / frontalTotal) * 100);
      
      // Occipital
      const occipitalOk = Object.keys(data.cortex?.occipital || {}).filter(k => data.cortex.occipital[k]?.status === 'ok').length;
      const occipitalTotal = Object.keys(data.cortex?.occipital || {}).length || 1;
      updateSignalBar('occipital', (occipitalOk / occipitalTotal) * 100);
      
      // Limbic
      const limbicOk = Object.keys(data.limbic || {}).filter(k => data.limbic[k]?.status === 'ok').length;
      const limbicTotal = Object.keys(data.limbic || {}).length || 1;
      updateSignalBar('limbic', (limbicOk / limbicTotal) * 100);
      
      // Hippo
      const hippoStatus = data.hippo?.status === 'ok' ? 100 : 0;
      updateSignalBar('hippo', hippoStatus);
      
      // Brainstem
      const brainstemOk = Object.keys(data.brainstem || {}).filter(k => data.brainstem[k]?.status === 'ok').length;
      const brainstemTotal = Object.keys(data.brainstem || {}).length || 1;
      updateSignalBar('brainstem', (brainstemOk / brainstemTotal) * 100);
      
      // Motor
      const motorOk = Object.keys(data.motor || {}).filter(k => data.motor[k]?.status === 'ok').length;
      const motorTotal = Object.keys(data.motor || {}).length || 1;
      updateSignalBar('motor-ctrl', (motorOk / motorTotal) * 100);
    }

    function updateSignalBar(name, percent) {
      const bar = document.getElementById(`signal-${name}`);
      const val = document.getElementById(`signal-${name}-val`);
      if (bar) {
        bar.style.width = `${percent}%`;
        if (percent < 50) {
          bar.classList.add('warning');
        } else {
          bar.classList.remove('warning');
        }
      }
      if (val) {
        val.textContent = `${Math.round(percent)}%`;
      }
    }

    function updateNodeStatus(nodeId, data) {
      const node = document.getElementById(`node-${nodeId}`);
      if (!node) return;
      
      let isOk = false;
      if (data && typeof data === 'object') {
        if (data.status === 'ok') {
          isOk = true;
        } else if (Object.keys(data).length > 0) {
          isOk = Object.values(data).some(m => m?.status === 'ok');
        }
      }
      
      if (isOk) {
        node.classList.add('connected');
        node.classList.remove('error');
      } else {
        node.classList.remove('connected');
      }
    }

    async function cognitiveDiagnostic() {
      addNervousLog('Iniciando diagnÃ³stico cognitivo completo...', 'info');
      addActivity('DiagnÃ³stico cognitivo...', 'info');
      
      const modules = ['frontal', 'parietal', 'temporal', 'occipital', 'limbic', 'hippo', 'basal', 'brainstem', 'medulla', 'motor', 'learning'];
      
      for (const moduleId of modules) {
        const node = document.getElementById(`node-${moduleId}`);
        if (node) {
          node.classList.add('active');
          await sleep(150);
          node.classList.remove('active');
        }
      }
      
      await refreshCognitive();
      addNervousLog('DiagnÃ³stico cognitivo completado', 'success');
    }

    function inspectCognitiveNode(endpoint) {
      const nodeNames = {
        'cortex/frontal': 'ðŸŽ¯ Cortex Frontal - PlanificaciÃ³n y DecisiÃ³n',
        'cortex/parietal': 'ðŸ—ºï¸ Cortex Parietal - FusiÃ³n Sensorial',
        'cortex/temporal': 'ðŸ‘‚ Cortex Temporal - Audio y Lenguaje',
        'cortex/occipital': 'ðŸ‘ï¸ Cortex Occipital - VisiÃ³n y Profundidad',
        'limbic': 'â¤ï¸ Sistema LÃ­mbico - MotivaciÃ³n y Emociones',
        'hippo': 'ðŸ§© Hipocampo - Memoria EpisÃ³dica',
        'basal': 'âš¡ Ganglios Basales - SelecciÃ³n de Acciones',
        'brainstem': 'ðŸ«€ Tronco EncefÃ¡lico - Funciones Vitales',
        'medulla': 'ðŸ”Œ MÃ©dula Atlas - Bus de ComunicaciÃ³n',
        'motor': 'ðŸ¦¾ Control Motor - Trayectorias y PID',
        'learning': 'ðŸ“š Aprendizaje - LfD, RL, NL Feedback',
        'snp': 'ðŸŒ SNP - Sensores y Drivers'
      };
      
      addNervousLog(`Inspeccionando: ${nodeNames[endpoint] || endpoint}`, 'info');
      
      // Fetch detailed info
      fetch(`${API_BASE}/cognitive/${endpoint}`)
        .then(res => res.json())
        .then(data => {
          if (data.ok !== false) {
            const modules = data.modules || (data.module ? { main: data.module } : {});
            const count = Object.keys(modules).length;
            const okCount = Object.values(modules).filter(m => m?.status === 'ok').length;
            addNervousLog(`  â†’ ${okCount}/${count} mÃ³dulos activos`, 'success');
            
            // Show detailed info
            Object.entries(modules).forEach(([name, info]) => {
              const status = info?.status || 'unknown';
              const latency = info?.latency_ms?.toFixed(2) || '?';
              addNervousLog(`    â€¢ ${name}: ${status} (${latency}ms)`, status === 'ok' ? 'success' : 'warning');
            });
          }
        })
        .catch(e => {
          addNervousLog(`  Error: ${e.message}`, 'error');
        });
    }

    function connectCognitiveWS() {
      if (cognitiveWS && cognitiveWS.readyState === WebSocket.OPEN) {
        cognitiveWS.close();
        addNervousLog('WebSocket desconectado', 'info');
        cognitiveState.connected = false;
        return;
      }
      
      const wsUrl = `ws://${window.location.host}/cognitive/ws`;
      addNervousLog(`Conectando WebSocket: ${wsUrl}`, 'info');
      
      try {
        cognitiveWS = new WebSocket(wsUrl);
        
        cognitiveWS.onopen = () => {
          cognitiveState.connected = true;
          addNervousLog('WebSocket conectado - datos en tiempo real', 'success');
          addActivity('WebSocket cognitivo activo', 'success');
        };
        
        cognitiveWS.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            // Update UI with real-time data
            document.getElementById('nervous-signals').textContent = data.signals_per_minute || 0;
            document.getElementById('nervous-latency').textContent = data.avg_latency_ms?.toFixed(1) || '0.0';
            document.getElementById('nervous-goals').textContent = data.active_goals || 0;
            document.getElementById('nervous-memory').textContent = data.memory_episodes || 0;
            
            updateCognitiveSignals(data);
            cognitiveState.lastUpdate = Date.now();
          } catch (e) {
            // Ignore parse errors
          }
        };
        
        cognitiveWS.onclose = () => {
          cognitiveState.connected = false;
          addNervousLog('WebSocket cerrado', 'info');
        };
        
        cognitiveWS.onerror = (e) => {
          addNervousLog('Error WebSocket: conexiÃ³n fallida', 'error');
        };
      } catch (e) {
        addNervousLog(`Error creando WebSocket: ${e.message}`, 'error');
      }
    }

    async function showGoals() {
      addNervousLog('Obteniendo objetivos activos...', 'info');
      
      try {
        const res = await fetch(`${API_BASE}/cognitive/goals`);
        const data = await res.json();
        
        if (data.ok && data.goals?.length > 0) {
          addNervousLog(`${data.goals.length} objetivos activos:`, 'success');
          data.goals.forEach((g, i) => {
            addNervousLog(`  ${i+1}. [${g.priority}] ${g.description} (${Math.round(g.progress * 100)}%)`, 'info');
          });
        } else {
          addNervousLog('No hay objetivos activos', 'info');
        }
      } catch (e) {
        addNervousLog(`Error: ${e.message}`, 'error');
      }
    }

    async function showMemories() {
      addNervousLog('Obteniendo memorias recientes...', 'info');
      
      try {
        const res = await fetch(`${API_BASE}/cognitive/memory/recent`);
        const data = await res.json();
        
        if (data.ok && data.episodes?.length > 0) {
          addNervousLog(`${data.episodes.length} episodios recientes:`, 'success');
          data.episodes.forEach((e, i) => {
            addNervousLog(`  ${i+1}. ${e.goal} â†’ ${e.outcome} (R:${e.reward?.toFixed(2) || '?'})`, 'info');
          });
        } else {
          addNervousLog('No hay episodios recientes', 'info');
        }
      } catch (e) {
        addNervousLog(`Error: ${e.message}`, 'error');
      }
    }

    // Auto-refresh cognitive status every 10 seconds when tab is visible (silencioso)
    setInterval(() => {
      const panel = document.getElementById('panel-nervioso');
      if (panel && !panel.classList.contains('hidden') && !cognitiveState.connected) {
        refreshCognitiveSilent();  // Usar versiÃ³n silenciosa para auto-refresh
      }
    }, 10000);  // Cada 10 segundos en lugar de 5

    // Legacy function for backwards compatibility
    async function refreshNervous() {
      return refreshCognitive();
    }

    async function nervousDiagnostic() {
      addNervousLog('Iniciando diagnÃ³stico completo...', 'info');
      addActivity('DiagnÃ³stico del sistema nervioso...', 'info');
      
      // Animar nodos durante diagnÃ³stico
      for (const nodeId of NERVOUS_NODES) {
        const node = document.getElementById(`node-${nodeId}`);
        if (node) {
          node.classList.add('active');
          await sleep(200);
          node.classList.remove('active');
        }
      }
      
      try {
        const res = await fetch(`${API_BASE}/nervous/diagnostic`);
        const data = await res.json();
        
        if (data.ok) {
          addNervousLog(`DiagnÃ³stico completo: ${data.health || 100}% salud`, 'success');
          addActivity('DiagnÃ³stico completo: Sistema OK', 'success');
          
          // Marcar todos los nodos como conectados
          NERVOUS_NODES.forEach(nodeId => {
            const node = document.getElementById(`node-${nodeId}`);
            if (node) {
              node.classList.remove('error');
              node.classList.add('connected');
            }
          });
        }
      } catch (e) {
        addNervousLog('Error en diagnÃ³stico: ' + e.message, 'error');
      }
    }

    function inspectNode(nodeId) {
      const nodeNames = {
        cerebro: 'ðŸ§  Cerebro - Procesamiento Principal',
        cerebelo: 'ðŸŽ¯ Cerebelo - CoordinaciÃ³n Motora',
        tronco: 'ðŸŒ‰ Tronco EncefÃ¡lico - Funciones Vitales',
        medula: 'ðŸ¦´ MÃ©dula Espinal - ConducciÃ³n Nerviosa',
        sensorial: 'ðŸ‘ï¸ Nervios Sensoriales - Entrada de Datos',
        motor: 'ðŸ’ª Nervios Motores - Control Muscular',
        craneal: 'ðŸ—£ï¸ Nervios Craneales - Sentidos Especiales',
        espinal: 'ðŸ”€ Nervios Espinales - Reflejos',
        simpatico: 'âš¡ Sistema SimpÃ¡tico - Respuesta de EstrÃ©s',
        parasimpatico: 'ðŸ§˜ Sistema ParasimpÃ¡tico - Descanso',
        enterico: 'ðŸ«ƒ Sistema EntÃ©rico - DigestiÃ³n',
        cardiaco: 'ðŸ’“ Sistema CardÃ­aco - Ritmo del CorazÃ³n'
      };
      
      const node = document.getElementById(`node-${nodeId}`);
      if (node) {
        // Highlight temporal
        node.classList.add('active');
        setTimeout(() => node.classList.remove('active'), 1000);
      }
      
      addNervousLog(`Inspeccionando: ${nodeNames[nodeId] || nodeId}`, 'info');
      addActivity(`Nodo: ${nodeNames[nodeId] || nodeId}`, 'info');
    }

    async function testReflexes() {
      addNervousLog('Iniciando test de reflejos...', 'info');
      addActivity('Test de reflejos iniciado', 'info');
      
      const reflexNodes = ['sensorial', 'espinal', 'motor'];
      let reflexCount = 0;
      
      for (let i = 0; i < 5; i++) {
        // Simular seÃ±al sensorial -> espinal -> motor
        for (const nodeId of reflexNodes) {
          const node = document.getElementById(`node-${nodeId}`);
          if (node) {
            node.classList.add('active');
            await sleep(100);
            node.classList.remove('active');
          }
        }
        reflexCount++;
        document.getElementById('nervous-reflexes').textContent = reflexCount;
        await sleep(300);
      }
      
      addNervousLog(`Test completado: ${reflexCount} reflejos verificados`, 'success');
      addActivity(`Reflejos OK: ${reflexCount} verificados`, 'success');
    }

    async function simulateStress() {
      addNervousLog('âš ï¸ Simulando respuesta de estrÃ©s...', 'warning');
      addActivity('Simulando estrÃ©s del sistema', 'info');
      
      nervousState.mode = 'stress';
      
      // Activar sistema simpÃ¡tico
      const simpatico = document.getElementById('node-simpatico');
      const cardiaco = document.getElementById('node-cardiaco');
      
      if (simpatico) simpatico.classList.add('active');
      if (cardiaco) cardiaco.classList.add('active');
      
      // Aumentar heartbeat
      let bpm = 72;
      const interval = setInterval(() => {
        if (nervousState.mode !== 'stress' || bpm >= 120) {
          clearInterval(interval);
          return;
        }
        bpm += 5;
        document.getElementById('nervous-heartbeat').textContent = bpm;
        nervousState.heartbeat = bpm;
      }, 200);
      
      // Cambiar colores de seÃ±ales a warning
      document.querySelectorAll('.signal-fill').forEach(el => {
        el.classList.add('warning');
      });
      
      // Actualizar badge
      document.getElementById('nervous-main-status').textContent = 'ESTRÃ‰S';
      document.getElementById('nervous-main-status').style.background = 'var(--accent-red)';
      
      addNervousLog('Sistema simpÃ¡tico activado - BPM aumentando', 'warning');
      
      // Auto-calmar despuÃ©s de 5 segundos
      setTimeout(() => {
        if (nervousState.mode === 'stress') {
          calmSystem();
        }
      }, 5000);
    }

    async function calmSystem() {
      addNervousLog('ðŸ§˜ Activando sistema parasimpÃ¡tico...', 'info');
      addActivity('Calmando sistema...', 'info');
      
      nervousState.mode = 'calm';
      
      // Activar sistema parasimpÃ¡tico
      const parasimpatico = document.getElementById('node-parasimpatico');
      const simpatico = document.getElementById('node-simpatico');
      const cardiaco = document.getElementById('node-cardiaco');
      
      if (simpatico) simpatico.classList.remove('active');
      if (parasimpatico) parasimpatico.classList.add('active');
      
      // Reducir heartbeat gradualmente
      let bpm = nervousState.heartbeat;
      const interval = setInterval(() => {
        if (bpm <= 72) {
          clearInterval(interval);
          nervousState.mode = 'normal';
          if (parasimpatico) parasimpatico.classList.remove('active');
          if (cardiaco) cardiaco.classList.remove('active');
          return;
        }
        bpm -= 3;
        document.getElementById('nervous-heartbeat').textContent = bpm;
        nervousState.heartbeat = bpm;
      }, 150);
      
      // Restaurar colores de seÃ±ales
      document.querySelectorAll('.signal-fill').forEach(el => {
        el.classList.remove('warning');
      });
      
      // Restaurar badge
      document.getElementById('nervous-main-status').textContent = 'OPERATIVO';
      document.getElementById('nervous-main-status').style.background = 'var(--accent-green)';
      
      addNervousLog('Sistema parasimpÃ¡tico activado - Normalizando', 'success');
    }

    function updateSignalBars() {
      const signals = [
        { id: 'brain', min: 80, max: 95 },
        { id: 'vision', min: 85, max: 98 },
        { id: 'audio', min: 70, max: 90 },
        { id: 'motor', min: 88, max: 99 },
        { id: 'ans', min: 82, max: 95 }
      ];
      
      signals.forEach(s => {
        const value = Math.floor(Math.random() * (s.max - s.min)) + s.min;
        const fill = document.getElementById(`signal-${s.id}`);
        const val = document.getElementById(`signal-${s.id}-val`);
        if (fill) fill.style.width = value + '%';
        if (val) val.textContent = value + '%';
      });
    }

    function simulateHeartbeat() {
      // Simular variaciÃ³n natural del heartbeat
      setInterval(() => {
        if (nervousState.mode === 'normal') {
          const variation = Math.floor(Math.random() * 5) - 2; // -2 a +2
          let bpm = nervousState.heartbeat + variation;
          bpm = Math.max(68, Math.min(78, bpm)); // Rango normal
          nervousState.heartbeat = bpm;
          document.getElementById('nervous-heartbeat').textContent = bpm;
        }
      }, 2000);
      
      // Incrementar seÃ±ales por minuto
      setInterval(() => {
        nervousState.signalsPerMin += Math.floor(Math.random() * 5) + 1;
        document.getElementById('nervous-signals').textContent = nervousState.signalsPerMin;
      }, 1000);
    }

    function addNervousLog(message, type = 'info') {
      const logList = document.getElementById('nervous-log-list');
      if (!logList) return;
      
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `nervous-log-entry ${type}`;
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-msg">${message}</span>
      `;
      
      logList.appendChild(entry);
      logList.scrollTop = logList.scrollHeight;
      
      // Limitar a 50 entradas
      while (logList.children.length > 50) {
        logList.removeChild(logList.firstChild);
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Inicializar sistema nervioso cuando se carga el tab
    function initNervousSystem() {
      updateSignalBars();
      simulateHeartbeat();
      addNervousLog('Sistema nervioso central iniciado', 'success');
    }

    // Llamar cuando se cambia al tab nervioso
    const originalInitTabs = initTabs;
    initTabs = function() {
      originalInitTabs();
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          if (tab.getAttribute('data-tab') === 'nervioso') {
            initNervousSystem();
          }
          if (tab.getAttribute('data-tab') === 'tutorias') {
            initTutorias();
          }
        });
      });
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Sistema de TutorÃ­as y Visitas
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let visitaEnCurso = null;
    let visitaTimer = null;
    let visitaStartTime = null;
    let especialistasCache = [];

    async function initTutorias() {
      await refreshTutorias();
    }

    async function refreshTutorias() {
      addToBitacora('Actualizando sistema de tutorÃ­as...', 'info', 'tutorias');
      await Promise.all([
        cargarEstadisticas(),
        cargarEspecialistas(),
        cargarHistorialVisitas(),
        cargarRecomendaciones(),
        cargarSeguimientos()
      ]);
      addToBitacora('Sistema de tutorÃ­as actualizado', 'success', 'tutorias');
    }

    async function cargarEstadisticas() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/estadisticas`);
        const data = await res.json();
        if (data.ok) {
          const stats = data.estadisticas;
          document.getElementById('tut-stat-especialistas').textContent = stats.total_especialistas || 0;
          document.getElementById('tut-stat-visitas').textContent = stats.total_visitas || 0;
          document.getElementById('tut-stat-informes').textContent = stats.informes_firmados || 0;
          document.getElementById('tut-stat-puntuacion').textContent = (stats.puntuacion_promedio || 0).toFixed(1);
        }
      } catch (e) {
        console.log('Error cargando estadÃ­sticas:', e);
      }
    }

    async function cargarEspecialistas() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/especialistas`);
        const data = await res.json();
        if (data.ok) {
          especialistasCache = data.especialistas || [];
          renderEspecialistas(especialistasCache);
          actualizarSelectEspecialistas(especialistasCache);
        }
      } catch (e) {
        console.log('Error cargando especialistas:', e);
      }
    }

    function renderEspecialistas(especialistas) {
      const container = document.getElementById('lista-especialistas');
      if (!container) return;
      
      if (!especialistas.length) {
        container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 2rem;">
          No hay especialistas registrados aÃºn
        </div>`;
        return;
      }
      
      container.innerHTML = especialistas.map(esp => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem;">
          <div>
            <strong style="color: var(--accent-cyan);">${esp.nombre}</strong>
            <span style="color: var(--text-muted); margin-left: 0.5rem;">${esp.rol}</span>
            <div style="font-size: 0.85rem; color: var(--text-muted);">
              ${esp.especialidad} | ${esp.visitas_realizadas || 0} visitas
            </div>
          </div>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <span style="font-family: monospace; font-size: 0.75rem; color: var(--accent-purple);">
              ðŸ” ${esp.firma_digital?.substring(0, 8) || 'N/A'}
            </span>
          </div>
        </div>
      `).join('');
    }

    function actualizarSelectEspecialistas(especialistas) {
      const select = document.getElementById('visita-especialista');
      if (!select) return;
      
      select.innerHTML = '<option value="">Seleccionar especialista...</option>' +
        especialistas.map(esp => `<option value="${esp.id}">${esp.nombre} (${esp.rol})</option>`).join('');
    }

    async function registrarEspecialista() {
      const nombre = document.getElementById('esp-nombre').value.trim();
      const rol = document.getElementById('esp-rol').value;
      const especialidad = document.getElementById('esp-especialidad').value.trim();
      const email = document.getElementById('esp-email').value.trim();
      
      if (!nombre || !especialidad) {
        alert('Por favor ingrese nombre y especialidad');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/tutorias/especialistas`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre, rol, especialidad, email })
        });
        const data = await res.json();
        
        if (data.ok) {
          addToBitacora(`Especialista registrado: ${nombre}`, 'success', 'tutorias');
          addActivity(`Nuevo especialista: ${nombre}`, 'success');
          
          // Limpiar campos
          document.getElementById('esp-nombre').value = '';
          document.getElementById('esp-especialidad').value = '';
          document.getElementById('esp-email').value = '';
          
          // Recargar lista
          await cargarEspecialistas();
          await cargarEstadisticas();
        } else {
          alert('Error: ' + (data.detail || 'No se pudo registrar'));
        }
      } catch (e) {
        alert('Error de conexiÃ³n');
      }
    }

    async function iniciarVisita() {
      const especialistaId = document.getElementById('visita-especialista').value;
      const tipo = document.getElementById('visita-tipo').value;
      const motivo = document.getElementById('visita-motivo').value.trim();
      
      const modulosChecked = document.querySelectorAll('.modulo-check:checked');
      const modulos = Array.from(modulosChecked).map(cb => cb.value);
      
      if (!especialistaId) {
        alert('Por favor seleccione un especialista');
        return;
      }
      if (!motivo) {
        alert('Por favor ingrese el motivo de la visita');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/tutorias/visitas`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tipo,
            especialista_id: especialistaId,
            motivo,
            modulos_revisados: modulos,
            objetivos: []
          })
        });
        const data = await res.json();
        
        if (data.ok) {
          visitaEnCurso = {
            id: data.visita_id,
            tipo,
            especialista: data.especialista,
            inicio: new Date()
          };
          
          // Mostrar panel de visita en curso
          document.getElementById('visita-en-curso').style.display = 'block';
          document.getElementById('visita-actual-tipo').textContent = tipo.toUpperCase();
          document.getElementById('visita-actual-esp').textContent = data.especialista;
          
          // Iniciar timer
          visitaStartTime = Date.now();
          visitaTimer = setInterval(updateVisitaTimer, 1000);
          
          addToBitacora(`Visita iniciada: ${tipo} por ${data.especialista}`, 'success', 'tutorias');
          addActivity(`Visita ${tipo} iniciada`, 'info');
          
          // Limpiar formulario
          document.getElementById('visita-motivo').value = '';
          document.querySelectorAll('.modulo-check').forEach(cb => cb.checked = false);
        } else {
          alert('Error: ' + (data.detail || 'No se pudo iniciar la visita'));
        }
      } catch (e) {
        alert('Error de conexiÃ³n');
      }
    }

    function updateVisitaTimer() {
      const elapsed = Date.now() - visitaStartTime;
      const hours = Math.floor(elapsed / 3600000);
      const mins = Math.floor((elapsed % 3600000) / 60000);
      const secs = Math.floor((elapsed % 60000) / 1000);
      document.getElementById('visita-timer').textContent = 
        `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function cancelarVisita() {
      if (confirm('Â¿EstÃ¡ seguro de cancelar la visita en curso?')) {
        if (visitaTimer) clearInterval(visitaTimer);
        visitaEnCurso = null;
        document.getElementById('visita-en-curso').style.display = 'none';
        addToBitacora('Visita cancelada', 'warning', 'tutorias');
      }
    }

    function mostrarFormularioInforme() {
      const notas = document.getElementById('visita-notas').value;
      
      // Crear modal para informe
      const modal = document.createElement('div');
      modal.id = 'informe-modal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
      `;
      modal.innerHTML = `
        <div style="background: var(--bg-card); border-radius: 16px; padding: 2rem; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border);">
          <h2 style="color: var(--accent-cyan); margin-bottom: 1.5rem;">ðŸ“ Crear Informe de Visita</h2>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">TÃ­tulo del Informe</label>
            <input type="text" id="inf-titulo" value="Informe de ${visitaEnCurso?.tipo || 'visita'} - ${new Date().toLocaleDateString()}" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Resumen</label>
            <input type="text" id="inf-resumen" placeholder="Resumen breve del informe" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Contenido Detallado</label>
            <textarea id="inf-contenido" rows="5" placeholder="DescripciÃ³n detallada de la visita...">${notas}</textarea>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-cyan);">ðŸ“Š Evaluaciones</label>
            <div id="evaluaciones-list">
              <div class="eval-item" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px;">
                <input type="text" class="eval-aspecto" placeholder="Aspecto" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                <select class="eval-nivel" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                  <option value="EXCELENTE">â­ Excelente (5)</option>
                  <option value="BUENO">âœ… Bueno (4)</option>
                  <option value="ACEPTABLE" selected>ðŸ”µ Aceptable (3)</option>
                  <option value="MEJORABLE">âš ï¸ Mejorable (2)</option>
                  <option value="CRITICO">ðŸ”´ CrÃ­tico (1)</option>
                </select>
                <input type="text" class="eval-comentario" placeholder="Comentario" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
              </div>
            </div>
            <button onclick="agregarEvaluacion()" style="padding: 0.5rem 1rem; background: var(--bg-elevated); color: var(--accent-cyan); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">+ Agregar EvaluaciÃ³n</button>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-orange);">ðŸ’¡ Recomendaciones</label>
            <div id="recomendaciones-list">
              <div class="rec-item" style="padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem;">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <input type="text" class="rec-titulo" placeholder="TÃ­tulo de la recomendaciÃ³n" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                  <select class="rec-prioridad" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                    <option value="CRITICA">ðŸ”´ CrÃ­tica</option>
                    <option value="ALTA">ðŸŸ  Alta</option>
                    <option value="MEDIA" selected>ðŸŸ¡ Media</option>
                    <option value="BAJA">ðŸŸ¢ Baja</option>
                    <option value="OPCIONAL">âšª Opcional</option>
                  </select>
                </div>
                <input type="text" class="rec-descripcion" placeholder="DescripciÃ³n de la recomendaciÃ³n" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 0.5rem;">
                <input type="text" class="rec-modulo" placeholder="MÃ³dulo afectado (ej: vision, brain)" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
              </div>
            </div>
            <button onclick="agregarRecomendacion()" style="padding: 0.5rem 1rem; background: var(--bg-elevated); color: var(--accent-orange); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">+ Agregar RecomendaciÃ³n</button>
          </div>
          
          <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="enviarInforme()" style="flex: 1;">âœï¸ Firmar y Enviar Informe</button>
            <button class="btn" onclick="cerrarModalInforme()" style="background: var(--bg-elevated);">Cancelar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function agregarEvaluacion() {
      const list = document.getElementById('evaluaciones-list');
      const item = document.createElement('div');
      item.className = 'eval-item';
      item.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px;';
      item.innerHTML = `
        <input type="text" class="eval-aspecto" placeholder="Aspecto" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
        <select class="eval-nivel" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
          <option value="EXCELENTE">â­ Excelente (5)</option>
          <option value="BUENO">âœ… Bueno (4)</option>
          <option value="ACEPTABLE" selected>ðŸ”µ Aceptable (3)</option>
          <option value="MEJORABLE">âš ï¸ Mejorable (2)</option>
          <option value="CRITICO">ðŸ”´ CrÃ­tico (1)</option>
        </select>
        <input type="text" class="eval-comentario" placeholder="Comentario" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
      `;
      list.appendChild(item);
    }

    function agregarRecomendacion() {
      const list = document.getElementById('recomendaciones-list');
      const item = document.createElement('div');
      item.className = 'rec-item';
      item.style.cssText = 'padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem;';
      item.innerHTML = `
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
          <input type="text" class="rec-titulo" placeholder="TÃ­tulo de la recomendaciÃ³n" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
          <select class="rec-prioridad" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
            <option value="CRITICA">ðŸ”´ CrÃ­tica</option>
            <option value="ALTA">ðŸŸ  Alta</option>
            <option value="MEDIA" selected>ðŸŸ¡ Media</option>
            <option value="BAJA">ðŸŸ¢ Baja</option>
            <option value="OPCIONAL">âšª Opcional</option>
          </select>
        </div>
        <input type="text" class="rec-descripcion" placeholder="DescripciÃ³n de la recomendaciÃ³n" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 0.5rem;">
        <input type="text" class="rec-modulo" placeholder="MÃ³dulo afectado (ej: vision, brain)" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
      `;
      list.appendChild(item);
    }

    function cerrarModalInforme() {
      const modal = document.getElementById('informe-modal');
      if (modal) modal.remove();
    }

    async function enviarInforme() {
      const titulo = document.getElementById('inf-titulo').value.trim();
      const resumen = document.getElementById('inf-resumen').value.trim();
      const contenido = document.getElementById('inf-contenido').value.trim();
      
      // Recoger evaluaciones
      const evalItems = document.querySelectorAll('.eval-item');
      const evaluaciones = [];
      const nivelPuntuacion = { EXCELENTE: 5, BUENO: 4, ACEPTABLE: 3, MEJORABLE: 2, CRITICO: 1 };
      
      evalItems.forEach(item => {
        const aspecto = item.querySelector('.eval-aspecto').value.trim();
        const nivel = item.querySelector('.eval-nivel').value;
        const comentario = item.querySelector('.eval-comentario').value.trim();
        if (aspecto) {
          evaluaciones.push({
            aspecto,
            nivel,
            puntuacion: nivelPuntuacion[nivel] || 3,
            comentario
          });
        }
      });
      
      // Recoger recomendaciones
      const recItems = document.querySelectorAll('.rec-item');
      const recomendaciones = [];
      
      recItems.forEach(item => {
        const rec_titulo = item.querySelector('.rec-titulo').value.trim();
        const prioridad = item.querySelector('.rec-prioridad').value;
        const descripcion = item.querySelector('.rec-descripcion').value.trim();
        const modulo = item.querySelector('.rec-modulo').value.trim();
        if (rec_titulo) {
          recomendaciones.push({
            titulo: rec_titulo,
            prioridad,
            descripcion,
            modulo_afectado: modulo || 'general',
            pasos_implementacion: []
          });
        }
      });
      
      if (!titulo || !resumen) {
        alert('Por favor complete el tÃ­tulo y resumen del informe');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/tutorias/visitas/${visitaEnCurso.id}/finalizar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            titulo,
            resumen,
            contenido,
            evaluaciones,
            recomendaciones,
            objetivos_cumplidos: [],
            objetivos_pendientes: [],
            proximos_pasos: []
          })
        });
        const data = await res.json();
        
        if (data.ok) {
          addToBitacora(`Informe firmado: ${titulo}`, 'success', 'tutorias');
          addActivity(`Visita finalizada - Informe: ${data.informe?.firma?.substring(0, 8)}`, 'success');
          
          // Cerrar modal y limpiar
          cerrarModalInforme();
          if (visitaTimer) clearInterval(visitaTimer);
          visitaEnCurso = null;
          document.getElementById('visita-en-curso').style.display = 'none';
          
          // Actualizar datos
          await refreshTutorias();
          
          alert(`âœ… Informe firmado exitosamente!\n\nFirma: ${data.informe?.firma || 'N/A'}\nHash: ${data.informe?.hash?.substring(0, 16) || 'N/A'}\nPuntuaciÃ³n: ${data.informe?.puntuacion_global?.toFixed(1) || 'N/A'}/5`);
        } else {
          alert('Error: ' + (data.detail || 'No se pudo enviar el informe'));
        }
      } catch (e) {
        alert('Error de conexiÃ³n: ' + e.message);
      }
    }

    async function cargarHistorialVisitas() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/visitas?limite=10&solo_completadas=true`);
        const data = await res.json();
        if (data.ok) {
          renderHistorialVisitas(data.visitas || []);
        }
      } catch (e) {
        console.log('Error cargando historial:', e);
      }
    }

    function renderHistorialVisitas(visitas) {
      const container = document.getElementById('historial-visitas');
      if (!container) return;
      
      if (!visitas.length) {
        container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 2rem;">
          No hay visitas registradas aÃºn
        </div>`;
        return;
      }
      
      const tipoEmojis = {
        tutoria: 'ðŸ“š', revision: 'ðŸ”', auditoria: 'ðŸ“Š', capacitacion: 'ðŸŽ“',
        mantenimiento: 'ðŸ”§', emergencia: 'ðŸš¨', seguimiento: 'ðŸ“Œ'
      };
      
      container.innerHTML = visitas.map(v => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem;">
          <div>
            <span style="margin-right: 0.5rem;">${tipoEmojis[v.tipo] || 'ðŸ“‹'}</span>
            <strong style="color: var(--accent-cyan);">${v.tipo?.toUpperCase() || 'VISITA'}</strong>
            <span style="color: var(--text-muted); margin-left: 0.5rem;">
              por ${v.especialista?.nombre || 'N/A'}
            </span>
            <div style="font-size: 0.85rem; color: var(--text-muted);">
              ${v.motivo || 'Sin motivo'} | ${v.duracion_minutos || 0} min
            </div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 0.85rem; color: var(--text-muted);">
              ${new Date(v.fecha_inicio).toLocaleDateString()}
            </div>
            ${v.informe?.firmado ? `<span style="color: var(--accent-green); font-size: 0.75rem;">âœ… Firmado</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    async function cargarRecomendaciones() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/recomendaciones?estado=PENDIENTE&limite=10`);
        const data = await res.json();
        if (data.ok) {
          renderRecomendaciones(data.recomendaciones || []);
        }
      } catch (e) {
        console.log('Error cargando recomendaciones:', e);
      }
    }

    function renderRecomendaciones(recomendaciones) {
      const container = document.getElementById('lista-recomendaciones');
      if (!container) return;
      
      if (!recomendaciones.length) {
        container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 2rem;">
          No hay recomendaciones pendientes ðŸ‘
        </div>`;
        return;
      }
      
      const prioridadColors = {
        CRITICA: 'var(--accent-red)', ALTA: 'var(--accent-orange)',
        MEDIA: 'var(--accent-orange)', BAJA: 'var(--accent-green)', OPCIONAL: 'var(--text-muted)'
      };
      
      container.innerHTML = recomendaciones.map(r => `
        <div style="padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${prioridadColors[r.prioridad] || 'var(--border)'};">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <strong style="color: var(--text);">${r.titulo}</strong>
              <span style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: ${prioridadColors[r.prioridad]}; color: white; border-radius: 10px; margin-left: 0.5rem;">${r.prioridad}</span>
              <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                ${r.descripcion || 'Sin descripciÃ³n'}
              </div>
              <div style="font-size: 0.75rem; color: var(--accent-purple); margin-top: 0.25rem;">
                MÃ³dulo: ${r.modulo_afectado || 'general'}
              </div>
            </div>
            <button onclick="marcarRecomendacion('${r.id}', 'COMPLETADA')" style="padding: 0.25rem 0.5rem; background: var(--accent-green); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">âœ“</button>
          </div>
        </div>
      `).join('');
    }

    async function marcarRecomendacion(id, estado) {
      try {
        await fetch(`${API_BASE}/tutorias/recomendaciones/${id}/estado?estado=${estado}`, {
          method: 'PUT'
        });
        addToBitacora(`RecomendaciÃ³n ${estado.toLowerCase()}`, 'success', 'tutorias');
        await cargarRecomendaciones();
        await cargarEstadisticas();
      } catch (e) {
        console.log('Error actualizando recomendaciÃ³n:', e);
      }
    }

    async function cargarSeguimientos() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/seguimientos?solo_activos=true`);
        const data = await res.json();
        if (data.ok) {
          renderSeguimientos(data.seguimientos || []);
        }
      } catch (e) {
        console.log('Error cargando seguimientos:', e);
      }
    }

    function renderSeguimientos(seguimientos) {
      const container = document.getElementById('lista-seguimientos');
      if (!container) return;
      
      if (!seguimientos.length) {
        container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 2rem;">
          No hay seguimientos activos
        </div>`;
        return;
      }
      
      container.innerHTML = seguimientos.map(s => `
        <div style="padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <strong style="color: var(--text);">${s.titulo}</strong>
            <span style="color: var(--accent-cyan); font-weight: bold;">${s.porcentaje_avance}%</span>
          </div>
          <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple)); height: 100%; width: ${s.porcentaje_avance}%; transition: width 0.3s;"></div>
          </div>
          <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
            Responsable: ${s.responsable || 'ATLAS'} | ${s.hitos?.length || 0} hitos
          </div>
        </div>
      `).join('');
    }

    async function generarDashboardTutorias() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/dashboard`);
        const data = await res.json();
        if (data.ok) {
          addToBitacora(`Dashboard generado: ${data.dashboard_path}`, 'success', 'tutorias');
          alert('Dashboard generado en:\n' + data.dashboard_path);
        }
      } catch (e) {
        alert('Error generando dashboard');
      }
    }

    async function exportarRecomendaciones() {
      addToBitacora('Exportando recomendaciones...', 'info', 'tutorias');
      // Simplemente descargar lista actual
      try {
        const res = await fetch(`${API_BASE}/tutorias/recomendaciones?limite=100`);
        const data = await res.json();
        if (data.ok) {
          const blob = new Blob([JSON.stringify(data.recomendaciones, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `recomendaciones_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          addToBitacora('Recomendaciones exportadas', 'success', 'tutorias');
        }
      } catch (e) {
        alert('Error exportando recomendaciones');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMUNICACIONES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function refreshCommsStatus() {
      try {
        document.getElementById('comms-status').textContent = 'VERIFICANDO...';
        document.getElementById('comms-status').style.background = 'var(--accent-orange)';
        
        const response = await fetch('/ans/comms/status');
        if (!response.ok) throw new Error('API no disponible');
        
        const data = await response.json();
        
        // WhatsApp
        const waStatus = data.whatsapp?.connected ? 'âœ… Conectado' : 'âŒ Desconectado';
        document.getElementById('comms-whatsapp-status').textContent = waStatus;
        document.getElementById('waha-connection-status').textContent = waStatus;
        document.getElementById('waha-session-name').textContent = data.whatsapp?.session || 'default';
        document.getElementById('waha-phone-number').textContent = data.whatsapp?.phone || '--';
        
        // Telegram
        const tgStatus = data.telegram?.configured ? 'âœ… Configurado' : 'âš ï¸ Sin configurar';
        document.getElementById('comms-telegram-status').textContent = tgStatus;
        document.getElementById('telegram-connection-status').textContent = tgStatus;
        document.getElementById('telegram-token-status').textContent = data.telegram?.has_token ? 'âœ… Presente' : 'âŒ Falta';
        document.getElementById('telegram-chat-id').textContent = data.telegram?.chat_id || '--';
        
        // Audio
        const audioStatus = data.audio?.available ? 'âœ… Disponible' : 'âŒ No disponible';
        document.getElementById('comms-audio-status').textContent = audioStatus;
        document.getElementById('audio-connection-status').textContent = audioStatus;
        document.getElementById('audio-engine').textContent = data.audio?.engine || 'pyttsx3';
        
        // Messages today
        document.getElementById('comms-messages-today').textContent = data.messages_today || '0';
        
        // Overall status
        const allOk = data.whatsapp?.connected && data.telegram?.configured && data.audio?.available;
        document.getElementById('comms-status').textContent = allOk ? 'OPERATIVO' : 'PARCIAL';
        document.getElementById('comms-status').style.background = allOk ? 'var(--accent-green)' : 'var(--accent-orange)';
        
        addToBitacora('Estado de comunicaciones actualizado', 'success', 'comms');
      } catch (e) {
        console.error('Error refreshing comms:', e);
        document.getElementById('comms-status').textContent = 'ERROR';
        document.getElementById('comms-status').style.background = 'var(--accent-red)';
        addToBitacora('Error verificando comunicaciones: ' + e.message, 'error', 'comms');
      }
    }
    
    function openWahaDashboard() {
      window.open('http://localhost:3000/dashboard', '_blank');
      addToBitacora('Abriendo WAHA Dashboard', 'info', 'comms');
    }
    
    async function showQRCode() {
      try {
        const container = document.getElementById('waha-qr-container');
        const img = document.getElementById('waha-qr-image');
        
        addToBitacora('Obteniendo cÃ³digo QR de WhatsApp...', 'info', 'comms');
        
        const response = await fetch('/ans/comms/waha/qr');
        if (!response.ok) throw new Error('No se pudo obtener QR');
        
        const data = await response.json();
        if (data.qr_base64) {
          img.src = 'data:image/png;base64,' + data.qr_base64;
          container.style.display = 'block';
          addToBitacora('QR obtenido - escanear con WhatsApp', 'success', 'comms');
        } else {
          alert(data.message || 'SesiÃ³n ya conectada o QR no disponible');
          container.style.display = 'none';
        }
      } catch (e) {
        alert('Error obteniendo QR: ' + e.message);
        addToBitacora('Error obteniendo QR: ' + e.message, 'error', 'comms');
      }
    }
    
    async function restartWahaSession() {
      if (!confirm('Â¿Reiniciar sesiÃ³n de WhatsApp? Se desconectarÃ¡ temporalmente.')) return;
      
      try {
        addToBitacora('Reiniciando sesiÃ³n WAHA...', 'info', 'comms');
        const response = await fetch('/ans/comms/waha/restart', { method: 'POST' });
        const data = await response.json();
        
        if (data.ok) {
          addToBitacora('SesiÃ³n reiniciada - mostrando QR', 'success', 'comms');
          setTimeout(showQRCode, 2000);
        } else {
          throw new Error(data.error || 'Error reiniciando');
        }
      } catch (e) {
        alert('Error: ' + e.message);
        addToBitacora('Error reiniciando sesiÃ³n: ' + e.message, 'error', 'comms');
      }
    }
    
    async function testWhatsApp() {
      try {
        addToBitacora('Enviando test a WhatsApp...', 'info', 'comms');
        const response = await fetch('/ans/comms/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel: 'whatsapp', message: 'Test desde Dashboard ATLAS' })
        });
        const data = await response.json();
        if (data.ok) {
          addToBitacora('Test WhatsApp enviado', 'success', 'comms');
          alert('Mensaje enviado a WhatsApp');
        } else {
          throw new Error(data.error || 'Error enviando');
        }
      } catch (e) {
        alert('Error: ' + e.message);
        addToBitacora('Error test WhatsApp: ' + e.message, 'error', 'comms');
      }
    }
    
    async function testTelegram() {
      try {
        addToBitacora('Enviando test a Telegram...', 'info', 'comms');
        const response = await fetch('/ans/comms/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel: 'telegram', message: 'Test desde Dashboard ATLAS' })
        });
        const data = await response.json();
        if (data.ok) {
          addToBitacora('Test Telegram enviado', 'success', 'comms');
          alert('Mensaje enviado a Telegram');
        } else {
          throw new Error(data.error || 'Error enviando');
        }
      } catch (e) {
        alert('Error: ' + e.message);
        addToBitacora('Error test Telegram: ' + e.message, 'error', 'comms');
      }
    }
    
    async function testAudio() {
      try {
        addToBitacora('Probando audio TTS...', 'info', 'comms');
        const response = await fetch('/ans/comms/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel: 'audio', message: 'Test de audio desde Dashboard' })
        });
        const data = await response.json();
        if (data.ok) {
          addToBitacora('Test Audio ejecutado', 'success', 'comms');
          alert('Audio reproducido');
        } else {
          throw new Error(data.error || 'Error');
        }
      } catch (e) {
        alert('Error: ' + e.message);
        addToBitacora('Error test Audio: ' + e.message, 'error', 'comms');
      }
    }
    
    async function testAllComms() {
      addToBitacora('Probando todos los canales...', 'info', 'comms');
      await testWhatsApp();
      await testTelegram();
      await testAudio();
      addToBitacora('Test completo finalizado', 'success', 'comms');
    }
    
    async function sendTestAll() {
      try {
        addToBitacora('Enviando notificaciÃ³n a todos los canales...', 'info', 'comms');
        const response = await fetch('/ans/comms/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel: 'all', message: 'NotificaciÃ³n broadcast desde ATLAS Dashboard' })
        });
        const data = await response.json();
        if (data.ok) {
          addToBitacora('NotificaciÃ³n broadcast enviada', 'success', 'comms');
          alert('NotificaciÃ³n enviada a todos los canales');
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    async function reconnectAllComms() {
      addToBitacora('Reconectando servicios de comunicaciÃ³n...', 'info', 'comms');
      await restartWahaSession();
      setTimeout(refreshCommsStatus, 3000);
    }
    
    async function loadCommsBitacora() {
      try {
        const response = await fetch('/ans/bitacora?limit=20');
        if (!response.ok) return;
        
        const data = await response.json();
        const container = document.getElementById('comms-activity-list');
        
        // Filter comms-related entries
        const commsEntries = (data.entries || []).filter(e => 
          ['whatsapp', 'telegram', 'audio', 'comms'].includes(e.category?.toLowerCase())
        );
        
        if (commsEntries.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted);">Sin eventos de comunicaciÃ³n recientes</p>';
          return;
        }
        
        container.innerHTML = commsEntries.slice(0, 10).map(e => {
          const time = new Date(e.timestamp || Date.now()).toLocaleTimeString();
          const icon = e.icon || 'ðŸ“¡';
          const levelColor = e.level === 'error' ? 'var(--accent-red)' : 
                             e.level === 'warning' ? 'var(--accent-orange)' : 'var(--text-muted)';
          return `<div style="padding: 0.5rem; border-bottom: 1px solid var(--border);">
            <span style="color: var(--text-muted);">${time}</span> ${icon} 
            <span style="color: ${levelColor};">${e.message || e.event || '--'}</span>
          </div>`;
        }).join('');
      } catch (e) {
        console.error('Error loading comms bitacora:', e);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HEALTH WIDGET
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function updateHealthWidget() {
      try {
        const response = await fetch('/health');
        if (!response.ok) throw new Error('Health endpoint unavailable');
        
        const data = await response.json();
        const score = data.score || 0;
        const checks = data.checks || {};
        
        // Update score badge
        const scoreBadge = document.getElementById('health-score-badge');
        const scoreValue = document.getElementById('health-score-value');
        const statusIcon = document.getElementById('health-status-icon');
        
        if (scoreValue) scoreValue.textContent = score;
        
        if (scoreBadge && statusIcon) {
          scoreBadge.className = 'health-score-badge';
          statusIcon.className = 'health-status-icon';
          if (score >= 80) {
            scoreBadge.classList.add('ok');
          } else if (score >= 50) {
            scoreBadge.classList.add('warning');
            statusIcon.classList.add('warning');
          } else {
            scoreBadge.classList.add('critical');
            statusIcon.classList.add('critical');
          }
        }
        
        // Update metrics
        const servicesOk = Object.values(checks).filter(c => c === true).length;
        const servicesTotal = Object.keys(checks).length;
        document.getElementById('health-services').textContent = `${servicesOk}/${servicesTotal}`;
        document.getElementById('health-services').className = 'health-metric-value ' + (servicesOk === servicesTotal ? 'ok' : 'warning');
        
        // Memory status
        try {
          const memRes = await fetch('/api/cognitive-memory/lifelog/status');
          const memData = await memRes.json();
          if (memData.ok) {
            const entries = memData.total_entries || 0;
            document.getElementById('health-memory').textContent = entries > 0 ? `${entries} entries` : 'OK';
            document.getElementById('health-memory').className = 'health-metric-value ok';
          }
        } catch (e) {
          document.getElementById('health-memory').textContent = 'N/A';
          document.getElementById('health-memory').className = 'health-metric-value';
        }
        
        // ANS cycles
        try {
          const ansRes = await fetch('/nervous/status');
          const ansData = await ansRes.json();
          if (ansData.ok) {
            const cycles = ansData.cycles_completed || 0;
            document.getElementById('health-ans').textContent = cycles;
            document.getElementById('health-ans').className = 'health-metric-value ok';
          }
        } catch (e) {
          document.getElementById('health-ans').textContent = 'N/A';
          document.getElementById('health-ans').className = 'health-metric-value';
        }
        
        // Uptime
        const uptime = data.uptime_seconds || 0;
        const hours = Math.floor(uptime / 3600);
        const mins = Math.floor((uptime % 3600) / 60);
        document.getElementById('health-uptime').textContent = `${hours}h ${mins}m`;
        document.getElementById('health-uptime').className = 'health-metric-value ok';
        
        // Lifelog
        try {
          const llRes = await fetch('/api/cognitive-memory/lifelog/status');
          const llData = await llRes.json();
          if (llData.ok) {
            const rate = llData.success_rate || 0;
            document.getElementById('health-lifelog').textContent = `${Math.round(rate * 100)}%`;
            document.getElementById('health-lifelog').className = 'health-metric-value ' + (rate >= 0.8 ? 'ok' : 'warning');
          }
        } catch (e) {
          document.getElementById('health-lifelog').textContent = 'N/A';
          document.getElementById('health-lifelog').className = 'health-metric-value';
        }
        
        // Incidents
        try {
          const incRes = await fetch('/ans/incidents?status=open&limit=100');
          const incData = await incRes.json();
          const openCount = (incData.incidents || []).length;
          document.getElementById('health-incidents').textContent = openCount;
          document.getElementById('health-incidents').className = 'health-metric-value ' + (openCount === 0 ? 'ok' : 'warning');
        } catch (e) {
          document.getElementById('health-incidents').textContent = '0';
          document.getElementById('health-incidents').className = 'health-metric-value ok';
        }
        
      } catch (e) {
        console.error('Error updating health widget:', e);
        document.getElementById('health-score-value').textContent = 'ERR';
      }
    }

    // Auto-refresh comms when tab is active
    document.addEventListener('DOMContentLoaded', () => {
      const commsTab = document.querySelector('[data-tab="comms"]');
      if (commsTab) {
        commsTab.addEventListener('click', () => {
          refreshCommsStatus();
          loadCommsBitacora();
          refreshVoiceStatus();
        });
      }
      
      // Update health widget on modules tab load
      const modulosTab = document.querySelector('[data-tab="modulos"]');
      if (modulosTab) {
        modulosTab.addEventListener('click', () => {
          updateHealthWidget();
        });
      }
      
      // Initial health widget update
      updateHealthWidget();
      
      // Auto-refresh health widget every 30 seconds
      setInterval(updateHealthWidget, 30000);
    });
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VOICE ASSISTANT - Control de interacciÃ³n por voz
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let voiceAssistantRunning = false;
    
    async function refreshVoiceStatus() {
      try {
        const response = await fetch('/ans/voice/status');
        if (!response.ok) return;
        
        const data = await response.json();
        voiceAssistantRunning = data.running;
        
        const statusEl = document.getElementById('voice-assistant-status');
        const btnEl = document.getElementById('voice-toggle-btn');
        
        if (data.running) {
          statusEl.textContent = 'ðŸŸ¢ Activo (PID: ' + data.pid + ')';
          statusEl.style.color = 'var(--accent-green)';
          btnEl.textContent = 'ðŸ›‘ Detener Voz';
          btnEl.style.background = 'var(--accent-red)';
        } else {
          statusEl.textContent = 'âšª Inactivo';
          statusEl.style.color = 'var(--text-muted)';
          btnEl.textContent = 'ðŸŽ¤ Iniciar Voz';
          btnEl.style.background = '';
        }
      } catch (e) {
        console.error('Error refreshing voice status:', e);
      }
    }
    
    async function toggleVoiceAssistant() {
      const endpoint = voiceAssistantRunning ? '/ans/voice/stop' : '/ans/voice/start';
      const action = voiceAssistantRunning ? 'Deteniendo' : 'Iniciando';
      
      try {
        addToBitacora(action + ' asistente de voz...', 'info', 'voice');
        
        const response = await fetch(endpoint, { method: 'POST' });
        const data = await response.json();
        
        if (data.ok) {
          addToBitacora('Asistente de voz ' + (voiceAssistantRunning ? 'detenido' : 'iniciado'), 'success', 'voice');
          setTimeout(refreshVoiceStatus, 1000);
        } else {
          throw new Error(data.error || 'Error');
        }
      } catch (e) {
        alert('Error: ' + e.message);
        addToBitacora('Error con asistente de voz: ' + e.message, 'error', 'voice');
      }
    }
    
    async function speakCustomText() {
      const input = document.getElementById('speak-text-input');
      const text = (input.value || '').trim();
      
      if (!text) {
        alert('Escribe algo para que ATLAS hable');
        return;
      }
      
      try {
        addToBitacora('ATLAS hablando: ' + text.substring(0, 30) + '...', 'info', 'voice');
        
        const response = await fetch('/ans/voice/speak?text=' + encodeURIComponent(text), {
          method: 'POST'
        });
        const data = await response.json();
        
        if (data.ok) {
          addToBitacora('ATLAS hablÃ³ correctamente', 'success', 'voice');
          input.value = '';
        } else {
          throw new Error(data.error || 'Error');
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    // Enter key para hablar
    document.addEventListener('DOMContentLoaded', () => {
      const speakInput = document.getElementById('speak-text-input');
      if (speakInput) {
        speakInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') speakCustomText();
        });
      }
    });
  </script>
</body>
</html>

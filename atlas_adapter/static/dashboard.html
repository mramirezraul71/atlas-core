<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ATLAS Dashboard v2.5.0</title>
  <style>
    :root {
      /* Base oscuro con toques morados */
      --bg: #0d0c12;
      --bg-elevated: #14121b;
      --card: #16141f;
      --card-border: rgba(139, 92, 246, 0.12);
      --text: #e8e6ed;
      --muted: #78748a;
      /* Acento principal: morado/violeta */
      --accent: #8b5cf6;
      --accent-hover: #a78bfa;
      --accent-muted: rgba(139, 92, 246, 0.2);
      --purple: #8b5cf6;
      --purple-light: #a78bfa;
      --purple-dark: #6d28d9;
      /* Estado */
      --green: #22c55e;
      --red: #ef4444;
      --amber: #eab308;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(139, 92, 246, 0.08), transparent);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--card-border);
    }
    h1 {
      font-size: 1.5rem;
      margin: 0;
      font-weight: 600;
      background: linear-gradient(135deg, var(--text) 0%, var(--purple-light) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header-actions { display: flex; align-items: center; gap: .75rem; }
    .last-update { font-size: .75rem; color: var(--muted); }
    .last-update.updating { animation: pulse 0.8s ease-in-out infinite; }
    @keyframes pulse { 50% { opacity: 0.6; } }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 1.1rem;
      border: 1px solid var(--card-border);
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
      transition: border-color .2s, box-shadow .2s;
    }
    .card:hover {
      border-color: rgba(139, 92, 246, 0.25);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.08);
    }
    .card h2 {
      font-size: .75rem;
      margin: 0 0 .5rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 600;
    }
    .card h2::after {
      content: '';
      display: inline-block;
      width: 3px;
      height: 10px;
      background: var(--purple);
      border-radius: 2px;
      margin-left: 6px;
      vertical-align: middle;
    }
    .card .value { font-size: .95rem; word-break: break-word; line-height: 1.4; }
    .card.loading .value { color: var(--muted); }
    .card.error .value { color: var(--red); }
    .row { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; margin-top: .5rem; }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: .4rem .75rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: .875rem;
      font-weight: 500;
      transition: background .2s, transform .1s;
    }
    button:hover { background: var(--accent-hover); }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    button.danger { background: var(--red); }
    button.danger:hover { filter: brightness(1.1); }
    button.growth { background: var(--green); color: #fff; }
    button.growth:hover { filter: brightness(1.1); }
    button.governed { background: #64748b; color: #fff; }
    button.governed:hover { filter: brightness(1.1); }
    button.secondary {
      background: var(--accent-muted);
      color: var(--purple-light);
      border: 1px solid rgba(139, 92, 246, 0.3);
    }
    button.secondary:hover {
      background: rgba(139, 92, 246, 0.3);
      border-color: var(--purple);
    }
    button.small { padding: .25rem .5rem; font-size: .75rem; }
    button.btn-brain-active { background: var(--green); color: #fff; border: 1px solid var(--green); }
    button.btn-brain-active:hover { filter: brightness(1.1); }
    .brain-model-panel .brain-model-row { display: flex; align-items: center; justify-content: space-between; gap: .75rem; padding: .5rem 0; border-bottom: 1px solid rgba(139,92,246,0.12); font-size: .8rem; min-height: 2rem; }
    .brain-model-panel .brain-model-row:last-child { border-bottom: none; }
    .brain-model-panel .brain-model-label { flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: .5rem; }
    .brain-model-panel .brain-model-actions { display: flex; align-items: center; gap: .5rem; flex-shrink: 0; flex-wrap: nowrap; }
    .brain-model-panel .brain-model-actions button { padding: .2rem .4rem; font-size: .7rem; }
    .brain-panel-hint { font-size: .75rem; color: var(--muted); margin: 0 0 .75rem; line-height: 1.4; }
    .brain-providers-header { margin-top: .75rem; padding-top: .6rem; border-top: 1px solid rgba(139,92,246,0.2); font-size: .7rem; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; margin-bottom: .25rem; }
    .brain-status-configured { font-size: .75rem; color: var(--green); margin-right: .5rem; white-space: nowrap; }
    .brain-dominant-connected { color: var(--green) !important; font-weight: 600; }
    .brain-dominant-error { color: var(--red) !important; }
    .badge { display: inline-block; padding: .2rem .45rem; border-radius: 4px; font-size: .75rem; font-weight: 500; }
    .badge.ok { background: rgba(34,197,94,.25); color: var(--green); }
    .badge.warn { background: rgba(234,179,8,.25); color: var(--amber); }
    .badge.err { background: rgba(239,68,68,.25); color: var(--red); }
    .score-bar {
      height: 6px;
      background: var(--bg-elevated);
      border-radius: 3px;
      overflow: hidden;
      margin-top: .4rem;
      max-width: 120px;
    }
    #health-bar-fill { transition: width .3s ease, background .2s; }
    ul { margin: 0; padding-left: 1.2rem; font-size: .875rem; }
    #approvals-list li { margin-bottom: .35rem; }
    .metrics-list { font-size: .8rem; color: var(--muted); margin-top: .3rem; }
    /* Men√∫ desplegable horizontal */
    .nav-horizontal { display: flex; align-items: center; gap: .5rem; flex-wrap: wrap; }
    .nav-dropdown-wrap { position: relative; }
    .nav-dropdown-btn {
      display: flex; align-items: center; gap: .35rem;
      background: var(--accent-muted); color: var(--purple-light);
      border: 1px solid rgba(139, 92, 246, 0.3);
      padding: .5rem .85rem; border-radius: 8px;
      cursor: pointer; font-size: .875rem; font-weight: 500;
      transition: background .2s, border-color .2s;
    }
    .nav-dropdown-btn:hover {
      background: rgba(139, 92, 246, 0.3);
      border-color: var(--purple);
    }
    .nav-dropdown-btn.open { background: rgba(139, 92, 246, 0.25); border-color: var(--purple); }
    .nav-dropdown-btn .chevron { font-size: .7em; transition: transform .2s; }
    .nav-dropdown-btn.open .chevron { transform: rotate(180deg); }
    .nav-dropdown-panel {
      display: none; position: absolute; top: 100%; left: 0; margin-top: .35rem;
      min-width: 320px; max-width: 95vw; max-height: 80vh; overflow-y: auto;
      background: var(--card); border: 1px solid var(--card-border);
      border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.4);
      z-index: 100; padding: 1rem;
    }
    .nav-dropdown-panel.open { display: block; }
    .nav-dropdown-panel h3 { font-size: .8rem; color: var(--muted); margin: 1rem 0 .5rem; text-transform: uppercase; letter-spacing: .05em; }
    .nav-dropdown-panel h3:first-child { margin-top: 0; }
    .metrics-list span { display: block; }

    /* Sidebar izquierdo: men√∫ con hamburguesa (‚ò∞) desplegable */
    .app-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 52px;
      background: var(--card);
      border-right: 1px solid var(--card-border);
      z-index: 200;
      display: flex;
      flex-direction: column;
      transition: width .25s ease, box-shadow .25s ease;
      overflow: hidden;
    }
    .app-sidebar.open {
      width: min(320px, 90vw);
      box-shadow: 4px 0 20px rgba(0,0,0,.3);
    }
    .sidebar-toggle {
      flex-shrink: 0;
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-muted);
      border: none;
      border-bottom: 1px solid var(--card-border);
      color: var(--purple-light);
      font-size: 1.4rem;
      cursor: pointer;
      transition: background .2s;
    }
    .sidebar-toggle:hover { background: rgba(139, 92, 246, 0.3); }
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      min-width: 0;
      display: none;
    }
    .app-sidebar.open .sidebar-content { display: block; }
    .sidebar-content .card { margin-bottom: .75rem; }
    .sidebar-content .grid { grid-template-columns: 1fr; }
    .main-wrap { margin-left: 52px; transition: margin-left .25s ease; min-height: 100vh; }
    .app-sidebar.open ~ .main-wrap { margin-left: min(320px, 90vw); }
    /* Interacci√≥n robot */
    .robot-section { margin-top: 1.5rem; }
    .robot-section .card { padding: 1.25rem; }
    .robot-section h2 { margin-bottom: .75rem; }
    .robot-task-type { margin-bottom: .75rem; }
    .robot-task-type label { display: block; font-size: .8rem; color: var(--muted); margin-bottom: .35rem; }
    .robot-task-type select {
      width: 100%;
      max-width: 320px;
      padding: .5rem;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--card-border);
      color: var(--text);
      font-size: .9rem;
    }
    .robot-task-type select:focus {
      outline: none;
      border-color: var(--purple);
      box-shadow: 0 0 0 2px var(--accent-muted);
    }
    .robot-task-help { font-size: .75rem; color: var(--muted); margin-top: .25rem; margin-bottom: .5rem; }
    .robot-input {
      width: 100%;
      min-height: 80px;
      padding: .75rem;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--card-border);
      color: var(--text);
      font-size: .9rem;
      resize: vertical;
      font-family: inherit;
      transition: border-color .2s, box-shadow .2s;
    }
    .robot-input:focus {
      outline: none;
      border-color: var(--purple);
      box-shadow: 0 0 0 2px var(--accent-muted);
    }
    .robot-input::placeholder { color: var(--muted); }
    .robot-actions { margin-top: .75rem; display: flex; gap: .5rem; align-items: center; }
    .robot-response {
      margin-top: 1rem;
      padding: .75rem;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--card-border);
      font-size: .85rem;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 280px;
      overflow-y: auto;
    }
    .robot-response.empty { color: var(--muted); }
    .robot-response.error { border-color: var(--red); color: var(--red); }
    /* Expandir panel: bot√≥n y modal */
    .btn-expand {
      background: none; border: none; cursor: pointer; padding: .2rem .35rem;
      font-size: .9rem; color: var(--muted); opacity: 0.7;
      border-radius: 4px; margin-left: .35rem; vertical-align: middle;
    }
    .btn-expand:hover { color: var(--purple-light); opacity: 1; background: var(--accent-muted); }
    .atlas-card-header {
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;
      gap: .5rem; margin-bottom: .5rem;
    }
    .atlas-card-header h2 { margin: 0; }
    .btn-expand-atlas {
      font-size: .75rem; padding: .4rem .65rem;
      background: var(--bg-elevated); border: 1px solid var(--card-border);
      color: var(--purple-light); border-radius: 6px; cursor: pointer;
    }
    .btn-expand-atlas:hover { background: var(--accent-muted); border-color: var(--purple-light); }
    .btn-expand-atlas .btn-expand-icon { margin-right: .3rem; }

    /* Command Center (tipo Cursor) */
    .cc-topbar { display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap; margin:.25rem 0 .75rem; }
    .cc-tabs { display:flex; gap:.4rem; flex-wrap:wrap; align-items:center; }
    .cc-tabbtn {
      background: var(--bg-elevated);
      color: var(--muted);
      border: 1px solid var(--card-border);
      padding: .28rem .55rem;
      border-radius: 999px;
      font-size: .75rem;
    }
    .cc-tabbtn:hover { background: rgba(139, 92, 246, 0.18); color: var(--purple-light); }
    .cc-tabbtn.active { background: rgba(139, 92, 246, 0.24); color: var(--text); border-color: rgba(139, 92, 246, 0.35); }
    .cc-panel { display:none; }
    .cc-panel.active { display:block; }
    .cc-split { display:grid; grid-template-columns: 1fr 320px; gap:.75rem; align-items:start; }
    @media (max-width: 880px) { .cc-split { grid-template-columns: 1fr; } }
    .cc-side {
      background: var(--bg-elevated);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: .75rem;
      min-height: 120px;
    }
    .cc-side h3 { margin: 0 0 .5rem; font-size: .75rem; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }
    .cc-evidence-img { width:100%; max-height: 180px; object-fit: cover; border-radius: 8px; border: 1px solid var(--card-border); background:#000; }
    .cc-ops-list { max-height: 320px; overflow:auto; font-size: .78rem; }
    .cc-ops-item { padding:.5rem .55rem; border:1px solid rgba(139,92,246,0.12); border-radius:10px; margin-bottom:.45rem; background: rgba(255,255,255,0.02); }
    .cc-ops-item .meta { color: var(--muted); font-size: .72rem; margin-top: .25rem; }
    .cc-ops-item .msg { white-space: pre-wrap; word-break: break-word; }
    .cc-ops-thumb { margin-top:.45rem; width:100%; max-height: 160px; object-fit: cover; border-radius: 8px; border: 1px solid var(--card-border); }
    .cc-terminal-mini { font-family: Consolas, monospace; font-size: .75rem; background: #0a0a0f; color:#a5d6ff; padding:.6rem; border-radius:8px; border:1px solid var(--card-border); max-height: 220px; overflow:auto; white-space: pre-wrap; word-break: break-all; }

    /* Cursor-ATLAS full-screen shell (IDE-like) */
    .cursor-atlas-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 12000;
      background: rgba(0,0,0,0.86);
      backdrop-filter: blur(10px);
      align-items: stretch;
      justify-content: stretch;
      padding: .75rem;
    }
    .cursor-atlas-overlay.open { display: flex; }
    .cursor-atlas-shell {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      background: rgba(22, 20, 31, 0.92);
      border: 1px solid rgba(139, 92, 246, 0.25);
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      overflow: hidden;
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 44px 1fr;
      grid-template-areas:
        "top top"
        "side main";
    }
    @media (max-width: 980px) {
      .cursor-atlas-shell { grid-template-columns: 1fr; grid-template-rows: 44px 1fr 220px; grid-template-areas: "top" "main" "side"; }
    }
    .cursor-atlas-topbar {
      grid-area: top;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.5rem;
      padding: .5rem .75rem;
      background: rgba(20, 18, 27, 0.9);
      border-bottom: 1px solid rgba(139, 92, 246, 0.18);
    }
    .cursor-atlas-topbar .title {
      font-weight: 650;
      font-size: .85rem;
      letter-spacing: .05em;
      text-transform: uppercase;
      color: var(--text);
    }
    .cursor-atlas-topbar .title span { color: var(--purple-light); }
    .cursor-atlas-topbar .cmdbar {
      display:flex; align-items:center; gap:.5rem; flex: 1; justify-content: center;
    }
    .cursor-atlas-topbar input.cmdbar-input {
      width: min(720px, 100%);
      padding: .38rem .6rem;
      border-radius: 10px;
      border: 1px solid rgba(139, 92, 246, 0.25);
      background: rgba(13, 12, 18, 0.65);
      color: var(--text);
      font-size: .85rem;
      outline: none;
    }
    .cursor-atlas-topbar input.cmdbar-input:focus {
      border-color: rgba(139, 92, 246, 0.55);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.18);
    }
    .cursor-atlas-side {
      grid-area: side;
      padding: .65rem;
      overflow: auto;
      border-right: 1px solid rgba(139, 92, 246, 0.15);
      background: rgba(13, 12, 18, 0.35);
    }
    .cursor-atlas-main {
      grid-area: main;
      padding: .65rem;
      overflow: auto;
      min-height: 0;
    }
    .ca-group {
      margin-bottom: .75rem;
      padding: .6rem;
      border-radius: 12px;
      border: 1px solid rgba(139, 92, 246, 0.12);
      background: rgba(255,255,255,0.02);
    }
    .ca-group h3 {
      margin: 0 0 .5rem;
      font-size: .72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .ca-item {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.5rem;
      padding: .38rem .45rem;
      border-radius: 10px;
      cursor:pointer;
      border: 1px solid transparent;
      color: var(--text);
      font-size: .82rem;
    }
    .ca-item:hover {
      background: rgba(139, 92, 246, 0.10);
      border-color: rgba(139, 92, 246, 0.18);
    }
    .ca-item small { color: var(--muted); font-size: .72rem; }
    .kbd {
      font-family: Consolas, monospace;
      font-size: .72rem;
      color: var(--purple-light);
      border: 1px solid rgba(139, 92, 246, 0.25);
      background: rgba(139, 92, 246, 0.10);
      padding: .08rem .35rem;
      border-radius: 6px;
      white-space: nowrap;
    }

    /* Command palette (Ctrl+K) */
    .cmdk-overlay {
      display:none;
      position: fixed;
      inset: 0;
      z-index: 13000;
      background: rgba(0,0,0,0.80);
      backdrop-filter: blur(8px);
      align-items: flex-start;
      justify-content: center;
      padding-top: 12vh;
    }
    .cmdk-overlay.open { display:flex; }
    .cmdk-box {
      width: min(860px, 94vw);
      border-radius: 14px;
      border: 1px solid rgba(139, 92, 246, 0.25);
      background: rgba(20, 18, 27, 0.92);
      box-shadow: 0 18px 70px rgba(0,0,0,0.65);
      overflow: hidden;
    }
    .cmdk-head { padding: .75rem .85rem; border-bottom: 1px solid rgba(139, 92, 246, 0.15); display:flex; align-items:center; gap:.6rem; }
    .cmdk-head input {
      flex: 1;
      padding: .5rem .6rem;
      border-radius: 10px;
      border: 1px solid rgba(139, 92, 246, 0.22);
      background: rgba(13, 12, 18, 0.55);
      color: var(--text);
      outline: none;
      font-size: .9rem;
    }
    .cmdk-head .hint { color: var(--muted); font-size: .78rem; }
    .cmdk-list { max-height: 52vh; overflow:auto; padding: .35rem; }
    .cmdk-item {
      padding: .55rem .65rem;
      border-radius: 12px;
      cursor:pointer;
      border: 1px solid transparent;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:.8rem;
    }
    .cmdk-item:hover { background: rgba(139, 92, 246, 0.10); border-color: rgba(139, 92, 246, 0.18); }
    .cmdk-item.active { background: rgba(139, 92, 246, 0.18); border-color: rgba(139, 92, 246, 0.28); }
    .cmdk-item .t { font-weight: 600; font-size: .88rem; }
    .cmdk-item .d { color: var(--muted); font-size: .78rem; margin-top:.15rem; }
    .cmdk-foot { padding: .55rem .85rem; border-top: 1px solid rgba(139, 92, 246, 0.12); display:flex; align-items:center; justify-content:space-between; color: var(--muted); font-size: .78rem; }
    .expand-modal {
      display: none; position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,.85); backdrop-filter: blur(6px);
      align-items: center; justify-content: center; padding: 2rem;
    }
    .expand-modal.open { display: flex; }
    .expand-modal-content {
      background: var(--card); border: 1px solid var(--card-border);
      border-radius: 12px; max-width: 95vw; max-height: 90vh;
      width: 100%; overflow: auto; padding: 1.5rem;
      box-shadow: 0 8px 32px rgba(0,0,0,.5);
    }
    /* Ventana de ampliaci√≥n tipo Cursor: casi pantalla completa, mismo panel interactivo */
    .expand-modal.expand-modal--atlas { padding: .75rem; align-items: stretch; justify-content: stretch; }
    .expand-modal.expand-modal--atlas .expand-modal-content {
      max-width: none; max-height: none; width: 100%; height: 100%;
      border-radius: 10px; display: flex; flex-direction: column;
      min-height: 0; overflow: hidden;
    }
    .expand-modal.expand-modal--atlas #expand-modal-body {
      flex: 1; overflow: auto; min-height: 0; padding: 0;
    }
    .expand-modal.expand-modal--atlas #expand-modal-body .card {
      min-height: min(100%, 85vh); display: flex; flex-direction: column;
    }
    .expand-modal.expand-modal--atlas #expand-modal-body .robot-response {
      flex: 1; min-height: 200px; max-height: none;
    }
    .expand-modal.expand-modal--atlas #expand-modal-body .robot-input {
      min-height: 80px;
    }
    /* Ventana de ampliaci√≥n C√°maras: casi pantalla completa, streams m√°s grandes */
    .expand-modal.expand-modal--cameras { padding: .75rem; align-items: stretch; justify-content: stretch; }
    .expand-modal.expand-modal--cameras .expand-modal-content {
      max-width: none; max-height: none; width: 100%; height: 100%;
      border-radius: 10px; display: flex; flex-direction: column;
      min-height: 0; overflow: hidden;
    }
    .expand-modal.expand-modal--cameras #expand-modal-body {
      flex: 1; overflow: auto; min-height: 0; padding: 0;
    }
    .expand-modal.expand-modal--cameras #expand-modal-body .card {
      min-height: min(100%, 85vh); display: flex; flex-direction: column;
    }
    .expand-modal.expand-modal--cameras #expand-modal-body .nexus-panel-iframe-wrap {
      min-height: 280px;
    }
    .expand-modal-content .pre-expand { max-height: none !important; height: 70vh !important; font-size: .85rem !important; }
    .expand-modal-content .list-expand { max-height: none !important; height: 70vh !important; }
    .expand-modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1rem; padding-bottom: .75rem; border-bottom: 1px solid var(--card-border);
    }
    .expand-modal-header h2 { margin: 0; font-size: 1rem; }
    .btn-close-expand {
      background: var(--red); color: #fff; border: none; padding: .35rem .75rem;
      border-radius: 6px; cursor: pointer; font-size: .8rem;
    }
    .btn-close-expand:hover { filter: brightness(1.1); }

    /* Panel integrado Cuerpo (NEXUS): overlay con iframe */
    .nexus-panel-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeIn 0.2s ease;
    }
    .nexus-panel-overlay.open { display: flex; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .nexus-panel-box {
      width: 95vw;
      max-width: 1200px;
      height: 88vh;
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .nexus-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--card-border);
      flex-shrink: 0;
    }
    .nexus-panel-header h2 {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }
    .nexus-panel-header h2 span { color: var(--muted); font-weight: 400; }
    .nexus-panel-iframe-wrap {
      flex: 1;
      min-height: 0;
      background: #0d0c12;
    }
    .nexus-panel-iframe-wrap iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
    .nexus-panel-iframe-wrap .nexus-unavailable {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted);
      font-size: 0.9rem;
      padding: 2rem;
      text-align: center;
    }

  </style>
</head>
<body>
  <aside id="app-sidebar" class="app-sidebar" aria-label="Men√∫ principal">
    <button type="button" class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Abrir o cerrar men√∫" title="Men√∫">‚ò∞</button>
    <div class="sidebar-content">
      <div id="nav-opciones-content" style="display:flex;flex-direction:column;gap:1rem;">
        <div class="grid" style="grid-template-columns:1fr;gap:.75rem;">
          <div class="card" id="metrics-card"><h2 data-i18n="card.metrics">M√©tricas</h2><div class="value">‚Äî</div><div class="metrics-list" id="metrics-detail"></div></div>
          <div class="card" id="scheduler-card"><h2 data-i18n="card.scheduler">Programador</h2><div class="value">‚Äî</div><div class="row"></div></div>
          <div class="card" id="cluster-card"><h2 data-i18n="card.cluster">Cluster</h2><div class="value">‚Äî</div><div class="row"><button class="small" onclick="loadCluster()" data-i18n="cluster.view">Ver nodos</button></div></div>
          <div class="card" id="gateway-card"><h2 data-i18n="card.gateway">Gateway</h2><div class="value">‚Äî</div><div class="row"><button class="small" onclick="loadGateway()" data-i18n="gateway.view">Ver</button></div></div>
          <div class="card" id="approvals-card">
            <h2 data-i18n="card.approvals">Aprobaciones
              <button type="button" class="small secondary" style="float:right;" onclick="expandPanel('owner-console-section','Aprobaciones','#approvals-card,#owner-pending-list,#owner-expired-list')" title="Abrir / Maximizar">‚õ∂</button>
            </h2>
            <div class="value">
              <ul id="approvals-list"></ul>
              <div id="evolution-pending" style="margin-top:.5rem;font-size:.8rem;"></div>
            </div>
          </div>
        </div>
        <div id="nav-opciones-sections"></div>
      </div>
    </div>
  </aside>
  <div class="main-wrap">
  <div id="nexus-panel-overlay" class="nexus-panel-overlay" onclick="if(event.target===this) closeNexusPanel()">
    <div class="nexus-panel-box" onclick="event.stopPropagation()">
      <div class="nexus-panel-header">
        <h2>CEREBRO <span>‚Üí</span> CUERPO (NEXUS)</h2>
        <button type="button" class="btn-close-expand" onclick="closeNexusPanel()">Cerrar</button>
      </div>
      <div class="nexus-panel-iframe-wrap" id="nexus-panel-iframe-wrap">
        <iframe id="nexus-panel-iframe" title="Panel NEXUS (Cuerpo)" style="display:none;"></iframe>
        <div id="nexus-panel-unavailable" class="nexus-unavailable" style="display:none;">NEXUS no est√° disponible en el puerto 8000.<br>Pulsa ¬´Reconectar NEXUS¬ª en la tarjeta Estado y vuelve a abrir este panel.</div>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="header">
      <h1 data-i18n="app.title">ATLAS Dashboard <span style="font-size: 0.6em; color: var(--purple); font-weight: 400; margin-left: 0.5rem; padding: 0.15rem 0.4rem; background: var(--accent-muted); border-radius: 4px; vertical-align: middle;">v2.5.0</span></h1>
      <div class="header-actions nav-horizontal">
        <span style="font-size:.75rem;color:var(--muted);margin-right:.5rem;">
          <a href="#" onclick="setLocale('es');return false;" id="lang-es" style="color:var(--purple-light);text-decoration:none;">ES</a>
          <span style="color:var(--muted);">|</span>
          <a href="#" onclick="setLocale('en');return false;" id="lang-en" style="color:var(--muted);text-decoration:none;">EN</a>
        </span>
        <span class="last-update" id="last-update">‚Äî</span>
        <button class="secondary" id="btn-refresh" onclick="refreshAll()" data-i18n="app.refresh">Actualizar</button>
        <button class="small" id="btn-cursor-atlas" onclick="openCursorAtlas()" title="Abrir Cursor‚ÄëATLAS (centro de mando)"><span class="kbd">Ctrl</span>+<span class="kbd">K</span> Cursor‚ÄëATLAS</button>
        <button class="small secondary" id="btn-clear-cache" onclick="clearCacheAndRefresh()" title="Limpiar cache del navegador y del servidor (proceso pendiente se mata al reconectar)">Limpiar cach√©</button>
        <button class="small" id="btn-check-update" onclick="checkForUpdates()" style="background: linear-gradient(135deg, #6d28d9, #8b5cf6); border: 1px solid var(--purple);" title="Verificar si hay actualizaciones disponibles">üîÑ Buscar Actualizaci√≥n</button>
      </div>
    </div>
    <!-- Governance bar: GROWTH / GOVERNED / EMERGENCY STOP -->
    <div class="governance-bar" id="governance-bar" style="display:flex;align-items:center;gap:.5rem;padding:.5rem 0;margin-bottom:.75rem;border-bottom:1px solid var(--card-border);">
      <span style="font-size:.75rem;color:var(--muted);margin-right:.5rem;" data-i18n="gov.label">Governance:</span>
      <button class="growth" id="gov-growth" onclick="govSetMode('growth')">GROWTH</button>
      <button class="governed" id="gov-governed" onclick="govSetMode('governed')">GOVERNED</button>
      <button class="danger" id="gov-emergency" onclick="govEmergencyStop()">EMERGENCY STOP</button>
      <span class="badge" id="gov-status" style="margin-left:.5rem;">‚Äî</span>
      <span class="last-update" id="gov-msg"></span>
    </div>
    <!-- Grid principal: siempre visible -->
    <div class="grid">
      <div class="card" id="status-card"><h2 data-i18n="card.status">Estado</h2><div class="value">‚Äî</div><div class="row" style="margin-top:.35rem;flex-wrap:wrap;gap:.35rem;"><button class="small secondary" id="btn-reconnect-nexus" onclick="reconnectNexus()" title="Arrancar Cuerpo (NEXUS+Robot) y actualizar estado">Reconectar Cuerpo</button><button class="small secondary" id="btn-nexus-panel" onclick="openNexusPanel()" title="Abrir panel NEXUS integrado (proxy)">Panel NEXUS</button>
          <button class="small secondary" id="btn-robot-panel" onclick="openRobotPanel()" title="Abrir p√°gina del Robot (c√°maras/visi√≥n) v√≠a proxy /cuerpo/">P√°gina del Robot</button></div></div>
      <div class="card" id="brain-card">
        <h2>Cerebro</h2>
        <div class="value" id="brain-dominant">IA dominante: ‚Äî</div>
        <div class="metrics-list" id="brain-config-line" style="margin-top:.25rem;font-size:.72rem;"></div>
        <p class="robot-task-help" style="color:var(--muted);font-size:.7rem;margin:.35rem 0;">Auto: multi-IA free, el router elige el especialista. Manual: eliges una IA (suscripci√≥n/API).</p>
        <div class="row brain-mode-row" style="margin-top:.35rem;flex-wrap:wrap;gap:.35rem;align-items:center;">
          <button class="small btn-brain-active" id="brain-btn-auto" onclick="setBrainMode('auto')" title="Multi-IA: el router elige por tarea">Auto</button>
          <button class="small secondary" id="brain-btn-manual" onclick="setBrainMode('manual')" title="Elegir una IA concreta">Manual</button>
          <button class="small secondary" id="brain-btn-elegir" onclick="toggleBrainModelPanel()" title="Abrir lista de modelos (free y suscripci√≥n/API)">Elegir modelo</button>
          <button class="small secondary" id="brain-btn-audit" onclick="openBrainAudit()" title="Auditor√≠a t√©cnica del cerebro (latencias, IA, validadores)">Auditar</button>
        </div>
        <div id="brain-model-panel" class="brain-model-panel" style="display:none;margin-top:.75rem;padding:1rem;background:var(--bg-elevated);border-radius:10px;border:1px solid var(--card-border);max-height:320px;overflow-y:auto;">
          <p class="brain-panel-hint">
            Selecciona una IA. Suscripci√≥n/API: <strong>Conectar</strong> abre la p√°gina del proveedor.
            Credenciales: <strong>Cargar B√≥veda</strong> lee `credenciales.txt` y configura el cerebro sin pegar claves.
          </p>
          <div class="row" style="margin:.25rem 0 .75rem;gap:.4rem;">
            <button class="small secondary" id="brain-btn-vault" onclick="loadBrainVault()" title="Cargar claves desde B√≥veda">Cargar B√≥veda</button>
            <button class="small secondary" onclick="loadBrainState()" title="Refrescar estado del cerebro">Refrescar</button>
          </div>
          <div id="brain-model-list"></div>
        </div>
      </div>
      <div class="card" id="organs-card">
        <h2>√ìrganos</h2>
        <div class="value" id="organs-status">‚Äî</div>
        <div class="metrics-list" id="organs-detail"></div>
      </div>
      <div class="card" id="cameras-card" style="grid-column: span 2;">
        <div class="atlas-card-header">
          <h2>C√°maras (Cuerpo)</h2>
          <button type="button" class="btn-expand-atlas" onclick="expandCamerasPanel()" title="Abrir en ventana ampliada"><span class="btn-expand-icon">‚õ∂</span> Ampliar ventana</button>
        </div>
        <div class="value" id="cameras-status">Robot: ‚Äî</div>
        <p id="cameras-disconnected-hint" class="robot-task-help" style="display:none;color:var(--muted);font-size:.75rem;margin:.35rem 0 0;">Arranca el servicio del Robot (pulsa ¬´Reconectar Robot¬ª) o <a href="#" id="cameras-show-commands" onclick="showRobotStartCommands(); return false;" style="color:var(--purple-light);">ver comandos para arrancar a mano</a>.</p>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;margin-top:.5rem;">
          <div>
            <div style="font-size:.7rem;color:var(--muted);margin-bottom:.25rem;">NexiGo N930W IR (0)</div>
            <div class="nexus-panel-iframe-wrap" style="height:160px;border-radius:8px;overflow:hidden;background:var(--bg-elevated);border:1px solid var(--card-border);position:relative;">
              <img id="camera-stream-img-0" src="" alt="Stream c√°mara 0" style="width:100%;height:100%;object-fit:contain;display:none;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div id="cameras-no-stream-0" style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:.7rem;text-align:center;padding:.5rem;">C√°mara 0 offline</div>
            </div>
            <div class="row" style="margin-top:.35rem;gap:.25rem;flex-wrap:wrap;align-items:center;">
              <button class="small secondary" id="btn-camera-connect-0" onclick="cameraConnect(0)" title="Conectar c√°mara 0">Conectar</button>
              <button class="small secondary" id="btn-camera-off-0" onclick="cameraDisconnect(0)" title="Apagar c√°mara 0">Apagar</button>
              <span id="camera-state-0" style="font-size:.7rem;color:var(--muted);">‚Äî</span>
            </div>
          </div>
          <div>
            <div style="font-size:.7rem;color:var(--muted);margin-bottom:.25rem;">NexiGo N930W (1)</div>
            <div class="nexus-panel-iframe-wrap" style="height:160px;border-radius:8px;overflow:hidden;background:var(--bg-elevated);border:1px solid var(--card-border);position:relative;">
              <img id="camera-stream-img-1" src="" alt="Stream c√°mara 1" style="width:100%;height:100%;object-fit:contain;display:none;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div id="cameras-no-stream-1" style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:.7rem;text-align:center;padding:.5rem;">C√°mara 1 offline</div>
            </div>
            <div class="row" style="margin-top:.35rem;gap:.25rem;flex-wrap:wrap;align-items:center;">
              <button class="small secondary" id="btn-camera-connect-1" onclick="cameraConnect(1)" title="Conectar c√°mara 1">Conectar</button>
              <button class="small secondary" id="btn-camera-off-1" onclick="cameraDisconnect(1)" title="Apagar c√°mara 1">Apagar</button>
              <span id="camera-state-1" style="font-size:.7rem;color:var(--muted);">‚Äî</span>
            </div>
          </div>
          <div>
            <div style="font-size:.7rem;color:var(--muted);margin-bottom:.25rem;">Insta360 Link 2 (2)</div>
            <div class="nexus-panel-iframe-wrap" style="height:160px;border-radius:8px;overflow:hidden;background:var(--bg-elevated);border:1px solid var(--card-border);position:relative;">
              <img id="camera-stream-img-2" src="" alt="Stream c√°mara 2" style="width:100%;height:100%;object-fit:contain;display:none;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div id="cameras-no-stream-2" style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:.7rem;text-align:center;padding:.5rem;">C√°mara 2 offline</div>
            </div>
            <div class="row" style="margin-top:.35rem;gap:.25rem;flex-wrap:wrap;align-items:center;">
              <button class="small secondary" id="btn-camera-connect-2" onclick="cameraConnect(2)" title="Conectar c√°mara 2">Conectar</button>
              <button class="small secondary" id="btn-camera-off-2" onclick="cameraDisconnect(2)" title="Apagar c√°mara 2">Apagar</button>
              <span id="camera-state-2" style="font-size:.7rem;color:var(--muted);">‚Äî</span>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:.35rem; flex-wrap:wrap; gap:.35rem;">
          <button class="small secondary" id="btn-actualizar-camaras" onclick="loadCamerasStatus()" title="Comprobar Robot y refrescar stream">Actualizar c√°maras</button>
          <button class="small" id="btn-reconectar-robot" onclick="reconnectRobot()" title="Arrancar backend del Robot (c√°maras) si est√° parado">Reconectar Robot</button>
          <button class="small secondary" id="btn-diagnostico-camaras" onclick="runCamerasDiagnostic()" title="Prueba 0‚Üí1‚Üí2 y reporta cu√°l falla">Diagn√≥stico secuencial</button>
          <span id="cameras-diagnostic-result" style="font-size:.72rem;color:var(--muted);">‚Äî</span>
        </div>
      </div>
      <div class="card" id="version-card"><h2 data-i18n="card.version">Versi√≥n</h2><div class="value">‚Äî</div></div>
      <div class="card" id="health-card"><h2 data-i18n="card.health">Salud</h2><div class="value">‚Äî</div><div class="score-bar"><div id="health-bar-fill" style="width:0%;height:100%;background:var(--muted);border-radius:3px"></div></div><div id="health-checks-detail" class="metrics-list" style="margin-top:.5rem;font-size:.7rem;cursor:pointer;" onclick="toggleHealthDetail()" title="Clic para ver desglose"></div></div>
      <div class="card" id="update-card"><h2 data-i18n="card.update">Actualizaci√≥n</h2><div class="value">‚Äî</div></div>
      <div class="card" id="deploy-card"><h2 data-i18n="card.deploy">Despliegue</h2><div class="value">‚Äî</div><div class="row"></div></div>
      <div class="card" id="ga-card"><h2 data-i18n="ga.panel">Governed Autonomy</h2><div class="value">‚Äî</div><div class="row"><button class="small" onclick="gaRunNow()" data-i18n="ga.run">Run Now</button><button class="small secondary" onclick="loadGAStatus()" data-i18n="app.refresh">Actualizar</button></div><div class="metrics-list" id="ga-detail"></div></div>
    </div>

    <!-- Bit√°cora: qu√© est√° mal ‚Üí qu√© acci√≥n ejecuto ‚Üí resultado -->
    <section class="robot-section" id="bitacora-section" style="margin-top:1rem;">
      <div class="card" style="padding:1rem;">
        <h2>Bit√°cora ANS <button class="btn-expand" onclick="expandPanel('bitacora-section','Bit√°cora ANS','#bitacora-list')" title="Ampliar">‚õ∂</button></h2>
        <p class="robot-task-help" style="color:var(--muted);font-size:.8rem;margin:.5rem 0;">Problema detectado ‚Üí Acci√≥n ejecutada ‚Üí Resultado</p>
        <div id="bitacora-list" style="font-size:.8rem;max-height:160px;overflow-y:auto;background:var(--bg-elevated);border-radius:8px;padding:.5rem;border:1px solid var(--card-border);">
          <div class="bitacora-empty" id="bitacora-empty">Sin entradas recientes</div>
        </div>
      </div>
    </section>

    <!-- Scanner + Descargas: √∫ltimo scan y pip install -->
    <section class="robot-section" id="scanner-downloads-section" style="margin-top:1rem;">
      <div class="card" style="padding:1rem;">
        <h2>Scanner y Descargas <button class="btn-expand" onclick="expandPanel('scanner-downloads-section','Scanner y Descargas','#scanner-expand-content')" title="Ampliar">‚õ∂</button></h2>
        <p class="robot-task-help" style="color:var(--muted);font-size:.8rem;margin:.5rem 0;">√öltimo scan (MakePlay) y descargas pip en tiempo real.</p>
        <div class="row" style="margin-bottom:.5rem;">
          <button class="small secondary" onclick="loadScannerStatus()" data-i18n="app.refresh">Actualizar</button>
        </div>
        <div id="scanner-expand-content" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;font-size:.8rem;">
          <div>
            <h3 style="font-size:.7rem;color:var(--muted);margin:.5rem 0;">√öltimo scan</h3>
            <pre id="scanner-last-scan" style="font-family:Consolas,monospace;font-size:.7rem;max-height:120px;overflow-y:auto;background:#0a0a0f;color:#a5d6ff;padding:.5rem;border-radius:6px;border:1px solid var(--card-border);margin:0;white-space:pre-wrap;"></pre>
          </div>
          <div>
            <h3 style="font-size:.7rem;color:var(--muted);margin:.5rem 0;">√öltimas descargas (pip)</h3>
            <div id="scanner-downloads-list" style="max-height:120px;overflow-y:auto;background:#0a0a0f;color:#a5d6ff;padding:.5rem;border-radius:6px;border:1px solid var(--card-border);"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Consola en vivo: se√±ales ANS (estilo Cursor) -->
    <section class="robot-section" id="live-console-section" style="margin-top:1rem;">
      <div class="card" style="padding:1rem;">
        <h2>Consola en vivo <button class="btn-expand" onclick="expandPanel('live-console-section','Consola en vivo','#live-console-output')" title="Ampliar">‚õ∂</button></h2>
        <p class="robot-task-help" style="color:var(--muted);font-size:.8rem;margin:.5rem 0;">Lo que el sistema ejecuta en tiempo real: checks, heals, decisiones.</p>
        <div class="row" style="margin-bottom:.5rem;">
          <button class="small" id="live-console-btn" onclick="toggleLiveConsole()">Iniciar stream</button>
          <button class="small secondary" onclick="loadLiveRecent()">Cargar recientes</button>
          <a href="#" class="small secondary" style="padding:.25rem .5rem;text-decoration:none;" onclick="window.open(base+'/ans/self-model','_blank','width=800,height=600');return false;">Ver autoconocimiento</a>
          <span class="badge" id="live-console-status" style="margin-left:.5rem;">‚Äî</span>
        </div>
        <pre id="live-console-output" style="font-family:Consolas,monospace;font-size:.75rem;max-height:240px;overflow-y:auto;background:#0a0a0f;color:#a5d6ff;padding:.75rem;border-radius:8px;border:1px solid var(--card-border);margin:0;white-space:pre-wrap;word-break:break-all;"></pre>
      </div>
    </section>

    <section class="robot-section" id="product-section">
      <div class="card">
        <h2 data-i18n="product.panel">Product</h2>
        <p class="robot-task-help" data-i18n="product.help">Version, edition, license, service, cluster, gateway, health, GA/Metalearn, support bundle.</p>
        <div class="row" style="margin-bottom:.5rem;">
          <span class="badge ok" id="product-version">‚Äî</span>
          <span class="badge" id="product-edition">‚Äî</span>
          <span class="badge" id="product-license">‚Äî</span>
          <button class="small secondary" onclick="loadProductStatus()" data-i18n="app.refresh">Actualizar</button>
          <button class="small" onclick="downloadSupportBundle()" data-i18n="product.support">Support bundle</button>
        </div>
        <div id="product-detail" class="value" style="font-size:.8rem; color:var(--muted);"></div>
      </div>
    </section>

    <section class="robot-section" id="ans-section">
      <div class="card">
        <h2 data-i18n="ans.panel">ANS (Autonomic Nervous System) <button class="btn-expand" onclick="expandPanel('ans-section','ANS','#ans-incidents-list,#ans-actions-list')" title="Ampliar">‚õ∂</button></h2>
        <p class="robot-task-help" data-i18n="ans.help" style="color:var(--muted); font-size:.8rem;">Auto-checks, auto-heals (SAFE), incidentes, reportes.</p>
        <div class="row" style="margin-top:.5rem;">
          <span class="badge" id="ans-enabled">‚Äî</span>
          <span class="badge" id="ans-mode">‚Äî</span>
          <span class="last-update" id="ans-incidents">‚Äî</span>
          <button class="small" onclick="ansRunNow()" data-i18n="ans.run">Run Now</button>
          <button class="small secondary" onclick="ansResolveIncidents()" title="Cerrar todos los incidentes abiertos (stale)">Resolver incidentes</button>
          <button class="small secondary" onclick="loadANSStatus()" data-i18n="app.refresh">Actualizar</button>
        </div>
        <div id="ans-incidents-list" class="value" style="font-size:.8rem; max-height:100px; overflow-y:auto; margin-top:.5rem;"></div>
        <div id="ans-actions-list" class="value" style="font-size:.75rem; color:var(--muted); max-height:80px; overflow-y:auto; margin-top:.35rem;"></div>
        <div class="row" style="margin-top:.5rem;">
          <a id="ans-report-link" href="#" target="_blank" style="font-size:.8rem; color:var(--purple-light);" data-i18n="ans.report">√öltimo reporte</a>
          <button class="small secondary" onclick="downloadSupportBundle()" data-i18n="product.support">Support Bundle</button>
        </div>
      </div>
    </section>

    <section class="robot-section" id="owner-console-section">
      <div class="card">
        <h2 data-i18n="owner.panel">Owner Console <button class="btn-expand" onclick="expandPanel('owner-console-section','Owner Console','#owner-sessions,#ga-last-report,#owner-pending-list,#owner-expired-list')" title="Ampliar">‚õ∂</button></h2>
        <p class="robot-task-help" data-i18n="owner.help">Sesiones activas, aprobaciones pendientes/expiradas, emergencia, integridad de cadena.</p>
        <div class="row" style="margin-bottom:0.5rem;">
          <span style="font-size:.8rem; color:var(--muted);">Iniciar sesi√≥n:</span>
          <button class="small" onclick="ownerStartWithFace()" title="Reconocimiento facial">üì∑ Rostro</button>
          <button class="small" onclick="showOwnerWindowsLogin()" title="Contrase√±a Windows">üîê Contrase√±a Windows</button>
          <span class="last-update" id="owner-session-msg"></span>
        </div>
        <div id="owner-face-login" style="display:none; margin-bottom:0.75rem; padding:0.75rem; background:var(--bg-elevated); border-radius:8px; border:1px solid var(--card-border);">
          <p style="font-size:.8rem; margin:0 0 .5rem;">Mira a la c√°mara y captura:</p>
          <video id="owner-face-video" autoplay playsinline width="240" height="180" style="border-radius:6px; background:#000; margin-bottom:.5rem;"></video>
          <div class="row"><button class="small" onclick="ownerCaptureAndLogin()">Capturar e iniciar sesi√≥n</button><button class="small secondary" onclick="hideOwnerFaceLogin()">Cancelar</button></div>
        </div>
        <div id="owner-windows-login" style="display:none; margin-bottom:0.75rem; padding:0.75rem; background:var(--bg-elevated); border-radius:8px; border:1px solid var(--card-border);">
          <p style="font-size:.8rem; margin:0 0 .5rem;">Usuario y contrase√±a de Windows:</p>
          <div style="margin-bottom:.5rem;"><input type="text" id="owner-win-user" placeholder="Usuario" style="width:160px; padding:.35rem; border-radius:6px; background:var(--bg); border:1px solid var(--card-border); color:var(--text); font-size:.85rem;"></div>
          <div style="margin-bottom:.5rem;"><input type="password" id="owner-win-pass" placeholder="Contrase√±a" style="width:160px; padding:.35rem; border-radius:6px; background:var(--bg); border:1px solid var(--card-border); color:var(--text); font-size:.85rem;"></div>
          <div class="row"><button class="small" onclick="ownerLoginWithWindows()">Iniciar sesi√≥n</button><button class="small secondary" onclick="hideOwnerWindowsLogin()">Cancelar</button></div>
        </div>
        <div class="row" style="margin-bottom:0.75rem;">
          <button class="small secondary" onclick="loadOwnerStatus()" data-i18n="app.refresh">Actualizar</button>
          <button class="small" id="owner-emergency-btn" onclick="ownerToggleEmergency()" data-i18n="owner.emergency">Emergency: ‚Äî</button>
          <button class="small secondary" onclick="ownerVerifyChain()" data-i18n="owner.verify">Verificar cadena</button>
        </div>
        <div id="owner-sessions" class="value" style="font-size:.8rem; color:var(--muted);"></div>
        <h3 style="font-size:.75rem; color:var(--muted); margin:.5rem 0 .25rem;" data-i18n="owner.ga_label">Governed Autonomy</h3>
        <div class="row" style="margin-bottom:.5rem;">
          <button class="small" onclick="gaRunNow()" data-i18n="ga.run_now">Run GA Now</button>
          <span class="last-update" id="ga-status-msg"></span>
        </div>
        <div id="ga-last-report" class="value" style="font-size:.8rem; color:var(--muted); max-height:80px; overflow-y:auto;"></div>
        <div id="ga-executed" class="value" style="font-size:.75rem; color:var(--green); margin-top:.35rem;"></div>
        <h3 style="font-size:.75rem; color:var(--muted); margin:.5rem 0 .25rem;" data-i18n="owner.pending">Pendientes / Expiradas</h3>
        <div id="owner-pending-list" class="value" style="font-size:.8rem; max-height:120px; overflow-y:auto;"></div>
        <div id="owner-expired-list" class="value" style="font-size:.8rem; max-height:80px; overflow-y:auto; color:var(--amber);"></div>
        <h3 style="font-size:.75rem; color:var(--muted); margin:.5rem 0 .25rem;" data-i18n="owner.history">Historial cr√≠ticos</h3>
        <div id="owner-critical-history" class="value" style="font-size:.8rem; max-height:140px; overflow-y:auto;"></div>
      </div>
    </section>

    <section class="robot-section" id="governance-panel">
      <div class="card">
        <h2 data-i18n="gov.panel">Governance</h2>
        <p class="robot-task-help" data-i18n="gov.panel_help">Log de cambios de modo, acciones bloqueadas, approvals creadas.</p>
        <div class="row" style="margin-top:.5rem;">
          <button class="small secondary" onclick="loadGovernanceStatus()" data-i18n="app.refresh">Actualizar</button>
          <a href="#" id="governance-log-link" target="_blank" style="font-size:.8rem; color:var(--purple-light);" data-i18n="gov.log">Log</a>
        </div>
        <div id="governance-log" class="value" style="font-size:.75rem; max-height:120px; overflow-y:auto; margin-top:.5rem; color:var(--muted);"></div>
      </div>
    </section>

    <section class="robot-section" id="gateway-section" style="display:none;">
      <div class="card">
        <h2 data-i18n="gateway.stealth">Gateway ‚Äî Stealth</h2>
        <p class="robot-task-help" data-i18n="gateway.help">Modo actual, herramientas detectadas, √∫ltimo √©xito, Check / Bootstrap / Set mode.</p>
        <div class="row" style="margin-bottom:0.75rem;">
          <button class="small" onclick="gatewayCheck()" data-i18n="gateway.check">Check</button>
          <button class="small" onclick="gatewayBootstrap()" data-i18n="gateway.bootstrap">Bootstrap</button>
          <select id="gateway-mode" onchange="gatewaySetMode()" style="padding:.35rem .5rem; border-radius:6px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.8rem;">
            <option value="auto">auto</option>
            <option value="cloudflare">cloudflare</option>
            <option value="tailscale">tailscale</option>
            <option value="ssh">ssh</option>
            <option value="lan">lan</option>
          </select>
          <span class="last-update" id="gateway-status-msg"></span>
        </div>
        <div id="gateway-tools" class="value" style="font-size:.85rem;"></div>
        <div id="gateway-last-success" class="value" style="font-size:.8rem; color:var(--muted); margin-top:.5rem;"></div>
        <div id="gateway-recommendations" class="value" style="font-size:.8rem; color:var(--amber); margin-top:.35rem;"></div>
      </div>
    </section>

    <section class="robot-section" id="cluster-section" style="display:none;">
      <div class="card">
        <h2 data-i18n="cluster.command_center">Cluster ‚Äî Owner Command Center</h2>
        <p class="robot-task-help" data-i18n="cluster.help">Nodos registrados, heartbeat, ruta preferida y eventos.</p>
        <div class="row" style="margin-bottom:0.75rem;">
          <button class="small" onclick="loadCluster()" data-i18n="cluster.refresh">Actualizar nodos</button>
          <button class="small secondary" onclick="clusterPing()" data-i18n="cluster.ping">Ping</button>
          <select id="cluster-route-pref" onchange="setClusterRoute()" style="padding:.35rem .5rem; border-radius:6px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.8rem;">
            <option value="local" data-i18n="cluster.route_local">Ruta: local</option>
            <option value="remote_preferred" data-i18n="cluster.route_remote">Ruta: remote_preferred</option>
          </select>
          <button class="small secondary" onclick="runClusterTestJob()" data-i18n="cluster.test_job">Run test job (best node)</button>
        </div>
        <div id="cluster-nodes-list" class="value" style="font-size:.85rem; max-height:200px; overflow-y:auto;"></div>
        <h3 style="font-size:.8rem; color:var(--muted); margin:.75rem 0 .35rem;" data-i18n="cluster.events">√öltimos eventos</h3>
        <div id="cluster-events-list" class="value" style="font-size:.8rem; max-height:160px; overflow-y:auto; color:var(--muted);"></div>
      </div>
    </section>

    <section class="robot-section" id="robot-section-id">
      <div class="card" id="atlas-interact-card">
        <div class="atlas-card-header">
          <h2 data-i18n="robot.title">Interactuar con ATLAS</h2>
          <button type="button" class="btn-expand-atlas" onclick="expandAtlasPanel()" title="Abrir en ventana ampliada (como Consola en vivo)"><span class="btn-expand-icon">‚õ∂</span> Ampliar ventana</button>
        </div>
        <div class="cc-topbar">
          <div class="cc-tabs" role="tablist" aria-label="Atlas Command Center">
            <button type="button" class="cc-tabbtn active" id="cc-tab-chat" onclick="ccSelectTab('chat')">Chat</button>
            <button type="button" class="cc-tabbtn" id="cc-tab-ops" onclick="ccSelectTab('ops')">OPS</button>
            <button type="button" class="cc-tabbtn" id="cc-tab-web" onclick="ccSelectTab('web')">Web (Pies)</button>
            <button type="button" class="cc-tabbtn" id="cc-tab-vision" onclick="ccSelectTab('vision')">Visi√≥n</button>
            <button type="button" class="cc-tabbtn" id="cc-tab-terminal" onclick="ccSelectTab('terminal')">Terminal</button>
            <button type="button" class="cc-tabbtn" id="cc-tab-architect" onclick="ccSelectTab('architect')">Architect</button>
          </div>
          <div class="row" style="margin:0;">
            <span class="badge" id="cc-comms-badge">COMMS: ‚Äî</span>
            <button type="button" class="small secondary" onclick="ccRefreshOps()">Actualizar OPS</button>
          </div>
        </div>

        <div id="cc-panel-chat" class="cc-panel active">
          <p class="robot-task-help" id="robot-task-help" style="color:var(--muted); font-size:.8rem;">Comando directo: /status, /doctor, /modules. Objetivo: plan con IA (Modo, Recursos, IA, Perfil).</p>
          <div class="cc-split">
            <div>
              <div class="robot-task-type">
                <label for="robot-input" data-i18n="cursor.goal">Objetivo</label>
                <textarea id="robot-input" class="robot-input" data-i18n-placeholder="robot.placeholder" placeholder="Escribe un comando (ej. /status) o un objetivo para la IA‚Ä¶" rows="2" style="min-height:56px;"></textarea>
              </div>
              <div class="row" style="margin-top:.5rem; gap:1rem; flex-wrap:wrap;">
                <div class="robot-task-type">
                  <label for="atlas-mode" data-i18n="cursor.mode_label">Modo</label>
                  <select id="atlas-mode" style="padding:.35rem .5rem; border-radius:6px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.8rem;">
                    <option value="plan_only" data-i18n="cursor.mode_plan_only">Solo plan</option>
                    <option value="controlled" data-i18n="cursor.mode_controlled">Controlado</option>
                    <option value="auto" data-i18n="cursor.mode_auto">Auto</option>
                  </select>
                </div>
                <div class="robot-task-type">
                  <label for="atlas-resources" data-i18n="cursor.resources_label">Recursos</label>
                  <select id="atlas-resources" style="padding:.35rem .5rem; border-radius:6px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.8rem;">
                    <option value="lite" data-i18n="cursor.resources_lite">Lite</option>
                    <option value="pro" selected data-i18n="cursor.resources_pro">Pro</option>
                    <option value="ultra" data-i18n="cursor.resources_ultra">Ultra</option>
                  </select>
                </div>
                <div class="robot-task-type">
                  <label for="atlas-ai" data-i18n="cursor.ai_label">IA</label>
                  <select id="atlas-ai" style="padding:.35rem .5rem; border-radius:6px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.8rem;">
                    <option value="free_only" data-i18n="cursor.ai_free_only">Solo gratis (Ollama)</option>
                    <option value="auto" data-i18n="cursor.ai_auto">Auto</option>
                    <option value="allow_paid" data-i18n="cursor.ai_allow_paid">Permitir pago (Owner)</option>
                  </select>
                </div>
                <div class="robot-task-type">
                  <label for="atlas-profile" data-i18n="cursor.profile_label">Perfil</label>
                  <select id="atlas-profile" style="padding:.35rem .5rem; border-radius:6px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.8rem;">
                    <option value="owner" data-i18n="cursor.profile_owner">Owner</option>
                    <option value="operario" data-i18n="cursor.profile_operario">Operario</option>
                    <option value="contadora" data-i18n="cursor.profile_contadora">Contadora</option>
                  </select>
                </div>
              </div>
              <div class="robot-actions" style="margin-top:.75rem;">
                <button id="robot-send" onclick="sendToRobot()" data-i18n="robot.send">Enviar</button>
                <span class="last-update" id="robot-status"></span>
                <span class="last-update" style="color:var(--muted); font-size:.7rem;" data-i18n="cursor.plan_hint">M√°x. ~12 s (Pro) / ~18 s (Ultra). Si no hay IA disponible, responde con plan determin√≠stico.</span>
              </div>
              <div class="robot-actions" style="margin-top:0.5rem;">
                <button type="button" class="small secondary" id="btn-voice-mic" onclick="startVoiceRecognition()" data-i18n="voice.talk">üé§ Hablar por voz</button>
                <button type="button" class="small secondary" id="btn-voice-play" onclick="playResponseWithVoice()" data-i18n="voice.speak">üîä Reproducir respuesta por PC</button>
              </div>
              <div id="atlas-steps-panel" class="metrics-list" style="margin-top:.75rem; display:none;">
                <strong data-i18n="cursor.steps">Pasos</strong>
                <ul id="atlas-steps-list"></ul>
              </div>
              <div id="atlas-routing-panel" class="metrics-list" style="margin-top:.5rem; display:none;">
                <strong data-i18n="cursor.model">Modelo</strong>
                <span id="atlas-routing-text"></span>
              </div>
              <div id="atlas-evidence-panel" class="metrics-list" style="margin-top:.35rem; display:none;">
                <strong data-i18n="cursor.evidence">Evidencia</strong>
                <span id="atlas-evidence-text"></span>
              </div>
              <div class="robot-response empty" id="robot-response" data-i18n="cursor.response_placeholder" style="margin-top:.75rem;">La respuesta aparecer√° aqu√≠.</div>
            </div>

            <div class="cc-side">
              <h3>Contexto r√°pido</h3>
              <div class="row" style="margin-top:0;">
                <button type="button" class="small secondary" onclick="ccCaptureVision()">üì∑ Capturar c√°mara</button>
                <select id="cc-vision-enhance" style="padding:.25rem .4rem; border-radius:6px; background:var(--bg); border:1px solid var(--card-border); color:var(--text); font-size:.75rem;">
                  <option value="auto">auto</option>
                  <option value="sharp">sharp</option>
                  <option value="max" selected>max</option>
                  <option value="ocr">ocr</option>
                </select>
              </div>
              <div class="row" style="margin-top:.45rem;">
                <img id="cc-vision-preview" class="cc-evidence-img" alt="Vista previa c√°mara" src="" style="display:none;">
              </div>
              <div class="row" style="margin-top:.45rem;">
                <button type="button" class="small secondary" onclick="ccSelectTab('ops')">Ver OPS</button>
                <button type="button" class="small secondary" onclick="scrollToSection('owner-console-section')">Aprobaciones</button>
              </div>
              <div class="value" id="cc-side-hint" style="font-size:.78rem; color:var(--muted); margin-top:.5rem;">Consejo: usa slash commands para diagn√≥stico inmediato y ‚ÄúWeb (Pies)‚Äù para tareas en p√°ginas con evidencia por screenshot.</div>
            </div>
          </div>
        </div>

        <div id="cc-panel-ops" class="cc-panel">
          <div class="row" style="margin-top:0;">
            <button type="button" class="small secondary" onclick="ccRefreshComms()">Estado COMMS</button>
            <button type="button" class="small secondary" onclick="ccEmitOpsTest()">Emitir test</button>
            <span class="last-update" id="cc-ops-status"></span>
          </div>
          <div id="cc-ops-list" class="cc-ops-list" style="margin-top:.5rem;"></div>
        </div>

        <div id="cc-panel-web" class="cc-panel">
          <p class="robot-task-help" style="color:var(--muted); font-size:.8rem;">Pies digitales (Playwright). Ejecuta navegaci√≥n con evidencia (screenshot) y narraci√≥n OPS.</p>
          <div class="row" style="margin-top:.25rem;">
            <input id="cc-web-url" type="text" placeholder="URL (ej. https://example.com)" style="flex:1; min-width:220px; padding:.35rem .5rem; border-radius:8px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.85rem;">
            <label style="font-size:.75rem; color:var(--muted); display:flex; align-items:center; gap:.35rem;">
              <input id="cc-web-show" type="checkbox" style="accent-color: var(--purple);"> Mostrar navegador
            </label>
            <button type="button" class="small" onclick="ccWebOpen()">Abrir</button>
            <button type="button" class="small secondary" onclick="ccWebShot()">Screenshot</button>
          </div>
          <div class="robot-response empty" id="cc-web-result" style="margin-top:.6rem;">Sin ejecuci√≥n.</div>
        </div>

        <div id="cc-panel-vision" class="cc-panel">
          <p class="robot-task-help" style="color:var(--muted); font-size:.8rem;">C√°mara del robot (proxy) con perfil de nitidez y zoom digital.</p>
          <div class="row" style="margin-top:.25rem;">
            <select id="cc-vision-index" style="padding:.35rem .5rem; border-radius:8px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.85rem;">
              <option value="0" selected>Cam 0</option>
              <option value="1">Cam 1</option>
              <option value="2">Cam 2</option>
            </select>
            <select id="cc-vision-enhance2" style="padding:.35rem .5rem; border-radius:8px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.85rem;">
              <option value="auto">auto</option>
              <option value="sharp">sharp</option>
              <option value="max" selected>max</option>
              <option value="ocr">ocr</option>
            </select>
            <select id="cc-vision-zoom" style="padding:.35rem .5rem; border-radius:8px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.85rem;">
              <option value="1.0" selected>Zoom 1.0</option>
              <option value="1.2">Zoom 1.2</option>
              <option value="1.5">Zoom 1.5</option>
              <option value="2.0">Zoom 2.0</option>
            </select>
            <button type="button" class="small" onclick="ccCaptureVision(true)">Capturar</button>
          </div>
          <div class="row" style="margin-top:.5rem;">
            <img id="cc-vision-preview2" class="cc-evidence-img" alt="Snapshot c√°mara" src="" style="display:none;">
          </div>
          <div class="card" style="margin-top:.8rem;">
            <h2 style="margin:0 0 .35rem;">Visi√≥n Ubicua (LAN)</h2>
            <p class="robot-task-help" style="color:var(--muted); font-size:.8rem; margin-top:0;">
              Descubre RTSP/ONVIF, centraliza streams (FFmpeg‚ÜíHLS) y permite ‚Äúojo activo‚Äù por movimiento.
            </p>
            <div class="row" style="margin-top:.25rem; gap:.5rem; flex-wrap:wrap;">
              <button type="button" class="small" onclick="ubiqDiscover()">Escanear LAN</button>
              <button type="button" class="small secondary" onclick="ubiqLoad()">Refrescar lista</button>
              <button type="button" class="small secondary" onclick="ubiqMotionStart()">Motion ON</button>
              <button type="button" class="small secondary" onclick="ubiqMotionStop()">Motion OFF</button>
              <span class="last-update" id="ubiq-status" style="color:var(--muted); font-size:.75rem;"></span>
            </div>
            <div class="row" style="margin-top:.35rem; gap:.5rem; flex-wrap:wrap;">
              <button type="button" class="small secondary" onclick="ubiqFetchToken()">Obtener token m√≥vil (local)</button>
              <code id="ubiq-token" style="font-size:.72rem; color:var(--muted);">token: ‚Äî</code>
            </div>
            <div id="ubiq-cameras" class="value" style="font-size:.82rem; margin-top:.5rem; max-height:220px; overflow:auto; color:var(--text);">‚Äî</div>
          </div>
        </div>

        <div id="cc-panel-terminal" class="cc-panel">
          <p class="robot-task-help" style="color:var(--muted); font-size:.8rem;">Vista r√°pida de la Consola en vivo. Para vista completa, abre el panel ‚ÄúConsola en vivo‚Äù.</p>
          <div class="row" style="margin-top:.25rem;">
            <button type="button" class="small secondary" onclick="scrollToSection('live-console-section')">Ir a Consola en vivo</button>
          </div>
          <pre id="cc-terminal-mini" class="cc-terminal-mini">‚Äî</pre>
        </div>

        <div id="cc-panel-architect" class="cc-panel">
          <p class="robot-task-help" style="color:var(--muted); font-size:.8rem;">
            ATLAS_ARCHITECT: scaffolding + parches at√≥micos + terminal feedback loop.
            En <strong>GOVERNED</strong> genera diffs y crea una aprobaci√≥n. En <strong>GROWTH</strong> aplica y prueba.
          </p>
          <div class="row" style="margin-top:.25rem; gap:.6rem; align-items:flex-start;">
            <textarea id="cc-architect-order" class="robot-input" placeholder="Ej: Dise√±a una app de inventario para la panader√≠a Rauli" rows="2" style="min-height:56px; flex:1;"></textarea>
            <select id="cc-architect-mode" style="padding:.35rem .5rem; border-radius:8px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.85rem;">
              <option value="governed" selected>GOVERNED</option>
              <option value="growth">GROWTH</option>
            </select>
            <button type="button" class="small" onclick="ccArchitectRun()">Ejecutar</button>
          </div>
          <div class="row" style="margin-top:.35rem;">
            <span class="last-update" id="cc-architect-status"></span>
          </div>
          <div class="card" style="margin-top:.6rem;">
            <h2>Resultado</h2>
            <pre id="cc-architect-out" class="cc-terminal-mini">‚Äî</pre>
          </div>
          <div class="card" style="margin-top:.6rem;">
            <h2>Diffs (preview)</h2>
            <div id="cc-architect-diffs" class="value" style="font-size:.8rem; color:var(--muted);">‚Äî</div>
          </div>
        </div>
      </div>
    </section>

    <section class="robot-section" id="voice-section">
      <div class="card">
        <h2 data-i18n="voice.panel">Voz y rostro <button class="btn-expand" onclick="expandPanel('voice-section','Voz y rostro','#face-video-container,#face-result')" title="Ampliar">‚õ∂</button></h2>
        <p class="robot-task-help" data-i18n="voice.help">Reconocimiento de voz (micr√≥fono) y detecci√≥n de rostro (c√°mara).</p>
        <div class="robot-actions">
          <button type="button" class="small" id="btn-face-check" onclick="checkFace()" data-i18n="voice.face">üì∑ Verificar rostro (c√°mara)</button>
          <button type="button" class="small secondary" id="btn-face-disconnect" style="display:none;" onclick="disconnectCamera()" data-i18n="voice.disconnect">Apagar c√°mara</button>
          <span class="last-update" id="face-result"></span>
        </div>
        <div id="face-video-container" style="display:none; margin-top:0.5rem;">
          <video id="face-video" autoplay playsinline width="320" height="240" style="border-radius:8px; background:#000;"></video>
          <p style="font-size:.8rem; color:var(--muted); margin-top:.35rem;" data-i18n="face.help_video">Mira a la c√°mara y pulsa ¬´Verificar rostro¬ª para capturar. Pulsa ¬´Apagar c√°mara¬ª cuando termines.</p>
        </div>
      </div>
    </section>
  </div>
  </div>
  <script>
    // --- Anti-Silencio (watchdog independiente del resto del JS) ---
    (function() {
      function safeJson(x) { try { return JSON.stringify(x); } catch(e) { return '{}'; } }
      var _localSpeakLast = {};
      function localSpeak(text, key) {
        try {
          var k = String(key || 'default');
          var now = Date.now();
          if (_localSpeakLast[k] && (now - _localSpeakLast[k] < 15000)) return; // throttle 15s
          _localSpeakLast[k] = now;
          if (window.speechSynthesis && window.SpeechSynthesisUtterance) {
            var u = new SpeechSynthesisUtterance(String(text || '').slice(0, 220));
            u.lang = 'es-ES';
            window.speechSynthesis.speak(u);
          }
        } catch (e) {}
      }
      function alertAtlas(kind, messageHuman, actionHuman, technical, level) {
        // IMPORTANTE: evitar doble voz. Solo usar voz local si NO se pudo reportar al servidor.
        try {
          var payload = {
            kind: kind || 'ui',
            message_human: messageHuman || 'Alerta: el panel tuvo un problema.',
            action_human: actionHuman || 'Reintentando conexi√≥n.',
            technical: technical || {},
            level: level || 'high'
          };
          var body = safeJson(payload);
          return fetch('/api/comms/alert', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: body,
            cache: 'no-store',
            keepalive: true
          }).then(function() {
            return true;
          }).catch(function() {
            // Fallback: solo si el servidor no recibi√≥ la alerta.
            localSpeak(payload.message_human + ' ' + payload.action_human, String(payload.kind || 'alert'));
            return false;
          });
        } catch (e) {
          try { localSpeak('Alerta: el panel tuvo un problema.', 'alert_fallback'); } catch (_) {}
          return Promise.resolve(false);
        }
      }

      // Captura errores globales (incluye SyntaxError de scripts posteriores)
      window.addEventListener('error', function(ev) {
        try {
          var msg = (ev && ev.message) ? String(ev.message) : 'Error en el panel';
          var where = (ev && ev.filename) ? (String(ev.filename).split('/').pop() + ':' + (ev.lineno || 0)) : '';
          alertAtlas(
            'dashboard_js_error',
            'Alerta: el panel se rompi√≥ y perdi√≥ funciones.',
            'Registrando el error y reintentando.',
            { message: msg, where: where }
          );
        } catch (e) {}
      });
      window.addEventListener('unhandledrejection', function(ev) {
        try {
          var reason = (ev && ev.reason) ? String(ev.reason) : 'Promesa rechazada';
          alertAtlas(
            'dashboard_unhandled_rejection',
            'Alerta: el panel tuvo un fallo interno.',
            'Registrando el error y reintentando.',
            { reason: reason }
          );
        } catch (e) {}
      });

      // Watchdog de conexi√≥n: ping /health con backoff 5/10/30 para no spamear.
      var backoff = [5000, 10000, 30000];
      var idx = 0;
      var nextAt = 0;
      function loop() {
        var now = Date.now();
        if (now < nextAt) { setTimeout(loop, 1000); return; }
        fetch('/health', { cache: 'no-store' })
          .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json().catch(function(){return {};}); })
          .then(function() {
            idx = 0;
            nextAt = Date.now() + 15000;
            setTimeout(loop, 15000);
          })
          .catch(function(err) {
            var wait = backoff[Math.min(idx, backoff.length - 1)];
            if (idx < backoff.length - 1) idx++;
            nextAt = Date.now() + wait;
            alertAtlas(
              'dashboard_connection_lost',
              'Alerta: el panel perdi√≥ conexi√≥n con ATLAS.',
              'Reintentando autom√°ticamente.',
              { error: String(err && err.message ? err.message : err) }
            );
            setTimeout(loop, wait);
          });
      }
      setTimeout(loop, 8000);
    })();
  </script>
  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ATLAS Dashboard - Version Control
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ATLAS_VERSION = '2.5.0';
    const ATLAS_BUILD_DATE = '2026-02-16';
    console.log(`%cüöÄ ATLAS Dashboard v${ATLAS_VERSION} (${ATLAS_BUILD_DATE})`, 'color: #8b5cf6; font-weight: bold; font-size: 14px;');
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    (function() {
      var q = new URLSearchParams(window.location.search);
      var fromQ = q.get('api_base');
      if (fromQ) {
        try { localStorage.setItem('atlas_api_base', fromQ); } catch (e) {}
      }
    })();
    var base = (function() {
      try {
        var stored = (localStorage.getItem('atlas_api_base') || '').trim().replace(/\/$/, '');
        if (stored) return stored;
      } catch (e) {}
      return window.location.origin;
    })();
    if (typeof window._apiBase === 'undefined') window._apiBase = base;
    window._base = base;
    let ownerSessionToken = null;
    function showToast(msg, isError) {
      if (typeof window._toast === 'function') { window._toast(msg); return; }
      var el = document.getElementById('brain-toast');
      if (!el) {
        el = document.createElement('div');
        el.id = 'brain-toast';
        el.style.cssText = 'position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);color:#fff;padding:.6rem 1.2rem;border-radius:8px;font-size:.9rem;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.3);transition:opacity .3s;';
        document.body.appendChild(el);
      }
      el.style.background = isError ? 'var(--red)' : 'var(--green)';
      el.textContent = msg;
      el.style.opacity = '1';
      el.style.display = 'block';
      clearTimeout(el._toastT);
      el._toastT = setTimeout(function() { el.style.opacity = '0'; setTimeout(function() { el.style.display = 'none'; }, 300); }, isError ? 6000 : 4000);
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('app-sidebar');
      if (!sidebar) return;
      sidebar.classList.toggle('open');
      sidebar.setAttribute('aria-expanded', sidebar.classList.contains('open'));
    }
    document.addEventListener('click', function(e) {
      const sidebar = document.getElementById('app-sidebar');
      if (sidebar && sidebar.classList.contains('open') && !sidebar.contains(e.target)) {
        sidebar.classList.remove('open');
      }
    });
    let currentLocale = localStorage.getItem('ui_locale') || 'es';
    let UI_STRINGS = {};
    const REQUEST_TIMEOUT_MS = 4500;
    let _refreshInFlight = false;
    const _nativeFetch = window.fetch ? window.fetch.bind(window) : null;
    async function _fetchWithTimeout(url, options, timeoutMs) {
      if (!_nativeFetch) throw new Error('fetch unavailable');
      const ctrl = new AbortController();
      const tm = setTimeout(function() {
        try { ctrl.abort(); } catch (e) {}
      }, timeoutMs || REQUEST_TIMEOUT_MS);
      try {
        return await _nativeFetch(url, { ...(options || {}), signal: ctrl.signal });
      } finally {
        clearTimeout(tm);
      }
    }
    // Forzar timeout por defecto en cualquier fetch del dashboard (incluye llamados legacy).
    window.fetch = function(input, init) {
      return _fetchWithTimeout(input, init || {}, REQUEST_TIMEOUT_MS);
    };
    async function get(path) {
      const url = base + path;
      const r = await _fetchWithTimeout(
        url,
        { headers: { 'Accept': 'application/json' }, cache: 'no-store' },
        REQUEST_TIMEOUT_MS
      );
      if (r.ok) return r.json();
      if (r.status === 404 && !window._api404Shown) {
        window._api404Shown = true;
        showToast('API 404. Inicia el servidor Atlas en este puerto: uvicorn atlas_adapter.atlas_http_api:app --port 8791 . Luego abre http://127.0.0.1:8791/ui', true);
      }
      return null;
    }
    async function setLocale(locale) {
      if (locale !== 'es' && locale !== 'en') return;
      currentLocale = locale;
      localStorage.setItem('ui_locale', locale);
      document.documentElement.lang = locale === 'es' ? 'es' : 'en';
      const langEs = document.getElementById('lang-es');
      const langEn = document.getElementById('lang-en');
      if (langEs) { langEs.style.color = locale === 'es' ? 'var(--purple-light)' : 'var(--muted)'; }
      if (langEn) { langEn.style.color = locale === 'en' ? 'var(--purple-light)' : 'var(--muted)'; }
      const r = await get('/ui/lang?locale=' + locale);
      if (r && r.ok && r.strings) applyStrings(r.strings);
      refreshAll();
    }
    function applyStrings(strings) {
      UI_STRINGS = strings || {};
      document.querySelectorAll('[data-i18n]').forEach(function(el) {
        const key = el.getAttribute('data-i18n');
        if (key && UI_STRINGS[key]) el.textContent = UI_STRINGS[key];
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
        const key = el.getAttribute('data-i18n-placeholder');
        if (key && UI_STRINGS[key]) el.placeholder = UI_STRINGS[key];
      });
      updateTaskHelp();
    }
    async function loadLocale() {
      const r = await get('/ui/lang?locale=' + currentLocale);
      if (r && r.ok && r.strings) applyStrings(r.strings);
      document.documentElement.lang = currentLocale === 'es' ? 'es' : 'en';
      const langEs = document.getElementById('lang-es');
      const langEn = document.getElementById('lang-en');
      if (langEs) { langEs.style.color = currentLocale === 'es' ? 'var(--purple-light)' : 'var(--muted)'; }
      if (langEn) { langEn.style.color = currentLocale === 'en' ? 'var(--purple-light)' : 'var(--muted)'; }
    }
    async function post(path, body, headers, timeoutMs) {
      const h = { 'Content-Type': 'application/json', ...(headers || {}) };
      if (ownerSessionToken) h['X-Owner-Session'] = ownerSessionToken;
      const r = await _fetchWithTimeout(
        base + path,
        { method: 'POST', headers: h, body: JSON.stringify(body || {}), cache: 'no-store' },
        timeoutMs || REQUEST_TIMEOUT_MS
      );
      const data = await r.json().catch(function() { return {}; });
      if (r.ok) return data;
      return data && data.error ? { ok: false, error: data.error } : { ok: false, error: 'Error ' + r.status };
    }
    function setLastUpdate() {
      const s = UI_STRINGS['app.last_update'] ? (UI_STRINGS['app.last_update'] + ': ') : (currentLocale === 'en' ? 'Last update: ' : '√öltima actualizaci√≥n: ');
      const el = document.getElementById('last-update');
      if (el) el.textContent = s + new Date().toLocaleTimeString(currentLocale === 'es' ? 'es-ES' : 'en-US');
    }
    function setCard(id, text, isError) {
      const card = document.getElementById(id);
      if (!card) return;
      const val = card.querySelector('.value');
      if (val) val.textContent = text;
      card.classList.remove('loading', 'error');
      if (isError) card.classList.add('error');
    }
    function setCardJson(id, data) {
      const card = document.getElementById(id);
      if (!card) return;
      const val = card.querySelector('.value');
      val.textContent = data ? (data.ok !== undefined ? (data.ok ? 'OK' : (data.error || 'Error')) : JSON.stringify(data).slice(0, 120)) : '‚Äî';
      card.classList.remove('loading', 'error');
      if (data && data.ok === false) card.classList.add('error');
    }
    function updateTaskHelp() {}
    function scrollToSection(id) {
      try {
        const el = document.getElementById(id);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (e) {}
    }

    let _ccTab = 'chat';
    let _ccOpsTimer = null;
    function ccSelectTab(tab) {
      _ccTab = tab || 'chat';
      ['chat','ops','web','vision','terminal','architect'].forEach(function(t) {
        const btn = document.getElementById('cc-tab-' + t);
        const panel = document.getElementById('cc-panel-' + t);
        if (btn) btn.classList.toggle('active', t === _ccTab);
        if (panel) panel.classList.toggle('active', t === _ccTab);
      });
      if (_ccTab === 'ops') {
        ccRefreshComms();
        ccRefreshOps();
        if (_ccOpsTimer) clearInterval(_ccOpsTimer);
        _ccOpsTimer = setInterval(function() { ccRefreshOps(); }, 3000);
      } else {
        if (_ccOpsTimer) clearInterval(_ccOpsTimer);
        _ccOpsTimer = null;
      }
      if (_ccTab === 'terminal') {
        try {
          const src = document.getElementById('live-console-output');
          const dst = document.getElementById('cc-terminal-mini');
          if (src && dst) dst.textContent = (src.textContent || '').slice(-5000) || '‚Äî';
        } catch (e) {}
      }
    }

    async function ccArchitectRun() {
      const status = document.getElementById('cc-architect-status');
      const outEl = document.getElementById('cc-architect-out');
      const diffsEl = document.getElementById('cc-architect-diffs');
      const order = (document.getElementById('cc-architect-order') || {}).value || '';
      const mode = (document.getElementById('cc-architect-mode') || {}).value || 'governed';
      if (status) status.textContent = 'EN PROCESO DE B√öSQUEDA...';
      if (outEl) outEl.textContent = '‚Äî';
      if (diffsEl) diffsEl.textContent = '‚Äî';
      try {
        const r = await post('/api/architect/order', { order: order, mode: mode, prefer_free: true, max_heal_attempts: 3 });
        if (!r) { if (status) status.textContent = 'Sin respuesta'; return; }
        if (status) status.textContent = (r.ok ? 'OK' : ('ERROR: ' + (r.error || 'fallo')));
        if (outEl) outEl.textContent = JSON.stringify(r.data || r, null, 2).slice(-6000);
        try {
          const plan = (r.data && r.data.plan) ? r.data.plan : null;
          if (plan && Array.isArray(plan.changes) && diffsEl) {
            const previews = plan.changes
              .filter(c => (c.diff_preview || '').trim().length > 0)
              .slice(0, 8)
              .map((c, i) => `#${i+1} ${c.path}\n${(c.diff_preview || '').slice(0, 1500)}`);
            diffsEl.textContent = previews.length ? previews.join('\n\n') : '‚Äî';
          }
        } catch (e) {}
      } catch (e) {
        if (status) status.textContent = 'ERROR';
        if (outEl) outEl.textContent = String(e);
      }
    }

    function _evImgUrl(path) {
      if (!path) return '';
      return base + '/api/evidence/image?path=' + encodeURIComponent(path);
    }

    async function ccRefreshComms() {
      const badge = document.getElementById('cc-comms-badge');
      try {
        const r = await get('/api/comms/status');
        if (!badge) return;
        if (!r) { badge.textContent = 'COMMS: sin conexi√≥n'; badge.className = 'badge warn'; return; }
        // soporta ambos formatos: {audio_enabled, telegram_enabled, whatsapp_enabled} o {channels:{...}}
        const st = (r.status && r.status.channels) ? r.status : r;
        const channels = (st && st.channels) ? st.channels : null;
        const tts = channels ? !!(channels.tts && channels.tts.enabled) : !!st.audio_enabled;
        const tg = channels ? !!(channels.telegram && channels.telegram.enabled) : !!st.telegram_enabled;
        const wa = channels ? !!(channels.whatsapp && channels.whatsapp.enabled) : !!st.whatsapp_enabled;
        badge.textContent = 'COMMS: ' + (tts ? 'AUDIO' : 'audio√ó') + ' ¬∑ ' + (tg ? 'TG' : 'tg√ó') + ' ¬∑ ' + (wa ? 'WA' : 'wa√ó');
        badge.className = 'badge ' + ((tts || tg || wa) ? 'ok' : 'warn');
      } catch (e) {
        if (badge) { badge.textContent = 'COMMS: error'; badge.className = 'badge err'; }
      }
    }

    function ccRenderOps(events) {
      const list = document.getElementById('cc-ops-list');
      if (!list) return;
      const evs = Array.isArray(events) ? events : [];
      if (!evs.length) { list.innerHTML = '<div class="value" style="color:var(--muted);">Sin eventos OPS recientes.</div>'; return; }
      list.innerHTML = '';
      evs.forEach(function(ev) {
        const div = document.createElement('div');
        div.className = 'cc-ops-item';
        let when = '';
        try {
          if (ev.ts) {
            const d = new Date(ev.ts);
            if (!isNaN(d.getTime())) when = d.toLocaleTimeString(currentLocale === 'es' ? 'es-ES' : 'en-US');
          }
        } catch (e) {}
        const level = (ev.level || 'info').toUpperCase();
        const subs = ev.subsystem || 'ops';
        div.innerHTML = '<div class="msg"><strong>[' + level + ']</strong> ' + subs + ': ' + (ev.message || '') + '</div>'
          + '<div class="meta">' + (when ? (when + ' ¬∑ ') : '') + (ev.id ? ('id ' + String(ev.id).slice(0,8)) : '') + '</div>';
        if (ev.evidence_path) {
          const img = document.createElement('img');
          img.className = 'cc-ops-thumb';
          img.src = _evImgUrl(ev.evidence_path);
          img.alt = 'evidencia';
          div.appendChild(img);
        }
        list.appendChild(div);
      });
    }

    async function ccRefreshOps() {
      const statusEl = document.getElementById('cc-ops-status');
      try {
        if (statusEl) statusEl.textContent = 'Cargando‚Ä¶';
        const r = await get('/api/comms/recent?limit=30');
        if (r && r.ok) {
          ccRenderOps(r.events || []);
          if (statusEl) statusEl.textContent = 'OK';
        } else {
          ccRenderOps([]);
          if (statusEl) statusEl.textContent = (r && r.error) ? String(r.error).slice(0, 60) : 'Error';
        }
      } catch (e) {
        ccRenderOps([]);
        if (statusEl) statusEl.textContent = 'Error';
      }
    }

    async function ccEmitOpsTest() {
      const statusEl = document.getElementById('cc-ops-status');
      try {
        if (statusEl) statusEl.textContent = 'Enviando‚Ä¶';
        const r = await post('/api/comms/test', { message: 'UI test: evento OPS emitido desde Command Center.', subsystem: 'ui', level: 'info' });
        if (statusEl) statusEl.textContent = (r && r.ok) ? 'OK' : ((r && r.error) ? r.error : 'Error');
        ccRefreshOps();
      } catch (e) {
        if (statusEl) statusEl.textContent = 'Error';
      }
    }

    async function ccCaptureVision(forceSecondPreview) {
      const enhance = (document.getElementById(forceSecondPreview ? 'cc-vision-enhance2' : 'cc-vision-enhance') || {}).value || 'max';
      const idx = (document.getElementById('cc-vision-index') || {}).value || '0';
      const zoom = (document.getElementById('cc-vision-zoom') || {}).value || '1.0';
      const imgEl = document.getElementById(forceSecondPreview ? 'cc-vision-preview2' : 'cc-vision-preview');
      try {
        const url = base + '/cuerpo/vision/snapshot?index=' + encodeURIComponent(idx) + '&enhance=' + encodeURIComponent(enhance) + '&zoom=' + encodeURIComponent(zoom);
        const r = await fetch(url, { method: 'GET', cache: 'no-store' });
        const blob = await r.blob();
        const objUrl = URL.createObjectURL(blob);
        if (imgEl) { imgEl.src = objUrl; imgEl.style.display = 'block'; }
        if (!forceSecondPreview) {
          const sideHint = document.getElementById('cc-side-hint');
          if (sideHint) sideHint.textContent = 'Snapshot capturado. Si ejecutas Web/acciones, ver√°s evidencia tambi√©n en OPS.';
        }
      } catch (e) {
        showToast('No se pudo capturar c√°mara: ' + ((e && e.message) || 'error'), true);
      }
    }

    // --- Visi√≥n Ubicua (LAN) ---
    var ubiqMobileToken = '';
    function _ubiqSetStatus(msg, isErr) {
      var el = document.getElementById('ubiq-status');
      if (!el) return;
      el.textContent = msg || '';
      el.style.color = isErr ? 'var(--danger)' : 'var(--muted)';
    }
    function _ubiqSetToken(tok) {
      ubiqMobileToken = String(tok || '').trim();
      var el = document.getElementById('ubiq-token');
      if (el) el.textContent = ubiqMobileToken ? ('token: ' + ubiqMobileToken) : 'token: ‚Äî';
    }

    async function ubiqFetchToken() {
      _ubiqSetStatus('Leyendo token‚Ä¶');
      try {
        var r = await get('/api/vision/ubiq/mobile-token');
        if (r && r.ok && r.token) {
          _ubiqSetToken(r.token);
          _ubiqSetStatus('Token OK');
        } else {
          _ubiqSetStatus('Token no disponible', true);
        }
      } catch (e) {
        _ubiqSetStatus('Error token', true);
      }
    }

    async function ubiqDiscover() {
      _ubiqSetStatus('Escaneando LAN‚Ä¶');
      try {
        var r = await post('/api/vision/ubiq/discover', { scan_ports: true, onvif: true });
        if (r && r.ok) {
          _ubiqSetStatus('OK: ' + ((r.data && r.data.new_count) || 0) + ' nuevos');
          await ubiqLoad();
        } else {
          _ubiqSetStatus('Error: ' + ((r && r.error) || 'fallo'), true);
        }
      } catch (e) {
        _ubiqSetStatus('Error escaneo', true);
      }
    }

    async function ubiqMotionStart() {
      _ubiqSetStatus('Motion ON‚Ä¶');
      try {
        var r = await post('/api/vision/ubiq/motion/start', {});
        _ubiqSetStatus((r && r.ok) ? 'Motion ON' : 'Motion error', !(r && r.ok));
      } catch (e) {
        _ubiqSetStatus('Motion error', true);
      }
    }
    async function ubiqMotionStop() {
      _ubiqSetStatus('Motion OFF‚Ä¶');
      try {
        var r = await post('/api/vision/ubiq/motion/stop', {});
        _ubiqSetStatus((r && r.ok) ? 'Motion OFF' : 'Motion error', !(r && r.ok));
      } catch (e) {
        _ubiqSetStatus('Motion error', true);
      }
    }

    async function ubiqStreamStart(camId, variant) {
      _ubiqSetStatus('Iniciando stream ' + variant + '‚Ä¶');
      try {
        var r = await post('/api/vision/ubiq/streams/' + encodeURIComponent(camId) + '/start', { variant: variant });
        _ubiqSetStatus((r && r.ok) ? ('Stream ' + variant + ' OK') : ('Stream error: ' + ((r && r.error) || 'fallo')), !(r && r.ok));
        await ubiqLoad();
      } catch (e) {
        _ubiqSetStatus('Stream error', true);
      }
    }
    async function ubiqSetActiveEye(camId) {
      _ubiqSetStatus('Fijando ojo activo‚Ä¶');
      try {
        var r = await post('/api/vision/ubiq/active-eye', { eye: 'ubiq:' + String(camId), hold_s: 25 });
        _ubiqSetStatus((r && r.ok) ? 'Ojo activo OK' : 'Ojo activo error', !(r && r.ok));
      } catch (e) {
        _ubiqSetStatus('Ojo activo error', true);
      }
    }

    function _ubiqRender(cams) {
      var box = document.getElementById('ubiq-cameras');
      if (!box) return;
      if (!cams || !cams.length) { box.innerHTML = '<div style="color:var(--muted);">Sin c√°maras registradas.</div>'; return; }
      var html = '';
      cams.forEach(function(c) {
        var id = String(c.id || '');
        var ip = String(c.ip || '');
        var proto = String(c.protocol || '');
        var model = String(c.model || '');
        var url = String(c.url || '');
        var localM3u8 = base + '/api/vision/ubiq/streams/' + encodeURIComponent(id) + '/local/index.m3u8';
        var mobileM3u8 = base + '/mobile/vision/' + encodeURIComponent(id) + '.m3u8' + (ubiqMobileToken ? ('?token=' + encodeURIComponent(ubiqMobileToken)) : '');
        html += '<div style="padding:.45rem .45rem; border:1px solid var(--card-border); border-radius:10px; margin:.35rem 0; background:rgba(255,255,255,.03);">' +
          '<div style="display:flex; justify-content:space-between; gap:.5rem; align-items:flex-start;">' +
            '<div style="min-width:0;">' +
              '<div><strong>' + esc(model || id) + '</strong> <span style="color:var(--muted); font-size:.75rem;">(' + esc(proto) + ')</span></div>' +
              '<div style="color:var(--muted); font-size:.75rem; word-break:break-all;">' + esc(ip || url).slice(0, 140) + '</div>' +
            '</div>' +
            '<div class="row" style="margin:0; gap:.35rem; flex-wrap:wrap; justify-content:flex-end;">' +
              '<button class="small secondary" data-ubiq-action="start" data-variant="local" data-camid="' + esc(id) + '">Start local</button>' +
              '<button class="small secondary" data-ubiq-action="start" data-variant="mobile" data-camid="' + esc(id) + '">Start mobile</button>' +
              '<button class="small" data-ubiq-action="eye" data-camid="' + esc(id) + '">Ojo activo</button>' +
            '</div>' +
          '</div>' +
          '<div style="margin-top:.35rem; display:flex; gap:.6rem; flex-wrap:wrap; font-size:.75rem;">' +
            '<a href="' + localM3u8 + '" target="_blank" style="color:var(--purple-light);">local.m3u8</a>' +
            '<a href="' + mobileM3u8 + '" target="_blank" style="color:var(--amber);">mobile.m3u8</a>' +
          '</div>' +
        '</div>';
      });
      box.innerHTML = html;
      // Delegaci√≥n de eventos: evita inline onclick (y escapes rotos)
      if (!box.__ubiqBound) {
        box.__ubiqBound = true;
        box.addEventListener('click', function(ev) {
          try {
            var t = ev && ev.target ? ev.target : null;
            if (!t) return;
            var btn = (t.closest && t.closest('button[data-ubiq-action]')) ? t.closest('button[data-ubiq-action]') : null;
            if (!btn) return;
            var action = String(btn.getAttribute('data-ubiq-action') || '');
            var camId = String(btn.getAttribute('data-camid') || '');
            var variant = String(btn.getAttribute('data-variant') || '');
            if (!camId) return;
            if (action === 'start') return ubiqStreamStart(camId, variant || 'local');
            if (action === 'eye') return ubiqSetActiveEye(camId);
          } catch (e) {}
        });
      }
    }

    async function ubiqLoad() {
      _ubiqSetStatus('Cargando c√°maras‚Ä¶');
      try {
        var r = await get('/api/vision/ubiq/cameras?limit=80');
        if (r && r.ok && r.data && r.data.cameras) {
          _ubiqRender(r.data.cameras);
          _ubiqSetStatus('OK (' + (r.data.count || r.data.cameras.length || 0) + ')');
        } else {
          _ubiqRender([]);
          _ubiqSetStatus('Error', true);
        }
      } catch (e) {
        _ubiqRender([]);
        _ubiqSetStatus('Error', true);
      }
    }

    async function ccWebOpen() {
      const url = (document.getElementById('cc-web-url') && document.getElementById('cc-web-url').value || '').trim();
      const show = !!(document.getElementById('cc-web-show') && document.getElementById('cc-web-show').checked);
      const outEl = document.getElementById('cc-web-result');
      if (!url) { if (outEl) outEl.textContent = 'Especifica una URL.'; return; }
      if (outEl) { outEl.textContent = 'Ejecutando‚Ä¶'; outEl.classList.remove('error'); }
      const shotName = 'ui_open_' + Date.now() + '.png';
      const body = {
        command: 'workflow',
        payload: { driver: 'digital', show_browser: show, steps: [{ kind: 'goto', url: url }, { kind: 'screenshot', name: shotName }] }
      };
      try {
        const r = await post('/api/feet/execute', body);
        if (r && r.ok && r.result) {
          const res = r.result;
          const shot = res.screenshot_path || (res.result && res.result.screenshot_path);
          let msg = 'OK (' + (res.ms || 0) + 'ms)';
          if (res.last_url) msg += '\nURL: ' + res.last_url;
          if (shot) msg += '\nScreenshot: ' + shot;
          if (outEl) outEl.textContent = msg;
          ccSelectTab('ops');
        } else {
          if (outEl) { outEl.textContent = 'Error: ' + ((r && (r.error || (r.result && r.result.error))) || 'fallo'); outEl.classList.add('error'); }
        }
      } catch (e) {
        if (outEl) { outEl.textContent = 'Error: ' + ((e && e.message) || e); outEl.classList.add('error'); }
      }
    }

    async function ccWebShot() {
      const show = !!(document.getElementById('cc-web-show') && document.getElementById('cc-web-show').checked);
      const outEl = document.getElementById('cc-web-result');
      if (outEl) { outEl.textContent = 'Capturando‚Ä¶'; outEl.classList.remove('error'); }
      const shotName = 'ui_shot_' + Date.now() + '.png';
      const body = { command: 'workflow', payload: { driver: 'digital', show_browser: show, steps: [{ kind: 'screenshot', name: shotName }] } };
      try {
        const r = await post('/api/feet/execute', body);
        if (r && r.ok && r.result) {
          const res = r.result;
          const shot = res.screenshot_path || (res.result && res.result.screenshot_path);
          if (outEl) outEl.textContent = shot ? ('Screenshot: ' + shot) : JSON.stringify(res).slice(0, 600);
          ccSelectTab('ops');
        } else {
          if (outEl) { outEl.textContent = 'Error: ' + ((r && (r.error || (r.result && r.result.error))) || 'fallo'); outEl.classList.add('error'); }
        }
      } catch (e) {
        if (outEl) { outEl.textContent = 'Error: ' + ((e && e.message) || e); outEl.classList.add('error'); }
      }
    }

    // Cursor-ATLAS shell + command palette (Ctrl+K)
    var cursorAtlasCardOriginalParent = null;
    var cursorAtlasCardOriginalNext = null;
    function openCursorAtlas() {
      const overlay = document.getElementById('cursor-atlas-overlay');
      const slot = document.getElementById('cursor-atlas-main-slot');
      const card = document.getElementById('atlas-interact-card');
      if (!overlay || !slot || !card) return;
      // evita conflictos con el expand modal
      try { closeExpandModal(); } catch (e) {}
      cursorAtlasCardOriginalParent = card.parentNode;
      cursorAtlasCardOriginalNext = card.nextElementSibling;
      slot.innerHTML = '';
      slot.appendChild(card);
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden', 'false');
      // estado inicial
      try { ccSelectTab('chat'); ccRefreshComms(); } catch (e) {}
      // focus barra de mando
      setTimeout(function() {
        const inp = document.getElementById('cursor-atlas-cmd');
        if (inp) inp.focus();
      }, 50);
    }
    function closeCursorAtlas() {
      const overlay = document.getElementById('cursor-atlas-overlay');
      const slot = document.getElementById('cursor-atlas-main-slot');
      const card = document.getElementById('atlas-interact-card');
      if (overlay) { overlay.classList.remove('open'); overlay.setAttribute('aria-hidden', 'true'); }
      if (slot) slot.innerHTML = '';
      if (card && cursorAtlasCardOriginalParent) {
        if (cursorAtlasCardOriginalNext) cursorAtlasCardOriginalParent.insertBefore(card, cursorAtlasCardOriginalNext);
        else cursorAtlasCardOriginalParent.appendChild(card);
      }
      cursorAtlasCardOriginalParent = null;
      cursorAtlasCardOriginalNext = null;
    }
    function cursorAtlasNav(tab) {
      try { openCursorAtlas(); } catch (e) {}
      setTimeout(function() {
        try { ccSelectTab(tab); } catch (e) {}
        if (tab === 'web') {
          const el = document.getElementById('cc-web-url');
          if (el) el.focus();
        }
      }, 60);
    }
    async function cursorAtlasRunCommand(text) {
      const t = (text || '').trim();
      if (!t) return;
      openCursorAtlas();
      try { ccSelectTab('chat'); } catch (e) {}
      const input = document.getElementById('robot-input');
      if (input) input.value = t;
      try { await sendToRobot(); } catch (e) {}
    }

    async function pcWalk(command, payload) {
      try {
        showToast('PC-Windows: ejecutando ' + command + '‚Ä¶');
        const r = await post('/api/pc/walk', { command: command, payload: payload || {} });
        if (r && r.ok) {
          showToast('PC-Windows: OK (' + ((r.ms || 0) + 'ms') + ')');
          try { cursorAtlasNav('ops'); } catch (e) {}
          try { ccRefreshOps(); } catch (e) {}
          return r;
        }
        showToast('PC-Windows: FAIL ' + ((r && r.error) || ''), true);
        return r;
      } catch (e) {
        showToast('PC-Windows: Error ' + ((e && e.message) || e), true);
        return { ok: false, error: (e && e.message) || String(e) };
      }
    }

    function _cmdkActions() {
      // Se eval√∫a on-demand para que pueda llamar funciones ya definidas.
      return [
        { id: 'open_ca', title: 'Abrir Cursor‚ÄëATLAS', desc: 'Centro de mando (IDE) en pantalla completa', keys: 'Ctrl+K', run: function() { openCursorAtlas(); } },
        { id: 'close_ca', title: 'Cerrar Cursor‚ÄëATLAS', desc: 'Volver al dashboard', keys: 'Esc', run: function() { closeCursorAtlas(); } },
        { id: 'refresh', title: 'Actualizar todo', desc: 'Refrescar estado, salud, ANS, approvals, etc.', keys: 'R', run: function() { refreshAll(); } },
        { id: 'ops', title: 'OPS: abrir monitor', desc: 'Eventos recientes + evidencia', keys: 'O', run: function() { cursorAtlasNav('ops'); } },
        { id: 'web', title: 'Web (Pies): abrir', desc: 'Automatizaci√≥n web con screenshots', keys: 'W', run: function() { cursorAtlasNav('web'); } },
        { id: 'vision', title: 'Visi√≥n: snapshot', desc: 'Capturar c√°mara del robot (enhance/max)', keys: 'V', run: function() { cursorAtlasNav('vision'); setTimeout(function(){ ccCaptureVision(true); }, 100); } },
        { id: 'terminal', title: 'Terminal: consola en vivo', desc: 'Ver ANS live y logs', keys: 'T', run: function() { cursorAtlasNav('terminal'); scrollToSection('live-console-section'); } },
        { id: 'toggle_live', title: 'Consola en vivo: iniciar/detener', desc: 'Stream ANS live (SSE)', keys: 'L', run: function() { toggleLiveConsole(); } },
        { id: 'status', title: 'Ejecutar: /status', desc: 'Diagn√≥stico r√°pido del sistema', keys: '/s', run: function() { cursorAtlasRunCommand('/status'); } },
        { id: 'doctor', title: 'Ejecutar: /doctor', desc: 'Doctor + checks', keys: '/d', run: function() { cursorAtlasRunCommand('/doctor'); } },
        { id: 'modules', title: 'Ejecutar: /modules', desc: 'Listado de m√≥dulos', keys: '/m', run: function() { cursorAtlasRunCommand('/modules'); } },
        { id: 'approvals', title: 'Owner: approvals', desc: 'Ir a aprobaciones y sesi√≥n', keys: 'A', run: function() { closeCursorAtlas(); scrollToSection('owner-console-section'); } },
        { id: 'nexus_panel', title: 'Cuerpo: abrir Panel NEXUS', desc: 'Vista integrada del cuerpo', keys: 'P', run: function() { openNexusPanel(); } },
        { id: 'reconnect', title: 'Cuerpo: reconectar', desc: 'Arranca/valida NEXUS+Robot', keys: 'C', run: function() { reconnectNexus(); } },
        { id: 'emergency', title: 'Emergency Stop', desc: 'Activar/Desactivar (requiere confirmaci√≥n)', keys: 'E', run: function() { govEmergencyStop(); } },
        { id: 'ops_test', title: 'OPS: emitir evento test', desc: 'Verifica audio/telegram/wa', keys: 'X', run: function() { cursorAtlasNav('ops'); setTimeout(function(){ ccEmitOpsTest(); }, 100); } },
        { id: 'pc_explorer', title: 'PC-Windows: abrir Explorador', desc: 'Caminar por el PC (abrir Explorador de archivos)', keys: 'PE', run: function() { openCursorAtlas(); pcWalk('open_app', { name: 'explorer.exe', sleep_ms: 0 }); } },
        { id: 'pc_snapshots', title: 'PC-Windows: abrir Snapshots', desc: 'Abrir carpeta de evidencia local', keys: 'PS', run: function() { openCursorAtlas(); pcWalk('open_path', { path: 'C:/ATLAS_PUSH/snapshots', sleep_ms: 0 }); } },
        { id: 'pc_shot', title: 'PC-Windows: screenshot', desc: 'Captura de pantalla (evidencia en snapshots/pc_walk)', keys: 'PX', run: function() { openCursorAtlas(); pcWalk('screenshot', { name: 'ui_pc', sleep_ms: 0 }); } },
        { id: 'clear_cache', title: 'Limpiar cach√©', desc: 'Borra cache UI y reinicia', keys: 'K', run: function() { clearCacheAndRefresh(); } },
      ];
    }

    var _cmdkOpen = false;
    var _cmdkIndex = 0;
    var _cmdkFiltered = [];
    function openCmdk() {
      const ov = document.getElementById('cmdk-overlay');
      const inp = document.getElementById('cmdk-input');
      if (!ov || !inp) return;
      _cmdkOpen = true;
      _cmdkIndex = 0;
      ov.classList.add('open');
      ov.setAttribute('aria-hidden', 'false');
      inp.value = '';
      renderCmdk('');
      setTimeout(function(){ inp.focus(); }, 30);
    }
    function closeCmdk() {
      const ov = document.getElementById('cmdk-overlay');
      if (!ov) return;
      _cmdkOpen = false;
      ov.classList.remove('open');
      ov.setAttribute('aria-hidden', 'true');
    }
    function renderCmdk(q) {
      const list = document.getElementById('cmdk-list');
      if (!list) return;
      const query = (q || '').trim().toLowerCase();
      const all = _cmdkActions();
      _cmdkFiltered = all.filter(function(a) {
        if (!query) return true;
        return (a.title || '').toLowerCase().includes(query) || (a.desc || '').toLowerCase().includes(query) || (a.id || '').toLowerCase().includes(query);
      });
      if (_cmdkIndex >= _cmdkFiltered.length) _cmdkIndex = Math.max(0, _cmdkFiltered.length - 1);
      list.innerHTML = '';
      if (!_cmdkFiltered.length) {
        list.innerHTML = '<div class="value" style="padding:.9rem;color:var(--muted);">Sin coincidencias.</div>';
        return;
      }
      _cmdkFiltered.forEach(function(a, i) {
        const div = document.createElement('div');
        div.className = 'cmdk-item' + (i === _cmdkIndex ? ' active' : '');
        div.onclick = function() { runCmdk(i); };
        div.innerHTML = '<div><div class="t">' + (a.title || '') + '</div><div class="d">' + (a.desc || '') + '</div></div>'
          + '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:.25rem;">'
          + (a.keys ? ('<span class="kbd">' + a.keys + '</span>') : '')
          + '</div>';
        list.appendChild(div);
      });
    }
    function runCmdk(i) {
      const a = _cmdkFiltered[i];
      if (!a || typeof a.run !== 'function') return;
      closeCmdk();
      try { a.run(); } catch (e) { showToast('Acci√≥n fall√≥: ' + ((e && e.message) || e), true); }
    }

    // Atajos globales
    document.addEventListener('keydown', function(e) {
      // CmdK: abrir paleta
      if ((e.ctrlKey || e.metaKey) && (e.key || '').toLowerCase() === 'k') {
        e.preventDefault();
        if (_cmdkOpen) closeCmdk(); else openCmdk();
        return;
      }
      // Escape: cerrar overlays
      if (e.key === 'Escape') {
        if (_cmdkOpen) { closeCmdk(); return; }
        const ca = document.getElementById('cursor-atlas-overlay');
        if (ca && ca.classList.contains('open')) { closeCursorAtlas(); return; }
      }
      // Navegaci√≥n dentro de cmdk
      if (_cmdkOpen) {
        if (e.key === 'ArrowDown') { e.preventDefault(); _cmdkIndex = Math.min(_cmdkIndex + 1, Math.max(0, _cmdkFiltered.length - 1)); renderCmdk((document.getElementById('cmdk-input') || {}).value || ''); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); _cmdkIndex = Math.max(_cmdkIndex - 1, 0); renderCmdk((document.getElementById('cmdk-input') || {}).value || ''); }
        else if (e.key === 'Enter') { e.preventDefault(); runCmdk(_cmdkIndex); }
      }
    });

    function cursorAtlasCmdSubmit() {
      const inp = document.getElementById('cursor-atlas-cmd');
      if (!inp) return;
      const text = (inp.value || '').trim();
      if (!text) return;
      // comportamiento: si es url -> manda a Web; si empieza / -> quick cmd; si no -> goal
      const lower = text.toLowerCase();
      if (lower.startsWith('http://') || lower.startsWith('https://')) {
        cursorAtlasNav('web');
        const u = document.getElementById('cc-web-url');
        if (u) u.value = text;
        ccWebOpen();
      } else {
        cursorAtlasRunCommand(text);
      }
      inp.value = '';
    }
    function isQuickCommand(text) {
      const t = (text || '').trim().toLowerCase();
      return t.startsWith('/status') || t.startsWith('/doctor') || t.startsWith('/modules') || t.startsWith('/repo-push') || t.startsWith('aprobar ') || t.startsWith('confirmar ');
    }
    async function sendToRobot() {
      const input = document.getElementById('robot-input');
      const responseEl = document.getElementById('robot-response');
      const statusEl = document.getElementById('robot-status');
      const btn = document.getElementById('robot-send');
      const text = (input && input.value || '').trim();
      if (!text) {
        responseEl.textContent = UI_STRINGS['robot.no_input'] || 'Escribe un comando o objetivo.';
        responseEl.classList.add('error', 'empty');
        return;
      }
      btn.disabled = true;
      statusEl.textContent = UI_STRINGS['robot.sending'] || 'Enviando‚Ä¶';
      responseEl.classList.remove('error', 'empty');
      responseEl.textContent = '‚Ä¶';
      document.getElementById('atlas-steps-panel').style.display = 'none';
      document.getElementById('atlas-routing-panel').style.display = 'none';
      document.getElementById('atlas-evidence-panel').style.display = 'none';
      try {
        let out;
        const textLower = text.trim().toLowerCase();
        if (textLower.startsWith('aprobar ') || textLower.startsWith('confirmar ')) {
          out = await post('/owner/voice/command', { transcript: text.trim(), device_source: 'ui' });
          const msg = (out && out.response !== undefined) ? out.response : (out && out.error ? 'Error: ' + out.error : 'Sin respuesta');
          responseEl.textContent = msg;
          if (out && out.approved) responseEl.classList.remove('error'); else if (out && out.error) responseEl.classList.add('error');
          setLastResponseText(msg);
        } else if (isQuickCommand(text)) {
          out = await post('/intent', { text: text });
          let msg = formatRobotResponse(out, 'quick');
          if (out && out.error) responseEl.classList.add('error');
          else responseEl.classList.remove('error');
          responseEl.textContent = msg;
          setLastResponseText(msg);
        } else {
          const mode = (document.getElementById('atlas-mode') && document.getElementById('atlas-mode').value) || 'plan_only';
          const resourcesEl = document.getElementById('atlas-resources');
          const resources = (resourcesEl && resourcesEl.value) || 'pro';
          const depthMap = { lite: 1, pro: 2, ultra: 3 };
          const depth = depthMap[resources] || 2;
          const freeSel = document.getElementById('atlas-ai') && document.getElementById('atlas-ai').value;
          const prefer_free = freeSel !== 'allow_paid';
          const allow_paid = freeSel === 'allow_paid';
          const profile = (document.getElementById('atlas-profile') && document.getElementById('atlas-profile').value) || 'owner';
          statusEl.textContent = UI_STRINGS['cursor.running'] || 'Generando plan‚Ä¶';
          out = await post('/cursor/run', { goal: text, mode: mode, depth: depth, prefer_free: prefer_free, allow_paid: allow_paid, profile: profile, resources: resources, context: { source: 'ui_command_center' } });
          let msg = formatRobotResponse(out, 'plan');
          if (out && out.data && (out.data.steps || out.data.plan)) {
            msg += '\n\n' + (out.data.resumen || '');
            const stepsList = document.getElementById('atlas-steps-list');
            const stepsPanel = document.getElementById('atlas-steps-panel');
            const routingPanel = document.getElementById('atlas-routing-panel');
            const routingText = document.getElementById('atlas-routing-text');
            const evidencePanel = document.getElementById('atlas-evidence-panel');
            const evidenceText = document.getElementById('atlas-evidence-text');
            if (stepsList && (out.data.steps || out.data.plan)) {
              stepsList.innerHTML = '';
              (out.data.steps || out.data.plan || []).forEach(function(s, i) {
                const li = document.createElement('li');
                li.textContent = (typeof s === 'string') ? s : (s.description || s.step || JSON.stringify(s).slice(0, 80));
                stepsList.appendChild(li);
              });
              stepsPanel.style.display = 'block';
            }
            if (routingText && (out.data.model || out.data.model_routing)) {
              routingText.textContent = out.data.model ? String(out.data.model) : formatModelRouting(out.data.model_routing);
              routingPanel.style.display = 'block';
            }
            if (evidenceText && out.data.evidence) {
              evidenceText.textContent = Array.isArray(out.data.evidence) ? out.data.evidence.join(' ¬∑ ') : String(out.data.evidence);
              evidencePanel.style.display = 'block';
            }
            // Mostrar terminal preview del cursor-run si existe
            try {
              if (out.data.terminal_preview) {
                const term = document.getElementById('cc-terminal-mini');
                if (term) term.textContent = String(out.data.terminal_preview || '').slice(-6000) || '‚Äî';
              }
            } catch (e) {}
          }
          if (out && out.error) responseEl.classList.add('error');
          else responseEl.classList.remove('error');
          responseEl.textContent = msg;
          setLastResponseText(msg);
        }
      } catch (e) {
        responseEl.textContent = 'Error: ' + (e.message || String(e));
        responseEl.classList.add('error');
      }
      statusEl.textContent = '';
      btn.disabled = false;
    }

    let lastResponseText = '';
    function setLastResponseText(t) { lastResponseText = (t || '').trim(); }

    function formatRobotResponse(out, taskType) {
      if (!out) return UI_STRINGS['robot.no_response'] || 'No hubo respuesta del robot.';
      if (out.error) return (UI_STRINGS['robot.error'] || 'Error') + ': ' + (out.error || '');
      // Cursor-run shape: {ok, data:{summary,...}}
      if (out.data && out.data.summary) return String(out.data.summary);
      if (taskType === 'quick' && out.output !== undefined) {
        var o = out.output;
        if (typeof o === 'string') return o;
        if (o && typeof o === 'object') {
          if (o.atlas) return String(o.atlas);
          if (o.message) return String(o.message);
          if (o.status) return (UI_STRINGS['robot.status_prefix'] || 'Estado: ') + String(o.status);
        }
        return typeof o === 'string' ? o : (out.resumen || (UI_STRINGS['robot.cmd_done'] || 'Comando ejecutado. Revisa los detalles abajo.'));
      }
      if (out.resumen) return out.resumen;
      if (out.message) return out.message;
      return UI_STRINGS['robot.done'] || 'Listo. Revisa los detalles si los hay.';
    }

    function formatModelRouting(mr) {
      if (!mr) return '';
      if (typeof mr === 'string') return mr;
      if (typeof mr === 'object') {
        const prov = mr.provider_id || mr.provider || mr.source || '';
        const mk = mr.model_key || mr.model || '';
        const modelShort = (typeof mk === 'string' && mk.indexOf(':') >= 0) ? mk.split(':', 2)[1] : mk;
        const route = mr.route || '';
        const reason = mr.reason || '';
        const lat = (mr.latency_ms !== undefined && mr.latency_ms !== null) ? (Math.round(Number(mr.latency_ms)) + 'ms') : '';
        return [prov && ('prov=' + prov), modelShort && ('model=' + modelShort), route && ('route=' + route), reason && ('reason=' + reason), lat].filter(Boolean).join(' ¬∑ ');
      }
      return String(mr);
    }

    function startVoiceRecognition() {
      const btn = document.getElementById('btn-voice-mic');
      const input = document.getElementById('robot-input');
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert(UI_STRINGS['voice.browser_no_speech'] || 'Tu navegador no soporta reconocimiento de voz. Usa Chrome o Edge.');
        return;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new SpeechRecognition();
      rec.lang = 'es-ES';
      rec.continuous = false;
      rec.interimResults = false;
      if (btn) { btn.disabled = true; btn.textContent = 'üé§ ' + (UI_STRINGS['voice.listening'] || 'Escuchando‚Ä¶'); }
      rec.onresult = function(e) {
        const text = (e.results[0] && e.results[0][0]) ? e.results[0][0].transcript : '';
        if (input) input.value = text;
        if (btn) { btn.disabled = false; btn.textContent = 'üé§ ' + (UI_STRINGS['voice.talk'] || 'Hablar por voz'); }
        if (text) sendToRobot();
      };
      rec.onerror = function() {
        if (btn) { btn.disabled = false; btn.textContent = 'üé§ ' + (UI_STRINGS['voice.talk'] || 'Hablar por voz'); }
      };
      rec.onend = function() {
        if (btn && btn.textContent.indexOf('Escuchando') >= 0) { btn.disabled = false; btn.textContent = 'üé§ ' + (UI_STRINGS['voice.talk'] || 'Hablar por voz'); }
      };
      rec.start();
    }

    async function playResponseWithVoice() {
      const text = lastResponseText || (document.getElementById('robot-response') && document.getElementById('robot-response').textContent) || '';
      if (!text || text.startsWith(UI_STRINGS['cursor.response_placeholder'] || 'La respuesta') || text === '‚Ä¶') {
        alert(UI_STRINGS['voice.no_response_play'] || 'No hay respuesta que reproducir. Env√≠a un comando primero.');
        return;
      }
      function simplifyForSpeech(t) {
        let s = String(t || '');
        // reducir claves t√©cnicas comunes
        s = s.replace(/ga_refactor_plan/g, 'plan de mantenimiento del c√≥digo');
        s = s.replace(/architect_apply/g, 'aplicar un plan de creaci√≥n de aplicaci√≥n');
        s = s.replace(/approval_id/g, 'identificador de aprobaci√≥n');
        // quitar IDs tipo uuid-corto
        s = s.replace(/\b[0-9a-f]{8}-[0-9a-f]{3}\b/gi, 'ID');
        // quitar JSON muy t√©cnico
        if (s.trim().startsWith('{') || s.trim().startsWith('[')) {
          s = 'Evento recibido. Revisa el panel para ver el detalle.';
        }
        // cortar y suavizar
        s = s.replace(/[_{}[\]"]/g, ' ');
        s = s.replace(/\s+/g, ' ').trim();
        return s;
      }
      const short = simplifyForSpeech(text).slice(0, 420);
      try {
        const r = await post('/voice/speak', { text: short });
        if (r && r.ok) return;
        if (window.speechSynthesis && window.SpeechSynthesisUtterance) {
          const u = new SpeechSynthesisUtterance(short);
          u.lang = 'es-ES';
          window.speechSynthesis.speak(u);
        } else alert(UI_STRINGS['voice.tts_unavailable'] || 'TTS no disponible en el servidor. Instala pyttsx3.');
      } catch (e) {
        if (window.speechSynthesis && window.SpeechSynthesisUtterance) {
          const u = new SpeechSynthesisUtterance(short);
          u.lang = 'es-ES';
          window.speechSynthesis.speak(u);
        } else alert('Error: ' + (e.message || e));
      }
    }

    let faceStream = null;
    function disconnectCamera() {
      if (faceStream) {
        faceStream.getTracks().forEach(function(t) { t.stop(); });
        faceStream = null;
      }
      const video = document.getElementById('face-video');
      const container = document.getElementById('face-video-container');
      const btn = document.getElementById('btn-face-check');
      const btnDisc = document.getElementById('btn-face-disconnect');
      const resultEl = document.getElementById('face-result');
      if (video) { video.srcObject = null; video.style.display = 'none'; }
      if (container) container.style.display = 'none';
      if (btn) btn.textContent = 'üì∑ ' + (UI_STRINGS['voice.face'] || 'Verificar rostro (c√°mara)');
      if (btnDisc) btnDisc.style.display = 'none';
      if (resultEl) resultEl.textContent = UI_STRINGS['face.camera_off'] || 'C√°mara apagada.';
    }
    async function checkFace() {
      const resultEl = document.getElementById('face-result');
      const container = document.getElementById('face-video-container');
      const video = document.getElementById('face-video');
      const btn = document.getElementById('btn-face-check');
      const btnDisc = document.getElementById('btn-face-disconnect');
      if (resultEl) resultEl.textContent = '‚Ä¶';
      try {
        if (!faceStream) {
          faceStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 320, height: 240 } });
          if (video) { video.srcObject = faceStream; video.style.display = 'block'; }
          if (container) container.style.display = 'block';
          if (btn) btn.textContent = 'üì∑ ' + (UI_STRINGS['face.capture'] || 'Capturar y verificar');
          if (btnDisc) btnDisc.style.display = 'inline-block';
          if (resultEl) resultEl.textContent = UI_STRINGS['face.camera_on'] || 'C√°mara encendida. Pulsa de nuevo para capturar.';
          return;
        }
        if (!video || video.readyState < 2) {
          if (resultEl) resultEl.textContent = UI_STRINGS['face.wait_video'] || 'Espera a que cargue el video.';
          return;
        }
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const dataUrl = canvas.toDataURL('image/png');
        const base64 = dataUrl.split(',')[1];
        const r = await post('/face/check', { image_base64: base64 });
        if (r && r.ok && r.data) {
          const n = r.data.faces_detected || r.data.count || 0;
          if (resultEl) resultEl.textContent = n > 0 ? ((UI_STRINGS['face.detected'] || '‚úì Rostro detectado ({n})').replace('{n}', n)) : (UI_STRINGS['face.not_detected'] || 'No se detect√≥ rostro.');
        } else {
          if (resultEl) resultEl.textContent = 'Error: ' + (r && r.error ? r.error : 'sin respuesta');
        }
      } catch (e) {
        if (resultEl) resultEl.textContent = 'Error: ' + (e.message || e);
      }
    }

    async function loadStatus() {
      const d = await get('/status');
      const card = document.getElementById('status-card');
      if (card) {
        const val = card.querySelector('.value');
        if (val) {
          const atlasOk = d && d.ok;
          const nexusConnected = d && d.nexus_connected === true;
          const nexusActive = d && d.nexus_active === true;
          const nexusLabel = nexusConnected ? (nexusActive ? 'CONECTADO | ACTIVO' : 'Conectado') : 'Desconectado';
          const robotConnected = d && d.robot_connected === true;
          const robotLabel = robotConnected ? 'Conectado' : 'Desconectado';
          val.textContent = (atlasOk ? 'OK' : (d && d.error) || 'Error') + ' | CUERPO: NEXUS=' + nexusLabel + ' | ROBOT=' + robotLabel;
          card.classList.toggle('error', !atlasOk);
          card.classList.remove('loading');
        }
        if (d && d.nexus_dashboard_url) window._nexusDashboardUrl = d.nexus_dashboard_url;
        window._nexusConnected = !!(d && d.nexus_connected);
      }
    }
    function openNexusPanel() {
      var base = (window._base || window._apiBase || window.location.origin).replace(/\/$/, '');
      // Unificado: NEXUS se accede por proxy bajo el mismo puerto (sin 8000 directo)
      var url = base + '/cuerpo/nexus/dashboard';
      var overlay = document.getElementById('nexus-panel-overlay');
      var iframe = document.getElementById('nexus-panel-iframe');
      var unav = document.getElementById('nexus-panel-unavailable');
      if (!overlay || !iframe) return;
      if (unav) unav.innerHTML = 'NEXUS no est√° disponible.<br>Pulsa ¬´Reconectar Cuerpo¬ª en la tarjeta Estado y vuelve a abrir este panel.';
      overlay.classList.add('open');
      if (window._nexusConnected !== false) {
        iframe.style.display = 'block';
        unav.style.display = 'none';
        iframe.src = url;
      } else {
        iframe.style.display = 'none';
        iframe.src = 'about:blank';
        if (unav) unav.style.display = 'flex';
      }
    }
    function openRobotPanel() {
      var url = (window._base || window._apiBase || window.location.origin) + '/cuerpo/';
      var overlay = document.getElementById('nexus-panel-overlay');
      var iframe = document.getElementById('nexus-panel-iframe');
      var unav = document.getElementById('nexus-panel-unavailable');
      if (!overlay || !iframe) return;
      if (unav) unav.innerHTML = 'Robot no disponible. Comprueba que el backend del Robot est√© en marcha (NEXUS_ROBOT_URL, p. ej. 8002 o 5174) y vuelve a abrir.';
      overlay.classList.add('open');
      iframe.style.display = 'block';
      iframe.src = url;
      if (unav) unav.style.display = 'none';
      iframe.onerror = function() {
        iframe.style.display = 'none';
        if (unav) { unav.style.display = 'flex'; }
      };
    }
    function closeNexusPanel() {
      var overlay = document.getElementById('nexus-panel-overlay');
      var iframe = document.getElementById('nexus-panel-iframe');
      if (overlay) overlay.classList.remove('open');
      if (iframe) { iframe.src = 'about:blank'; iframe.style.display = 'none'; }
      var unav = document.getElementById('nexus-panel-unavailable');
      if (unav) unav.style.display = 'none';
    }
    window._cameraManualOff = window._cameraManualOff || { 0: false, 1: false, 2: false };
    function _cameraSetState(idx, text, isError) {
      var el = document.getElementById('camera-state-' + idx);
      if (!el) return;
      el.textContent = text || '‚Äî';
      el.style.color = isError ? 'var(--danger)' : 'var(--muted)';
    }
    function _cameraSetBusy(idx, busy, connectLabel, offLabel) {
      var c = document.getElementById('btn-camera-connect-' + idx);
      var o = document.getElementById('btn-camera-off-' + idx);
      if (c) { c.disabled = !!busy; if (connectLabel) c.textContent = connectLabel; else c.textContent = 'Conectar'; }
      if (o) { o.disabled = !!busy; if (offLabel) o.textContent = offLabel; else o.textContent = 'Apagar'; }
    }
    function _sleep(ms) { return new Promise(function(resolve){ setTimeout(resolve, ms || 0); }); }
    window._cameraDiagRunning = false;
    async function cameraConnect(idx) {
      _cameraSetBusy(idx, true, 'Conectando‚Ä¶', 'Apagar');
      _cameraSetState(idx, 'Conectando‚Ä¶', false);
      try {
        var r = await post('/cuerpo/api/camera/connect-index', { index: idx, resolution: [640, 480] }, null, 25000);
        if (r && r.ok && r.connected) {
          window._cameraManualOff[idx] = false;
          var img = document.getElementById('camera-stream-img-' + idx);
          var noStream = document.getElementById('cameras-no-stream-' + idx);
          if (img) {
            var base = (window._base || window._apiBase || window.location.origin).replace(/\/$/, '');
            var streamUrl = base + '/cuerpo/camera/stream?index=' + idx + '&t=' + Date.now();
            img.src = streamUrl;
            img.setAttribute('data-stream-url', streamUrl);
            img.style.display = 'block';
            img.onload = function() { _cameraSetState(idx, 'Conectada', false); };
            img.onerror = function() {
              img.style.display = 'none';
              if (noStream) noStream.style.display = 'flex';
              _cameraSetState(idx, 'Sin stream', true);
            };
          }
          if (noStream) noStream.style.display = 'none';
          if (window._toast) window._toast('C√°mara ' + idx + ': conectada');
        } else {
          var err = (r && (r.probe_error || r.error || r.message)) || 'No conecta';
          _cameraSetState(idx, 'Error: ' + err, true);
          if (window._toast) window._toast('C√°mara ' + idx + ': ' + err);
        }
      } catch (e) {
        _cameraSetState(idx, 'Error de red', true);
      } finally {
        _cameraSetBusy(idx, false);
      }
    }
    async function cameraDisconnect(idx) {
      _cameraSetBusy(idx, true, 'Conectar', 'Apagando‚Ä¶');
      try {
        await post('/cuerpo/api/camera/disconnect', { index: idx }, null, 12000);
      } catch (_) {}
      window._cameraManualOff[idx] = true;
      var img = document.getElementById('camera-stream-img-' + idx);
      var noStream = document.getElementById('cameras-no-stream-' + idx);
      if (img) {
        img.src = '';
        img.removeAttribute('data-stream-url');
        img.style.display = 'none';
      }
      if (noStream) {
        noStream.textContent = 'C√°mara ' + idx + ' apagada';
        noStream.style.display = 'flex';
      }
      _cameraSetState(idx, 'Apagada', false);
      _cameraSetBusy(idx, false);
    }
    async function runCamerasDiagnostic() {
      if (window._cameraDiagRunning) return;
      window._cameraDiagRunning = true;
      var cams = [0, 1, 2];
      var btnDiag = document.getElementById('btn-diagnostico-camaras');
      var btnRefresh = document.getElementById('btn-actualizar-camaras');
      var btnReconnect = document.getElementById('btn-reconectar-robot');
      var resEl = document.getElementById('cameras-diagnostic-result');
      var base = (window._base || window._apiBase || window.location.origin).replace(/\/$/, '');
      var report = [];
      if (btnDiag) { btnDiag.disabled = true; btnDiag.textContent = 'Diagnosticando‚Ä¶'; }
      if (btnRefresh) btnRefresh.disabled = true;
      if (btnReconnect) btnReconnect.disabled = true;
      if (resEl) { resEl.textContent = 'Ejecutando diagn√≥stico 0‚Üí1‚Üí2‚Ä¶'; resEl.style.color = 'var(--muted)'; }
      try {
        // Evita contenci√≥n de dispositivo: cerrar streams activos antes de diagnosticar.
        cams.forEach(function(idx) {
          window._cameraManualOff[idx] = true;
          var img = document.getElementById('camera-stream-img-' + idx);
          var noStream = document.getElementById('cameras-no-stream-' + idx);
          if (img) {
            img.src = '';
            img.removeAttribute('data-stream-url');
            img.style.display = 'none';
          }
          if (noStream) {
            noStream.textContent = 'Diagn√≥stico en curso‚Ä¶';
            noStream.style.display = 'flex';
          }
        });
        await _sleep(350);
        for (var i = 0; i < cams.length; i++) {
          var idx = cams[i];
          _cameraSetBusy(idx, true, 'Test‚Ä¶', 'Apagar');
          _cameraSetState(idx, 'Diagn√≥stico‚Ä¶', false);
          var connect = await post('/cuerpo/api/camera/connect-index', { index: idx, resolution: [640, 480] }, null, 25000);
          var connectOk = !!(connect && connect.ok && connect.connected);
          var frameOk = !!(connect && connect.frame_ok);
          var snapOk = false;
          var snapErr = '';
          if (connectOk) {
            try {
              var snapUrl = base + '/cuerpo/vision/snapshot?source=camera&index=' + idx + '&jpeg_quality=80&t=' + Date.now();
              var rsp = await _fetchWithTimeout(snapUrl, { method: 'GET', cache: 'no-store' }, 12000);
              if (rsp && rsp.ok) {
                var blob = await rsp.blob();
                snapOk = blob && blob.size > 2000;
              } else {
                snapErr = 'snapshot_' + (rsp ? rsp.status : 'error');
              }
            } catch (e) {
              snapErr = (e && e.message) ? e.message : String(e);
            }
          }
          try { await post('/cuerpo/api/camera/disconnect', { index: idx }, null, 12000); } catch (_) {}
          window._cameraManualOff[idx] = true;
          var finalOk = connectOk && (frameOk || snapOk);
          if (finalOk) {
            _cameraSetState(idx, 'OK (con frame)', false);
            report.push({ index: idx, ok: true, detail: 'frame_ok=' + frameOk + ', snapshot_ok=' + snapOk });
          } else if (connectOk) {
            _cameraSetState(idx, 'Conecta sin frame', true);
            report.push({ index: idx, ok: false, detail: 'conecta pero no hay frame (' + (snapErr || 'frame_ok=false') + ')' });
          } else {
            var err = (connect && (connect.probe_error || connect.error || connect.message)) || 'no_conecta';
            _cameraSetState(idx, 'Falla conexi√≥n', true);
            report.push({ index: idx, ok: false, detail: err });
          }
          _cameraSetBusy(idx, false);
          await _sleep(400);
        }
        var oks = report.filter(function(x){ return x.ok; }).map(function(x){ return x.index; });
        var fails = report.filter(function(x){ return !x.ok; });
        var txt = 'OK: [' + (oks.length ? oks.join(',') : 'ninguna') + ']';
        if (fails.length) txt += ' | Fallan: ' + fails.map(function(x){ return x.index + ' (' + x.detail + ')'; }).join('; ');
        if (resEl) {
          resEl.textContent = txt;
          resEl.style.color = fails.length ? 'var(--danger)' : 'var(--success)';
        }
        if (window._toast) window._toast(txt);
        await loadCamerasStatus();
      } catch (e) {
        var msg = 'Diagn√≥stico error: ' + ((e && e.message) ? e.message : String(e));
        if (resEl) { resEl.textContent = msg; resEl.style.color = 'var(--danger)'; }
        if (window._toast) window._toast(msg);
      } finally {
        window._cameraDiagRunning = false;
        if (btnDiag) { btnDiag.disabled = false; btnDiag.textContent = 'Diagn√≥stico secuencial'; }
        if (btnRefresh) btnRefresh.disabled = false;
        if (btnReconnect) btnReconnect.disabled = false;
      }
    }
    async function loadCamerasStatus() {
      var statusEl = document.getElementById('cameras-status');
      var btnCameras = document.getElementById('btn-actualizar-camaras');
      var cams = [0, 1, 2];
      var base = window._base || window._apiBase || window.location.origin;
      if (btnCameras) { btnCameras.disabled = true; btnCameras.textContent = 'Actualizando‚Ä¶'; }
      try {
        const r = await get('/api/robot/status');
        var connected = r && r.connected;
        var robotUrl = (r && r.robot_url) ? r.robot_url : 'http://127.0.0.1:8002';
        var source = (r && r.source) ? String(r.source) : 'none';
        var portLabel = robotUrl.replace(/^https?:\/\//, '').replace(/\/.*$/, '');
        if (statusEl) {
          if (connected && source === 'local') statusEl.textContent = 'Robot: Fallback local USB activo';
          else statusEl.textContent = 'Robot (' + portLabel + '): ' + (connected ? 'Conectado' : 'Desconectado');
        }
        var hintEl = document.getElementById('cameras-disconnected-hint');
        if (hintEl) hintEl.style.display = connected ? 'none' : 'block';
        cams.forEach(function(idx) {
          var img = document.getElementById('camera-stream-img-' + idx);
          var noStream = document.getElementById('cameras-no-stream-' + idx);
          if (!img) return;
          if (window._cameraManualOff && window._cameraManualOff[idx]) {
            img.src = '';
            img.style.display = 'none';
            img.removeAttribute('data-stream-url');
            if (noStream) {
              noStream.textContent = 'C√°mara ' + idx + ' apagada';
              noStream.style.display = 'flex';
            }
            _cameraSetState(idx, 'Apagada', false);
            return;
          }
          var streamUrl = base.replace(/\/$/, '') + '/cuerpo/camera/stream?index=' + idx;
          // Evita reconectar el MJPEG en cada refresh (reduce lag y CLOSE_WAIT en Windows).
          if (img.getAttribute('data-stream-url') !== streamUrl) {
            img.src = streamUrl;
            img.setAttribute('data-stream-url', streamUrl);
          }
          img.style.display = 'block';
          if (noStream) noStream.style.display = 'none';
          _cameraSetState(idx, 'Conectando stream‚Ä¶', false);
          img.onload = (function(i) {
            return function() { _cameraSetState(i, 'Online', false); };
          })(idx);
          img.onerror = (function(im, ns, i) {
            return function() {
              im.style.display = 'none';
              if (ns) ns.style.display = 'flex';
              _cameraSetState(i, 'Offline', true);
            };
          })(img, noStream, idx);
        });
      } catch (e) {
        if (statusEl) statusEl.textContent = 'Robot (8002): Error';
        cams.forEach(function(idx) {
          var img = document.getElementById('camera-stream-img-' + idx);
          var noStream = document.getElementById('cameras-no-stream-' + idx);
          if (img) { img.src = ''; img.style.display = 'none'; }
          if (noStream) noStream.style.display = 'flex';
        });
      }
      if (btnCameras) { btnCameras.disabled = false; btnCameras.textContent = 'Actualizar c√°maras'; }
    }
    async function reconnectRobot() {
      var btn = document.getElementById('btn-reconectar-robot');
      var statusEl = document.getElementById('cameras-status');
      if (btn) { btn.disabled = true; btn.textContent = 'Conectando‚Ä¶'; }
      try {
        var r = await post('/api/robot/reconnect', {});
        var msg = (r && r.message) ? r.message : (r && r.error) ? r.error : 'Sin respuesta';
        if (statusEl) statusEl.textContent = 'Robot: ' + msg;
        if (window._toast) window._toast(msg); else if (statusEl) statusEl.textContent = 'Robot: ' + msg;
        await loadCamerasStatus();
      } catch (e) {
        var err = (e && e.message) ? e.message : String(e);
        if (statusEl) statusEl.textContent = 'Robot: Error ‚Äì ' + err;
        if (window._toast) window._toast('Error: ' + err); else alert('Error: ' + err);
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = 'Reconectar Robot'; }
      }
    }
    async function showRobotStartCommands() {
      try {
        var d = await get('/api/robot/start-commands');
        if (!d || !d.commands) { alert('No se obtuvieron comandos'); return; }
        var t = (d.hint || '') + '\n\nRobot (8002):\n' + (d.commands.robot || '') + '\n\nNEXUS (8000):\n' + (d.commands.nexus || '');
        alert(t);
      } catch (e) {
        alert('Error: ' + (e.message || e));
      }
    }
    async function clearCacheAndRefresh() {
      try {
        localStorage.clear();
        sessionStorage.clear();
        const r = await fetch((window._apiBase || '') + '/api/cache/clear', { method: 'POST', headers: { 'Accept': 'application/json' }, cache: 'no-store' });
        const d = r.ok ? await r.json() : {};
        if (d.ok) { if (window._toast) window._toast('Cach√© limpiada (navegador + servidor)'); else alert('Cach√© limpiada.'); }
        refreshAll();
      } catch (e) {
        if (window._toast) window._toast('Error: ' + (e.message || 'cache')); else alert('Error al limpiar cach√©');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Sistema de Actualizaciones
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function checkForUpdates() {
      const btn = document.getElementById('btn-check-update');
      const originalText = btn ? btn.innerHTML : '';
      
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Buscando...';
        btn.style.animation = 'pulse 0.8s ease-in-out infinite';
      }
      
      showToast('üîç EN PROCESO DE B√öSQUEDA DE ACTUALIZACI√ìN...', false);
      
      try {
        // Verificar versi√≥n del servidor
        const r = await fetch((window._apiBase || '') + '/version', { 
          method: 'GET', 
          headers: { 'Accept': 'application/json' }, 
          cache: 'no-store' 
        });
        
        if (r.ok) {
          const data = await r.json();
          const serverVersion = data.version || data.dashboard_version || 'unknown';
          const currentVersion = typeof ATLAS_VERSION !== 'undefined' ? ATLAS_VERSION : '2.5.0';
          
          if (serverVersion !== currentVersion && serverVersion !== 'unknown') {
            // Nueva versi√≥n disponible
            showUpdateModal(currentVersion, serverVersion, data.changelog || []);
          } else {
            showToast(`‚úÖ Sistema actualizado (v${currentVersion})`, false);
          }
        } else {
          // Endpoint no existe, verificar GitHub
          await checkGitHubUpdates();
        }
      } catch (e) {
        // Fallback: verificar si hay cambios pendientes en git
        try {
          const gitR = await fetch((window._apiBase || '') + '/git/status', { 
            method: 'GET', 
            headers: { 'Accept': 'application/json' }, 
            cache: 'no-store' 
          });
          if (gitR.ok) {
            const gitData = await gitR.json();
            if (gitData.behind > 0) {
              showToast(`üîÑ ACTUALIZACI√ìN DISPONIBLE: ${gitData.behind} commits nuevos`, false);
              showUpdateModal(ATLAS_VERSION, `+${gitData.behind} commits`, gitData.commits || []);
            } else {
              showToast(`‚úÖ Sistema actualizado (v${ATLAS_VERSION})`, false);
            }
          } else {
            showToast(`‚úÖ v${ATLAS_VERSION} - No se pudo verificar servidor`, false);
          }
        } catch (e2) {
          showToast(`‚ö†Ô∏è Error verificando: ${e.message || 'conexi√≥n'}`, true);
        }
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText;
          btn.style.animation = '';
        }
      }
    }

    async function checkGitHubUpdates() {
      try {
        const r = await fetch((window._apiBase || '') + '/git/check-updates', { 
          method: 'POST', 
          headers: { 'Accept': 'application/json' }, 
          cache: 'no-store' 
        });
        if (r.ok) {
          const data = await r.json();
          if (data.updates_available) {
            showUpdateModal(ATLAS_VERSION, data.latest_version || 'nueva', data.changelog || []);
          } else {
            showToast(`‚úÖ Sistema actualizado (v${ATLAS_VERSION})`, false);
          }
        }
      } catch (e) {
        showToast(`‚úÖ v${ATLAS_VERSION} - Verificaci√≥n local OK`, false);
      }
    }

    function showUpdateModal(currentVer, newVer, changelog) {
      // Crear modal de actualizaci√≥n
      let modal = document.getElementById('update-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'update-modal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0,0,0,0.8); z-index: 10000;
          display: flex; align-items: center; justify-content: center;
          backdrop-filter: blur(4px);
        `;
        document.body.appendChild(modal);
      }
      
      const changelogHTML = Array.isArray(changelog) && changelog.length > 0 
        ? changelog.map(c => `<li style="margin: 0.3rem 0; color: var(--text);">${c}</li>`).join('')
        : '<li style="color: var(--muted);">Sin detalles disponibles</li>';
      
      modal.innerHTML = `
        <div style="
          background: var(--card); 
          border: 1px solid var(--purple); 
          border-radius: 16px; 
          padding: 2rem; 
          max-width: 450px; 
          width: 90%;
          box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
        ">
          <h2 style="margin: 0 0 1rem; color: var(--purple-light); display: flex; align-items: center; gap: 0.5rem;">
            üöÄ Actualizaci√≥n Disponible
          </h2>
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg); border-radius: 8px;">
            <div style="text-align: center;">
              <div style="font-size: 0.75rem; color: var(--muted);">Versi√≥n actual</div>
              <div style="font-size: 1.1rem; color: var(--amber);">v${currentVer}</div>
            </div>
            <div style="display: flex; align-items: center; color: var(--purple);">‚Üí</div>
            <div style="text-align: center;">
              <div style="font-size: 0.75rem; color: var(--muted);">Nueva versi√≥n</div>
              <div style="font-size: 1.1rem; color: var(--green);">v${newVer}</div>
            </div>
          </div>
          <div style="margin-bottom: 1.5rem;">
            <div style="font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem;">Cambios:</div>
            <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.85rem; max-height: 150px; overflow-y: auto;">
              ${changelogHTML}
            </ul>
          </div>
          <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
            <button class="secondary" onclick="closeUpdateModal()">M√°s tarde</button>
            <button onclick="performUpdate()" style="background: var(--green);">üîÑ Actualizar Ahora</button>
          </div>
        </div>
      `;
      modal.style.display = 'flex';
    }

    function closeUpdateModal() {
      const modal = document.getElementById('update-modal');
      if (modal) modal.style.display = 'none';
    }

    async function performUpdate() {
      closeUpdateModal();
      showToast('üîÑ Aplicando actualizaci√≥n...', false);
      
      try {
        // Intentar git pull via API
        const r = await fetch((window._apiBase || '') + '/git/pull', { 
          method: 'POST', 
          headers: { 'Accept': 'application/json' }, 
          cache: 'no-store' 
        });
        
        if (r.ok) {
          const data = await r.json();
          if (data.ok || data.success) {
            showToast('‚úÖ Actualizaci√≥n completada. Recargando...', false);
            // Limpiar cach√© y recargar
            setTimeout(() => {
              localStorage.removeItem('atlas_cache');
              sessionStorage.clear();
              location.reload(true);
            }, 2000);
          } else {
            showToast(`‚ö†Ô∏è ${data.error || 'Error en actualizaci√≥n'}`, true);
          }
        } else {
          showToast('‚ö†Ô∏è No se pudo conectar al servidor de actualizaciones', true);
        }
      } catch (e) {
        showToast(`‚ùå Error: ${e.message || 'actualizaci√≥n fallida'}`, true);
      }
    }

    // Auto-check updates cada 30 minutos
    setInterval(() => {
      const lastCheck = localStorage.getItem('atlas_last_update_check');
      const now = Date.now();
      if (!lastCheck || (now - parseInt(lastCheck)) > 1800000) { // 30 min
        localStorage.setItem('atlas_last_update_check', now.toString());
        // Check silencioso
        fetch((window._apiBase || '') + '/version', { cache: 'no-store' })
          .then(r => r.ok ? r.json() : null)
          .then(data => {
            if (data && data.version && data.version !== ATLAS_VERSION) {
              showToast('üîî ACTUALIZACI√ìN DISPONIBLE - Click en "Buscar Actualizaci√≥n"', false);
            }
          })
          .catch(() => {});
      }
    }, 300000); // Check cada 5 min si pasaron 30 min desde √∫ltimo check
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function reconnectNexus() {
      const btn = document.getElementById('btn-reconnect-nexus');
      if (btn) { btn.disabled = true; btn.textContent = 'Conectando‚Ä¶'; }
      try {
        const r = await post('/api/cuerpo/reconnect', {});
        await loadStatus();
        const msg = (r && (r.message || r.error)) ? (r.message || r.error) : 'Cuerpo: comando enviado';
        if (window._toast) window._toast(msg);
        if (btn) {
          btn.textContent = 'Reconectar Cuerpo';
          btn.classList.toggle('error', !(r && r.ok));
          btn.title = msg;
        }
      } catch (e) {
        if (btn) { btn.textContent = 'Reconectar Cuerpo'; btn.disabled = false; btn.title = (e && e.message) || 'Error'; }
      }
      if (btn) btn.disabled = false;
    }
    var _brainState = null;
    function isDominantConnected(state) {
      if (!state || !state.credentials) return false;
      if (state.mode !== 'manual' || !state.override_model) return false;
      var providerId = (state.override_model.indexOf(':') >= 0 ? state.override_model.split(':')[0] : state.override_model).toLowerCase();
      return !!(state.credentials[providerId] && state.credentials[providerId].configured);
    }
    function hasAnyProviderConnected(state) {
      if (!state || !state.credentials) return false;
      return Object.keys(state.credentials).some(function(id) { return state.credentials[id] && state.credentials[id].configured; });
    }
    var _brainProviderOptionsFallback = [
      { id: 'openai', name: 'OpenAI (GPT)', connect_url: 'https://platform.openai.com/api-keys' },
      { id: 'anthropic', name: 'Anthropic (Claude)', connect_url: 'https://console.anthropic.com/' },
      { id: 'gemini', name: 'Google Gemini', connect_url: 'https://aistudio.google.com/app/apikey' },
      { id: 'perplexity', name: 'Perplexity', connect_url: 'https://www.perplexity.ai/settings/api' }
    ];
    async function loadBrainState() {
      try {
        var d = await get('/api/brain/state');
        if (!d) {
          _brainState = { ok: false, mode: 'auto', available_models: [], provider_options: _brainProviderOptionsFallback, credentials: {} };
          var errEl = document.getElementById('brain-dominant');
          if (errEl) { errEl.textContent = 'IA dominante: Error al cargar'; errEl.className = 'value brain-dominant-error'; errEl.style.color = ''; }
          return;
        }
        _brainState = d;
        const dominantEl = document.getElementById('brain-dominant');
        const cfgEl = document.getElementById('brain-config-line');
        const btnAuto = document.getElementById('brain-btn-auto');
        const btnManual = document.getElementById('brain-btn-manual');
        if (!dominantEl) return;
        dominantEl.textContent = 'IA dominante: ' + (d.dominant_display ? d.dominant_display : '‚Äî');
        if (cfgEl) {
          var mode = (d.mode || 'auto').toUpperCase();
          var ov = (d.override_model || '‚Äî');
          var creds = d.credentials || {};
          var connectedCount = Object.keys(creds).filter(function(k){ return creds[k] && creds[k].configured; }).length;
          cfgEl.innerHTML =
            '<span style="color:var(--muted);">Modo:</span> <strong>' + mode + '</strong>' +
            (d.mode === 'manual' ? (' ¬∑ <span style="color:var(--muted);">Override:</span> <span style="color:var(--purple-light);">' + (ov.replace(/</g,'&lt;').replace(/>/g,'&gt;')) + '</span>') : '') +
            (' ¬∑ <span style="color:var(--muted);">Claves:</span> <strong>' + connectedCount + '</strong>');
        }
        var connected = isDominantConnected(d) || (d.mode === 'auto' && hasAnyProviderConnected(d));
        dominantEl.classList.toggle('brain-dominant-connected', connected);
        dominantEl.classList.remove('brain-dominant-error');
        if (dominantEl.style) dominantEl.style.removeProperty('color');
        const isManual = (d.mode === 'manual');
        var panel = document.getElementById('brain-model-panel');
        var btnElegir = document.getElementById('brain-btn-elegir');
        var panelOpen = panel && panel.style.display === 'block';
        if (btnAuto) { btnAuto.className = (panelOpen ? 'small secondary' : (isManual ? 'small secondary' : 'small btn-brain-active')); }
        if (btnManual) { btnManual.className = (panelOpen ? 'small secondary' : (isManual ? 'small btn-brain-active' : 'small secondary')); }
        if (btnElegir) { btnElegir.className = panelOpen ? 'small btn-brain-active' : 'small secondary'; }
        if (panel && panelOpen) renderBrainModelList();
      } catch (e) {
        _brainState = { ok: false, mode: 'auto', available_models: [], provider_options: _brainProviderOptionsFallback, credentials: {} };
        var errEl = document.getElementById('brain-dominant');
        if (errEl) { errEl.textContent = 'IA dominante: Error al cargar'; errEl.className = 'value brain-dominant-error'; errEl.classList.remove('brain-dominant-connected'); }
      }
    }
    function updateBrainElegirButtonState() {
      var panel = document.getElementById('brain-model-panel');
      var btnElegir = document.getElementById('brain-btn-elegir');
      var btnAuto = document.getElementById('brain-btn-auto');
      var btnManual = document.getElementById('brain-btn-manual');
      var panelOpen = panel && panel.style.display === 'block';
      var isManual = _brainState && _brainState.mode === 'manual';
      if (btnElegir) btnElegir.className = panelOpen ? 'small btn-brain-active' : 'small secondary';
      if (btnAuto) btnAuto.className = (panelOpen ? 'small secondary' : (isManual ? 'small secondary' : 'small btn-brain-active'));
      if (btnManual) btnManual.className = (panelOpen ? 'small secondary' : (isManual ? 'small btn-brain-active' : 'small secondary'));
    }
    async function toggleBrainModelPanel() {
      var panel = document.getElementById('brain-model-panel');
      if (!panel) return;
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        updateBrainElegirButtonState();
        return;
      }
      panel.style.display = 'block';
      updateBrainElegirButtonState();
      var listEl = document.getElementById('brain-model-list');
      if (listEl) listEl.innerHTML = '<div style="color:var(--muted);font-size:.8rem;">Cargando‚Ä¶</div>';
      await loadBrainState();
      updateBrainElegirButtonState();
      renderBrainModelList();
    }
    function renderBrainModelList() {
      var listEl = document.getElementById('brain-model-list');
      if (!listEl) return;
      if (!_brainState) { listEl.innerHTML = '<div style="color:var(--muted);font-size:.8rem;">Error al cargar. <button class="small" onclick="toggleBrainModelPanel()">Reintentar</button></div>'; return; }
      var models = _brainState.available_models || [];
      var connectUrls = _brainState.provider_connect_urls || {};
      var providerOptions = _brainState.provider_options || [];
      var cur = _brainState.override_model || '';
      var html = '';
      html += models.map(function(m) {
        var key = m.full_key || '';
        var keyAttr = key.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        var label = (m.label || m.full_key) + (m.is_free ? ' (free)' : '');
        var labelSafe = (label || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        var isPaid = !m.is_free && m.provider_id;
        var connectUrl = isPaid && connectUrls[m.provider_id] ? connectUrls[m.provider_id] : '';
        var usarBtn = '<button class="small ' + (key === cur ? 'btn-brain-active' : '') + '" data-brain-key="' + keyAttr + '" onclick="setBrainModelAndClose(this.getAttribute(\'data-brain-key\'))" title="Usar esta IA como dominante">Usar</button>';
        var conectarBtn = isPaid && connectUrl ? '<a href="' + connectUrl.replace(/"/g, '&quot;') + '" target="_blank" rel="noopener" class="small secondary" style="padding:.2rem .4rem;font-size:.7rem;text-decoration:none;border-radius:6px;display:inline-block;" title="Abrir p√°gina para API key / suscripci√≥n">Conectar</a>' : '';
        return '<div class="brain-model-row"><span class="brain-model-label">' + labelSafe + '</span><div class="brain-model-actions">' + usarBtn + (conectarBtn ? ' ' + conectarBtn : '') + '</div></div>';
      }).join('');
      if (providerOptions.length) {
        var creds = _brainState.credentials || {};
        html += '<div class="brain-providers-header">Otras (suscripci√≥n/API)</div>';
        html += providerOptions.map(function(p) {
          var url = (p.connect_url || '').replace(/"/g, '&quot;');
          var nameSafe = (p.name || p.id || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
          var idSafe = (p.id || '').replace(/"/g, '&quot;');
          var c = creds[p.id] || {};
          var configured = c.configured;
          var masked = (c.masked || '***').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          var labelColor = configured ? 'color:var(--green);' : 'color:var(--text);';
          var conectarStyle = configured
            ? 'padding:.25rem .5rem;font-size:.7rem;text-decoration:none;border-radius:6px;display:inline-block;color:var(--green);white-space:nowrap;'
            : 'padding:.25rem .5rem;font-size:.7rem;text-decoration:none;border-radius:6px;display:inline-block;color:var(--purple-light);white-space:nowrap;';
          var conectarTitle = configured ? 'Conectado (API key configurada)' : 'Abrir p√°gina del proveedor para obtener la API key';
          var conectarLink = '<a href="' + url + '" target="_blank" rel="noopener" class="small" style="' + conectarStyle + '" title="' + conectarTitle + '">Conectar</a>';
          var configBtn = configured
            ? '<span class="brain-status-configured">Configurado (' + masked + ')</span><button type="button" class="small secondary" onclick="clearBrainCredential(\'' + idSafe + '\')" title="Borrar clave guardada">Borrar</button>'
            : '<span style="font-size:.75rem;color:var(--muted);white-space:nowrap;">Usa ‚ÄúCargar B√≥veda‚Äù</span>';
          return '<div class="brain-model-row"><span class="brain-model-label" style="' + labelColor + '">' + nameSafe + '</span><div class="brain-model-actions">' + conectarLink + ' ' + configBtn + '</div></div>';
        }).join('');
      }
      listEl.innerHTML = html || '<div style="color:var(--muted);font-size:.8rem;">No hay modelos configurados. Usa Ollama (free) o Conectar para API.</div>';
    }
    async function setBrainModelAndClose(fullKey) {
      if (!fullKey) return;
      await setBrainModel(fullKey);
      var panel = document.getElementById('brain-model-panel');
      if (panel) { panel.style.display = 'none'; updateBrainElegirButtonState(); }
      if (window._toast) window._toast('Entorno: ' + (fullKey.split(':')[1] || fullKey));
    }
    async function setBrainMode(mode) {
      try {
        // Si el panel de "Elegir modelo" est√° abierto, ci√©rralo al cambiar de modo.
        // Esto evita que el bot√≥n "Auto" se quede en estado secundario por panelOpen=true.
        var panel = document.getElementById('brain-model-panel');
        if (panel && panel.style.display === 'block') {
          panel.style.display = 'none';
          updateBrainElegirButtonState();
        }
        var r = await post('/api/brain/state', { mode: mode });
        if (!r || r.ok === false) throw new Error(r && r.error ? r.error : 'No se pudo cambiar el modo');
        await loadBrainState();
        updateBrainElegirButtonState();
        if (window._toast) window._toast(mode === 'auto' ? 'Cerebro en Auto (multi-IA)' : 'Cerebro en Manual: elige una IA');
      } catch (e) {
        await loadBrainState();
        updateBrainElegirButtonState();
        var msg = (e && e.message) ? e.message : 'Error al cambiar modo';
        if (window._toast) window._toast(msg); else alert(msg);
      }
    }
    function setBrainModelFromSelect() {
      const sel = document.getElementById('brain-model-select');
      if (!sel) return;
      setBrainModel(sel.value || null);
    }
    async function setBrainModel(fullKey) {
      try {
        await post('/api/brain/state', { mode: 'manual', override_model: fullKey || null });
        await loadBrainState();
        if (window._toast) window._toast(fullKey ? 'IA fijada: ' + (fullKey.split(':')[1] || fullKey) : 'Selecciona una IA');
      } catch (e) {
        if (window._toast) window._toast('Error: ' + (e && e.message) || 'brain');
      }
    }
    async function loadBrainVault() {
      var btn = document.getElementById('brain-btn-vault');
      var old = btn ? btn.textContent : '';
      if (btn) { btn.disabled = true; btn.textContent = 'Cargando‚Ä¶'; }
      try {
        var r = await post('/api/brain/credentials/load-vault', {});
        if (!r || r.ok === false) throw new Error((r && r.error) ? r.error : 'vault_failed');
        _brainState = _brainState || {};
        if (r.credentials) _brainState.credentials = r.credentials;
        await loadBrainState();
        renderBrainModelList();
        showToast('B√≥veda cargada. Proveedores: ' + ((r.loaded_providers || []).join(', ') || 'ninguno'));
      } catch (e) {
        showToast('Error B√≥veda: ' + ((e && e.message) || 'vault'), true);
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = old || 'Cargar B√≥veda'; }
      }
    }
    async function clearBrainCredential(providerId) {
      if (!providerId) return;
      try {
        var r = await post('/api/brain/credentials', { provider_id: providerId, api_key: null });
        if (r && r.credentials) {
          _brainState = _brainState || {};
          _brainState.credentials = r.credentials;
        }
        await loadBrainState();
        renderBrainModelList();
        showToast('Clave eliminada: ' + providerId);
      } catch (e) {
        showToast('Error al borrar: ' + ((e && e.message) || providerId), true);
      }
    }
    function openBrainAudit() {
      try { window.open((window._apiBase || '') + '/nervous/brain/audit', '_blank', 'width=980,height=700'); } catch(e) {}
    }
    async function loadVersion() {
      const d = await get('/version');
      if (d && d.ok !== false) setCard('version-card', (d.version || '‚Äî') + ' (' + (d.channel || '') + ')' + (d.git_sha ? ' ' + d.git_sha : ''));
      else setCard('version-card', '‚Äî', true);
    }
    var _lastHealthData = null;
    var _healthDetailExpanded = false;
    var HEALTH_HINTS = {
      api_up: { ok: 'API respondiendo', fail: 'API no responde' },
      memory_writable: { ok: 'Memoria OK', fail: 'Memory DB no escribible ‚Äî revisa MEMORY_DB_PATH / ATLAS_MEMORY_DB_PATH' },
      audit_writable: { ok: 'Audit OK', fail: 'Audit DB no escribible ‚Äî define AUDIT_DB_PATH' },
      scheduler_alive: { ok: 'Scheduler OK', fail: 'Scheduler ca√≠do ‚Äî revisa SCHED_DB_PATH y que el scheduler est√© corriendo' },
      llm_reachable: { ok: 'LLM OK', fail: 'Ollama no alcanzable ‚Äî inicia Ollama o configura OLLAMA_BASE_URL' },
      avg_latency_ms: { ok: 'Latencia OK', fail: 'Latencia alta (>2s)' },
      error_rate: { ok: 'Error rate OK', fail: 'Tasa de error alta (>10%)' },
      ans_open_incidents: { ok: 'Sin incidentes', fail: 'Incidentes ANS abiertos ‚Äî ANS debe ejecutar heals para cerrarlos' }
    };
    function toggleHealthDetail() {
      _healthDetailExpanded = !_healthDetailExpanded;
      renderHealthDetail();
    }
    function renderHealthDetail() {
      const el = document.getElementById('health-checks-detail');
      if (!el) return;
      if (!_lastHealthData || !_lastHealthData.checks) {
        el.textContent = _healthDetailExpanded ? 'Sin datos ‚Äî actualiza' : 'Clic para ver desglose';
        return;
      }
      const c = _lastHealthData.checks;
      if (!_healthDetailExpanded) {
        const fails = ['api_up','memory_writable','audit_writable','scheduler_alive','llm_reachable'].filter(k => c[k] === false);
        const inc = c.ans_open_incidents || 0;
        if (inc > 0) fails.push(inc + ' incidente(s)');
        el.innerHTML = fails.length ? '<span style="color:var(--red);">' + fails.length + ' fallo(s) ‚Äî Clic para ver</span>' : '<span style="color:var(--green);">OK ‚Äî Clic para desglose</span>';
        return;
      }
      var lines = [];
      ['api_up','memory_writable','audit_writable','scheduler_alive','llm_reachable','avg_latency_ms','error_rate'].forEach(function(k) {
        var v = c[k];
        var hint = HEALTH_HINTS[k] || {};
        var ok = v === true || (k === 'avg_latency_ms' && (v == null || (typeof v === 'number' && v <= 2000))) || (k === 'error_rate' && (v == null || v === false || (typeof v === 'number' && v <= 0.1) || (typeof v === 'string' && parseFloat(v) <= 0.1)));
        var msg = ok ? (hint.ok || 'OK') : (hint.fail || (k + ': ' + v));
        lines.push('<span class="badge ' + (ok ? 'ok' : 'err') + '" style="margin-right:.35rem;">' + (ok ? '‚úì' : '‚úó') + '</span>' + k + ': ' + msg);
      });
      if (c.ans_open_incidents > 0) {
        lines.push('<span class="badge err" style="margin-right:.35rem;">!</span>ans_open_incidents: ' + c.ans_open_incidents + ' (penaliza -' + Math.min(10, c.ans_open_incidents * 1) + ')');
      }
      lines.push('<span style="color:var(--muted);">latencia: ' + (c.avg_latency_ms != null ? c.avg_latency_ms + ' ms' : '‚Äî') + ' ¬∑ error_rate: ' + (c.error_rate != null ? (c.error_rate * 100).toFixed(2) + '%' : '‚Äî') + '</span>');
      el.innerHTML = lines.join('<br>');
    }
    async function loadHealth() {
      const d = await get('/health');
      _lastHealthData = d;
      const card = document.getElementById('health-card');
      const val = card ? card.querySelector('.value') : null;
      const bar = document.getElementById('health-bar-fill');
      const detailEl = document.getElementById('health-checks-detail');
      if (!d) {
        if (val) val.textContent = '‚Äî';
        if (bar) bar.style.width = '0%';
        if (card) card.classList.add('error');
        if (detailEl) detailEl.textContent = 'Error al cargar';
        return;
      }
      const score = d.score != null ? d.score : 0;
      if (val) val.textContent = score + '/100';
      if (bar) {
        bar.style.width = score + '%';
        bar.style.background = score >= 80 ? 'var(--green)' : score >= 50 ? 'var(--amber)' : 'var(--red)';
      }
      card.classList.remove('error');
      if (d.ok === false) card.classList.add('error');
      renderHealthDetail();
    }
    async function loadMetrics() {
      const d = await get('/metrics');
      const detail = document.getElementById('metrics-detail');
      if (d && d.data) {
        const c = d.data.counters || {};
        const l = d.data.latencies || {};
        const keys = Object.keys(c);
        const top = keys.slice(0, 6).map(k => k + ': ' + c[k]).join(' ¬∑ ');
        setCard('metrics-card', (keys.length ? (UI_STRINGS['metrics.counters'] || 'Contadores') + ': ' + keys.length : '‚Äî') + (Object.keys(l).length ? ' ¬∑ ' + (UI_STRINGS['metrics.latencies'] || 'Latencias') + ': ' + Object.keys(l).length : ''));
        if (detail && top) detail.innerHTML = '<span>' + top + '</span>';
        else if (detail) detail.innerHTML = '';
      } else {
        setCard('metrics-card', '‚Äî');
        if (detail) detail.innerHTML = '';
      }
    }
    async function loadScheduler() {
      const d = await get('/scheduler/jobs');
      const jobs = (d && d.data) ? (Array.isArray(d.data) ? d.data : []) : [];
      const card = document.getElementById('scheduler-card');
      if (card) {
        const val = card.querySelector('.value');
        if (val) val.textContent = jobs.length + ' ' + (UI_STRINGS['jobs.suffix'] || 'trabajo(s)');
      }
    }
    async function loadUpdate() {
      const d = await get('/update/status');
      if (d && d.data) {
        const has = d.data.has_update;
        const branch = d.data.branch || '‚Äî';
        setCard('update-card', branch + ' ¬∑ ' + (UI_STRINGS['update.has'] || 'actualizaci√≥n') + ': ' + (has ? (UI_STRINGS['update.yes'] || 'S√≠') : (UI_STRINGS['update.no'] || 'No')));
      } else setCard('update-card', '‚Äî');
    }
    async function loadDeploy() {
      const d = await get('/deploy/status');
      if (d && d.data) {
        const x = d.data;
        const mode = x.mode || 'single';
        const port = x.active_port != null ? x.active_port : '‚Äî';
        const score = (x.last_health && x.last_health.score != null) ? x.last_health.score : (x.health_score != null ? x.health_score : '‚Äî');
        const canary = x.canary && x.canary.enabled ? 'Canary ON' : 'Canary OFF';
        setCard('deploy-card', (UI_STRINGS['deploy.mode'] || 'modo: {mode} ¬∑ puerto: {port} ¬∑ salud: {score} ¬∑ {canary}').replace('{mode}', mode).replace('{port}', port).replace('{score}', score).replace('{canary}', canary));
      } else setCard('deploy-card', '‚Äî');
    }
    async function loadCluster() {
      const st = await get('/cluster/status');
      const card = document.getElementById('cluster-card');
      if (st && st.data) {
        const en = st.data.enabled;
        const nodeId = st.data.node_id || '‚Äî';
        const role = st.data.role || '‚Äî';
        const count = (st.data.nodes && st.data.nodes.length) || 0;
        if (card) {
          const val = card.querySelector('.value');
          if (val) val.textContent = en ? (nodeId + ' ¬∑ ' + role + ' ¬∑ ' + count + ' ' + (UI_STRINGS['cluster.node_count'] || '{n} nodo(s)').replace('{n}', count)) : (UI_STRINGS['gateway.disabled'] || 'Desactivado');
        }
        document.getElementById('cluster-section').style.display = en ? 'block' : 'none';
        if (en) {
          const nodesEl = document.getElementById('cluster-nodes-list');
          const nodes = st.data.nodes || [];
          nodesEl.innerHTML = nodes.length ? nodes.map((n, i) => '<div style="margin:.35rem 0; padding:.35rem; background:var(--bg-elevated); border-radius:6px;">' + n.node_id + ' ¬∑ ' + (n.status || '‚Äî') + ' ¬∑ score ' + (n.health_score != null ? n.health_score : '‚Äî') + ' ¬∑ ' + (n.base_url || '') + ' <button class="small" data-base-url="' + (n.base_url || '').replace(/"/g, '&quot;') + '" onclick="clusterPingNode(this)">' + (UI_STRINGS['cluster.ping'] || 'Ping') + '</button></div>').join('') : '<span class="muted">' + (UI_STRINGS['cluster.no_nodes'] || 'Sin nodos') + '</span>';
          const ev = await get('/cluster/events?limit=20');
          const eventsEl = document.getElementById('cluster-events-list');
          const events = (ev && ev.data && Array.isArray(ev.data)) ? ev.data : [];
          eventsEl.innerHTML = events.length ? events.slice(0, 15).map(e => e.ts + ' ' + e.node_id + ' ' + e.kind).join('\n') : '‚Äî';
        }
      } else {
        if (card) { const val = card.querySelector('.value'); if (val) val.textContent = '‚Äî'; }
      }
    }
    function clusterPing() {
      get('/cluster/ping').then(d => alert(d && d.data && d.data.pong ? 'Pong OK' : 'No pong'));
    }
    function clusterPingNode(btnOrUrl) {
      const baseUrl = typeof btnOrUrl === 'string' ? btnOrUrl : (btnOrUrl && btnOrUrl.getAttribute ? btnOrUrl.getAttribute('data-base-url') : null);
      if (!baseUrl) return;
      fetch(baseUrl.replace(/\/$/, '') + '/cluster/ping', { cache: 'no-store' }).then(r => r.json()).then(d => alert(d && d.data && d.data.pong ? 'Pong OK' : 'Error')).catch(() => alert('Error de red'));
    }
    function setClusterRoute() {
      const sel = document.getElementById('cluster-route-pref');
      if (sel) localStorage.setItem('atlas_cluster_route', sel.value);
    }
    async function runClusterTestJob() {
      const r = await post('/cluster/route/decision', { task: 'hands', prefer_remote: true });
      if (r && r.data) alert('Ruta: ' + (r.data.route || '‚Äî') + (r.data.node_id ? ' ¬∑ nodo ' + r.data.node_id : ''));
      else alert('Error: ' + (r && r.error ? r.error : 'sin respuesta'));
    }
    async function loadGateway() {
      const st = await get('/gateway/status');
      const card = document.getElementById('gateway-card');
      if (st && st.data) {
        const d = st.data;
        if (card) { const val = card.querySelector('.value'); if (val) val.textContent = d.enabled ? (d.mode + ' ¬∑ ' + (d.last_success_mode || '‚Äî')) : (UI_STRINGS['gateway.disabled'] || 'Desactivado'); }
        document.getElementById('gateway-section').style.display = d.enabled ? 'block' : 'none';
        const sel = document.getElementById('gateway-mode'); if (sel) sel.value = d.mode || 'auto';
        const tools = document.getElementById('gateway-tools');
        tools.innerHTML = 'cloudflared: ' + (d.tools && d.tools.cloudflared ? 'OK' : '‚Äî') + ' ¬∑ tailscale: ' + (d.tools && d.tools.tailscale ? 'OK' : '‚Äî') + ' ¬∑ ssh: ' + (d.tools && d.tools.ssh ? 'OK' : '‚Äî');
        const last = document.getElementById('gateway-last-success');
        last.textContent = d.last_success_ts ? ((UI_STRINGS['gateway.last_success'] || '√öltimo √©xito') + ': ' + d.last_success_ts + ' ¬∑ ' + (d.last_success_mode || '') + ' ¬∑ ' + (d.last_success_target || '')) : (UI_STRINGS['gateway.no_success'] || 'Sin √∫ltimo √©xito');
        const rec = document.getElementById('gateway-recommendations');
        rec.textContent = (d.recommendations && d.recommendations.length) ? d.recommendations.join('; ') : '';
      } else { if (card) { const val = card.querySelector('.value'); if (val) val.textContent = '‚Äî'; } }
    }
    async function gatewayCheck() {
      const msg = document.getElementById('gateway-status-msg'); if (msg) msg.textContent = UI_STRINGS['gateway.checking'] || 'Comprobando‚Ä¶';
      const r = await post('/gateway/check');
      if (msg) msg.textContent = r && r.ok ? 'Check OK' : (r && r.error ? r.error : 'Error');
      loadGateway();
    }
    async function gatewayBootstrap() {
      const msg = document.getElementById('gateway-status-msg'); if (msg) msg.textContent = 'Bootstrap‚Ä¶';
      const r = await post('/gateway/bootstrap');
      if (msg) msg.textContent = r && r.ok ? 'Bootstrap OK' : (r && r.error ? r.error : 'Error');
      loadGateway();
    }
    async function gatewaySetMode() {
      const sel = document.getElementById('gateway-mode'); if (!sel) return;
      const r = await post('/gateway/mode', { mode: sel.value });
      if (r && r.ok) loadGateway(); else alert(r && r.error ? r.error : 'Error');
    }
    async function loadApprovals() {
      const d = await get('/approvals/list');
      const list = document.getElementById('approvals-list');
      const items = (d && d.data && Array.isArray(d.data)) ? d.data : [];
      function approvalExplain(a) {
        const action = (a && a.action) ? String(a.action) : '';
        const payload = (a && a.payload) ? a.payload : {};
        if (action === 'ga_refactor_plan') {
          const f = payload.finding || {};
          const path = (f.path || '').toString();
          const detail = (f.detail || '').toString();
          return {
            title: 'Mantenimiento del proyecto (plan)',
            desc: (path ? ('Se detect√≥ un archivo grande: ' + path + (detail ? (' (' + detail + ')') : '') + '.') : 'Plan de mantenimiento del repositorio.'),
          };
        }
        if (action === 'architect_apply') {
          const goal = (payload.goal || '').toString();
          return {
            title: 'Crear/editar app (ATLAS_ARCHITECT)',
            desc: goal ? ('Acci√≥n propuesta: ' + goal + '.') : 'Acci√≥n propuesta por ATLAS_ARCHITECT.',
          };
        }
        if (action === 'update_apply' || action === 'deploy_apply') {
          return { title: 'Actualizar / desplegar', desc: 'Se solicita permiso para aplicar una actualizaci√≥n.' };
        }
        return { title: 'Aprobaci√≥n requerida', desc: action ? ('Operaci√≥n: ' + action) : 'Operaci√≥n pendiente.' };
      }
      function isExpired(a) {
        if (a && a.expired === true) return true;
        const ex = a && a.expires_at ? Date.parse(String(a.expires_at)) : NaN;
        return !Number.isNaN(ex) && ex <= Date.now();
      }
      function esc(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
      // Si no hay pendientes, mostrar explicaci√≥n humana + mini-historial
      if (!items.length) {
        try {
          const h1 = await get('/approvals/list?status=approved&limit=3');
          const h2 = await get('/approvals/list?status=rejected&limit=3');
          const approved = (h1 && h1.data && Array.isArray(h1.data)) ? h1.data : [];
          const rejected = (h2 && h2.data && Array.isArray(h2.data)) ? h2.data : [];
          const last = approved.concat(rejected).slice(0, 6);
          const rows = last.map(function(a) {
            const act = (a.action || '').toString();
            const st = (a.status || '').toString();
            const when = (a.created_ts || '').toString().slice(0, 19).replace('T', ' ');
            return '<div style="margin:.25rem 0; font-size:.75rem; color:var(--muted);">' +
              '<span style="color:var(--text);">' + esc(act || 'evento') + '</span>' +
              ' ¬∑ ' + esc(st || '‚Äî') +
              (when ? (' ¬∑ ' + esc(when)) : '') +
              '</div>';
          }).join('');
          list.innerHTML = '<li><div style="color:var(--muted);">No hay aprobaciones pendientes.</div>' +
            '<div class="row" style="margin-top:.35rem;gap:.35rem;">' +
            '<button class="small secondary" onclick="scrollToSection(\'owner-console-section\')">Abrir Owner Console</button>' +
            '<button class="small secondary" onclick="ccSelectTab(\'architect\')">Ir a Architect</button>' +
            '</div>' +
            (rows ? ('<div style="margin-top:.35rem;"><strong style="font-size:.7rem;color:var(--muted);">√öltimos eventos</strong>' + rows + '</div>') : '') +
            '</li>';
        } catch (e) {
          list.innerHTML = '<li><div style="color:var(--muted);">No hay aprobaciones pendientes.</div></li>';
        }
        loadEvolutionPending();
        return;
      }

      list.innerHTML = items.length
        ? items.map(function(a) {
            const info = approvalExplain(a);
            const expired = isExpired(a);
            const id = esc(a.id);
            const badge = expired ? '<span class="badge warn" style="margin-left:.35rem;">Expirada</span>' : '';
            const btnApprove = expired ? '' : (' <button class="small" onclick="approve(\'' + id + '\')">Aprobar</button>');
            const btnReject = ' <button class="small danger" onclick="reject(\'' + id + '\')">Rechazar</button>';
            const btnView = ' <button class="small secondary" onclick="viewApproval(\'' + id + '\')">Ver</button>';
            return '<li style="margin-bottom:.5rem;">' +
              '<div><strong>' + esc(info.title) + '</strong>' + badge + '</div>' +
              '<div style="font-size:.75rem;color:var(--muted);margin:.15rem 0 .25rem;">' + esc(info.desc) + '</div>' +
              '<div style="font-size:.7rem;color:var(--muted);">ID: ' + id + '</div>' +
              '<div class="row" style="margin-top:.25rem;gap:.35rem;">' + btnView + btnApprove + btnReject + '</div>' +
              '</li>';
          }).join('')
        : '<li>' + (UI_STRINGS['approvals.none'] || 'Ninguno') + '</li>';
      loadEvolutionPending();
    }
    async function loadEvolutionPending() {
      const el = document.getElementById('evolution-pending');
      if (!el) return;
      try {
        const r = await get('/api/evolution/status');
        const pending = (r && r.pending && Array.isArray(r.pending)) ? r.pending : [];
        const lastReport = (r && r.last_report) ? r.last_report : {};
        if (pending.length) {
          el.innerHTML = '<strong>Evolution (GOVERNED)</strong>: ' + pending.map(function(p) {
            const pkg = (p.package || '').replace(/'/g, '&#39;');
            const ver = (p.new_version || '').replace(/'/g, '&#39;');
            return pkg + ' ‚Üí ' + ver + ' <button class="small ok" onclick="evolutionApprove(\'' + pkg + '\', \'' + ver + '\')">Aprobar Asimilaci√≥n</button>';
          }).join('<br/>');
          el.style.color = 'var(--orange)';
        } else {
          el.innerHTML = lastReport.message ? '<span style="color:var(--muted);">Evolution: ' + (lastReport.message || '').substring(0, 60) + '</span>' : '';
          el.style.color = '';
        }
      } catch (e) {
        el.innerHTML = '';
      }
    }
    async function evolutionApprove(packageName, newVersion) {
      const r = await post('/api/evolution/approve', { package: packageName, new_version: newVersion });
      if (r && r.ok) {
        loadEvolutionPending();
        loadBitacora();
      } else {
        alert(r && r.error ? r.error : 'Error al aprobar');
      }
    }
    async function updateCheck() {
      await post('/update/check');
      loadUpdate();
    }
    async function approve(id) {
      const r = await post('/approvals/approve', { id: id, session_token: ownerSessionToken });
      const msgEl = document.getElementById('owner-session-msg');
      if (r && !r.ok) {
        if (r.status === 'owner_session_required') {
          if (msgEl) { msgEl.textContent = 'Sesi√≥n requerida. Inicia sesi√≥n en Owner Console (Rostro o Contrase√±a Windows) y vuelve a aprobar.'; msgEl.style.color = 'var(--amber)'; }
          alert('Para aprobar esto necesitas sesi√≥n Owner. Ve a Owner Console y autent√≠cate.');
        } else if (r.status === 'expired') {
          alert('Esta aprobaci√≥n est√° expirada. Rech√°zala y vuelve a generar el plan (Actualizar).');
        } else {
          alert('No se pudo aprobar: ' + (r.error || r.status || 'error'));
        }
      }
      loadApprovals();
      loadOwnerStatus();
    }
    async function reject(id) {
      const r = await post('/approvals/reject', { id: id });
      if (r && !r.ok) alert('No se pudo rechazar: ' + (r.error || r.status || 'error'));
      loadApprovals();
    }

    async function viewApproval(id) {
      try {
        const d = await get('/approvals/list?status=pending&limit=100');
        const items = (d && d.data && Array.isArray(d.data)) ? d.data : [];
        const it = items.find(x => x && x.id === id);
        const title = 'Detalle de aprobaci√≥n';
        const body = document.getElementById('expand-modal-body');
        const titleEl = document.getElementById('expand-modal-title');
        const modal = document.getElementById('expand-modal');
        if (!body || !titleEl || !modal) return;
        body.innerHTML = '';
        titleEl.textContent = title;
        const pre = document.createElement('pre');
        pre.className = 'cc-terminal-mini';
        pre.style.whiteSpace = 'pre-wrap';
        pre.textContent = JSON.stringify(it || { id: id, error: 'no encontrado' }, null, 2);
        const hint = document.createElement('div');
        hint.className = 'value';
        hint.style.fontSize = '.8rem';
        hint.style.color = 'var(--muted)';
        hint.style.marginBottom = '.5rem';
        hint.textContent = 'Resumen: esto es una solicitud de permiso. Si est√° expirada, rech√°zala y regenera el plan.';
        body.appendChild(hint);
        body.appendChild(pre);
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
      } catch (e) {
        alert('Error al cargar detalle: ' + (e.message || e));
      }
    }
    let ownerFaceStream = null;
    async function ownerStartWithFace() {
      const panel = document.getElementById('owner-face-login');
      const video = document.getElementById('owner-face-video');
      if (panel.style.display === 'block') return;
      panel.style.display = 'block';
      try {
        ownerFaceStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 240, height: 180 } });
        if (video) video.srcObject = ownerFaceStream;
      } catch (e) {
        document.getElementById('owner-session-msg').textContent = 'C√°mara no disponible: ' + (e.message || e);
        document.getElementById('owner-session-msg').style.color = 'var(--red)';
        panel.style.display = 'none';
      }
    }
    function hideOwnerFaceLogin() {
      const panel = document.getElementById('owner-face-login');
      const video = document.getElementById('owner-face-video');
      if (ownerFaceStream) { ownerFaceStream.getTracks().forEach(t => t.stop()); ownerFaceStream = null; }
      if (video) video.srcObject = null;
      panel.style.display = 'none';
    }
    async function ownerCaptureAndLogin() {
      const video = document.getElementById('owner-face-video');
      const msg = document.getElementById('owner-session-msg');
      if (!video || video.readyState < 2) { msg.textContent = 'Espera a que cargue el video.'; msg.style.color = 'var(--amber)'; return; }
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const base64 = canvas.toDataURL('image/png').split(',')[1];
      msg.textContent = 'Verificando‚Ä¶'; msg.style.color = 'var(--muted)';
      const r = await post('/owner/session/start-with-face', { image_base64: base64 });
      hideOwnerFaceLogin();
      if (r && r.ok && r.session_token) {
        ownerSessionToken = r.session_token;
        msg.textContent = 'Sesi√≥n activa (TTL ' + (r.ttl_seconds || 900) + 's)';
        msg.style.color = 'var(--green)';
        loadOwnerStatus();
      } else {
        ownerSessionToken = null;
        msg.textContent = (r && r.error) ? r.error : 'No se detect√≥ rostro. Intenta de nuevo.';
        msg.style.color = 'var(--red)';
      }
    }
    async function showOwnerWindowsLogin() {
      const panel = document.getElementById('owner-windows-login');
      const userEl = document.getElementById('owner-win-user');
      const passEl = document.getElementById('owner-win-pass');
      if (panel.style.display === 'block') return;
      panel.style.display = 'block';
      userEl.value = ''; passEl.value = '';
      const u = await get('/owner/windows-user');
      if (u && u.ok && u.username) userEl.value = u.username;
      if (passEl) passEl.focus();
    }
    function hideOwnerWindowsLogin() {
      document.getElementById('owner-windows-login').style.display = 'none';
    }
    async function ownerLoginWithWindows() {
      const userEl = document.getElementById('owner-win-user');
      const passEl = document.getElementById('owner-win-pass');
      const msg = document.getElementById('owner-session-msg');
      const user = (userEl && userEl.value || '').trim();
      const pass = (passEl && passEl.value || '');
      if (!user || !pass) { msg.textContent = 'Usuario y contrase√±a requeridos'; msg.style.color = 'var(--red)'; return; }
      msg.textContent = 'Verificando‚Ä¶'; msg.style.color = 'var(--muted)';
      const r = await post('/owner/session/start-with-windows', { username: user, password: pass });
      hideOwnerWindowsLogin();
      if (r && r.ok && r.session_token) {
        ownerSessionToken = r.session_token;
        msg.textContent = 'Sesi√≥n activa (TTL ' + (r.ttl_seconds || 900) + 's)';
        msg.style.color = 'var(--green)';
        loadOwnerStatus();
      } else {
        ownerSessionToken = null;
        msg.textContent = (r && r.error) ? r.error : 'Usuario o contrase√±a incorrectos';
        msg.style.color = 'var(--red)';
      }
    }
    async function ownerStartSession() {
      const msg = document.getElementById('owner-session-msg');
      const r = await post('/owner/session/start', { actor: 'owner', method: 'ui' });
      if (r && r.ok && r.session_token) {
        ownerSessionToken = r.session_token;
        msg.textContent = 'Sesi√≥n activa (TTL ' + (r.ttl_seconds || 900) + 's)';
        msg.style.color = 'var(--green)';
        loadOwnerStatus();
      } else {
        ownerSessionToken = null;
        msg.textContent = (r && r.error) ? r.error : 'Error al iniciar sesi√≥n';
        msg.style.color = 'var(--red)';
      }
    }
    async function loadOwnerStatus() {
      const d = await get('/owner/status');
      if (!d || !d.data) return;
      const data = d.data;
      const sessionsEl = document.getElementById('owner-sessions');
      if (sessionsEl) sessionsEl.textContent = (data.active_sessions && data.active_sessions.length) ? data.active_sessions.length + ' sesi√≥n(es) activa(s)' : 'Sin sesiones';
      const pendingEl = document.getElementById('owner-pending-list');
      if (pendingEl) pendingEl.innerHTML = (data.pending_approvals && data.pending_approvals.length) ? data.pending_approvals.map(a => a.id + ' ' + (a.action||'') + ' risk=' + (a.risk||'')).join(' | ') : (UI_STRINGS['approvals.none'] || 'Ninguno');
      const expiredEl = document.getElementById('owner-expired-list');
      if (expiredEl) expiredEl.innerHTML = (data.expired_approvals && data.expired_approvals.length) ? data.expired_approvals.map(a => a.id + ' ' + (a.action||'')).join(' | ') : (UI_STRINGS['approvals.none'] || 'Ninguno');
      const criticalEl = document.getElementById('owner-critical-history');
      if (criticalEl) criticalEl.innerHTML = (data.critical_history && data.critical_history.length) ? data.critical_history.slice(0, 10).map(a => a.id + ' ' + (a.action||'') + ' ' + (a.resolved_by||'')).join(' | ') : (UI_STRINGS['approvals.none'] || 'Ninguno');
      const emergencyBtn = document.getElementById('owner-emergency-btn');
      if (emergencyBtn) emergencyBtn.textContent = (UI_STRINGS['owner.emergency'] || 'Emergency:') + ' ' + (data.emergency ? (UI_STRINGS['owner.emergency_on'] || 'ON') : (UI_STRINGS['owner.emergency_off'] || 'OFF'));
    }
    async function loadNerveStatus() {
      const val = document.getElementById('organs-status');
      const detail = document.getElementById('organs-detail');
      try {
        const d = await get('/api/nerve/status');
        if (!d || d.ok === false) {
          if (val) val.textContent = '‚Äî';
          if (detail) detail.innerHTML = '<span style="color:var(--red);">Error al cargar</span>';
          return;
        }
        const eyes = d.eyes || {};
        const hands = d.hands || {};
        const feet = d.feet || {};
        const eyesOk = !!eyes.nexus_available;
        const handsOk = hands.deps_ok === null ? null : !!hands.deps_ok;
        const feetDriver = (feet.driver || 'none');
        if (val) {
          val.innerHTML =
            'Ojos: <span style="color:' + (eyesOk ? 'var(--green)' : 'var(--amber)') + ';">' + (eyesOk ? 'NEXUS OK' : 'Local') + '</span>' +
            ' ¬∑ Manos: <span style="color:' + (handsOk === null ? 'var(--muted)' : (handsOk ? 'var(--green)' : 'var(--red)')) + ';">' + (handsOk === null ? '‚Äî' : (handsOk ? 'OK' : 'Deps')) + '</span>' +
            ' ¬∑ Pies: <span style="color:' + (feetDriver !== 'none' ? 'var(--green)' : 'var(--muted)') + ';">' + feetDriver.toUpperCase() + '</span>';
        }
        if (detail) {
          const supports = (eyes.nexus_snapshot_supports || []).join(', ');
          const snap = eyes.nexus_snapshot_url || '';
          detail.innerHTML =
            (snap ? ('<span style="color:var(--muted);">snapshot:</span> <span style="color:var(--purple-light);">' + snap + '</span><br>') : '') +
            (supports ? ('<span style="color:var(--muted);">params:</span> ' + supports) : '');
        }
      } catch (e) {
        if (val) val.textContent = '‚Äî';
        if (detail) detail.innerHTML = '<span style="color:var(--red);">Sin conexi√≥n</span>';
      }
    }
    async function ownerToggleEmergency() {
      const d = await get('/owner/status');
      const next = !(d && d.data && d.data.emergency);
      const r = await post('/owner/emergency', { enable: next });
      if (r && r.ok) loadOwnerStatus(); else alert(r && r.error ? r.error : 'Error');
    }
    async function ownerVerifyChain() {
      const r = await get('/approvals/chain/verify');
      if (r && r.valid) alert('Cadena √≠ntegra.'); else alert(r && !r.valid ? 'Cadena rota: ' + (r.first_invalid_id || '') : (r && r.error) || 'Error');
    }
    async function loadGAStatus() {
      const r = await get('/ga/status');
      const card = document.getElementById('ga-card');
      const detail = document.getElementById('ga-detail');
      const lastReport = document.getElementById('ga-last-report');
      const executed = document.getElementById('ga-executed');
      if (!r || !r.ok) {
        if (card) card.querySelector('.value').textContent = r && r.error ? r.error : (UI_STRINGS['ga.not_available'] || 'GA no disponible');
        return;
      }
      const d = r.data || {};
      const rawMode = d.mode || 'plan_only';
      const modeKey = 'ga.mode_' + rawMode.replace(/-/g, '_');
      const modeText = (UI_STRINGS || {})[modeKey] || rawMode;
      const pending = d.approvals_pending_count || 0;
      const reportPath = d.last_report || d.last_report_path;
      const s = UI_STRINGS || {};
      if (card) card.querySelector('.value').textContent = (s['ga.mode'] || 'Modo') + ': ' + modeText + ' | ' + (s['ga.pending'] || 'Pendientes') + ': ' + pending;
      if (detail) detail.innerHTML = '<span>' + (s['ga.last_report'] || '√öltimo reporte') + ': ' + (reportPath ? reportPath.split(/[/\\]/).pop() : '‚Äî') + '</span>';
      if (lastReport) lastReport.textContent = reportPath ? (s['ga.report_label'] || 'Reporte') + ': ' + reportPath : (s['ga.no_reports'] || 'Sin reportes');
      if (executed) executed.textContent = '';
    }
    async function loadANSStatus() {
      const r = await get('/ans/status');
      const enabledEl = document.getElementById('ans-enabled');
      const modeEl = document.getElementById('ans-mode');
      const incidentsEl = document.getElementById('ans-incidents');
      const listEl = document.getElementById('ans-incidents-list');
      const reportLink = document.getElementById('ans-report-link');
      if (!r || !r.ok) {
        if (enabledEl) enabledEl.textContent = r && r.error ? r.error : '‚Äî';
        return;
      }
      if (enabledEl) enabledEl.textContent = r.enabled ? 'ON' : 'OFF';
      if (enabledEl) enabledEl.className = 'badge ' + (r.enabled ? 'ok' : 'warn');
      if (modeEl) modeEl.textContent = r.mode || '‚Äî';
      if (incidentsEl) incidentsEl.textContent = 'Abiertos: ' + (r.incidents_open || 0) + ' | Cerrados: ' + (r.incidents_closed || 0);
      const incR = await get('/ans/incidents?status=open&limit=10');
      if (listEl && incR && incR.data && incR.data.length) {
        listEl.innerHTML = incR.data.map(function(i) { return '<div>' + (i.check_id || '') + ': ' + (i.message || '').slice(0, 60) + '</div>'; }).join('');
      } else if (listEl) listEl.innerHTML = '<span style="color:var(--muted);">Sin incidentes abiertos</span>';
      if (reportLink && r.report_path) { reportLink.href = '#'; reportLink.textContent = 'Reporte: ' + r.report_path.split(/[/\\]/).pop(); }
    }
    async function ansRunNow() {
      const r = await post('/ans/run-now', { mode: 'auto' });
      if (r && r.ok) {
        loadANSStatus();
        loadBitacora();
        loadHealth();
        alert('ANS Run Now: ' + (r.issues_count ?? 0) + ' issues, ' + (r.actions_taken && r.actions_taken.length ? r.actions_taken.length : 0) + ' actions');
      } else {
        alert('ANS Run Now: ' + (r && r.error ? r.error : 'Error'));
      }
    }
    async function ansResolveIncidents() {
      const r = await post('/ans/resolve-incidents', {});
      if (r && r.ok) {
        loadANSStatus();
        loadHealth();
        if (r.resolved !== undefined) alert('Resueltos ' + r.resolved + ' incidente(s).');
      } else {
        alert('Resolver incidentes: ' + (r && r.error ? r.error : 'Error'));
      }
    }
    async function loadProductStatus() {
      const r = await get('/product/status');
      if (!r || !r.data) return;
      const d = r.data;
      const vEl = document.getElementById('product-version');
      const eEl = document.getElementById('product-edition');
      const lEl = document.getElementById('product-license');
      const detailEl = document.getElementById('product-detail');
      if (vEl) vEl.textContent = 'v' + (d.version || '‚Äî');
      if (eEl) { eEl.textContent = d.edition || 'community'; eEl.className = 'badge ' + (d.edition === 'enterprise' ? 'ok' : ''); }
      if (lEl) { lEl.textContent = (d.license && d.license.status) || '‚Äî'; lEl.className = 'badge ' + ((d.license && d.license.status === 'valid') ? 'ok' : 'warn'); }
      if (detailEl) detailEl.innerHTML = 'Health: ' + (d.health_score || 0) + ' | Port: ' + (d.active_port || '‚Äî') + ' | Cluster: ' + (d.cluster_nodes || 0) + ' nodes | Gateway: ' + (d.gateway_state || '‚Äî') + (d.support_contact ? ' | Contact: ' + d.support_contact : '');
    }
    async function downloadSupportBundle() {
      const r = await get('/support/bundle');
      if (r && r.data && r.data.path) {
        const msg = document.getElementById('product-detail');
        if (msg) msg.innerHTML = (msg.innerHTML || '') + ' <br>Bundle: ' + r.data.path;
      }
    }
    async function gaRunNow() {
      const msg = document.getElementById('ga-status-msg');
      if (msg) msg.textContent = 'Ejecutando‚Ä¶';
      const r = await post('/ga/run', { scope: 'all', mode: 'plan_only', max_findings: 10 });
      if (msg) msg.textContent = r && r.ok ? 'OK (' + (r.ms || 0) + 'ms)' : (r && r.error ? r.error : 'Error');
      loadGAStatus();
      loadApprovals();
    }
    async function refreshAll() {
      if (_refreshInFlight) return;
      _refreshInFlight = true;
      const btn = document.getElementById('btn-refresh');
      const lastEl = document.getElementById('last-update');
      if (btn) { btn.disabled = true; btn.textContent = UI_STRINGS['app.updating'] || 'Actualizando‚Ä¶'; }
      if (lastEl) { lastEl.textContent = UI_STRINGS['app.updating'] || 'Actualizando‚Ä¶'; lastEl.style.color = 'var(--purple-light)'; lastEl.classList.add('updating'); }
      try {
        await Promise.allSettled([
          loadStatus(),
          loadBrainState(),
          loadNerveStatus(),
          loadCamerasStatus(),
          loadVersion(),
          loadHealth(),
          loadMetrics(),
          loadScheduler(),
          updateCheck(),
          loadDeploy(),
          loadCluster(),
          loadGateway(),
          loadApprovals(),
          loadANSStatus(),
          loadBitacora(),
          loadScannerStatus(),
          loadOwnerStatus(),
          loadGAStatus(),
          loadProductStatus(),
          loadGovernanceStatus(),
          ccRefreshComms()
        ]);
        setLastUpdate();
      } catch (e) {
        if (lastEl) lastEl.textContent = (UI_STRINGS['robot.error'] || 'Error') + ' al actualizar';
      }
      if (lastEl) { lastEl.classList.remove('updating'); lastEl.style.color = ''; }
      if (btn) { btn.disabled = false; btn.textContent = UI_STRINGS['app.refresh'] || 'Actualizar'; }
      _refreshInFlight = false;
    }
    async function loadGovernanceStatus() {
      const logEl = document.getElementById('governance-log');
      const statusEl = document.getElementById('gov-status');
      const growthBtn = document.getElementById('gov-growth');
      const governedBtn = document.getElementById('gov-governed');
      const emergBtn = document.getElementById('gov-emergency');
      const logLink = document.getElementById('governance-log-link');
      const msgEl = document.getElementById('gov-msg');
      let st = null;
      try {
        st = await get('/governance/status');
      } catch (e) {
        if (msgEl) msgEl.textContent = 'Sin conexi√≥n';
      }
      if (st && st.ok) {
        const mode = st.mode || 'governed';
        const emergency = st.emergency_stop || false;
        if (statusEl) {
          statusEl.textContent = (emergency ? 'EMERGENCY ' : '') + mode.toUpperCase();
          statusEl.className = 'badge ' + (emergency ? 'err' : (mode === 'growth' ? 'ok' : 'warn'));
        }
        if (growthBtn) growthBtn.style.opacity = mode === 'growth' ? '1' : '0.6';
        if (governedBtn) governedBtn.style.opacity = mode === 'governed' ? '1' : '0.6';
        if (emergBtn) emergBtn.textContent = emergency ? (UI_STRINGS['gov.emergency_on'] || 'EMERGENCY STOP ON') : (UI_STRINGS['gov.emergency'] || 'EMERGENCY STOP');
        if (msgEl) msgEl.textContent = st.fallback ? 'Modo por defecto (sin DB)' : '';
      } else {
        if (statusEl) {
          statusEl.textContent = 'GOVERNED';
          statusEl.className = 'badge warn';
        }
        if (growthBtn) growthBtn.style.opacity = '0.6';
        if (governedBtn) governedBtn.style.opacity = '1';
        if (emergBtn) emergBtn.textContent = UI_STRINGS['gov.emergency'] || 'EMERGENCY STOP';
        if (msgEl) msgEl.textContent = (st && st.error) ? String(st.error).slice(0, 50) : (st ? 'Sin respuesta' : 'Sin conexi√≥n con la API');
      }
      if (logLink) logLink.href = base + '/governance/log?limit=20';
      try {
        const logData = await get('/governance/log?limit=10');
        if (logData && logData.log && logEl) {
          logEl.innerHTML = logData.log.map(x => x.action + ': ' + (x.from_val || '') + ' ‚Üí ' + (x.to_val || '') + (x.reason ? ' (' + x.reason.substring(0,40) + ')' : '')).join('<br>') || '‚Äî';
        }
      } catch (e) {}
    }
    async function govSetMode(mode) {
      const msgEl = document.getElementById('gov-msg');
      const statusEl = document.getElementById('gov-status');
      const growthBtn = document.getElementById('gov-growth');
      const governedBtn = document.getElementById('gov-governed');
      const emergBtn = document.getElementById('gov-emergency');
      var prevMode = (statusEl && statusEl.textContent) ? String(statusEl.textContent).replace(/^EMERGENCY\s+/i, '').trim().toLowerCase() : 'growth';
      if (prevMode !== 'growth' && prevMode !== 'governed') prevMode = 'growth';
      if (msgEl) msgEl.textContent = '';
      applyGovernanceUI(mode, false);
      if (msgEl) msgEl.textContent = 'Cambiando‚Ä¶';
      let r = null;
      try {
        r = await post('/governance/mode', { mode: mode });
      } catch (e) {
        applyGovernanceUI(prevMode || 'growth', false);
        if (msgEl) msgEl.textContent = 'Sin conexi√≥n';
        setTimeout(loadGovernanceStatus, 2000);
        return;
      }
      if (r && (r.ok || r.mode)) {
        if (msgEl) msgEl.textContent = '';
        applyGovernanceUI(r.mode || mode, r.emergency_stop);
        if (!r.ok) setTimeout(loadGovernanceStatus, 1500);
      } else {
        applyGovernanceUI(prevMode || 'growth', false);
        const err = r && (r.error || r.status);
        if (msgEl) msgEl.textContent = (err && (err + '').includes('owner_session')) ? (UI_STRINGS['gov.owner_required'] || 'Inicia sesi√≥n owner para cambiar modo') : (err ? String(err).slice(0, 40) : 'No se pudo cambiar');
        setTimeout(loadGovernanceStatus, 2000);
      }
    }
    function applyGovernanceUI(mode, emergency) {
      var m = (mode || 'governed').toString().toLowerCase();
      var statusEl = document.getElementById('gov-status');
      var growthBtn = document.getElementById('gov-growth');
      var governedBtn = document.getElementById('gov-governed');
      var emergBtn = document.getElementById('gov-emergency');
      if (statusEl) {
        statusEl.textContent = (emergency ? 'EMERGENCY ' : '') + m.toUpperCase();
        statusEl.className = 'badge ' + (emergency ? 'err' : (m === 'growth' ? 'ok' : 'warn'));
      }
      if (growthBtn) growthBtn.style.opacity = m === 'growth' ? '1' : '0.6';
      if (governedBtn) governedBtn.style.opacity = m === 'governed' ? '1' : '0.6';
      if (emergBtn) emergBtn.textContent = emergency ? (UI_STRINGS['gov.emergency_on'] || 'EMERGENCY STOP ON') : (UI_STRINGS['gov.emergency'] || 'EMERGENCY STOP');
    }
    let govEmergencyConfirm = false;
    async function govEmergencyStop() {
      const msgEl = document.getElementById('gov-msg');
      const st = await get('/governance/status');
      const cur = st && st.emergency_stop;
      if (!govEmergencyConfirm && !cur) {
        govEmergencyConfirm = true;
        if (msgEl) msgEl.textContent = UI_STRINGS['gov.confirm'] || 'Confirma: pulsa de nuevo para Emergency Stop';
        setTimeout(() => { govEmergencyConfirm = false; }, 3000);
        return;
      }
      govEmergencyConfirm = false;
      if (msgEl) msgEl.textContent = 'Procesando‚Ä¶';
      const r = await post('/governance/emergency', { enable: !cur });
      if (r && r.ok) {
        if (msgEl) msgEl.textContent = 'Emergency: ' + (r.emergency_stop ? 'ON' : 'OFF');
        loadGovernanceStatus();
      } else {
        const err = r && (r.error || r.status);
        if (msgEl) msgEl.textContent = (err && (err + '').includes('owner_session')) ? (UI_STRINGS['gov.emergency_owner'] || 'Inicia sesi√≥n owner para Emergency Stop') : (err || 'Error');
      }
    }
    function expandPanel(sectionId, title, selector) {
      const body = document.getElementById('expand-modal-body');
      const titleEl = document.getElementById('expand-modal-title');
      const modal = document.getElementById('expand-modal');
      if (!body || !titleEl || !modal) return;
      modal.classList.remove('expand-modal--atlas');
      const selectors = (selector || '').split(',').map(s => s.trim()).filter(Boolean);
      body.innerHTML = '';
      if (!selectors.length) {
        const section = document.getElementById(sectionId);
        if (section) {
          const card = section.querySelector('.card');
          const clone = card ? card.cloneNode(true) : section.cloneNode(true);
          clone.querySelectorAll('.btn-expand').forEach(el => el.remove());
          body.appendChild(clone);
        }
      } else {
        selectors.forEach(function(sel) {
          const el = document.querySelector(sel);
          if (el) {
            const wrap = document.createElement('div');
            wrap.style.marginBottom = '1rem';
            const c = el.cloneNode(true);
            if (el.id === 'live-console-output') {
              c.classList.add('pre-expand');
              c.style.minHeight = '60vh';
              c.style.fontSize = '0.85rem';
            } else if (el.id === 'scanner-expand-content') {
              c.querySelectorAll('pre, [id*="scanner"]').forEach(function(child) {
                child.style.maxHeight = '55vh';
                child.style.overflowY = 'auto';
              });
            } else {
              c.style.maxHeight = '60vh';
              c.style.overflowY = 'auto';
            }
            wrap.appendChild(c);
            body.appendChild(wrap);
          }
        });
      }
      titleEl.textContent = title || 'Ampliar';
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    }
    var atlasExpandCardOriginalParent = null;
    var atlasExpandCardOriginalNext = null;
    var camerasExpandCardOriginalParent = null;
    var camerasExpandCardOriginalNext = null;
    function expandCamerasPanel() {
      const modal = document.getElementById('expand-modal');
      const body = document.getElementById('expand-modal-body');
      const titleEl = document.getElementById('expand-modal-title');
      const card = document.getElementById('cameras-card');
      if (!modal || !body || !titleEl || !card) return;
      body.innerHTML = '';
      titleEl.textContent = 'C√°maras (Cuerpo)';
      modal.classList.remove('expand-modal--atlas');
      modal.classList.add('expand-modal--cameras');
      camerasExpandCardOriginalParent = card.parentNode;
      camerasExpandCardOriginalNext = card.nextElementSibling;
      body.appendChild(card);
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    }
    function expandAtlasPanel() {
      const modal = document.getElementById('expand-modal');
      const body = document.getElementById('expand-modal-body');
      const titleEl = document.getElementById('expand-modal-title');
      const card = document.getElementById('atlas-interact-card');
      if (!modal || !body || !titleEl || !card) return;
      body.innerHTML = '';
      titleEl.textContent = UI_STRINGS['robot.title'] || 'Interactuar con ATLAS';
      modal.classList.remove('expand-modal--cameras');
      modal.classList.add('expand-modal--atlas');
      atlasExpandCardOriginalParent = card.parentNode;
      atlasExpandCardOriginalNext = card.nextElementSibling;
      body.appendChild(card);
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    }
    function closeExpandModal() {
      const modal = document.getElementById('expand-modal');
      if (!modal) return;
      const body = document.getElementById('expand-modal-body');
      const atlasCard = document.getElementById('atlas-interact-card');
      const camerasCard = document.getElementById('cameras-card');
      if (atlasCard && body && body.contains(atlasCard) && atlasExpandCardOriginalParent) {
        if (atlasExpandCardOriginalNext) atlasExpandCardOriginalParent.insertBefore(atlasCard, atlasExpandCardOriginalNext);
        else atlasExpandCardOriginalParent.appendChild(atlasCard);
        atlasExpandCardOriginalParent = null;
        atlasExpandCardOriginalNext = null;
      }
      if (camerasCard && body && body.contains(camerasCard) && camerasExpandCardOriginalParent) {
        if (camerasExpandCardOriginalNext) camerasExpandCardOriginalParent.insertBefore(camerasCard, camerasExpandCardOriginalNext);
        else camerasExpandCardOriginalParent.appendChild(camerasCard);
        camerasExpandCardOriginalParent = null;
        camerasExpandCardOriginalNext = null;
      }
      body.innerHTML = '';
      modal.classList.remove('expand-modal--atlas');
      modal.classList.remove('expand-modal--cameras');
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
    }
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeExpandModal();
    });
    let liveConsoleEventSource = null;
    let liveConsoleWanted = false;
    function toggleLiveConsole() {
      const btn = document.getElementById('live-console-btn');
      const status = document.getElementById('live-console-status');
      if (liveConsoleEventSource) {
        liveConsoleWanted = false;
        liveConsoleEventSource.close();
        liveConsoleEventSource = null;
        if (btn) btn.textContent = 'Iniciar stream';
        if (status) { status.textContent = 'Detenido'; status.className = 'badge warn'; }
        return;
      }
      liveConsoleWanted = true;
      const url = base + '/ans/live';
      try {
        function connectLiveStream() {
          if (!liveConsoleWanted) return;
          const es = new EventSource(url);
          liveConsoleEventSource = es;
          es.onopen = function() {
            if (liveConsoleWanted && status) { status.textContent = 'Conectado'; status.className = 'badge ok'; }
          };
          es.onmessage = function(e) {
            try {
              const ev = JSON.parse(e.data);
              appendLiveEvent(ev);
            } catch (_) {}
          };
          es.onerror = function() {
            if (status) { status.textContent = 'Reconectando‚Ä¶'; status.className = 'badge warn'; }
            es.close();
            liveConsoleEventSource = null;
            if (liveConsoleWanted) setTimeout(connectLiveStream, 2000);
          };
        }
        connectLiveStream();
        if (btn) btn.textContent = 'Detener stream';
      } catch (err) {
        if (status) { status.textContent = 'Error: ' + (err.message || err); status.className = 'badge err'; }
      }
    }
    function formatLocalTime(isoStr) {
      if (!isoStr) return '--:--:--';
      try {
        var d = new Date(isoStr);
        return d.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
      } catch (_) { return (isoStr.split('T')[1] || '').substring(0, 8); }
    }
    function appendLiveEvent(ev) {
      const pre = document.getElementById('live-console-output');
      if (!pre) return;
      const phase = ev.phase || '?';
      const t = formatLocalTime(ev.ts);
      let line = '[' + t + '] ';
      if (phase === 'cycle_start') line += '>> Ciclo ANS iniciado';
      else if (phase === 'cycle_end') line += '<< Ciclo finalizado: ' + (ev.message || '');
      else if (phase === 'check_start') line += '  check: ' + (ev.check_id || '');
      else if (phase === 'check_end') line += '  check ' + (ev.check_id || '') + ': ' + (ev.ok ? 'OK' : 'FAIL') + ' ' + (ev.message || '').substring(0, 50);
      else if (phase === 'incident') line += '  ! INCIDENT ' + (ev.check_id || '') + ': ' + (ev.message || '').substring(0, 60);
      else if (phase === 'heal_attempt') line += '  -> heal: ' + (ev.heal_id || '');
      else if (phase === 'heal_end') line += '  <- heal ' + (ev.heal_id || '') + ': ' + (ev.ok ? 'OK' : 'FAIL') + ' ' + (ev.message || '').substring(0, 40);
      else if (phase === 'skip') line += '  (omitido) ' + (ev.heal_id || ev.check_id || '') + ': ' + (ev.message || '');
      else if (phase === 'scanner_start') line += '  >> Scanner iniciado';
      else if (phase === 'scanner_end') line += '  << Scanner finalizado: ' + (ev.message || '');
      else if (phase === 'download_start') {
        var cmt = (ev.details && (currentLocale === 'es' ? ev.details.comment_es : ev.details.comment_en)) || ((ev.details && ev.details.packages) ? ev.details.packages.join(' ') : ev.message || '');
        line += '  >> pip: ' + (cmt || ev.message || '').substring(0, 60);
      } else if (phase === 'download_end') {
        var cmt = (ev.details && (currentLocale === 'es' ? ev.details.comment_es : ev.details.comment_en)) || '';
        line += '  << pip ' + (ev.ok ? 'OK' : 'FAIL') + (cmt ? ': ' + cmt.substring(0, 50) : '') + (ev.message && !cmt ? ': ' + ev.message.substring(0, 40) : '');
      }
      else if (phase === 'heartbeat') line += '.';
      else if (phase === 'evolution_log') {
        line += '  ' + (ev.message || '').substring(0, 120) + (ev.ok === false ? ' [ERROR]' : '');
        var bitacoraList = document.getElementById('bitacora-list');
        var bitacoraEmpty = document.getElementById('bitacora-empty');
        if (bitacoraList) {
          if (bitacoraEmpty) bitacoraEmpty.style.display = 'none';
          var row = document.createElement('div');
          row.className = 'bitacora-row';
          row.innerHTML = '<span style="color:var(--muted);">' + t + '</span> <strong>Problema:</strong> Evoluci√≥n ‚Üí <strong>Acci√≥n:</strong> ‚Äî ‚Üí <span class="badge ' + (ev.ok === false ? 'err' : 'ok') + '">' + (ev.ok === false ? 'Error' : 'OK') + '</span> <span style="color:var(--muted);">' + (ev.message || '').substring(0, 60) + '</span>';
          row.style.marginBottom = '.35rem';
          bitacoraList.insertBefore(row, bitacoraList.firstChild);
        }
      }
      else line += '  ' + phase + ': ' + (ev.message || JSON.stringify(ev)).substring(0, 80);
      pre.textContent += line + '\n';
      pre.scrollTop = pre.scrollHeight;
    }
    async function loadLiveRecent() {
      const r = await get('/ans/live/recent?limit=80');
      const pre = document.getElementById('live-console-output');
      if (!pre) return;
      pre.textContent = '';
      (r && r.events || []).forEach(appendLiveEvent);
    }

    async function loadScannerStatus() {
      const r = await get('/ans/scanner-status');
      const scanEl = document.getElementById('scanner-last-scan');
      const listEl = document.getElementById('scanner-downloads-list');
      if (!scanEl && !listEl) return;
      if (scanEl) {
        const s = r && r.ok && r.last_scan ? r.last_scan : {};
        if (Object.keys(s).length) {
          scanEl.textContent = JSON.stringify(s, null, 2).substring(0, 800) + (JSON.stringify(s).length > 800 ? '...' : '');
        } else {
          scanEl.textContent = 'Sin datos';
        }
      }
      if (listEl) {
        const items = r && r.ok && r.last_downloads ? r.last_downloads : [];
        const loc = (typeof currentLocale !== 'undefined' ? currentLocale : 'es');
        listEl.innerHTML = items.length ? items.map(function(d) {
          const cls = d.ok ? 'ok' : 'err';
          const pkgs = (d.packages || []).join(', ');
          const cmt = (loc === 'es' ? d.comment_es : d.comment_en) || pkgs;
          const t = (d.ts || '').split('T')[1] || '';
          return '<div style="margin-bottom:.35rem;" title="' + pkgs + '"><span class="badge ' + cls + '">' + (d.ok ? 'OK' : 'FAIL') + '</span> ' + t.substring(0, 8) + ' ' + cmt + '</div>';
        }).join('') : '<div style="color:var(--muted);">Sin descargas recientes</div>';
      }
    }

    async function loadBitacora() {
      const list = document.getElementById('bitacora-list');
      const empty = document.getElementById('bitacora-empty');
      if (!list) return;
      const r = await get('/ans/bitacora?limit=50').catch(function() { return null; });
      const items = r && r.ok && r.data ? r.data : [];
      if (items.length === 0 && (!r || !r.ok)) return;
      list.querySelectorAll('.bitacora-row').forEach(el => el.remove());
      if (empty) empty.style.display = items.length ? 'none' : 'block';
      items.forEach(function(e) {
        const row = document.createElement('div');
        row.className = 'bitacora-row';
        const time = formatLocalTime(e.timestamp);
        row.innerHTML = '<span style="color:var(--muted);">' + time + '</span> ' +
          '<strong>Problema:</strong> ' + (e.problema || '‚Äî') + ' ‚Üí ' +
          '<strong>Acci√≥n:</strong> ' + (e.accion || '‚Äî') + ' ‚Üí ' +
          '<span class="badge ' + (e.resultado === 'OK' ? 'ok' : (e.resultado === 'Error' ? 'err' : 'warn')) + '">' + (e.resultado || '‚Äî') + '</span>' +
          (e.detalle ? ' <span style="color:var(--muted);">' + e.detalle.substring(0, 40) + '</span>' : '');
        row.style.marginBottom = '.35rem';
        list.appendChild(row);
      });
    }
    (function() {
      var target = document.getElementById('nav-opciones-sections');
      var ids = ['scanner-downloads-section','live-console-section','product-section','ans-section','owner-console-section','governance-panel','gateway-section','cluster-section','voice-section'];
      if (target) ids.forEach(function(id) { var el = document.getElementById(id); if (el) target.appendChild(el); });
    })();
    refreshAll();
    loadLocale();
    setInterval(refreshAll, 30000);
    setInterval(loadBitacora, 10000);
  </script>
  <!-- Ventana de ampliaci√≥n ATLAS (hija directa de body para quedar siempre encima) -->
  <div id="expand-modal" class="expand-modal" aria-hidden="true" onclick="if(event.target===this) closeExpandModal()">
    <div class="expand-modal-content" onclick="event.stopPropagation()">
      <div class="expand-modal-header">
        <h2 id="expand-modal-title">Interactuar con ATLAS</h2>
        <button type="button" class="btn-close-expand" onclick="closeExpandModal()" title="Cerrar (Esc)">Cerrar</button>
      </div>
      <div id="expand-modal-body"></div>
    </div>
  </div>

  <!-- Cursor‚ÄëATLAS: centro de mando tipo IDE -->
  <div id="cursor-atlas-overlay" class="cursor-atlas-overlay" aria-hidden="true" onclick="if(event.target===this) closeCursorAtlas()">
    <div class="cursor-atlas-shell" onclick="event.stopPropagation()">
      <div class="cursor-atlas-topbar">
        <div class="title">CURSOR<span>‚ÄëATLAS</span></div>
        <div class="cmdbar">
          <input id="cursor-atlas-cmd" class="cmdbar-input" type="text" placeholder="Orden r√°pida: /status, /doctor‚Ä¶ o pega una URL‚Ä¶ (Enter)" onkeydown="if(event.key==='Enter'){ cursorAtlasCmdSubmit(); }">
        </div>
        <div class="row" style="margin:0;gap:.35rem;">
          <button type="button" class="small secondary" onclick="openCmdk()" title="Paleta de comandos (Ctrl+K)"><span class="kbd">Ctrl</span>+<span class="kbd">K</span></button>
          <button type="button" class="small danger" onclick="closeCursorAtlas()" title="Cerrar (Esc)">Cerrar</button>
        </div>
      </div>
      <div class="cursor-atlas-side">
        <div class="ca-group">
          <h3>Navegaci√≥n</h3>
          <div class="ca-item" onclick="cursorAtlasNav('chat')"><span>Chat / Plan</span><small class="kbd">1</small></div>
          <div class="ca-item" onclick="cursorAtlasNav('ops')"><span>OPS Monitor</span><small class="kbd">2</small></div>
          <div class="ca-item" onclick="cursorAtlasNav('web')"><span>Web (Pies)</span><small class="kbd">3</small></div>
          <div class="ca-item" onclick="cursorAtlasNav('vision')"><span>Visi√≥n (Snapshot)</span><small class="kbd">4</small></div>
          <div class="ca-item" onclick="cursorAtlasNav('terminal')"><span>Terminal / Consola</span><small class="kbd">5</small></div>
        </div>
        <div class="ca-group">
          <h3>Acciones</h3>
          <div class="ca-item" onclick="cursorAtlasRunCommand('/status')"><span>/status</span><small>Diagn√≥stico</small></div>
          <div class="ca-item" onclick="cursorAtlasRunCommand('/doctor')"><span>/doctor</span><small>Checks</small></div>
          <div class="ca-item" onclick="cursorAtlasRunCommand('/modules')"><span>/modules</span><small>Inventario</small></div>
          <div class="ca-item" onclick="reconnectNexus()"><span>Reconectar Cuerpo</span><small>nexus/robot</small></div>
          <div class="ca-item" onclick="govEmergencyStop()"><span>Emergency Stop</span><small>doble-confirmaci√≥n</small></div>
        </div>
        <div class="ca-group">
          <h3>Comms</h3>
          <div class="ca-item" onclick="ccRefreshComms();ccRefreshOps();"><span>Actualizar COMMS/OPS</span><small>estado</small></div>
          <div class="ca-item" onclick="ccEmitOpsTest()"><span>Emitir OPS test</span><small>audio/telegram</small></div>
        </div>
        <div class="value" style="font-size:.78rem;color:var(--muted);">
          Consejo: todo lo que ATLAS haga en Web/Manos/Pies se ver√° en <strong>OPS</strong> con evidencia.
        </div>
      </div>
      <div class="cursor-atlas-main" id="cursor-atlas-main-slot"></div>
    </div>
  </div>

  <!-- Paleta de comandos -->
  <div id="cmdk-overlay" class="cmdk-overlay" aria-hidden="true" onclick="if(event.target===this) closeCmdk()">
    <div class="cmdk-box" onclick="event.stopPropagation()">
      <div class="cmdk-head">
        <input id="cmdk-input" type="text" placeholder="Buscar comando‚Ä¶ (Enter para ejecutar)" oninput="renderCmdk(this.value)" onkeydown="if(event.key==='Escape'){closeCmdk();}">
        <span class="hint"><span class="kbd">‚Üë</span>/<span class="kbd">‚Üì</span> navegar ¬∑ <span class="kbd">Enter</span> ejecutar</span>
      </div>
      <div id="cmdk-list" class="cmdk-list"></div>
      <div class="cmdk-foot">
        <span>Cursor‚ÄëATLAS</span>
        <span><span class="kbd">Ctrl</span>+<span class="kbd">K</span> abrir/cerrar</span>
      </div>
    </div>
  </div>

  <!-- Version Footer -->
  <div id="version-footer" style="
    position: fixed;
    bottom: 0;
    right: 0;
    padding: 0.4rem 0.8rem;
    background: rgba(22, 20, 31, 0.9);
    border-top-left-radius: 8px;
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-right: none;
    border-bottom: none;
    font-size: 0.7rem;
    color: var(--muted);
    z-index: 1000;
    backdrop-filter: blur(8px);
  ">
    <span style="color: var(--purple-light);">ATLAS</span> 
    <span id="footer-version">v2.5.0</span> 
    <span style="color: var(--muted);">|</span> 
    <span id="footer-build">2026-02-16</span>
  </div>
</body>
</html>

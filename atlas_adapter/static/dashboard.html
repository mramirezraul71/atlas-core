<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ATLAS Dashboard</title>
  <style>
    :root {
      /* Base oscuro con toques morados */
      --bg: #0d0c12;
      --bg-elevated: #14121b;
      --card: #16141f;
      --card-border: rgba(139, 92, 246, 0.12);
      --text: #e8e6ed;
      --muted: #78748a;
      /* Acento principal: morado/violeta */
      --accent: #8b5cf6;
      --accent-hover: #a78bfa;
      --accent-muted: rgba(139, 92, 246, 0.2);
      --purple: #8b5cf6;
      --purple-light: #a78bfa;
      --purple-dark: #6d28d9;
      /* Estado */
      --green: #22c55e;
      --red: #ef4444;
      --amber: #eab308;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(139, 92, 246, 0.08), transparent);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--card-border);
    }
    h1 {
      font-size: 1.5rem;
      margin: 0;
      font-weight: 600;
      background: linear-gradient(135deg, var(--text) 0%, var(--purple-light) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header-actions { display: flex; align-items: center; gap: .75rem; }
    .last-update { font-size: .75rem; color: var(--muted); }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 1.1rem;
      border: 1px solid var(--card-border);
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
      transition: border-color .2s, box-shadow .2s;
    }
    .card:hover {
      border-color: rgba(139, 92, 246, 0.25);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.08);
    }
    .card h2 {
      font-size: .75rem;
      margin: 0 0 .5rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
      font-weight: 600;
    }
    .card h2::after {
      content: '';
      display: inline-block;
      width: 3px;
      height: 10px;
      background: var(--purple);
      border-radius: 2px;
      margin-left: 6px;
      vertical-align: middle;
    }
    .card .value { font-size: .95rem; word-break: break-word; line-height: 1.4; }
    .card.loading .value { color: var(--muted); }
    .card.error .value { color: var(--red); }
    .row { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; margin-top: .5rem; }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: .4rem .75rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: .875rem;
      font-weight: 500;
      transition: background .2s, transform .1s;
    }
    button:hover { background: var(--accent-hover); }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    button.danger { background: var(--red); }
    button.danger:hover { filter: brightness(1.1); }
    button.secondary {
      background: var(--accent-muted);
      color: var(--purple-light);
      border: 1px solid rgba(139, 92, 246, 0.3);
    }
    button.secondary:hover {
      background: rgba(139, 92, 246, 0.3);
      border-color: var(--purple);
    }
    button.small { padding: .25rem .5rem; font-size: .75rem; }
    .badge { display: inline-block; padding: .2rem .45rem; border-radius: 4px; font-size: .75rem; font-weight: 500; }
    .badge.ok { background: rgba(34,197,94,.25); color: var(--green); }
    .badge.warn { background: rgba(234,179,8,.25); color: var(--amber); }
    .badge.err { background: rgba(239,68,68,.25); color: var(--red); }
    .score-bar {
      height: 6px;
      background: var(--bg-elevated);
      border-radius: 3px;
      overflow: hidden;
      margin-top: .4rem;
      max-width: 120px;
    }
    #health-bar-fill { transition: width .3s ease, background .2s; }
    ul { margin: 0; padding-left: 1.2rem; font-size: .875rem; }
    #approvals-list li { margin-bottom: .35rem; }
    .metrics-list { font-size: .8rem; color: var(--muted); margin-top: .3rem; }
    .metrics-list span { display: block; }
    /* InteracciÃ³n robot */
    .robot-section { margin-top: 1.5rem; }
    .robot-section .card { padding: 1.25rem; }
    .robot-section h2 { margin-bottom: .75rem; }
    .robot-task-type { margin-bottom: .75rem; }
    .robot-task-type label { display: block; font-size: .8rem; color: var(--muted); margin-bottom: .35rem; }
    .robot-task-type select {
      width: 100%;
      max-width: 320px;
      padding: .5rem;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--card-border);
      color: var(--text);
      font-size: .9rem;
    }
    .robot-task-type select:focus {
      outline: none;
      border-color: var(--purple);
      box-shadow: 0 0 0 2px var(--accent-muted);
    }
    .robot-task-help { font-size: .75rem; color: var(--muted); margin-top: .25rem; margin-bottom: .5rem; }
    .robot-input {
      width: 100%;
      min-height: 80px;
      padding: .75rem;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--card-border);
      color: var(--text);
      font-size: .9rem;
      resize: vertical;
      font-family: inherit;
      transition: border-color .2s, box-shadow .2s;
    }
    .robot-input:focus {
      outline: none;
      border-color: var(--purple);
      box-shadow: 0 0 0 2px var(--accent-muted);
    }
    .robot-input::placeholder { color: var(--muted); }
    .robot-actions { margin-top: .75rem; display: flex; gap: .5rem; align-items: center; }
    .robot-response {
      margin-top: 1rem;
      padding: .75rem;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--card-border);
      font-size: .85rem;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 280px;
      overflow-y: auto;
    }
    .robot-response.empty { color: var(--muted); }
    .robot-response.error { border-color: var(--red); color: var(--red); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ATLAS Dashboard</h1>
      <div class="header-actions">
        <span class="last-update" id="last-update">â€”</span>
        <button class="secondary" id="btn-refresh" onclick="refreshAll()">Actualizar</button>
      </div>
    </div>
    <div class="grid">
      <div class="card" id="status-card"><h2>Estado</h2><div class="value">â€”</div></div>
      <div class="card" id="version-card"><h2>VersiÃ³n</h2><div class="value">â€”</div></div>
      <div class="card" id="health-card"><h2>Salud</h2><div class="value">â€”</div><div class="score-bar"><div id="health-bar-fill" style="width:0%;height:100%;background:var(--muted);border-radius:3px"></div></div></div>
      <div class="card" id="metrics-card"><h2>MÃ©tricas</h2><div class="value">â€”</div><div class="metrics-list" id="metrics-detail"></div></div>
      <div class="card" id="scheduler-card"><h2>Programador</h2><div class="value">â€”</div><div class="row"></div></div>
      <div class="card" id="update-card"><h2>ActualizaciÃ³n</h2><div class="value">â€”</div><div class="row"><button class="small" onclick="updateCheck()">Comprobar</button></div></div>
      <div class="card" id="deploy-card"><h2>Despliegue</h2><div class="value">â€”</div><div class="row"></div></div>
      <div class="card" id="cluster-card"><h2>Cluster</h2><div class="value">â€”</div><div class="row"><button class="small" onclick="loadCluster()">Ver nodos</button></div></div>
      <div class="card" id="gateway-card"><h2>Gateway</h2><div class="value">â€”</div><div class="row"><button class="small" onclick="loadGateway()">Ver</button></div></div>
      <div class="card" id="approvals-card"><h2>Aprobaciones</h2><div class="value"><ul id="approvals-list"></ul></div></div>
    </div>

    <section class="robot-section" id="owner-console-section">
      <div class="card">
        <h2>Owner Console</h2>
        <p class="robot-task-help">Sesiones activas, aprobaciones pendientes/expiradas, emergencia, integridad de cadena.</p>
        <div class="row" style="margin-bottom:0.75rem;">
          <button class="small" id="owner-session-btn" onclick="ownerStartSession()">Iniciar sesiÃ³n owner</button>
          <span class="last-update" id="owner-session-msg"></span>
          <button class="small secondary" onclick="loadOwnerStatus()">Actualizar</button>
          <button class="small" id="owner-emergency-btn" onclick="ownerToggleEmergency()">Emergency: â€”</button>
          <button class="small secondary" onclick="ownerVerifyChain()">Verificar cadena</button>
        </div>
        <div id="owner-sessions" class="value" style="font-size:.8rem; color:var(--muted);"></div>
        <h3 style="font-size:.75rem; color:var(--muted); margin:.5rem 0 .25rem;">Pendientes / Expiradas</h3>
        <div id="owner-pending-list" class="value" style="font-size:.8rem; max-height:120px; overflow-y:auto;"></div>
        <div id="owner-expired-list" class="value" style="font-size:.8rem; max-height:80px; overflow-y:auto; color:var(--amber);"></div>
        <h3 style="font-size:.75rem; color:var(--muted); margin:.5rem 0 .25rem;">Historial crÃ­ticos</h3>
        <div id="owner-critical-history" class="value" style="font-size:.8rem; max-height:140px; overflow-y:auto;"></div>
      </div>
    </section>

    <section class="robot-section" id="gateway-section" style="display:none;">
      <div class="card">
        <h2>Gateway â€” Stealth</h2>
        <p class="robot-task-help">Modo actual, herramientas detectadas, Ãºltimo Ã©xito, Check / Bootstrap / Set mode.</p>
        <div class="row" style="margin-bottom:0.75rem;">
          <button class="small" onclick="gatewayCheck()">Check</button>
          <button class="small" onclick="gatewayBootstrap()">Bootstrap</button>
          <select id="gateway-mode" onchange="gatewaySetMode()" style="padding:.35rem .5rem; border-radius:6px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.8rem;">
            <option value="auto">auto</option>
            <option value="cloudflare">cloudflare</option>
            <option value="tailscale">tailscale</option>
            <option value="ssh">ssh</option>
            <option value="lan">lan</option>
          </select>
          <span class="last-update" id="gateway-status-msg"></span>
        </div>
        <div id="gateway-tools" class="value" style="font-size:.85rem;"></div>
        <div id="gateway-last-success" class="value" style="font-size:.8rem; color:var(--muted); margin-top:.5rem;"></div>
        <div id="gateway-recommendations" class="value" style="font-size:.8rem; color:var(--amber); margin-top:.35rem;"></div>
      </div>
    </section>

    <section class="robot-section" id="cluster-section" style="display:none;">
      <div class="card">
        <h2>Cluster â€” Owner Command Center</h2>
        <p class="robot-task-help">Nodos registrados, heartbeat, ruta preferida y eventos.</p>
        <div class="row" style="margin-bottom:0.75rem;">
          <button class="small" onclick="loadCluster()">Actualizar nodos</button>
          <button class="small secondary" onclick="clusterPing()">Ping</button>
          <select id="cluster-route-pref" onchange="setClusterRoute()" style="padding:.35rem .5rem; border-radius:6px; background:var(--bg-elevated); border:1px solid var(--card-border); color:var(--text); font-size:.8rem;">
            <option value="local">Ruta: local</option>
            <option value="remote_preferred">Ruta: remote_preferred</option>
          </select>
          <button class="small secondary" onclick="runClusterTestJob()">Run test job (best node)</button>
        </div>
        <div id="cluster-nodes-list" class="value" style="font-size:.85rem; max-height:200px; overflow-y:auto;"></div>
        <h3 style="font-size:.8rem; color:var(--muted); margin:.75rem 0 .35rem;">Ãšltimos eventos</h3>
        <div id="cluster-events-list" class="value" style="font-size:.8rem; max-height:160px; overflow-y:auto; color:var(--muted);"></div>
      </div>
    </section>

    <section class="robot-section">
      <div class="card">
        <h2>Interactuar con ATLAS</h2>
        <p class="robot-task-help" id="robot-task-help">Comando directo: /status, /doctor, /modules. Sin IA.</p>
        <div class="robot-task-type">
          <label for="robot-task-type">Envergadura de la tarea</label>
          <select id="robot-task-type" onchange="updateTaskHelp()">
            <option value="quick">RÃ¡pida (comando)</option>
            <option value="medium">Media (IA plan)</option>
            <option value="full">Compleja (IA plan + ejecuciÃ³n)</option>
          </select>
        </div>
        <textarea id="robot-input" class="robot-input" placeholder="Escribe un comando (ej. /status) o un objetivo para la IAâ€¦"></textarea>
        <div class="robot-actions">
          <button id="robot-send" onclick="sendToRobot()">Enviar</button>
          <span class="last-update" id="robot-status"></span>
        </div>
        <div class="robot-actions" style="margin-top:0.5rem;">
          <button type="button" class="small secondary" id="btn-voice-mic" onclick="startVoiceRecognition()">ðŸŽ¤ Hablar por voz</button>
          <button type="button" class="small secondary" id="btn-voice-play" onclick="playResponseWithVoice()">ðŸ”Š Reproducir respuesta por PC</button>
        </div>
        <div class="robot-response empty" id="robot-response">La respuesta aparecerÃ¡ aquÃ­.</div>
      </div>
    </section>

    <section class="robot-section">
      <div class="card">
        <h2>Voz y rostro</h2>
        <p class="robot-task-help">Reconocimiento de voz (micrÃ³fono) y detecciÃ³n de rostro (cÃ¡mara).</p>
        <div class="robot-actions">
          <button type="button" class="small" id="btn-face-check" onclick="checkFace()">ðŸ“· Verificar rostro (cÃ¡mara)</button>
          <button type="button" class="small secondary" id="btn-face-disconnect" style="display:none;" onclick="disconnectCamera()">Apagar cÃ¡mara</button>
          <span class="last-update" id="face-result"></span>
        </div>
        <div id="face-video-container" style="display:none; margin-top:0.5rem;">
          <video id="face-video" autoplay playsinline width="320" height="240" style="border-radius:8px; background:#000;"></video>
          <p style="font-size:.8rem; color:var(--muted); margin-top:.35rem;">Mira a la cÃ¡mara y pulsa Â«Verificar rostroÂ» para capturar. Pulsa Â«Apagar cÃ¡maraÂ» cuando termines.</p>
        </div>
      </div>
    </section>
  </div>
  <script>
    const base = window.location.origin;
    let ownerSessionToken = null;
    const TASK_HELP = {
      quick: 'Comando directo: /status, /doctor, /modules. Sin IA.',
      medium: 'La IA genera un plan; no ejecuta. Ideal para revisar pasos antes de ejecutar.',
      full: 'Plan y ejecuciÃ³n con aprobaciÃ³n. Mayor uso de recursos. Para tareas complejas.'
    };
    async function get(path) {
      const r = await fetch(base + path, { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
      return r.ok ? r.json() : null;
    }
    async function post(path, body, headers) {
      const h = { 'Content-Type': 'application/json', ...(headers || {}) };
      if (ownerSessionToken) h['X-Owner-Session'] = ownerSessionToken;
      const r = await fetch(base + path, { method: 'POST', headers: h, body: JSON.stringify(body || {}) });
      return r.ok ? r.json() : null;
    }
    function setLastUpdate() {
      document.getElementById('last-update').textContent = 'Ãšltima actualizaciÃ³n: ' + new Date().toLocaleTimeString('es');
    }
    function setCard(id, text, isError) {
      const card = document.getElementById(id);
      if (!card) return;
      const val = card.querySelector('.value');
      if (val) val.textContent = text;
      card.classList.remove('loading', 'error');
      if (isError) card.classList.add('error');
    }
    function setCardJson(id, data) {
      const card = document.getElementById(id);
      if (!card) return;
      const val = card.querySelector('.value');
      val.textContent = data ? (data.ok !== undefined ? (data.ok ? 'OK' : (data.error || 'Error')) : JSON.stringify(data).slice(0, 120)) : 'â€”';
      card.classList.remove('loading', 'error');
      if (data && data.ok === false) card.classList.add('error');
    }
    function updateTaskHelp() {
      const sel = document.getElementById('robot-task-type');
      const help = document.getElementById('robot-task-help');
      if (help && sel) help.textContent = TASK_HELP[sel.value] || TASK_HELP.quick;
    }
    async function sendToRobot() {
      const input = document.getElementById('robot-input');
      const responseEl = document.getElementById('robot-response');
      const statusEl = document.getElementById('robot-status');
      const btn = document.getElementById('robot-send');
      const taskType = document.getElementById('robot-task-type').value;
      const text = (input && input.value || '').trim();
      if (!text) {
        responseEl.textContent = 'Escribe un comando o objetivo.';
        responseEl.classList.add('error', 'empty');
        return;
      }
      btn.disabled = true;
      statusEl.textContent = 'Enviandoâ€¦';
      responseEl.classList.remove('error', 'empty');
      responseEl.textContent = 'â€¦';
      try {
        let out;
        if (taskType === 'quick') {
          out = await post('/intent', { text: text });
          let msg = formatRobotResponse(out, 'quick');
          if (out && out.error) responseEl.classList.add('error');
          else responseEl.classList.remove('error');
          responseEl.textContent = msg;
          setLastResponseText(msg);
        } else {
          const mode = taskType === 'medium' ? 'plan_only' : 'controlled';
          const depth = taskType === 'medium' ? 1 : 2;
          out = await post('/agent/goal', { goal: text, mode: mode, depth: depth, fast: taskType === 'medium' });
          let msg = formatRobotResponse(out, taskType);
          if (out && out.data && (out.data.steps || out.data.plan)) msg += '\n\n' + (out.data.resumen || JSON.stringify({ steps: out.data.steps || out.data.plan }, null, 2).slice(0, 1500));
          if (out && out.error) responseEl.classList.add('error');
          else responseEl.classList.remove('error');
          responseEl.textContent = msg;
          setLastResponseText(msg);
        }
      } catch (e) {
        responseEl.textContent = 'Error: ' + (e.message || String(e));
        responseEl.classList.add('error');
      }
      statusEl.textContent = '';
      btn.disabled = false;
    }

    let lastResponseText = '';
    function setLastResponseText(t) { lastResponseText = (t || '').trim(); }

    function formatRobotResponse(out, taskType) {
      if (!out) return 'No hubo respuesta del robot.';
      if (out.error) return 'Error: ' + (out.error || 'desconocido');
      if (taskType === 'quick' && out.output !== undefined) {
        var o = out.output;
        if (typeof o === 'string') return o;
        if (o && typeof o === 'object') {
          if (o.atlas) return String(o.atlas);
          if (o.message) return String(o.message);
          if (o.status) return 'Estado: ' + String(o.status);
        }
        return typeof o === 'string' ? o : (out.resumen || 'Comando ejecutado. Revisa los detalles abajo.');
      }
      if (out.resumen) return out.resumen;
      if (out.message) return out.message;
      return 'Listo. Revisa los detalles si los hay.';
    }

    function startVoiceRecognition() {
      const btn = document.getElementById('btn-voice-mic');
      const input = document.getElementById('robot-input');
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Tu navegador no soporta reconocimiento de voz. Usa Chrome o Edge.');
        return;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new SpeechRecognition();
      rec.lang = 'es-ES';
      rec.continuous = false;
      rec.interimResults = false;
      if (btn) { btn.disabled = true; btn.textContent = 'Escuchandoâ€¦'; }
      rec.onresult = function(e) {
        const text = (e.results[0] && e.results[0][0]) ? e.results[0][0].transcript : '';
        if (input) input.value = text;
        if (btn) { btn.disabled = false; btn.textContent = 'ðŸŽ¤ Hablar por voz'; }
        if (text) sendToRobot();
      };
      rec.onerror = function() {
        if (btn) { btn.disabled = false; btn.textContent = 'ðŸŽ¤ Hablar por voz'; }
      };
      rec.onend = function() {
        if (btn && btn.textContent === 'Escuchandoâ€¦') { btn.disabled = false; btn.textContent = 'ðŸŽ¤ Hablar por voz'; }
      };
      rec.start();
    }

    async function playResponseWithVoice() {
      const text = lastResponseText || (document.getElementById('robot-response') && document.getElementById('robot-response').textContent) || '';
      if (!text || text.startsWith('La respuesta') || text === 'â€¦') {
        alert('No hay respuesta que reproducir. EnvÃ­a un comando primero.');
        return;
      }
      const short = text.slice(0, 500);
      try {
        const r = await post('/voice/speak', { text: short });
        if (r && r.ok) return;
        if (window.speechSynthesis && window.SpeechSynthesisUtterance) {
          const u = new SpeechSynthesisUtterance(short);
          u.lang = 'es-ES';
          window.speechSynthesis.speak(u);
        } else alert('TTS no disponible en el servidor. Instala pyttsx3.');
      } catch (e) {
        if (window.speechSynthesis && window.SpeechSynthesisUtterance) {
          const u = new SpeechSynthesisUtterance(short);
          u.lang = 'es-ES';
          window.speechSynthesis.speak(u);
        } else alert('Error: ' + (e.message || e));
      }
    }

    let faceStream = null;
    function disconnectCamera() {
      if (faceStream) {
        faceStream.getTracks().forEach(function(t) { t.stop(); });
        faceStream = null;
      }
      const video = document.getElementById('face-video');
      const container = document.getElementById('face-video-container');
      const btn = document.getElementById('btn-face-check');
      const btnDisc = document.getElementById('btn-face-disconnect');
      const resultEl = document.getElementById('face-result');
      if (video) { video.srcObject = null; video.style.display = 'none'; }
      if (container) container.style.display = 'none';
      if (btn) btn.textContent = 'ðŸ“· Verificar rostro (cÃ¡mara)';
      if (btnDisc) btnDisc.style.display = 'none';
      if (resultEl) resultEl.textContent = 'CÃ¡mara apagada.';
    }
    async function checkFace() {
      const resultEl = document.getElementById('face-result');
      const container = document.getElementById('face-video-container');
      const video = document.getElementById('face-video');
      const btn = document.getElementById('btn-face-check');
      const btnDisc = document.getElementById('btn-face-disconnect');
      if (resultEl) resultEl.textContent = 'â€¦';
      try {
        if (!faceStream) {
          faceStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 320, height: 240 } });
          if (video) { video.srcObject = faceStream; video.style.display = 'block'; }
          if (container) container.style.display = 'block';
          if (btn) btn.textContent = 'ðŸ“· Capturar y verificar';
          if (btnDisc) btnDisc.style.display = 'inline-block';
          if (resultEl) resultEl.textContent = 'CÃ¡mara encendida. Pulsa de nuevo para capturar.';
          return;
        }
        if (!video || video.readyState < 2) {
          if (resultEl) resultEl.textContent = 'Espera a que cargue el video.';
          return;
        }
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const dataUrl = canvas.toDataURL('image/png');
        const base64 = dataUrl.split(',')[1];
        const r = await post('/face/check', { image_base64: base64 });
        if (r && r.ok && r.data) {
          const n = r.data.faces_detected || r.data.count || 0;
          if (resultEl) resultEl.textContent = n > 0 ? 'âœ“ Rostro detectado (' + n + ')' : 'No se detectÃ³ rostro.';
        } else {
          if (resultEl) resultEl.textContent = 'Error: ' + (r && r.error ? r.error : 'sin respuesta');
        }
      } catch (e) {
        if (resultEl) resultEl.textContent = 'Error: ' + (e.message || e);
      }
    }

    async function loadStatus() {
      const d = await get('/status');
      setCardJson('status-card', d);
    }
    async function loadVersion() {
      const d = await get('/version');
      if (d && d.ok !== false) setCard('version-card', (d.version || 'â€”') + ' (' + (d.channel || '') + ')' + (d.git_sha ? ' ' + d.git_sha : ''));
      else setCard('version-card', 'â€”', true);
    }
    async function loadHealth() {
      const d = await get('/health');
      const card = document.getElementById('health-card');
      const val = card ? card.querySelector('.value') : null;
      const bar = document.getElementById('health-bar-fill');
      if (!d) {
        if (val) val.textContent = 'â€”';
        if (bar) bar.style.width = '0%';
        if (card) card.classList.add('error');
        return;
      }
      const score = d.score != null ? d.score : 0;
      if (val) val.textContent = score + '/100';
      if (bar) {
        bar.style.width = score + '%';
        bar.style.background = score >= 80 ? 'var(--green)' : score >= 60 ? 'var(--amber)' : 'var(--red)';
      }
      card.classList.remove('error');
      if (d.ok === false) card.classList.add('error');
    }
    async function loadMetrics() {
      const d = await get('/metrics');
      const detail = document.getElementById('metrics-detail');
      if (d && d.data) {
        const c = d.data.counters || {};
        const l = d.data.latencies || {};
        const keys = Object.keys(c);
        const top = keys.slice(0, 6).map(k => k + ': ' + c[k]).join(' Â· ');
        setCard('metrics-card', (keys.length ? 'Contadores: ' + keys.length : 'â€”') + (Object.keys(l).length ? ' Â· Latencias: ' + Object.keys(l).length : ''));
        if (detail && top) detail.innerHTML = '<span>' + top + '</span>';
        else if (detail) detail.innerHTML = '';
      } else {
        setCard('metrics-card', 'â€”');
        if (detail) detail.innerHTML = '';
      }
    }
    async function loadScheduler() {
      const d = await get('/scheduler/jobs');
      const jobs = (d && d.data) ? (Array.isArray(d.data) ? d.data : []) : [];
      const card = document.getElementById('scheduler-card');
      if (card) {
        const val = card.querySelector('.value');
        if (val) val.textContent = jobs.length + ' trabajo(s)';
      }
    }
    async function loadUpdate() {
      const d = await get('/update/status');
      if (d && d.data) {
        const has = d.data.has_update;
        const branch = d.data.branch || 'â€”';
        setCard('update-card', branch + ' Â· actualizaciÃ³n: ' + (has ? 'SÃ­' : 'No'));
      } else setCard('update-card', 'â€”');
    }
    async function loadDeploy() {
      const d = await get('/deploy/status');
      if (d && d.data) {
        const x = d.data;
        const mode = x.mode || 'single';
        const port = x.active_port != null ? x.active_port : 'â€”';
        const score = (x.last_health && x.last_health.score != null) ? x.last_health.score : (x.health_score != null ? x.health_score : 'â€”');
        const canary = x.canary && x.canary.enabled ? 'Canary ON' : 'Canary OFF';
        setCard('deploy-card', 'modo: ' + mode + ' Â· puerto: ' + port + ' Â· salud: ' + score + ' Â· ' + canary);
      } else setCard('deploy-card', 'â€”');
    }
    async function loadCluster() {
      const st = await get('/cluster/status');
      const card = document.getElementById('cluster-card');
      if (st && st.data) {
        const en = st.data.enabled;
        const nodeId = st.data.node_id || 'â€”';
        const role = st.data.role || 'â€”';
        const count = (st.data.nodes && st.data.nodes.length) || 0;
        if (card) {
          const val = card.querySelector('.value');
          if (val) val.textContent = en ? (nodeId + ' Â· ' + role + ' Â· ' + count + ' nodo(s)') : 'Desactivado';
        }
        document.getElementById('cluster-section').style.display = en ? 'block' : 'none';
        if (en) {
          const nodesEl = document.getElementById('cluster-nodes-list');
          const nodes = st.data.nodes || [];
          nodesEl.innerHTML = nodes.length ? nodes.map((n, i) => '<div style="margin:.35rem 0; padding:.35rem; background:var(--bg-elevated); border-radius:6px;">' + n.node_id + ' Â· ' + (n.status || 'â€”') + ' Â· score ' + (n.health_score != null ? n.health_score : 'â€”') + ' Â· ' + (n.base_url || '') + ' <button class="small" data-base-url="' + (n.base_url || '').replace(/"/g, '&quot;') + '" onclick="clusterPingNode(this)">Ping</button></div>').join('') : '<span class="muted">Sin nodos</span>';
          const ev = await get('/cluster/events?limit=20');
          const eventsEl = document.getElementById('cluster-events-list');
          const events = (ev && ev.data && Array.isArray(ev.data)) ? ev.data : [];
          eventsEl.innerHTML = events.length ? events.slice(0, 15).map(e => e.ts + ' ' + e.node_id + ' ' + e.kind).join('\n') : 'â€”';
        }
      } else {
        if (card) { const val = card.querySelector('.value'); if (val) val.textContent = 'â€”'; }
      }
    }
    function clusterPing() {
      get('/cluster/ping').then(d => alert(d && d.data && d.data.pong ? 'Pong OK' : 'No pong'));
    }
    function clusterPingNode(btnOrUrl) {
      const baseUrl = typeof btnOrUrl === 'string' ? btnOrUrl : (btnOrUrl && btnOrUrl.getAttribute ? btnOrUrl.getAttribute('data-base-url') : null);
      if (!baseUrl) return;
      fetch(baseUrl.replace(/\/$/, '') + '/cluster/ping', { cache: 'no-store' }).then(r => r.json()).then(d => alert(d && d.data && d.data.pong ? 'Pong OK' : 'Error')).catch(() => alert('Error de red'));
    }
    function setClusterRoute() {
      const sel = document.getElementById('cluster-route-pref');
      if (sel) localStorage.setItem('atlas_cluster_route', sel.value);
    }
    async function runClusterTestJob() {
      const r = await post('/cluster/route/decision', { task: 'hands', prefer_remote: true });
      if (r && r.data) alert('Ruta: ' + (r.data.route || 'â€”') + (r.data.node_id ? ' Â· nodo ' + r.data.node_id : ''));
      else alert('Error: ' + (r && r.error ? r.error : 'sin respuesta'));
    }
    async function loadGateway() {
      const st = await get('/gateway/status');
      const card = document.getElementById('gateway-card');
      if (st && st.data) {
        const d = st.data;
        if (card) { const val = card.querySelector('.value'); if (val) val.textContent = d.enabled ? (d.mode + ' Â· ' + (d.last_success_mode || 'â€”')) : 'Desactivado'; }
        document.getElementById('gateway-section').style.display = d.enabled ? 'block' : 'none';
        const sel = document.getElementById('gateway-mode'); if (sel) sel.value = d.mode || 'auto';
        const tools = document.getElementById('gateway-tools');
        tools.innerHTML = 'cloudflared: ' + (d.tools && d.tools.cloudflared ? 'OK' : 'â€”') + ' Â· tailscale: ' + (d.tools && d.tools.tailscale ? 'OK' : 'â€”') + ' Â· ssh: ' + (d.tools && d.tools.ssh ? 'OK' : 'â€”');
        const last = document.getElementById('gateway-last-success');
        last.textContent = d.last_success_ts ? ('Ãšltimo Ã©xito: ' + d.last_success_ts + ' Â· ' + (d.last_success_mode || '') + ' Â· ' + (d.last_success_target || '')) : 'Sin Ãºltimo Ã©xito';
        const rec = document.getElementById('gateway-recommendations');
        rec.textContent = (d.recommendations && d.recommendations.length) ? d.recommendations.join('; ') : '';
      } else { if (card) { const val = card.querySelector('.value'); if (val) val.textContent = 'â€”'; } }
    }
    async function gatewayCheck() {
      const msg = document.getElementById('gateway-status-msg'); if (msg) msg.textContent = 'Comprobandoâ€¦';
      const r = await post('/gateway/check');
      if (msg) msg.textContent = r && r.ok ? 'Check OK' : (r && r.error ? r.error : 'Error');
      loadGateway();
    }
    async function gatewayBootstrap() {
      const msg = document.getElementById('gateway-status-msg'); if (msg) msg.textContent = 'Bootstrapâ€¦';
      const r = await post('/gateway/bootstrap');
      if (msg) msg.textContent = r && r.ok ? 'Bootstrap OK' : (r && r.error ? r.error : 'Error');
      loadGateway();
    }
    async function gatewaySetMode() {
      const sel = document.getElementById('gateway-mode'); if (!sel) return;
      const r = await post('/gateway/mode', { mode: sel.value });
      if (r && r.ok) loadGateway(); else alert(r && r.error ? r.error : 'Error');
    }
    async function loadApprovals() {
      const d = await get('/approvals/list');
      const list = document.getElementById('approvals-list');
      const items = (d && d.data && Array.isArray(d.data)) ? d.data : [];
      list.innerHTML = items.length
        ? items.map(a => '<li>' + a.id + ' ' + (a.action || '') + ' <button class="small" onclick="approve(\'' + a.id + '\')">Aprobar</button> <button class="small danger" onclick="reject(\'' + a.id + '\')">Rechazar</button></li>').join('')
        : '<li>Ninguno</li>';
    }
    async function updateCheck() {
      await post('/update/check');
      loadUpdate();
    }
    async function approve(id) {
      const r = await post('/approvals/approve', { id: id });
      if (r && !r.ok && r.status === 'owner_session_required') {
        document.getElementById('owner-session-msg').textContent = 'SesiÃ³n requerida para high/critical. Inicia sesiÃ³n en Owner Console.';
      }
      loadApprovals();
      loadOwnerStatus();
    }
    async function reject(id) {
      await post('/approvals/reject', { id: id });
      loadApprovals();
    }
    async function ownerStartSession() {
      const msg = document.getElementById('owner-session-msg');
      const r = await post('/owner/session/start', { actor: 'owner', method: 'ui' });
      if (r && r.ok && r.session_token) {
        ownerSessionToken = r.session_token;
        msg.textContent = 'SesiÃ³n activa (TTL ' + (r.ttl_seconds || 900) + 's)';
        msg.style.color = 'var(--green)';
        loadOwnerStatus();
      } else {
        ownerSessionToken = null;
        msg.textContent = (r && r.error) ? r.error : 'Error al iniciar sesiÃ³n';
        msg.style.color = 'var(--red)';
      }
    }
    async function loadOwnerStatus() {
      const d = await get('/owner/status');
      if (!d || !d.data) return;
      const data = d.data;
      const sessionsEl = document.getElementById('owner-sessions');
      if (sessionsEl) sessionsEl.textContent = (data.active_sessions && data.active_sessions.length) ? data.active_sessions.length + ' sesiÃ³n(es) activa(s)' : 'Sin sesiones';
      const pendingEl = document.getElementById('owner-pending-list');
      if (pendingEl) pendingEl.innerHTML = (data.pending_approvals && data.pending_approvals.length) ? data.pending_approvals.map(a => a.id + ' ' + (a.action||'') + ' risk=' + (a.risk||'')).join(' | ') : 'Ninguno';
      const expiredEl = document.getElementById('owner-expired-list');
      if (expiredEl) expiredEl.innerHTML = (data.expired_approvals && data.expired_approvals.length) ? data.expired_approvals.map(a => a.id + ' ' + (a.action||'')).join(' | ') : 'Ninguno';
      const criticalEl = document.getElementById('owner-critical-history');
      if (criticalEl) criticalEl.innerHTML = (data.critical_history && data.critical_history.length) ? data.critical_history.slice(0, 10).map(a => a.id + ' ' + (a.action||'') + ' ' + (a.resolved_by||'')).join(' | ') : 'Ninguno';
      const emergencyBtn = document.getElementById('owner-emergency-btn');
      if (emergencyBtn) emergencyBtn.textContent = 'Emergency: ' + (data.emergency ? 'ON' : 'OFF');
    }
    async function ownerToggleEmergency() {
      const d = await get('/owner/status');
      const next = !(d && d.data && d.data.emergency);
      const r = await post('/owner/emergency', { enable: next });
      if (r && r.ok) loadOwnerStatus(); else alert(r && r.error ? r.error : 'Error');
    }
    async function ownerVerifyChain() {
      const r = await get('/approvals/chain/verify');
      if (r && r.valid) alert('Cadena Ã­ntegra.'); else alert(r && !r.valid ? 'Cadena rota: ' + (r.first_invalid_id || '') : (r && r.error) || 'Error');
    }
    async function refreshAll() {
      const btn = document.getElementById('btn-refresh');
      const lastEl = document.getElementById('last-update');
      if (btn) { btn.disabled = true; btn.textContent = 'Actualizandoâ€¦'; }
      if (lastEl) lastEl.textContent = 'Actualizandoâ€¦';
      try {
        await Promise.all([
          loadStatus(),
          loadVersion(),
          loadHealth(),
          loadMetrics(),
          loadScheduler(),
          loadUpdate(),
          loadDeploy(),
          loadCluster(),
          loadGateway(),
          loadApprovals(),
          loadOwnerStatus()
        ]);
        setLastUpdate();
      } catch (e) {
        if (lastEl) lastEl.textContent = 'Error al actualizar';
      }
      if (btn) { btn.disabled = false; btn.textContent = 'Actualizar'; }
    }
    refreshAll();
    setInterval(refreshAll, 30000);
  </script>
</body>
</html>

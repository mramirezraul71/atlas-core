<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ATLAS Dashboard v3.8.0</title>
  <style>
    /* === THEME: Default (Cyan) === */
    :root, [data-theme="cyan"] {
      --bg: #0d1117;
      --bg-card: #161b22;
      --bg-elevated: #21262d;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-cyan: #39d3c4;
      --accent-green: #3fb950;
      --accent-purple: #a371f7;
      --accent-pink: #f778ba;
      --accent-orange: #d29922;
      --accent-red: #f85149;
      --accent-primary: #39d3c4;
    }
    /* === THEME: Purple === */
    [data-theme="purple"] {
      --bg: #0f0a1a;
      --bg-card: #1a1225;
      --bg-elevated: #251a35;
      --border: #3d2a5a;
      --accent-cyan: #a371f7;
      --accent-primary: #a371f7;
    }
    /* === THEME: Green (Matrix) === */
    [data-theme="green"] {
      --bg: #0a1208;
      --bg-card: #0f1a0c;
      --bg-elevated: #162212;
      --border: #2a4020;
      --accent-cyan: #3fb950;
      --accent-primary: #3fb950;
    }
    /* === THEME: Orange === */
    [data-theme="orange"] {
      --bg: #1a1008;
      --bg-card: #221508;
      --bg-elevated: #2d1c0a;
      --border: #4a3010;
      --accent-cyan: #f59e0b;
      --accent-primary: #f59e0b;
    }
    /* === THEME: Pink === */
    [data-theme="pink"] {
      --bg: #1a0a14;
      --bg-card: #22101a;
      --bg-elevated: #2d1522;
      --border: #4a2040;
      --accent-cyan: #f778ba;
      --accent-primary: #f778ba;
    }
    /* === THEME: Blue === */
    [data-theme="blue"] {
      --bg: #0a101a;
      --bg-card: #0f1622;
      --bg-elevated: #152030;
      --border: #203050;
      --accent-cyan: #3b82f6;
      --accent-primary: #3b82f6;
    }
    /* === THEME: Red === */
    [data-theme="red"] {
      --bg: #1a0a0a;
      --bg-card: #221010;
      --bg-elevated: #2d1515;
      --border: #4a2020;
      --accent-cyan: #ef4444;
      --accent-primary: #ef4444;
    }
    /* === THEME: Gold === */
    [data-theme="gold"] {
      --bg: #12100a;
      --bg-card: #1a1608;
      --bg-elevated: #221c0a;
      --border: #3d3010;
      --accent-cyan: #fbbf24;
      --accent-primary: #fbbf24;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* === TOP NAV BAR === */
    .top-nav {
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      height: 48px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      gap: 0.5rem;
    }
    .nav-logo {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent-cyan);
      margin-right: 1rem;
    }
    .nav-tabs {
      display: flex;
      gap: 0.25rem;
    }
    .nav-tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 0.875rem;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-tab:hover { background: var(--bg-elevated); color: var(--text); }
    .nav-tab.active { background: var(--accent-cyan); color: var(--bg); font-weight: 600; }
    .nav-spacer { flex: 1; }
    
    /* Theme Selector */
    .theme-selector {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--bg-elevated);
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    .theme-btn {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-btn:hover {
      transform: scale(1.2);
    }
    .theme-btn.active {
      border-color: white;
      box-shadow: 0 0 8px currentColor;
    }
    .nav-status {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
    }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
    }
    .status-dot.offline { background: var(--accent-red); }
    .nav-counter {
      background: var(--bg-elevated);
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-weight: 600;
    }
    .nav-time { color: var(--text-muted); }
    .btn-update {
      padding: 0.35rem 0.75rem;
      background: linear-gradient(135deg, #6d28d9, #8b5cf6);
      border: 1px solid #8b5cf6;
      border-radius: 6px;
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-update:hover { filter: brightness(1.2); transform: scale(1.02); }
    .btn-update.checking { animation: pulse 0.8s ease-in-out infinite; }
    @keyframes pulse { 50% { opacity: 0.6; } }
    .version-badge {
      background: var(--accent-purple);
      color: white;
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    /* === MAIN CONTAINER === */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* === STATS BAR === */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }
    .stat-value.warning { color: var(--accent-orange); }
    .stat-value.error { color: var(--accent-red); }
    .stat-value.success { color: var(--accent-green); }
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.25rem;
    }

    /* === ACTION BAR === */
    .action-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--accent-cyan); color: var(--bg); }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-secondary { background: var(--accent-purple); color: white; }
    .btn-secondary:hover { filter: brightness(1.1); }

    /* === MODULES LIST (Sistema Nervioso Style) === */
    .modules-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .modules-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .modules-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-cyan);
      border-left: 3px solid var(--accent-cyan);
      padding-left: 0.75rem;
    }
    .status-badge {
      background: var(--accent-green);
      color: var(--bg);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .status-badge::before {
      content: '';
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }
    .diagnostic-btn {
      width: 100%;
      padding: 0.75rem;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
      border: none;
      border-radius: 8px;
      color: var(--bg);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      margin-bottom: 1rem;
      transition: all 0.2s;
    }
    .diagnostic-btn:hover { filter: brightness(1.1); }
    .modules-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    /* Modules Grid Style */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }
    .module-tile {
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .module-tile:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .module-tile.connected {
      border-color: var(--accent-green);
    }
    .module-tile.connected::after {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 10px;
      height: 10px;
      background: var(--accent-green);
      border-radius: 50%;
      box-shadow: 0 0 8px var(--accent-green);
    }
    .module-tile.error {
      border-color: var(--accent-red);
    }
    .module-tile.error::after {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 10px;
      height: 10px;
      background: var(--accent-red);
      border-radius: 50%;
      animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .module-emoji {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    .module-tile-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      text-transform: capitalize;
    }
    .module-tile-status {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }
    .module-tile.connected .module-tile-status {
      color: var(--accent-green);
    }
    .module-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--bg-elevated);
      border-radius: 8px;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }
    .module-row:hover { border-color: var(--accent-cyan); }
    .module-row.selected {
      border-color: var(--accent-green);
      background: rgba(16, 185, 129, 0.1);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }
    .module-row.selected .module-dot {
      background: var(--accent-green);
      box-shadow: 0 0 8px var(--accent-green);
    }
    .module-row.streaming {
      border-color: var(--accent-red);
      background: rgba(239, 68, 68, 0.1);
    }
    .module-row.streaming::after {
      content: 'üî¥ LIVE';
      font-size: 0.65rem;
      color: var(--accent-red);
      margin-left: 0.5rem;
    }
    .camera-details {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .camera-specs {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-family: monospace;
    }
    .module-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .module-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-green);
    }
    .module-dot.error { background: var(--accent-red); }
    .module-dot.warning { background: var(--accent-orange); }
    .module-name-text { font-weight: 500; }
    .module-actions {
      display: flex;
      gap: 0.5rem;
    }
    .btn-check {
      padding: 0.35rem 0.75rem;
      background: var(--accent-cyan);
      color: var(--bg);
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-reconnect {
      padding: 0.35rem 0.75rem;
      background: var(--accent-orange);
      color: var(--bg);
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* === MODULES GRID (Icon view) === */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .module-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: all 0.2s;
      cursor: pointer;
    }
    .module-card:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-2px);
    }
    .module-card.connected { border-color: var(--accent-green); }
    .module-card.error { border-color: var(--accent-red); }
    .module-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    .module-name {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .module-status {
      font-size: 0.7rem;
      color: var(--accent-green);
    }
    .module-status.error { color: var(--accent-red); }

    /* === TAB PANELS === */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* === ACTIVITY LOG === */
    .activity-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
    }
    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .activity-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--accent-cyan);
      text-transform: uppercase;
    }
    .activity-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .activity-item {
      padding: 0.75rem;
      border-left: 3px solid var(--accent-cyan);
      background: var(--bg-elevated);
      margin-bottom: 0.5rem;
      border-radius: 0 6px 6px 0;
    }
    .activity-item.error { border-left-color: var(--accent-red); }
    .activity-item.success { border-left-color: var(--accent-green); }
    .activity-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }
    .activity-message { font-size: 0.85rem; }

    /* === CHAT PANEL === */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 250px);
      min-height: 400px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px 8px 0 0;
    }
    .chat-input-area {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 8px 8px;
    }
    .chat-input {
      flex: 1;
      padding: 0.75rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
    }
    .chat-input:focus { outline: none; border-color: var(--accent-cyan); }
    .chat-message {
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      max-width: 80%;
    }
    .chat-message.user {
      background: var(--accent-cyan);
      color: var(--bg);
      margin-left: auto;
    }
    .chat-message.assistant {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
    }

    /* === CONFIG PANEL === */
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    .config-grid-full {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }
    @media (max-width: 1400px) {
      .config-grid-full { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 900px) {
      .config-grid-full { grid-template-columns: 1fr; }
    }
    .config-status-bar {
      display: flex;
      align-items: center;
      gap: 2rem;
      padding: 0.75rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .config-status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }
    .config-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
    }
    .config-title {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--accent-purple);
    }
    .config-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      gap: 1rem;
    }
    .config-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .config-select {
      padding: 0.35rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
      min-width: 150px;
    }
    .config-select:focus {
      border-color: var(--accent-cyan);
      outline: none;
    }
    .config-select-mini {
      padding: 0.25rem 0.4rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.7rem;
      min-width: 100px;
    }
    .config-input {
      padding: 0.35rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
      width: 100%;
    }
    .config-input:focus {
      border-color: var(--accent-cyan);
      outline: none;
    }
    .config-slider {
      width: 100%;
      -webkit-appearance: none;
      height: 6px;
      background: var(--bg-elevated);
      border-radius: 3px;
      margin: 0.5rem 0;
    }
    .config-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--accent-cyan);
      border-radius: 50%;
      cursor: pointer;
    }
    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      color: var(--text-muted);
    }
    .config-textarea {
      width: 100%;
      padding: 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }
    .config-textarea:focus {
      border-color: var(--accent-cyan);
      outline: none;
    }
    .specialist-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .specialist-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem;
      background: var(--bg-elevated);
      border-radius: 4px;
    }
    .specialist-item input[type="checkbox"] {
      accent-color: var(--accent-cyan);
    }
    .specialist-item label {
      flex: 1;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .models-list {
      max-height: 200px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .model-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.4rem 0.6rem;
      background: var(--bg-elevated);
      border-radius: 4px;
      font-size: 0.8rem;
    }
    .model-item.active {
      border: 1px solid var(--accent-green);
      background: rgba(16, 185, 129, 0.1);
    }
    .model-size {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .ai-log-preview {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.5rem;
      max-height: 120px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.7rem;
    }
    .log-entry {
      padding: 0.15rem 0;
      border-bottom: 1px solid var(--border);
    }
    .log-entry:last-child { border-bottom: none; }
    .log-info { color: var(--accent-cyan); }
    .log-warn { color: var(--accent-orange); }
    .log-error { color: var(--accent-red); }
    .log-debug { color: var(--text-muted); }
    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .config-item:last-child { border-bottom: none; }
    .config-label { font-size: 0.85rem; }
    .config-select {
      padding: 0.35rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.8rem;
    }

    /* === VERSION FOOTER === */
    .version-footer {
      position: fixed;
      bottom: 0;
      right: 0;
      padding: 0.4rem 0.8rem;
      background: var(--bg-card);
      border-top-left-radius: 8px;
      border: 1px solid var(--border);
      border-right: none;
      border-bottom: none;
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .version-footer span { color: var(--accent-cyan); }

    /* === NERVOUS SYSTEM PANEL === */
    .nervous-diagram {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .nervous-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
    }
    .nervous-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-cyan);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    .nervous-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
    }
    .nervous-node {
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .nervous-node:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    .nervous-node.connected {
      border-color: var(--accent-green);
    }
    .nervous-node.connected::before {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      box-shadow: 0 0 6px var(--accent-green);
    }
    .nervous-node.error {
      border-color: var(--accent-red);
    }
    .nervous-node.error::before {
      background: var(--accent-red);
      box-shadow: 0 0 6px var(--accent-red);
      animation: pulse-red 1s infinite;
    }
    .nervous-node.active {
      border-color: var(--accent-cyan);
      background: rgba(57, 211, 196, 0.1);
      box-shadow: 0 0 15px rgba(57, 211, 196, 0.3);
    }
    .nervous-node-icon {
      font-size: 2rem;
      display: block;
      margin-bottom: 0.5rem;
    }
    .nervous-node-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      display: block;
    }
    .nervous-node-desc {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: block;
      margin-top: 0.25rem;
    }
    
    /* Signals Monitor */
    .nervous-signals-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      margin-top: 1.5rem;
    }
    .signals-monitor {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .signal-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .signal-name {
      min-width: 180px;
      font-size: 0.85rem;
      color: var(--text);
    }
    .signal-bar {
      flex: 1;
      height: 12px;
      background: var(--bg-elevated);
      border-radius: 6px;
      overflow: hidden;
    }
    .signal-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
      border-radius: 6px;
      transition: width 0.5s ease;
    }
    .signal-fill.warning {
      background: linear-gradient(90deg, var(--accent-orange), var(--accent-red));
    }
    .signal-value {
      min-width: 50px;
      text-align: right;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent-cyan);
    }
    
    /* Nervous Log */
    .nervous-log {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
    }
    .nervous-log-list {
      max-height: 150px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.8rem;
    }
    .nervous-log-entry {
      padding: 0.35rem 0.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 1rem;
    }
    .nervous-log-entry:last-child { border-bottom: none; }
    .nervous-log-entry .log-time {
      color: var(--text-muted);
      min-width: 70px;
    }
    .nervous-log-entry .log-msg {
      color: var(--text);
    }
    .nervous-log-entry.error .log-msg { color: var(--accent-red); }
    .nervous-log-entry.success .log-msg { color: var(--accent-green); }
    .nervous-log-entry.warning .log-msg { color: var(--accent-orange); }

    /* === BIT√ÅCORA CENTRAL FLOTANTE === */
    .bitacora-panel {
      position: fixed;
      bottom: 60px;
      right: 20px;
      width: 400px;
      max-height: 400px;
      background: var(--bg-card);
      border: 2px solid var(--accent-cyan);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    .bitacora-panel.minimized {
      max-height: 45px;
      overflow: hidden;
    }
    .bitacora-panel.expanded {
      width: 600px;
      max-height: 600px;
    }
    .bitacora-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: linear-gradient(90deg, var(--bg-elevated), var(--bg-card));
      border-bottom: 1px solid var(--border);
      border-radius: 10px 10px 0 0;
      cursor: move;
    }
    .bitacora-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--accent-cyan);
    }
    .bitacora-controls {
      display: flex;
      gap: 0.25rem;
    }
    .bitacora-btn {
      background: transparent;
      border: none;
      font-size: 0.8rem;
      cursor: pointer;
      padding: 0.25rem 0.4rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .bitacora-btn:hover {
      background: var(--bg-elevated);
    }
    .bitacora-filters {
      display: flex;
      gap: 0.25rem;
      padding: 0.5rem;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .bitacora-filter {
      padding: 0.25rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .bitacora-filter:hover, .bitacora-filter.active {
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }
    .bitacora-content {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
      max-height: 280px;
    }
    .bitacora-panel.expanded .bitacora-content {
      max-height: 480px;
    }
    .bitacora-entry {
      display: flex;
      gap: 0.5rem;
      padding: 0.4rem 0.5rem;
      border-radius: 4px;
      margin-bottom: 0.25rem;
      font-size: 0.8rem;
      background: var(--bg-elevated);
      border-left: 3px solid var(--accent-cyan);
      animation: slideIn 0.2s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .bitacora-entry.success { border-left-color: var(--accent-green); }
    .bitacora-entry.error { border-left-color: var(--accent-red); }
    .bitacora-entry.warning { border-left-color: var(--accent-orange); }
    .bitacora-entry.brain { border-left-color: var(--accent-purple); }
    .bitacora-entry.vision { border-left-color: var(--accent-pink); }
    .bitacora-entry.nervous { border-left-color: var(--accent-orange); }
    .bitacora-time {
      color: var(--text-muted);
      font-size: 0.7rem;
      min-width: 60px;
      font-family: monospace;
    }
    .bitacora-source {
      font-size: 0.75rem;
      min-width: 20px;
    }
    .bitacora-msg {
      flex: 1;
      color: var(--text);
      word-break: break-word;
    }
    .bitacora-stats {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      font-size: 0.7rem;
      color: var(--text-muted);
      border-top: 1px solid var(--border);
      background: var(--bg-elevated);
      border-radius: 0 0 10px 10px;
    }
    .bitacora-toggle-btn {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background: var(--accent-cyan);
      color: var(--bg);
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .bitacora-toggle-btn:hover {
      filter: brightness(1.1);
    }
    #bitacora-badge {
      background: var(--accent-red);
      color: white;
      padding: 0.1rem 0.4rem;
      border-radius: 10px;
      font-size: 0.7rem;
      margin-left: 0.25rem;
    }
  </style>
</head>
<body>
  <!-- TOP NAVIGATION -->
  <nav class="top-nav">
    <div class="nav-logo">ATLAS</div>
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="chat">Chat</button>
      <button class="nav-tab" data-tab="modulos">Modulos</button>
      <button class="nav-tab" data-tab="gobernanza">Gobernanza</button>
      <button class="nav-tab" data-tab="config">Config IA</button>
      <button class="nav-tab" data-tab="vision">üëÅ Vision</button>
      <button class="nav-tab" data-tab="nervioso">üîó Nervioso</button>
      <button class="nav-tab" data-tab="comms">üì± Comms</button>
      <button class="nav-tab" data-tab="tutorias">üìã Tutor√≠as</button>
    </div>
    <div class="nav-spacer"></div>
    <div class="nav-status">
      <!-- Selector de Tema -->
      <div class="theme-selector">
        <button class="theme-btn" data-theme="cyan" title="Cyan" style="background: #39d3c4;"></button>
        <button class="theme-btn" data-theme="purple" title="Purple" style="background: #a371f7;"></button>
        <button class="theme-btn" data-theme="green" title="Matrix" style="background: #3fb950;"></button>
        <button class="theme-btn" data-theme="blue" title="Blue" style="background: #3b82f6;"></button>
        <button class="theme-btn" data-theme="orange" title="Orange" style="background: #f59e0b;"></button>
        <button class="theme-btn" data-theme="pink" title="Pink" style="background: #f778ba;"></button>
        <button class="theme-btn" data-theme="red" title="Red" style="background: #ef4444;"></button>
        <button class="theme-btn" data-theme="gold" title="Gold" style="background: #fbbf24;"></button>
      </div>
      <!-- Bot√≥n Actualizar -->
      <button class="btn-update" id="btn-check-update" onclick="checkForUpdates()" title="Buscar actualizaciones">üîÑ Actualizar</button>
      <!-- Badge de versi√≥n -->
      <div class="version-badge" id="version-badge">v3.7.0</div>
      <div class="status-indicator">
        <div class="status-dot" id="cerebro-dot"></div>
        <span>Cerebro</span>
      </div>
      <div class="nav-counter" id="modules-counter">0/15</div>
      <div class="nav-time" id="current-time">00:00:00</div>
    </div>
  </nav>

  <div class="main-container">
    <!-- ========== TAB: CHAT ========== -->
    <div class="tab-panel active" id="panel-chat">
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="chat-message assistant">
            Hola, soy ATLAS. Estoy conectado al Brain Coordinator y listo para ayudarte. Puedes escribir comandos como /status, /help o simplemente hablarme.
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="chat-input" placeholder="Escribe un mensaje o comando..." />
          <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
        </div>
      </div>
      <div class="activity-section">
        <div class="activity-header">
          <span class="activity-title">ACTIVIDAD</span>
          <button class="btn btn-secondary" onclick="clearActivity()">Limpiar</button>
        </div>
        <div class="activity-list" id="activity-list"></div>
      </div>
    </div>

    <!-- ========== TAB: MODULOS ========== -->
    <div class="tab-panel" id="panel-modulos">
      <!-- Header con badge operativo -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: 600;">ATLAS Sistema Nervioso</h2>
        <div class="status-badge" id="system-status-badge">100% OPERATIVO</div>
      </div>

      <!-- M√≥dulos del Cuerpo -->
      <div class="modules-section">
        <div class="modules-header">
          <span class="modules-title">MODULOS DEL CUERPO</span>
          <button class="diagnostic-btn" onclick="runFullDiagnostic()" style="margin: 0;">üî¨ DIAGN√ìSTICO</button>
        </div>
        <div class="modules-grid" id="modules-grid">
          <!-- Se llena din√°micamente -->
        </div>
      </div>

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value success" id="stat-connected">15</div>
          <div class="stat-label">CONECTADOS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total">15</div>
          <div class="stat-label">TOTAL</div>
        </div>
        <div class="stat-card">
          <div class="stat-value success" id="stat-health">100%</div>
          <div class="stat-label">SALUD</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-signals">0</div>
          <div class="stat-label">SE√ëALES</div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-primary" onclick="checkAllModules()">Check All</button>
        <button class="btn btn-secondary" onclick="runDiagnostic()">Diagn√≥stico</button>
      </div>

      <div class="modules-grid" id="modules-grid"></div>

      <div class="activity-section">
        <div class="activity-header">
          <span class="activity-title">ACTIVIDAD</span>
          <button class="btn btn-secondary" onclick="clearActivity()">Limpiar</button>
        </div>
        <div class="activity-list" id="modules-activity-list"></div>
      </div>
    </div>

    <!-- ========== TAB: GOBERNANZA ========== -->
    <div class="tab-panel" id="panel-gobernanza">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value" id="gov-mode">GOVERNED</div>
          <div class="stat-label">MODO ACTUAL</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="gov-approvals">0</div>
          <div class="stat-label">APROBACIONES PENDIENTES</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="gov-policies">5</div>
          <div class="stat-label">POL√çTICAS ACTIVAS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="gov-score">100</div>
          <div class="stat-label">SCORE SEGURIDAD</div>
        </div>
      </div>
      <div class="action-bar">
        <button class="btn btn-primary" onclick="setGovMode('growth')">GROWTH</button>
        <button class="btn btn-secondary" onclick="setGovMode('governed')">GOVERNED</button>
        <button class="btn" style="background: var(--accent-red); color: white;" onclick="emergencyStop()">EMERGENCY STOP</button>
      </div>
    </div>

    <!-- ========== TAB: CONFIG IA ========== -->
    <div class="tab-panel" id="panel-config">
      <!-- Estado de conexi√≥n -->
      <div class="config-status-bar">
        <div class="config-status-item">
          <span class="status-dot" id="ai-status-dot"></span>
          <span id="ai-status-text">Conectando...</span>
        </div>
        <div class="config-status-item">
          <span style="color: var(--text-muted);">Latencia:</span>
          <span id="ai-latency">--</span>ms
        </div>
        <div class="config-status-item">
          <span style="color: var(--text-muted);">Tokens usados hoy:</span>
          <span id="ai-tokens-used">0</span>
        </div>
        <button class="btn btn-primary" onclick="testAIConnection()" style="margin-left: auto;">üîå Test Conexi√≥n</button>
        <button class="btn btn-secondary" onclick="saveAIConfig()">üíæ Guardar Config</button>
      </div>

      <div class="config-grid-full">
        <!-- Columna 1: Proveedor y Modelo -->
        <div class="config-card">
          <div class="config-title">üß† Proveedor de IA</div>
          <div class="config-item">
            <span class="config-label">Modo de Operaci√≥n</span>
            <select class="config-select" id="ai-mode" onchange="onAIModeChange()">
              <option value="auto">ü§ñ Autom√°tico (Cerebro decide)</option>
              <option value="local">üíª Solo Local (Ollama)</option>
              <option value="cloud">‚òÅÔ∏è Solo Cloud (API)</option>
              <option value="hybrid">üîÑ H√≠brido (Local + Fallback Cloud)</option>
            </select>
          </div>
          <div class="config-item">
            <span class="config-label">Proveedor Principal</span>
            <select class="config-select" id="ai-provider" onchange="onProviderChange()">
              <option value="ollama">ü¶ô Ollama (Local)</option>
              <option value="deepseek">üîÆ DeepSeek</option>
              <option value="openai">üü¢ OpenAI</option>
              <option value="anthropic">üü£ Anthropic Claude</option>
              <option value="gemini">üîµ Google Gemini</option>
              <option value="groq">‚ö° Groq</option>
              <option value="mistral">üåÄ Mistral AI</option>
              <option value="cohere">üü† Cohere</option>
            </select>
          </div>
          <div class="config-item">
            <span class="config-label">Modelo</span>
            <select class="config-select" id="ai-model">
              <!-- Se llena din√°micamente seg√∫n proveedor -->
            </select>
          </div>
          <div class="config-item" id="ollama-url-item">
            <span class="config-label">URL Ollama</span>
            <input type="text" class="config-input" id="ollama-url" value="http://localhost:11434" placeholder="http://localhost:11434">
          </div>
          <div class="config-item" id="api-key-item" style="display: none;">
            <span class="config-label">API Key</span>
            <div style="display: flex; gap: 0.5rem;">
              <input type="password" class="config-input" id="ai-api-key" placeholder="sk-..." style="flex: 1;">
              <button class="btn btn-secondary" onclick="toggleApiKeyVisibility()" style="padding: 0.25rem 0.5rem;">üëÅ</button>
            </div>
          </div>
        </div>

        <!-- Columna 2: Par√°metros de Generaci√≥n -->
        <div class="config-card">
          <div class="config-title">‚öôÔ∏è Par√°metros de Generaci√≥n</div>
          <div class="config-item">
            <span class="config-label">Temperatura <span id="temp-value">0.7</span></span>
            <input type="range" class="config-slider" id="ai-temperature" min="0" max="200" value="70" oninput="updateSliderValue('temperature')">
            <div class="slider-labels"><span>Preciso</span><span>Creativo</span></div>
          </div>
          <div class="config-item">
            <span class="config-label">Top P <span id="top-p-value">0.9</span></span>
            <input type="range" class="config-slider" id="ai-top-p" min="0" max="100" value="90" oninput="updateSliderValue('top-p')">
          </div>
          <div class="config-item">
            <span class="config-label">Top K <span id="top-k-value">40</span></span>
            <input type="range" class="config-slider" id="ai-top-k" min="1" max="100" value="40" oninput="updateSliderValue('top-k')">
          </div>
          <div class="config-item">
            <span class="config-label">Max Tokens</span>
            <input type="number" class="config-input" id="ai-max-tokens" value="2048" min="128" max="32768">
          </div>
          <div class="config-item">
            <span class="config-label">Repeat Penalty <span id="repeat-penalty-value">1.1</span></span>
            <input type="range" class="config-slider" id="ai-repeat-penalty" min="100" max="200" value="110" oninput="updateSliderValue('repeat-penalty')">
          </div>
        </div>

        <!-- Columna 3: Contexto y Sistema -->
        <div class="config-card">
          <div class="config-title">üìù Contexto del Sistema</div>
          <div class="config-item" style="flex-direction: column; align-items: stretch;">
            <span class="config-label">System Prompt</span>
            <textarea class="config-textarea" id="ai-system-prompt" rows="4" placeholder="Eres ATLAS, un asistente de IA...">Eres ATLAS, un sistema de inteligencia artificial avanzado. Responde de forma concisa, precisa y √∫til. Tienes acceso a m√≥dulos de visi√≥n, memoria, an√°lisis y control.</textarea>
          </div>
          <div class="config-item">
            <span class="config-label">Contexto de Memoria</span>
            <select class="config-select" id="ai-memory-context">
              <option value="none">Sin memoria</option>
              <option value="session">Solo sesi√≥n actual</option>
              <option value="short">Corto plazo (√∫ltimas 10 conversaciones)</option>
              <option value="long" selected>Largo plazo (memoria persistente)</option>
            </select>
          </div>
          <div class="config-item">
            <span class="config-label">Ventana de Contexto</span>
            <input type="number" class="config-input" id="ai-context-window" value="8192" min="1024" max="128000">
          </div>
        </div>

        <!-- Columna 4: Especialistas IA -->
        <div class="config-card">
          <div class="config-title">üéØ Especialistas IA (Modo Auto)</div>
          <div class="specialist-list" id="specialist-list">
            <div class="specialist-item">
              <input type="checkbox" id="spec-code" checked>
              <label for="spec-code">üíª C√≥digo</label>
              <select class="config-select-mini" id="spec-code-model">
                <option value="deepseek-coder">deepseek-coder</option>
                <option value="codellama">codellama</option>
                <option value="gpt-4">gpt-4</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-vision" checked>
              <label for="spec-vision">üëÅÔ∏è Visi√≥n</label>
              <select class="config-select-mini" id="spec-vision-model">
                <option value="llava">llava</option>
                <option value="gpt-4-vision">gpt-4-vision</option>
                <option value="gemini-pro-vision">gemini-pro-vision</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-chat" checked>
              <label for="spec-chat">üí¨ Chat</label>
              <select class="config-select-mini" id="spec-chat-model">
                <option value="llama3.2" selected>llama3.2</option>
                <option value="mistral">mistral</option>
                <option value="claude-3">claude-3</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-analysis" checked>
              <label for="spec-analysis">üìä An√°lisis</label>
              <select class="config-select-mini" id="spec-analysis-model">
                <option value="llama3.2">llama3.2</option>
                <option value="mixtral">mixtral</option>
              </select>
            </div>
            <div class="specialist-item">
              <input type="checkbox" id="spec-creative">
              <label for="spec-creative">üé® Creativo</label>
              <select class="config-select-mini" id="spec-creative-model">
                <option value="llama3.2">llama3.2</option>
                <option value="claude-3">claude-3</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Columna 5: Modelos Disponibles -->
        <div class="config-card">
          <div class="config-title">üì¶ Modelos Disponibles (Ollama)</div>
          <div class="models-list" id="ollama-models-list">
            <div style="color: var(--text-muted); text-align: center; padding: 1rem;">
              Cargando modelos...
            </div>
          </div>
          <button class="btn btn-secondary" onclick="refreshOllamaModels()" style="width: 100%; margin-top: 0.5rem;">üîÑ Actualizar Lista</button>
          <button class="btn" onclick="pullOllamaModel()" style="width: 100%; margin-top: 0.5rem; background: var(--accent-purple); color: white;">‚¨áÔ∏è Descargar Modelo</button>
        </div>

        <!-- Columna 6: Logs y Debug -->
        <div class="config-card">
          <div class="config-title">üîß Debug & Logs</div>
          <div class="config-item">
            <span class="config-label">Nivel de Log</span>
            <select class="config-select" id="ai-log-level">
              <option value="error">Solo Errores</option>
              <option value="warn">Advertencias</option>
              <option value="info" selected>Info</option>
              <option value="debug">Debug</option>
              <option value="trace">Trace (Verboso)</option>
            </select>
          </div>
          <div class="config-item">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="ai-stream-response" checked>
              <span>Respuesta en Streaming</span>
            </label>
          </div>
          <div class="config-item">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="ai-save-history" checked>
              <span>Guardar historial</span>
            </label>
          </div>
          <div class="config-item">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="ai-show-thinking">
              <span>Mostrar "pensamiento"</span>
            </label>
          </div>
          <div class="ai-log-preview" id="ai-log-preview">
            <div class="log-entry log-info">[INFO] Sistema listo</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== TAB: VISION ========== -->
    <div class="tab-panel" id="panel-vision">
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value" id="vision-cameras">3</div>
          <div class="stat-label">C√ÅMARAS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-active">1</div>
          <div class="stat-label">ACTIVAS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-fps">30</div>
          <div class="stat-label">FPS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="vision-detections">0</div>
          <div class="stat-label">DETECCIONES</div>
        </div>
      </div>

      <!-- C√°maras disponibles -->
      <div class="modules-section">
        <div class="modules-header">
          <span class="modules-title">C√ÅMARAS DISPONIBLES</span>
          <button class="btn btn-primary" onclick="scanCameras()" style="font-size: 0.8rem;">üîÑ Escanear</button>
        </div>
        <div class="modules-list" id="cameras-list">
          <div class="module-row" data-cam-id="0">
            <div class="module-info">
              <div class="module-dot"></div>
              <div class="camera-details">
                <span class="module-name-text">üëÅÔ∏è NexiGo N930W IR</span>
                <span class="camera-specs">1920x1080 @ 30fps</span>
              </div>
            </div>
            <div class="module-actions">
              <button class="btn-check" onclick="selectCamera(0, event)">SELECCIONAR</button>
              <button class="btn-reconnect" onclick="streamCamera(0, event)">üî¥ STREAM</button>
            </div>
          </div>
          <div class="module-row" data-cam-id="1">
            <div class="module-info">
              <div class="module-dot"></div>
              <div class="camera-details">
                <span class="module-name-text">üìπ NexiGo N930W</span>
                <span class="camera-specs">1920x1080 @ 30fps</span>
              </div>
            </div>
            <div class="module-actions">
              <button class="btn-check" onclick="selectCamera(1, event)">SELECCIONAR</button>
              <button class="btn-reconnect" onclick="streamCamera(1, event)">üî¥ STREAM</button>
            </div>
          </div>
          <div class="module-row" data-cam-id="2">
            <div class="module-info">
              <div class="module-dot"></div>
              <div class="camera-details">
                <span class="module-name-text">üé• Insta360 Link 2</span>
                <span class="camera-specs">3840x2160 @ 30fps</span>
              </div>
            </div>
            <div class="module-actions">
              <button class="btn-check" onclick="selectCamera(2, event)">SELECCIONAR</button>
              <button class="btn-reconnect" onclick="streamCamera(2, event)">üî¥ STREAM</button>
            </div>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-primary" onclick="captureSnapshot()">üì∑ Capturar</button>
        <button class="btn btn-secondary" onclick="startStreamSelected()">üé• Stream Permanente</button>
        <button class="btn" onclick="stopStream()" style="background: var(--accent-red); color: white;">‚èπÔ∏è Detener</button>
        <button class="btn" onclick="detectFaces()" style="background: var(--accent-purple); color: white;">üë§ Detectar Rostros</button>
        <button class="btn" onclick="readTextOCR()" style="background: var(--accent-orange); color: var(--bg);">üìù OCR</button>
      </div>

      <!-- Vista previa -->
      <div style="background: var(--bg-card); border: 2px solid var(--accent-cyan); border-radius: 12px; padding: 1rem; margin-top: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <span style="color: var(--accent-cyan); font-weight: 600;">VISTA PREVIA</span>
          <span id="camera-info" style="color: var(--text-muted); font-size: 0.8rem;">Ninguna c√°mara seleccionada</span>
        </div>
        <div id="vision-preview" style="background: var(--bg); border-radius: 8px; min-height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
          <div style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üì∑</div>
            <div>Selecciona una c√°mara para ver la vista previa</div>
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
          <span id="detection-results" style="color: var(--text-muted); font-size: 0.8rem;"></span>
        </div>
      </div>
    </div>

    <!-- ========== TAB: NERVIOSO ========== -->
    <div class="tab-panel" id="panel-nervioso">
      <!-- Header con estado general -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: 600;">üß† Arquitectura Cognitiva Atlas</h2>
        <div class="status-badge" id="nervous-main-status">OPERATIVO</div>
      </div>

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value success" id="nervous-status">OK</div>
          <div class="stat-label">ESTADO</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-signals">0</div>
          <div class="stat-label">SE√ëALES/MIN</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-latency">12</div>
          <div class="stat-label">LATENCIA (ms)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-uptime">99.9%</div>
          <div class="stat-label">UPTIME</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-goals">0</div>
          <div class="stat-label">GOALS ACTIVOS</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="nervous-memory">0</div>
          <div class="stat-label">EPISODIOS</div>
        </div>
      </div>

      <!-- Diagrama de Arquitectura Cognitiva -->
      <div class="nervous-diagram">
        <!-- CORTEX -->
        <div class="nervous-section">
          <div class="nervous-section-title">üß† Cortex (Procesamiento Cognitivo)</div>
          <div class="nervous-grid">
            <div class="nervous-node connected" id="node-frontal" onclick="inspectCognitiveNode('cortex/frontal')">
              <span class="nervous-node-icon">üéØ</span>
              <span class="nervous-node-name">Frontal</span>
              <span class="nervous-node-desc">Planificaci√≥n y decisi√≥n</span>
              <div class="node-modules" id="frontal-modules">
                <span class="mini-module">TaskPlanner</span>
                <span class="mini-module">DecisionMaker</span>
                <span class="mini-module">InhibitoryControl</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-parietal" onclick="inspectCognitiveNode('cortex/parietal')">
              <span class="nervous-node-icon">üó∫Ô∏è</span>
              <span class="nervous-node-name">Parietal</span>
              <span class="nervous-node-desc">Fusi√≥n sensorial</span>
              <div class="node-modules" id="parietal-modules">
                <span class="mini-module">SensoryFusion</span>
                <span class="mini-module">SpatialMap</span>
                <span class="mini-module">BodySchema</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-temporal" onclick="inspectCognitiveNode('cortex/temporal')">
              <span class="nervous-node-icon">üëÇ</span>
              <span class="nervous-node-name">Temporal</span>
              <span class="nervous-node-desc">Audio y lenguaje</span>
              <div class="node-modules" id="temporal-modules">
                <span class="mini-module">AudioProcessor</span>
                <span class="mini-module">LanguageUnderstanding</span>
                <span class="mini-module">EpisodicRecall</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-occipital" onclick="inspectCognitiveNode('cortex/occipital')">
              <span class="nervous-node-icon">üëÅÔ∏è</span>
              <span class="nervous-node-name">Occipital</span>
              <span class="nervous-node-desc">Visi√≥n y profundidad</span>
              <div class="node-modules" id="occipital-modules">
                <span class="mini-module">VisionPipeline</span>
                <span class="mini-module">DepthEstimation</span>
                <span class="mini-module">ObjectRecognition</span>
              </div>
            </div>
          </div>
        </div>

        <!-- SISTEMAS SUBCORTICALES -->
        <div class="nervous-section">
          <div class="nervous-section-title">üíú Sistemas Subcorticales</div>
          <div class="nervous-grid">
            <div class="nervous-node connected" id="node-limbic" onclick="inspectCognitiveNode('limbic')">
              <span class="nervous-node-icon">‚ù§Ô∏è</span>
              <span class="nervous-node-name">Sistema L√≠mbico</span>
              <span class="nervous-node-desc">Motivaci√≥n y emociones</span>
              <div class="node-modules" id="limbic-modules">
                <span class="mini-module">GoalManager</span>
                <span class="mini-module">RewardEngine</span>
                <span class="mini-module">StateRegulator</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-hippo" onclick="inspectCognitiveNode('hippo')">
              <span class="nervous-node-icon">üß©</span>
              <span class="nervous-node-name">Hipocampo</span>
              <span class="nervous-node-desc">Memoria epis√≥dica</span>
              <div class="node-modules" id="hippo-modules">
                <span class="mini-module">EpisodicMemory</span>
                <span class="mini-module">SemanticMemory</span>
                <span class="mini-module">Consolidator</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-basal" onclick="inspectCognitiveNode('basal')">
              <span class="nervous-node-icon">‚ö°</span>
              <span class="nervous-node-name">Ganglios Basales</span>
              <span class="nervous-node-desc">Selecci√≥n de acciones</span>
              <div class="node-modules" id="basal-modules">
                <span class="mini-module">ActionSelector</span>
                <span class="mini-module">Inhibitor</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-learning" onclick="inspectCognitiveNode('learning')">
              <span class="nervous-node-icon">üìö</span>
              <span class="nervous-node-name">Aprendizaje</span>
              <span class="nervous-node-desc">LfD, RL, NL Feedback</span>
              <div class="node-modules" id="learning-modules">
                <span class="mini-module">Demonstration</span>
                <span class="mini-module">Reinforcement</span>
                <span class="mini-module">NLFeedback</span>
              </div>
            </div>
          </div>
        </div>

        <!-- SISTEMAS VITALES -->
        <div class="nervous-section">
          <div class="nervous-section-title">ü©∫ Sistemas Vitales y Control</div>
          <div class="nervous-grid">
            <div class="nervous-node connected" id="node-brainstem" onclick="inspectCognitiveNode('brainstem')">
              <span class="nervous-node-icon">ü´Ä</span>
              <span class="nervous-node-name">Tronco Encef√°lico</span>
              <span class="nervous-node-desc">Funciones vitales</span>
              <div class="node-modules" id="brainstem-modules">
                <span class="mini-module">VitalsMonitor</span>
                <span class="mini-module">SafetyPolicy</span>
                <span class="mini-module">GlobalState</span>
                <span class="mini-module">Watchdog</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-medulla" onclick="inspectCognitiveNode('medulla')">
              <span class="nervous-node-icon">üîå</span>
              <span class="nervous-node-name">M√©dula Atlas</span>
              <span class="nervous-node-desc">Bus de comunicaci√≥n</span>
              <div class="node-modules" id="medulla-modules">
                <span class="mini-module">ZeroMQ Bus</span>
                <span class="mini-module">SharedState</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-motor" onclick="inspectCognitiveNode('motor')">
              <span class="nervous-node-icon">ü¶æ</span>
              <span class="nervous-node-name">Control Motor</span>
              <span class="nervous-node-desc">Trayectorias y PID</span>
              <div class="node-modules" id="motor-modules">
                <span class="mini-module">TrajectoryPlanner</span>
                <span class="mini-module">MotorController</span>
                <span class="mini-module">MotorInterface</span>
              </div>
            </div>
            <div class="nervous-node connected" id="node-snp" onclick="inspectCognitiveNode('snp')">
              <span class="nervous-node-icon">üåê</span>
              <span class="nervous-node-name">SNP (Sensores)</span>
              <span class="nervous-node-desc">Drivers hardware</span>
              <div class="node-modules" id="snp-modules">
                <span class="mini-module">Vision</span>
                <span class="mini-module">Audio</span>
                <span class="mini-module">IMU</span>
                <span class="mini-module">F/T</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel de Se√±ales en Tiempo Real -->
      <div class="nervous-signals-panel">
        <div class="nervous-section-title">üìä M√≥dulos en Tiempo Real</div>
        <div class="signals-monitor">
          <div class="signal-row">
            <span class="signal-name">üß† Cortex Frontal</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-frontal" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-frontal-val">--</span>
          </div>
          <div class="signal-row">
            <span class="signal-name">üëÅÔ∏è Cortex Occipital</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-occipital" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-occipital-val">--</span>
          </div>
          <div class="signal-row">
            <span class="signal-name">‚ù§Ô∏è Sistema L√≠mbico</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-limbic" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-limbic-val">--</span>
          </div>
          <div class="signal-row">
            <span class="signal-name">üß© Hipocampo</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-hippo" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-hippo-val">--</span>
          </div>
          <div class="signal-row">
            <span class="signal-name">ü´Ä Brainstem</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-brainstem" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-brainstem-val">--</span>
          </div>
          <div class="signal-row">
            <span class="signal-name">ü¶æ Motor Control</span>
            <div class="signal-bar">
              <div class="signal-fill cognitive-signal" id="signal-motor-ctrl" style="width: 0%;"></div>
            </div>
            <span class="signal-value" id="signal-motor-ctrl-val">--</span>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="action-bar" style="margin-top: 1rem;">
        <button class="btn btn-primary" onclick="refreshCognitive()">üîÑ Actualizar</button>
        <button class="btn btn-secondary" onclick="cognitiveDiagnostic()">üî¨ Diagn√≥stico Completo</button>
        <button class="btn" onclick="connectCognitiveWS()" style="background: var(--accent-purple); color: white;">üì° WebSocket Live</button>
        <button class="btn" onclick="showGoals()" style="background: var(--accent-orange); color: var(--bg);">üéØ Ver Goals</button>
        <button class="btn" onclick="showMemories()" style="background: var(--accent-green); color: var(--bg);">üß© Ver Memorias</button>
      </div>

      <!-- Log de eventos del sistema nervioso -->
      <div class="nervous-log" style="margin-top: 1rem;">
        <div class="nervous-section-title">üìã Log de Eventos Cognitivos</div>
        <div class="nervous-log-list" id="nervous-log-list">
          <div class="nervous-log-entry">
            <span class="log-time">--:--:--</span>
            <span class="log-msg">Sistema cognitivo Atlas inicializado</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: COMUNICACIONES -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-panel" id="panel-comms">
      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: 600;">üì± Centro de Comunicaciones</h2>
        <div class="status-badge" id="comms-status">VERIFICANDO...</div>
      </div>

      <!-- Stats Bar -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
        <div class="metric-card">
          <div class="metric-label">WhatsApp</div>
          <div class="metric-value" id="comms-whatsapp-status" style="color: var(--accent-cyan);">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Telegram</div>
          <div class="metric-value" id="comms-telegram-status" style="color: var(--accent-cyan);">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Audio TTS</div>
          <div class="metric-value" id="comms-audio-status" style="color: var(--accent-cyan);">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Mensajes Hoy</div>
          <div class="metric-value" id="comms-messages-today" style="color: var(--accent-green);">--</div>
        </div>
      </div>

      <!-- Action Bar -->
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
        <button class="action-btn" onclick="refreshCommsStatus()">üîÑ Actualizar Estado</button>
        <button class="action-btn" onclick="openWahaDashboard()">üåê WAHA Dashboard</button>
        <button class="action-btn" onclick="showQRCode()">üì∑ Mostrar QR</button>
        <button class="action-btn" onclick="testAllComms()">üß™ Test Canales</button>
      </div>

      <!-- Main Grid -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <!-- WhatsApp Card -->
        <div class="card" style="padding: 1.5rem;">
          <h3 style="color: var(--accent-green); margin-bottom: 1rem;">üí¨ WhatsApp (WAHA)</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Estado:</span>
              <span id="waha-connection-status">--</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Sesi√≥n:</span>
              <span id="waha-session-name">default</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Tel√©fono:</span>
              <span id="waha-phone-number">--</span>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
              <button class="action-btn" style="flex: 1;" onclick="restartWahaSession()">üîÑ Reiniciar Sesi√≥n</button>
              <button class="action-btn" style="flex: 1;" onclick="testWhatsApp()">üß™ Test</button>
            </div>
            <!-- QR Container -->
            <div id="waha-qr-container" style="display: none; text-align: center; padding: 1rem; background: #fff; border-radius: 8px; margin-top: 0.5rem;">
              <img id="waha-qr-image" style="max-width: 200px;" alt="QR WhatsApp"/>
              <p style="color: #333; font-size: 0.8rem; margin-top: 0.5rem;">Escanea con WhatsApp</p>
            </div>
          </div>
        </div>

        <!-- Telegram Card -->
        <div class="card" style="padding: 1.5rem;">
          <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">üì® Telegram</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Estado:</span>
              <span id="telegram-connection-status">--</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Token:</span>
              <span id="telegram-token-status">--</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Chat ID:</span>
              <span id="telegram-chat-id">--</span>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
              <button class="action-btn" style="flex: 1;" onclick="testTelegram()">üß™ Test Mensaje</button>
            </div>
          </div>
        </div>

        <!-- Audio & Voice Card -->
        <div class="card" style="padding: 1.5rem;">
          <h3 style="color: var(--accent-orange); margin-bottom: 1rem;">üé§ Audio & Voz Interactiva</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">TTS:</span>
              <span id="audio-connection-status">--</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Motor:</span>
              <span id="audio-engine">pyttsx3</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-muted);">Asistente:</span>
              <span id="voice-assistant-status">--</span>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
              <button class="action-btn" style="flex: 1;" onclick="testAudio()">üß™ Test</button>
              <button class="action-btn" style="flex: 1;" id="voice-toggle-btn" onclick="toggleVoiceAssistant()">üé§ Iniciar Voz</button>
            </div>
            <div style="margin-top: 0.5rem;">
              <input type="text" id="speak-text-input" placeholder="Escribe para que ATLAS hable..." 
                     style="width: 100%; padding: 0.5rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              <button class="action-btn" style="width: 100%; margin-top: 0.5rem;" onclick="speakCustomText()">üîä Hablar</button>
            </div>
          </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="card" style="padding: 1.5rem;">
          <h3 style="color: var(--accent-cyan); margin-bottom: 1rem;">‚ö° Acciones R√°pidas</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <button class="action-btn" onclick="sendTestAll()">üì¢ Notificar en Todos los Canales</button>
            <button class="action-btn" onclick="showQRCode()">üì∑ Mostrar QR de WhatsApp</button>
            <button class="action-btn" onclick="reconnectAllComms()">üîå Reconectar Servicios</button>
          </div>
        </div>
      </div>

      <!-- Bit√°cora de Comunicaciones -->
      <div class="card" style="padding: 1.5rem; margin-top: 1.5rem;">
        <h3 style="color: var(--accent-cyan); margin-bottom: 1rem;">üìã Bit√°cora de Comunicaciones</h3>
        <div id="comms-activity-list" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
          <p style="color: var(--text-muted);">Cargando eventos...</p>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: TUTOR√çAS Y VISITAS -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-panel" id="panel-tutorias">
      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: 600;">üìã Sistema de Tutor√≠as y Visitas</h2>
        <div class="status-badge" id="tutorias-status">ACTIVO</div>
      </div>

      <!-- Estad√≠sticas r√°pidas -->
      <div class="ai-config-grid" style="margin-bottom: 1.5rem;">
        <div class="ai-config-card">
          <h3>üë§ Especialistas</h3>
          <div style="text-align: center; padding: 1rem;">
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent-cyan);" id="tut-stat-especialistas">0</div>
            <div style="color: var(--text-muted);">Registrados</div>
          </div>
        </div>
        <div class="ai-config-card">
          <h3>üìÖ Visitas</h3>
          <div style="text-align: center; padding: 1rem;">
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent-green);" id="tut-stat-visitas">0</div>
            <div style="color: var(--text-muted);">Realizadas</div>
          </div>
        </div>
        <div class="ai-config-card">
          <h3>üìù Informes</h3>
          <div style="text-align: center; padding: 1rem;">
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent-purple);" id="tut-stat-informes">0</div>
            <div style="color: var(--text-muted);">Firmados</div>
          </div>
        </div>
        <div class="ai-config-card">
          <h3>‚≠ê Puntuaci√≥n</h3>
          <div style="text-align: center; padding: 1rem;">
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent-orange);" id="tut-stat-puntuacion">0.0</div>
            <div style="color: var(--text-muted);">Promedio</div>
          </div>
        </div>
      </div>

      <!-- Registrar Especialista -->
      <div class="ai-config-card" style="margin-bottom: 1rem;">
        <h3>üë§ Registrar Nuevo Especialista</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Nombre</label>
            <input type="text" id="esp-nombre" placeholder="Nombre completo" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Rol</label>
            <select id="esp-rol" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
              <option value="Arquitecto de IA">Arquitecto de IA</option>
              <option value="Desarrollador Senior">Desarrollador Senior</option>
              <option value="QA Engineer">QA Engineer</option>
              <option value="DevOps">DevOps</option>
              <option value="Data Scientist">Data Scientist</option>
              <option value="Security Analyst">Security Analyst</option>
              <option value="UX Designer">UX Designer</option>
              <option value="Project Manager">Project Manager</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Especialidad</label>
            <input type="text" id="esp-especialidad" placeholder="Ej: Vision, NLP, Robotics" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Email</label>
            <input type="email" id="esp-email" placeholder="email@ejemplo.com" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
        </div>
        <div style="padding: 0 1rem 1rem;">
          <button class="btn btn-primary" onclick="registrarEspecialista()">‚ûï Registrar Especialista</button>
        </div>
      </div>

      <!-- Lista de Especialistas -->
      <div class="ai-config-card" style="margin-bottom: 1rem;">
        <h3>üë• Especialistas Registrados</h3>
        <div id="lista-especialistas" style="padding: 1rem; max-height: 200px; overflow-y: auto;">
          <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
            Cargando especialistas...
          </div>
        </div>
      </div>

      <!-- Iniciar Nueva Visita -->
      <div class="ai-config-card" style="margin-bottom: 1rem;">
        <h3>üìÖ Iniciar Nueva Visita</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Especialista</label>
            <select id="visita-especialista" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
              <option value="">Seleccionar especialista...</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Tipo de Visita</label>
            <select id="visita-tipo" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
              <option value="tutoria">üìö Tutor√≠a</option>
              <option value="revision">üîç Revisi√≥n</option>
              <option value="auditoria">üìä Auditor√≠a</option>
              <option value="capacitacion">üéì Capacitaci√≥n</option>
              <option value="mantenimiento">üîß Mantenimiento</option>
              <option value="emergencia">üö® Emergencia</option>
              <option value="seguimiento">üìå Seguimiento</option>
            </select>
          </div>
          <div style="grid-column: span 2;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Motivo de la Visita</label>
            <input type="text" id="visita-motivo" placeholder="Describir el motivo de la visita..." style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
          <div style="grid-column: span 2;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">M√≥dulos a Revisar</label>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="brain"> üß† Brain
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="vision"> üëÅÔ∏è Vision
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="nervous"> üîó Nervous
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="memory"> üíæ Memory
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="quality"> ‚úÖ Quality
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" class="modulo-check" value="comms"> üì° Comms
              </label>
            </div>
          </div>
        </div>
        <div style="padding: 0 1rem 1rem;">
          <button class="btn btn-primary" onclick="iniciarVisita()">üöÄ Iniciar Visita</button>
        </div>
      </div>

      <!-- Visita en Curso -->
      <div class="ai-config-card" id="visita-en-curso" style="margin-bottom: 1rem; display: none; border: 2px solid var(--accent-cyan);">
        <h3>‚è±Ô∏è Visita en Curso</h3>
        <div style="padding: 1rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <div>
              <strong id="visita-actual-tipo">Tutor√≠a</strong>
              <span style="color: var(--text-muted);"> por </span>
              <strong id="visita-actual-esp">Especialista</strong>
            </div>
            <div style="color: var(--accent-cyan); font-weight: bold;" id="visita-timer">00:00:00</div>
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Notas de la Visita</label>
            <textarea id="visita-notas" rows="3" placeholder="Agregar notas durante la visita..." style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text); resize: vertical;"></textarea>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button class="btn btn-primary" onclick="mostrarFormularioInforme()">üìù Crear Informe</button>
            <button class="btn" style="background: var(--accent-red); color: white;" onclick="cancelarVisita()">‚ùå Cancelar Visita</button>
          </div>
        </div>
      </div>

      <!-- Historial de Visitas -->
      <div class="ai-config-card" style="margin-bottom: 1rem;">
        <h3>üìö Historial de Visitas</h3>
        <div id="historial-visitas" style="padding: 1rem; max-height: 300px; overflow-y: auto;">
          <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
            Cargando historial...
          </div>
        </div>
      </div>

      <!-- Recomendaciones Pendientes -->
      <div class="ai-config-card" style="margin-bottom: 1rem;">
        <h3>üí° Recomendaciones Pendientes</h3>
        <div id="lista-recomendaciones" style="padding: 1rem; max-height: 250px; overflow-y: auto;">
          <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
            Cargando recomendaciones...
          </div>
        </div>
      </div>

      <!-- Seguimientos Activos -->
      <div class="ai-config-card">
        <h3>üìå Seguimientos de Mejora</h3>
        <div id="lista-seguimientos" style="padding: 1rem; max-height: 250px; overflow-y: auto;">
          <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
            Cargando seguimientos...
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="action-bar" style="margin-top: 1rem;">
        <button class="btn btn-primary" onclick="refreshTutorias()">üîÑ Actualizar</button>
        <button class="btn btn-secondary" onclick="generarDashboardTutorias()">üìä Generar Dashboard</button>
        <button class="btn" style="background: var(--accent-orange); color: var(--bg);" onclick="exportarRecomendaciones()">üìã Exportar Recomendaciones</button>
      </div>
    </div>

  </div>

  <!-- BIT√ÅCORA FLOTANTE (siempre visible) -->
  <div class="bitacora-panel" id="bitacora-panel">
    <div class="bitacora-header">
      <span class="bitacora-title">üìã BIT√ÅCORA CENTRAL</span>
      <div class="bitacora-controls">
        <button class="bitacora-btn" onclick="toggleBitacoraSize()" title="Expandir/Contraer">‚¨ú</button>
        <button class="bitacora-btn" onclick="clearBitacora()" title="Limpiar">üóëÔ∏è</button>
        <button class="bitacora-btn" onclick="toggleBitacora()" title="Minimizar">‚ûñ</button>
      </div>
    </div>
    <div class="bitacora-filters">
      <button class="bitacora-filter active" data-filter="all">Todo</button>
      <button class="bitacora-filter" data-filter="success">‚úÖ</button>
      <button class="bitacora-filter" data-filter="info">‚ÑπÔ∏è</button>
      <button class="bitacora-filter" data-filter="error">‚ùå</button>
      <button class="bitacora-filter" data-filter="brain">üß†</button>
      <button class="bitacora-filter" data-filter="vision">üëÅÔ∏è</button>
      <button class="bitacora-filter" data-filter="nervous">üîó</button>
    </div>
    <div class="bitacora-content" id="bitacora-content">
      <!-- Entradas de bit√°cora -->
    </div>
    <div class="bitacora-stats">
      <span id="bitacora-count">0 eventos</span>
      <span id="bitacora-session">Sesi√≥n: 00:00:00</span>
    </div>
  </div>

  <!-- Bot√≥n para mostrar bit√°cora cuando est√° oculta -->
  <button class="bitacora-toggle-btn" id="bitacora-toggle-btn" onclick="showBitacora()" style="display: none;">
    üìã <span id="bitacora-badge">0</span>
  </button>

  <!-- VERSION FOOTER -->
  <div class="version-footer">
    <span>ATLAS</span> v3.8.0 | 2026-02-16
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ATLAS Dashboard v3.0.0 - JavaScript
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ATLAS_VERSION = '3.8.0';
    const ATLAS_BUILD_DATE = '2026-02-16';
    const API_BASE = window.location.origin;

    console.log(`%cüöÄ ATLAS Dashboard v${ATLAS_VERSION}`, 'color: #39d3c4; font-weight: bold; font-size: 14px;');

    // Modules definition
    const MODULES = [
      { id: 'brain', name: 'Brain', icon: 'üß†', status: 'ok' },
      { id: 'memory', name: 'Memory', icon: 'üíæ', status: 'ok' },
      { id: 'learning', name: 'Learning', icon: 'üìö', status: 'ok' },
      { id: 'analysis', name: 'Analysis', icon: 'üìä', status: 'ok' },
      { id: 'reaction', name: 'Reaction', icon: '‚ö°', status: 'ok' },
      { id: 'nervous', name: 'Nervous', icon: 'üîó', status: 'ok' },
      { id: 'ans', name: 'ANS', icon: '‚ù§Ô∏è', status: 'ok' },
      { id: 'vision', name: 'Vision', icon: 'üëÅÔ∏è', status: 'ok' },
      { id: 'ears', name: 'Ears', icon: 'üëÇ', status: 'ok' },
      { id: 'sensors', name: 'Sensors', icon: 'üì°', status: 'ok' },
      { id: 'voice', name: 'Voice', icon: 'üîä', status: 'ok' },
      { id: 'hands', name: 'Hands', icon: 'ü§ñ', status: 'ok' },
      { id: 'navigation', name: 'Navigation', icon: 'üß≠', status: 'ok' },
      { id: 'comms', name: 'Comms', icon: 'üì±', status: 'ok' },
      { id: 'quality', name: 'Quality', icon: '‚úÖ', status: 'ok' },
    ];

    // Activity log
    let activityLog = [];
    
    // Bit√°cora central
    let bitacoraLog = [];
    let bitacoraFilter = 'all';
    let sessionStartTime = Date.now();
    let unreadCount = 0;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initTabs();
      initThemeSelector();
      initBitacora();
      renderModules();
      updateTime();
      setInterval(updateTime, 1000);
      loadInitialData();
    });
    
    // Theme selector
    function initThemeSelector() {
      // Cargar tema guardado
      const savedTheme = localStorage.getItem('atlas-theme') || 'cyan';
      setTheme(savedTheme);
      
      // Event listeners para botones de tema
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const theme = btn.getAttribute('data-theme');
          setTheme(theme);
          localStorage.setItem('atlas-theme', theme);
          addActivity(`Tema cambiado: ${theme}`, 'info');
        });
      });
    }
    
    function setTheme(themeName) {
      document.documentElement.setAttribute('data-theme', themeName);
      
      // Actualizar bot√≥n activo
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-theme') === themeName) {
          btn.classList.add('active');
        }
      });
    }

    // Tab navigation
    function initTabs() {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(`panel-${tabId}`).classList.add('active');
        });
      });
    }

    // Render modules list (Sistema Nervioso style)
    function renderModules() {
      const grid = document.getElementById('modules-grid');
      if (grid) {
        grid.innerHTML = MODULES.map(mod => `
          <div class="module-tile ${mod.status === 'ok' ? 'connected' : 'error'}" 
               onclick="toggleModuleActions('${mod.id}')" 
               id="tile-${mod.id}">
            <span class="module-emoji">${mod.icon}</span>
            <div class="module-tile-name">${mod.name}</div>
            <div class="module-tile-status">${mod.status === 'ok' ? 'Conectado' : 'Error'}</div>
          </div>
        `).join('');
      }
      updateModuleCounter();
      updateSystemBadge();
    }
    
    function toggleModuleActions(moduleId) {
      const mod = MODULES.find(m => m.id === moduleId);
      if (!mod) return;
      
      // Crear men√∫ contextual
      const existing = document.getElementById('module-context-menu');
      if (existing) existing.remove();
      
      const tile = document.getElementById(`tile-${moduleId}`);
      const rect = tile.getBoundingClientRect();
      
      const menu = document.createElement('div');
      menu.id = 'module-context-menu';
      menu.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 8}px;
        left: ${rect.left}px;
        background: var(--bg-card);
        border: 1px solid var(--accent-cyan);
        border-radius: 8px;
        padding: 0.5rem;
        z-index: 1000;
        box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        min-width: 150px;
      `;
      menu.innerHTML = `
        <div style="padding: 0.5rem; font-weight: 600; border-bottom: 1px solid var(--border); margin-bottom: 0.5rem;">
          ${mod.icon} ${mod.name}
        </div>
        <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem; font-size: 0.8rem;" onclick="checkModule('${moduleId}'); closeModuleMenu();">
          üîç Check
        </button>
        <button class="btn btn-secondary" style="width: 100%; font-size: 0.8rem;" onclick="reconnectModule('${moduleId}'); closeModuleMenu();">
          üîÑ Reconectar
        </button>
      `;
      
      document.body.appendChild(menu);
      
      // Cerrar al hacer click fuera
      setTimeout(() => {
        document.addEventListener('click', closeModuleMenuOnOutside);
      }, 100);
    }
    
    function closeModuleMenu() {
      const menu = document.getElementById('module-context-menu');
      if (menu) menu.remove();
      document.removeEventListener('click', closeModuleMenuOnOutside);
    }
    
    function closeModuleMenuOnOutside(e) {
      const menu = document.getElementById('module-context-menu');
      if (menu && !menu.contains(e.target) && !e.target.closest('.module-tile')) {
        closeModuleMenu();
      }
    }

    function updateSystemBadge() {
      const connected = MODULES.filter(m => m.status === 'ok').length;
      const percentage = Math.round((connected / MODULES.length) * 100);
      const badge = document.getElementById('system-status-badge');
      if (badge) {
        badge.textContent = `${percentage}% OPERATIVO`;
        badge.style.background = percentage === 100 ? 'var(--accent-green)' : 
                                  percentage >= 80 ? 'var(--accent-orange)' : 'var(--accent-red)';
      }
    }

    async function reconnectModule(moduleId) {
      addActivity(`Reconectando m√≥dulo: ${moduleId}...`, 'info');
      try {
        const res = await fetch(`${API_BASE}/modules/reconnect/${moduleId}`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          addActivity(`M√≥dulo ${moduleId} reconectado`, 'success');
          // Actualizar estado del m√≥dulo en la UI
          const idx = MODULES.findIndex(m => m.id === moduleId);
          if (idx >= 0) {
            MODULES[idx].status = 'ok';
            renderModules();
          }
        } else {
          addActivity(`Error reconectando ${moduleId}: ${data.error}`, 'error');
        }
      } catch (e) {
        addActivity(`Error: ${e.message}`, 'error');
      }
    }

    async function runFullDiagnostic() {
      addActivity('Ejecutando diagn√≥stico completo del sistema...', 'info');
      try {
        const res = await fetch(`${API_BASE}/doctor`);
        const data = await res.json();
        addActivity('Diagn√≥stico completado: todos los m√≥dulos OK', 'success');
      } catch (e) {
        addActivity('Error en diagn√≥stico: ' + e.message, 'error');
      }
    }

    // Vision/Camera functions
    let selectedCamera = null;
    
    function getCameraIcon(name) {
      const nameLower = (name || '').toLowerCase();
      if (nameLower.includes('insta360') || nameLower.includes('360')) return 'üé•';
      if (nameLower.includes('ir') || nameLower.includes('infrared')) return 'üëÅÔ∏è';
      if (nameLower.includes('webcam') || nameLower.includes('web cam')) return 'üíª';
      if (nameLower.includes('usb')) return 'üîå';
      if (nameLower.includes('nexigo')) return 'üìπ';
      if (nameLower.includes('logitech')) return 'üé¨';
      if (nameLower.includes('microsoft')) return 'ü™ü';
      if (nameLower.includes('integrated') || nameLower.includes('built-in')) return 'üíª';
      return 'üì∑';
    }
    let streamingCamera = null;

    function selectCamera(camId, event) {
      // Evitar propagaci√≥n si se hace click en el bot√≥n
      if (event) event.stopPropagation();
      
      selectedCamera = camId;
      
      // Quitar selecci√≥n anterior de todas las filas de c√°maras
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('selected');
      });
      
      // Marcar la fila actual como seleccionada usando data-cam-id
      const selectedRow = document.querySelector(`#cameras-list .module-row[data-cam-id="${camId}"]`);
      if (selectedRow) {
        selectedRow.classList.add('selected');
      }
      
      // Actualizar info
      const camName = selectedRow ? selectedRow.querySelector('.module-name-text').textContent : `C√°mara ${camId}`;
      document.getElementById('camera-info').textContent = `${camName} seleccionada`;
      addActivity(`${camName} seleccionada`, 'info');
      
      // Capturar frame de preview
      captureSnapshot();
    }

    function streamCamera(camId, event) {
      if (event) event.stopPropagation();
      
      // Quitar streaming anterior
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('streaming');
      });
      
      streamingCamera = camId;
      selectedCamera = camId;
      
      // Quitar selecci√≥n y marcar como streaming
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('selected');
      });
      
      const streamRow = document.querySelector(`#cameras-list .module-row[data-cam-id="${camId}"]`);
      if (streamRow) {
        streamRow.classList.add('streaming');
        streamRow.classList.add('selected');
      }
      
      // Iniciar stream de video continuo
      const preview = document.getElementById('vision-preview');
      preview.innerHTML = `
        <div style="position: relative;">
          <img id="stream-img-${camId}" style="max-width: 100%; border-radius: 8px; min-height: 200px; background: var(--bg);">
          <div style="position: absolute; top: 10px; right: 10px; background: var(--accent-red); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
            üî¥ LIVE
          </div>
        </div>
      `;
      
      const camName = streamRow ? streamRow.querySelector('.module-name-text').textContent : `C√°mara ${camId}`;
      document.getElementById('camera-info').textContent = `üî¥ STREAMING - ${camName}`;
      addActivity(`Stream iniciado: ${camName}`, 'success');
      
      // Actualizar contadores
      document.getElementById('vision-active').textContent = '1';
      
      // Actualizar frames continuamente
      updateStreamFrame(camId);
    }
    
    async function updateStreamFrame(camId) {
      if (streamingCamera !== camId) return;
      
      try {
        const res = await fetch(`${API_BASE}/vision/capture/${camId}`);
        const data = await res.json();
        if (data.ok && data.image_base64) {
          const img = document.getElementById(`stream-img-${camId}`);
          if (img) {
            img.src = `data:image/jpeg;base64,${data.image_base64}`;
          }
        }
      } catch (e) {
        console.error('Stream error:', e);
      }
      
      // Siguiente frame (aprox 10 FPS)
      if (streamingCamera === camId) {
        setTimeout(() => updateStreamFrame(camId), 100);
      }
    }
    
    function stopStream() {
      const wasStreaming = streamingCamera;
      streamingCamera = null;
      document.querySelectorAll('#cameras-list .module-row').forEach(row => {
        row.classList.remove('streaming');
      });
      document.getElementById('vision-active').textContent = '0';
      if (wasStreaming !== null) {
        addActivity('Stream detenido', 'info');
        document.getElementById('camera-info').textContent = selectedCamera !== null ? `C√°mara ${selectedCamera} seleccionada` : 'Ninguna c√°mara seleccionada';
      }
    }
    
    function startStreamSelected() {
      if (selectedCamera === null) {
        addActivity('Selecciona una c√°mara primero', 'error');
        return;
      }
      streamCamera(selectedCamera, null);
    }

    async function scanCameras() {
      addActivity('Escaneando c√°maras...', 'info');
      try {
        const res = await fetch(`${API_BASE}/vision/scan`, { method: 'POST' });
        const data = await res.json();
        addActivity(`C√°maras encontradas: ${data.cameras?.length || 0}`, 'success');
      } catch (e) {
        addActivity('Error escaneando: ' + e.message, 'error');
      }
    }

    function readTextOCR() {
      if (selectedCamera === null) {
        addActivity('Selecciona una c√°mara primero', 'error');
        return;
      }
      addActivity('Leyendo texto (OCR)...', 'info');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Sistema de Actualizaciones
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function checkForUpdates() {
      const btn = document.getElementById('btn-check-update');
      const originalText = btn ? btn.innerHTML : '';
      
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Buscando...';
        btn.classList.add('checking');
      }
      
      addActivity('üîç Buscando actualizaciones...', 'info');
      
      try {
        const res = await fetch(`${API_BASE}/version`, { cache: 'no-store' });
        if (res.ok) {
          const data = await res.json();
          const serverVersion = data.version || 'unknown';
          
          if (serverVersion !== ATLAS_VERSION && serverVersion !== 'unknown') {
            addActivity(`üîÑ Nueva versi√≥n disponible: ${serverVersion}`, 'success');
            if (confirm(`Nueva versi√≥n disponible: ${serverVersion}\n\n¬øDesea actualizar ahora?`)) {
              location.reload(true);
            }
          } else {
            addActivity(`‚úÖ Sistema actualizado (v${ATLAS_VERSION})`, 'success');
          }
        } else {
          addActivity(`‚úÖ v${ATLAS_VERSION} - Sistema actualizado`, 'success');
        }
      } catch (e) {
        addActivity(`‚ö†Ô∏è Error verificando: ${e.message}`, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText;
          btn.classList.remove('checking');
        }
      }
    }

    function updateModuleCounter() {
      const connected = MODULES.filter(m => m.status === 'ok').length;
      document.getElementById('modules-counter').textContent = `${connected}/${MODULES.length}`;
      document.getElementById('stat-connected').textContent = connected;
      document.getElementById('stat-total').textContent = MODULES.length;
      document.getElementById('stat-health').textContent = Math.round((connected / MODULES.length) * 100) + '%';
    }

    // Time update
    function updateTime() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleTimeString('es-ES');
    }

    // Activity log
    function addActivity(message, type = 'info', source = 'system') {
      const time = new Date().toLocaleTimeString('es-ES');
      activityLog.unshift({ time, message, type });
      if (activityLog.length > 50) activityLog.pop();
      renderActivity();
      
      // Tambi√©n agregar a la bit√°cora central
      addToBitacora(message, type, source);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Bit√°cora Central
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function addToBitacora(message, type = 'info', source = 'system', syncToServer = true) {
      const time = new Date().toLocaleTimeString('es-ES');
      const entry = {
        id: Date.now(),
        time,
        message,
        type,
        source,
        timestamp: Date.now()
      };
      
      bitacoraLog.unshift(entry);
      if (bitacoraLog.length > 200) bitacoraLog.pop();
      
      renderBitacora();
      updateBitacoraStats();
      
      // Incrementar contador si est√° minimizada
      const panel = document.getElementById('bitacora-panel');
      if (panel && panel.classList.contains('minimized')) {
        unreadCount++;
        document.getElementById('bitacora-badge').textContent = unreadCount;
      }
      
      // Sincronizar con servidor (opcional)
      if (syncToServer && source !== 'server') {
        syncBitacoraToServer(message, type, source);
      }
    }
    
    function renderBitacora() {
      const content = document.getElementById('bitacora-content');
      if (!content) return;
      
      let filtered = bitacoraLog;
      if (bitacoraFilter !== 'all') {
        filtered = bitacoraLog.filter(e => e.type === bitacoraFilter || e.source === bitacoraFilter);
      }
      
      content.innerHTML = filtered.slice(0, 100).map(entry => {
        const sourceIcon = getSourceIcon(entry.source);
        return `
          <div class="bitacora-entry ${entry.type} ${entry.source}">
            <span class="bitacora-time">${entry.time}</span>
            <span class="bitacora-source">${sourceIcon}</span>
            <span class="bitacora-msg">${escapeHtml(entry.message)}</span>
          </div>
        `;
      }).join('');
      
      // Auto-scroll si est√° cerca del final
      if (content.scrollTop < 50) {
        content.scrollTop = 0;
      }
    }
    
    function getSourceIcon(source) {
      const icons = {
        system: '‚öôÔ∏è',
        brain: 'üß†',
        vision: 'üëÅÔ∏è',
        nervous: 'üîó',
        modules: 'üì¶',
        chat: 'üí¨',
        ai: 'ü§ñ',
        governance: 'üõ°Ô∏è',
        update: 'üîÑ'
      };
      return icons[source] || 'üìã';
    }
    
    function updateBitacoraStats() {
      const countEl = document.getElementById('bitacora-count');
      const sessionEl = document.getElementById('bitacora-session');
      
      if (countEl) {
        countEl.textContent = `${bitacoraLog.length} eventos`;
      }
      
      if (sessionEl) {
        const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const mins = Math.floor((elapsed % 3600) / 60);
        const secs = elapsed % 60;
        sessionEl.textContent = `Sesi√≥n: ${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
    }
    
    function toggleBitacora() {
      const panel = document.getElementById('bitacora-panel');
      const toggleBtn = document.getElementById('bitacora-toggle-btn');
      
      if (panel.classList.contains('minimized')) {
        panel.classList.remove('minimized');
        unreadCount = 0;
        document.getElementById('bitacora-badge').textContent = '0';
      } else {
        panel.classList.add('minimized');
      }
    }
    
    function toggleBitacoraSize() {
      const panel = document.getElementById('bitacora-panel');
      panel.classList.toggle('expanded');
    }
    
    function showBitacora() {
      const panel = document.getElementById('bitacora-panel');
      const toggleBtn = document.getElementById('bitacora-toggle-btn');
      
      panel.style.display = 'flex';
      toggleBtn.style.display = 'none';
      unreadCount = 0;
      document.getElementById('bitacora-badge').textContent = '0';
    }
    
    function hideBitacora() {
      const panel = document.getElementById('bitacora-panel');
      const toggleBtn = document.getElementById('bitacora-toggle-btn');
      
      panel.style.display = 'none';
      toggleBtn.style.display = 'block';
    }
    
    function clearBitacora() {
      if (confirm('¬øLimpiar toda la bit√°cora?')) {
        bitacoraLog = [];
        renderBitacora();
        updateBitacoraStats();
        addToBitacora('Bit√°cora limpiada', 'info', 'system');
      }
    }
    
    function initBitacora() {
      // Event listeners para filtros
      document.querySelectorAll('.bitacora-filter').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.bitacora-filter').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          bitacoraFilter = btn.getAttribute('data-filter');
          renderBitacora();
        });
      });
      
      // Actualizar tiempo de sesi√≥n cada segundo
      setInterval(updateBitacoraStats, 1000);
      
      // Cargar bit√°cora del servidor
      loadBitacoraFromServer();
      
      // Polling para nuevas entradas cada 2 segundos
      setInterval(pollBitacora, 2000);
      
      // Entrada inicial
      addToBitacora('Sistema ATLAS iniciado', 'success', 'system');
      addToBitacora(`Dashboard v${ATLAS_VERSION} cargado`, 'info', 'system');
    }
    
    let lastBitacoraId = 0;
    
    async function loadBitacoraFromServer() {
      try {
        const res = await fetch(`${API_BASE}/ans/bitacora?limit=100`);
        const data = await res.json();
        if (data.ok && data.entries) {
          // Combinar con entradas locales, evitando duplicados
          data.entries.forEach(entry => {
            // Convertir formato del servidor al formato local
            const ts = entry.timestamp ? new Date(entry.timestamp) : new Date();
            const localEntry = {
              id: ts.getTime(),
              time: ts.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit', second: '2-digit'}),
              message: entry.message || '',
              type: entry.level || 'info',
              source: entry.source || 'system',
              timestamp: ts.getTime()
            };
            // Evitar duplicados (por mensaje similar en mismo segundo)
            const isDupe = bitacoraLog.some(e => 
              Math.abs(e.timestamp - localEntry.timestamp) < 1000 && 
              e.message === localEntry.message
            );
            if (!isDupe) {
              bitacoraLog.push(localEntry);
            }
          });
          // Ordenar por timestamp (m√°s reciente primero)
          bitacoraLog.sort((a, b) => b.timestamp - a.timestamp);
          if (bitacoraLog.length > 0) {
            lastBitacoraId = bitacoraLog[0].id;
          }
          renderBitacora();
          updateBitacoraStats();
        }
      } catch (e) {
        console.error('Error loading bitacora:', e);
      }
    }
    
    async function pollBitacora() {
      try {
        const res = await fetch(`${API_BASE}/ans/bitacora?limit=20`);
        const data = await res.json();
        if (data.ok && data.entries && data.entries.length > 0) {
          let newEntries = 0;
          data.entries.forEach(entry => {
            const ts = entry.timestamp ? new Date(entry.timestamp) : new Date();
            const localEntry = {
              id: ts.getTime(),
              time: ts.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit', second: '2-digit'}),
              message: entry.message || '',
              type: entry.level || 'info',
              source: entry.source || 'system',
              timestamp: ts.getTime()
            };
            // Evitar duplicados
            const isDupe = bitacoraLog.some(e => 
              Math.abs(e.timestamp - localEntry.timestamp) < 1000 && 
              e.message === localEntry.message
            );
            if (!isDupe) {
              bitacoraLog.unshift(localEntry);
              newEntries++;
            }
          });
          
          if (newEntries > 0) {
            // Notificar si panel minimizado
            const panel = document.getElementById('bitacora-panel');
            if (panel && panel.classList.contains('minimized')) {
              unreadCount += newEntries;
              document.getElementById('bitacora-badge').textContent = unreadCount;
            }
            // Ordenar y renderizar
            bitacoraLog.sort((a, b) => b.timestamp - a.timestamp);
            renderBitacora();
            updateBitacoraStats();
          }
        }
      } catch (e) {
        // Silenciar errores de polling
      }
    }
    
    async function syncBitacoraToServer(message, level, source) {
      try {
        await fetch(`${API_BASE}/bitacora/log`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, level, source })
        });
      } catch (e) {
        // Silenciar errores
      }
    }

    function renderActivity() {
      const lists = ['activity-list', 'modules-activity-list'];
      lists.forEach(listId => {
        const list = document.getElementById(listId);
        if (list) {
          list.innerHTML = activityLog.slice(0, 10).map(item => `
            <div class="activity-item ${item.type}">
              <div class="activity-time">${item.time}</div>
              <div class="activity-message">${item.message}</div>
            </div>
          `).join('');
        }
      });
    }

    function clearActivity() {
      activityLog = [];
      renderActivity();
    }

    // API calls
    async function loadInitialData() {
      try {
        addActivity('Conectando al cerebro...', 'info');
        
        // 1. Verificar estado del cerebro
        const brainRes = await fetch(`${API_BASE}/brain/status`);
        if (brainRes.ok) {
          const brain = await brainRes.json();
          if (brain.connected) {
            addActivity('Cerebro conectado', 'success', 'brain');
            document.getElementById('cerebro-dot').classList.remove('offline');
          }
        }
        
        // 2. Cargar estado de todos los m√≥dulos
        await loadModulesFromAPI();
        
        // 3. Cargar configuraci√≥n de IA
        await loadAIConfig();
        
        // 4. Cargar estado de gobernanza
        await loadGovernanceStatus();
        
        // 5. Verificar c√°maras
        await loadCameras();
        
        addActivity('Sistema inicializado correctamente', 'success');
      } catch (e) {
        addActivity('Error conectando: ' + e.message, 'error');
        document.getElementById('cerebro-dot').classList.add('offline');
      }
    }

    async function loadModulesFromAPI() {
      try {
        const res = await fetch(`${API_BASE}/modules/check-all`);
        const data = await res.json();
        if (data.ok && data.modules) {
          // Actualizar MODULES con datos reales
          data.modules.forEach(mod => {
            const idx = MODULES.findIndex(m => m.id === mod.id);
            if (idx >= 0) {
              MODULES[idx].status = mod.status;
            }
          });
          renderModules();
          document.getElementById('stat-connected').textContent = data.connected;
          document.getElementById('stat-health').textContent = data.health + '%';
        }
      } catch (e) {
        console.error('Error loading modules:', e);
      }
    }

    // Modelos por proveedor
    const MODELS_BY_PROVIDER = {
      ollama: ['llama3.2', 'llama3.1', 'mistral', 'mixtral', 'codellama', 'deepseek-coder', 'llava', 'phi3', 'gemma2', 'qwen2'],
      deepseek: ['deepseek-chat', 'deepseek-coder', 'deepseek-reasoner'],
      openai: ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-4', 'gpt-3.5-turbo', 'o1-preview', 'o1-mini'],
      anthropic: ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku', 'claude-3.5-sonnet'],
      gemini: ['gemini-2.0-flash', 'gemini-1.5-pro', 'gemini-1.5-flash', 'gemini-pro', 'gemini-pro-vision'],
      groq: ['llama-3.3-70b', 'llama-3.1-8b', 'mixtral-8x7b', 'gemma2-9b'],
      mistral: ['mistral-large', 'mistral-medium', 'mistral-small', 'codestral'],
      cohere: ['command-r-plus', 'command-r', 'command']
    };

    async function loadAIConfig() {
      try {
        // Cargar configuraci√≥n del servidor
        const res = await fetch(`${API_BASE}/config/ai`);
        const data = await res.json();
        if (data.ok) {
          document.getElementById('ai-mode').value = data.mode || 'auto';
          document.getElementById('ai-provider').value = data.provider || 'ollama';
          
          // Cargar modelos del proveedor y seleccionar el actual
          onProviderChange();
          setTimeout(() => {
            document.getElementById('ai-model').value = data.model || 'llama3.2';
          }, 100);
          
          // Par√°metros
          if (data.temperature !== undefined) {
            document.getElementById('ai-temperature').value = data.temperature * 100;
            updateSliderValue('temperature');
          }
          if (data.top_p !== undefined) {
            document.getElementById('ai-top-p').value = data.top_p * 100;
            updateSliderValue('top-p');
          }
          if (data.top_k !== undefined) {
            document.getElementById('ai-top-k').value = data.top_k;
            updateSliderValue('top-k');
          }
          if (data.max_tokens !== undefined) {
            document.getElementById('ai-max-tokens').value = data.max_tokens;
          }
          if (data.repeat_penalty !== undefined) {
            document.getElementById('ai-repeat-penalty').value = data.repeat_penalty * 100;
            updateSliderValue('repeat-penalty');
          }
          if (data.system_prompt) {
            document.getElementById('ai-system-prompt').value = data.system_prompt;
          }
          if (data.context_window) {
            document.getElementById('ai-context-window').value = data.context_window;
          }
          if (data.memory_context) {
            document.getElementById('ai-memory-context').value = data.memory_context;
          }
          if (data.ollama_url) {
            document.getElementById('ollama-url').value = data.ollama_url;
          }
          
          // Estado de conexi√≥n
          document.getElementById('ai-status-dot').classList.remove('offline');
          document.getElementById('ai-status-text').textContent = 'Conectado';
          addAILog('info', `Configuraci√≥n cargada: ${data.provider}/${data.model}`);
        }
        
        // Cargar modelos de Ollama si est√° seleccionado
        if (document.getElementById('ai-provider').value === 'ollama') {
          refreshOllamaModels();
        }
        
      } catch (e) {
        console.error('Error loading AI config:', e);
        document.getElementById('ai-status-dot').classList.add('offline');
        document.getElementById('ai-status-text').textContent = 'Desconectado';
        addAILog('error', 'Error cargando configuraci√≥n: ' + e.message);
      }
    }

    function onProviderChange() {
      const provider = document.getElementById('ai-provider').value;
      const modelSelect = document.getElementById('ai-model');
      const apiKeyItem = document.getElementById('api-key-item');
      const ollamaUrlItem = document.getElementById('ollama-url-item');
      
      // Mostrar/ocultar campos seg√∫n proveedor
      if (provider === 'ollama') {
        apiKeyItem.style.display = 'none';
        ollamaUrlItem.style.display = 'flex';
      } else {
        apiKeyItem.style.display = 'flex';
        ollamaUrlItem.style.display = 'none';
      }
      
      // Cargar modelos del proveedor
      const models = MODELS_BY_PROVIDER[provider] || [];
      modelSelect.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
      
      addAILog('info', `Proveedor cambiado a: ${provider}`);
    }

    function onAIModeChange() {
      const mode = document.getElementById('ai-mode').value;
      addAILog('info', `Modo de operaci√≥n: ${mode}`);
    }

    function updateSliderValue(type) {
      const slider = document.getElementById(`ai-${type.replace('-', '-')}`);
      const valueSpan = document.getElementById(`${type}-value`);
      if (!slider || !valueSpan) return;
      
      let value;
      switch(type) {
        case 'temperature':
          value = (slider.value / 100).toFixed(1);
          break;
        case 'top-p':
          value = (slider.value / 100).toFixed(2);
          break;
        case 'top-k':
          value = slider.value;
          break;
        case 'repeat-penalty':
          value = (slider.value / 100).toFixed(2);
          break;
        default:
          value = slider.value;
      }
      valueSpan.textContent = value;
    }

    function toggleApiKeyVisibility() {
      const input = document.getElementById('ai-api-key');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function saveAIConfig() {
      const config = {
        mode: document.getElementById('ai-mode').value,
        provider: document.getElementById('ai-provider').value,
        model: document.getElementById('ai-model').value,
        temperature: parseFloat(document.getElementById('ai-temperature').value) / 100,
        top_p: parseFloat(document.getElementById('ai-top-p').value) / 100,
        top_k: parseInt(document.getElementById('ai-top-k').value),
        max_tokens: parseInt(document.getElementById('ai-max-tokens').value),
        repeat_penalty: parseFloat(document.getElementById('ai-repeat-penalty').value) / 100,
        system_prompt: document.getElementById('ai-system-prompt').value,
        memory_context: document.getElementById('ai-memory-context').value,
        context_window: parseInt(document.getElementById('ai-context-window').value),
        ollama_url: document.getElementById('ollama-url').value,
        stream_response: document.getElementById('ai-stream-response').checked,
        save_history: document.getElementById('ai-save-history').checked,
        log_level: document.getElementById('ai-log-level').value
      };
      
      // API Key si no es Ollama
      if (config.provider !== 'ollama') {
        config.api_key = document.getElementById('ai-api-key').value;
      }
      
      try {
        const res = await fetch(`${API_BASE}/config/ai`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        const data = await res.json();
        if (data.ok) {
          addActivity('Configuraci√≥n de IA guardada', 'success');
          addAILog('info', 'Configuraci√≥n guardada correctamente');
        } else {
          addAILog('error', 'Error guardando: ' + (data.error || 'desconocido'));
        }
      } catch (e) {
        addAILog('error', 'Error de conexi√≥n: ' + e.message);
      }
    }

    async function testAIConnection() {
      const provider = document.getElementById('ai-provider').value;
      const statusDot = document.getElementById('ai-status-dot');
      const statusText = document.getElementById('ai-status-text');
      const latencyEl = document.getElementById('ai-latency');
      
      statusText.textContent = 'Probando...';
      addAILog('info', `Probando conexi√≥n a ${provider}...`);
      
      const startTime = Date.now();
      
      try {
        const res = await fetch(`${API_BASE}/config/ai/test`, { method: 'POST' });
        const data = await res.json();
        const latency = Date.now() - startTime;
        
        latencyEl.textContent = latency;
        
        if (data.ok) {
          statusDot.classList.remove('offline');
          statusText.textContent = 'Conectado';
          addAILog('info', `Conexi√≥n OK (${latency}ms)`);
          addActivity(`IA ${provider} conectada`, 'success');
        } else {
          statusDot.classList.add('offline');
          statusText.textContent = 'Error';
          addAILog('error', data.error || 'Conexi√≥n fallida');
        }
      } catch (e) {
        statusDot.classList.add('offline');
        statusText.textContent = 'Desconectado';
        latencyEl.textContent = '--';
        addAILog('error', 'Error: ' + e.message);
      }
    }

    async function refreshOllamaModels() {
      const listEl = document.getElementById('ollama-models-list');
      listEl.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 0.5rem;">Cargando...</div>';
      
      try {
        const res = await fetch(`${API_BASE}/config/ai/ollama-models`);
        const data = await res.json();
        
        if (data.ok && data.models && data.models.length > 0) {
          const currentModel = document.getElementById('ai-model').value;
          listEl.innerHTML = data.models.map(m => `
            <div class="model-item ${m.name === currentModel ? 'active' : ''}" onclick="selectOllamaModel('${m.name}')">
              <span>ü¶ô ${m.name}</span>
              <span class="model-size">${m.size || ''}</span>
            </div>
          `).join('');
          addAILog('info', `${data.models.length} modelos encontrados`);
        } else {
          listEl.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 0.5rem;">No hay modelos instalados</div>';
        }
      } catch (e) {
        listEl.innerHTML = `<div style="color: var(--accent-red); text-align: center; padding: 0.5rem;">Error: ${e.message}</div>`;
        addAILog('error', 'Error cargando modelos: ' + e.message);
      }
    }

    function selectOllamaModel(modelName) {
      document.getElementById('ai-model').value = modelName;
      document.querySelectorAll('#ollama-models-list .model-item').forEach(el => {
        el.classList.remove('active');
        if (el.textContent.includes(modelName)) {
          el.classList.add('active');
        }
      });
      addAILog('info', `Modelo seleccionado: ${modelName}`);
    }

    async function pullOllamaModel() {
      const modelName = prompt('Nombre del modelo a descargar (ej: llama3.2, mistral, codellama):');
      if (!modelName) return;
      
      addAILog('info', `Descargando modelo: ${modelName}...`);
      addActivity(`Descargando modelo ${modelName}...`, 'info');
      
      try {
        const res = await fetch(`${API_BASE}/config/ai/ollama-pull`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: modelName })
        });
        const data = await res.json();
        if (data.ok) {
          addAILog('info', `Modelo ${modelName} descargado`);
          addActivity(`Modelo ${modelName} instalado`, 'success');
          refreshOllamaModels();
        } else {
          addAILog('error', data.error || 'Error descargando');
        }
      } catch (e) {
        addAILog('error', 'Error: ' + e.message);
      }
    }

    function addAILog(level, message) {
      const logEl = document.getElementById('ai-log-preview');
      if (!logEl) return;
      
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${level}`;
      entry.textContent = `[${time}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      
      // Limitar a 50 entradas
      while (logEl.children.length > 50) {
        logEl.removeChild(logEl.firstChild);
      }
    }

    async function loadGovernanceStatus() {
      try {
        const res = await fetch(`${API_BASE}/governance/status`);
        const data = await res.json();
        if (data.ok) {
          document.getElementById('gov-mode').textContent = (data.mode || 'governed').toUpperCase();
          document.getElementById('gov-approvals').textContent = data.approvals_pending || 0;
          document.getElementById('gov-policies').textContent = data.policies_active || 0;
          document.getElementById('gov-score').textContent = data.security_score || 100;
        }
      } catch (e) {
        console.error('Error loading governance:', e);
      }
    }

    async function loadCameras() {
      try {
        const res = await fetch(`${API_BASE}/vision/cameras`);
        const data = await res.json();
        if (data.ok && data.cameras) {
          document.getElementById('vision-cameras').textContent = data.count || 0;
          // Renderizar lista de c√°maras
          const camerasList = document.getElementById('cameras-list');
          if (camerasList && data.cameras.length > 0) {
            camerasList.innerHTML = data.cameras.map(cam => `
              <div class="module-row" data-cam-id="${cam.id}">
                <div class="module-info">
                  <div class="module-dot"></div>
                  <div class="camera-details">
                    <span class="module-name-text">${getCameraIcon(cam.name)} ${cam.name}</span>
                    <span class="camera-specs">${cam.resolution || '1920x1080'} @ ${cam.fps || 30}fps</span>
                  </div>
                </div>
                <div class="module-actions">
                  <button class="btn-check" onclick="selectCamera(${cam.id}, event)">SELECCIONAR</button>
                  <button class="btn-reconnect" onclick="streamCamera(${cam.id}, event)">üî¥ STREAM</button>
                </div>
              </div>
            `).join('');
          }
        }
      } catch (e) {
        console.error('Error loading cameras:', e);
      }
    }

    async function checkAllModules() {
      addActivity('Verificando todos los m√≥dulos...', 'info');
      try {
        const res = await fetch(`${API_BASE}/modules/check-all`);
        const data = await res.json();
        if (data.ok) {
          // Actualizar MODULES con datos reales
          data.modules.forEach(mod => {
            const idx = MODULES.findIndex(m => m.id === mod.id);
            if (idx >= 0) {
              MODULES[idx].status = mod.status;
            }
          });
          renderModules();
          addActivity(`M√≥dulos verificados: ${data.connected}/${data.total} OK (${data.health}%)`, 'success');
        }
      } catch (e) {
        addActivity('Error verificando m√≥dulos: ' + e.message, 'error');
      }
    }

    async function checkModule(moduleId) {
      addActivity(`Verificando m√≥dulo: ${moduleId}`, 'info');
    }

    async function runDiagnostic() {
      addActivity('Ejecutando diagn√≥stico completo...', 'info');
      try {
        const res = await fetch(`${API_BASE}/doctor`);
        const data = await res.json();
        addActivity('Diagn√≥stico completado', 'success');
      } catch (e) {
        addActivity('Error en diagn√≥stico: ' + e.message, 'error');
      }
    }

    // Chat
    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      const messagesDiv = document.getElementById('chat-messages');
      messagesDiv.innerHTML += `<div class="chat-message user">${escapeHtml(message)}</div>`;
      input.value = '';
      addActivity(`Usuario: ${message.substring(0, 30)}...`, 'info');

      // Mostrar indicador de "pensando"
      const thinkingId = 'thinking-' + Date.now();
      messagesDiv.innerHTML += `<div class="chat-message assistant" id="${thinkingId}" style="opacity: 0.6;">üß† Pensando...</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      try {
        // Enviar al cerebro
        const res = await fetch(`${API_BASE}/brain/process`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: message })
        });
        const data = await res.json();
        
        // Remover indicador de pensando
        const thinkingEl = document.getElementById(thinkingId);
        if (thinkingEl) thinkingEl.remove();
        
        if (data.ok) {
          const response = data.response || data.result || 'Sin respuesta';
          messagesDiv.innerHTML += `<div class="chat-message assistant">${formatResponse(response)}</div>`;
          addActivity('Cerebro respondi√≥', 'success', 'brain');
        } else {
          messagesDiv.innerHTML += `<div class="chat-message assistant" style="border-color: var(--accent-red);">Error: ${data.error || 'Sin respuesta'}</div>`;
          addActivity('Error del cerebro: ' + (data.error || 'desconocido'), 'error');
        }
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (e) {
        const thinkingEl = document.getElementById(thinkingId);
        if (thinkingEl) thinkingEl.remove();
        messagesDiv.innerHTML += `<div class="chat-message assistant" style="border-color: var(--accent-red);">Error de conexi√≥n: ${e.message}</div>`;
        addActivity('Error: ' + e.message, 'error');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatResponse(response) {
      if (typeof response === 'object') {
        return '<pre style="white-space: pre-wrap; font-size: 0.85rem;">' + JSON.stringify(response, null, 2) + '</pre>';
      }
      return escapeHtml(String(response));
    }

    document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Governance
    async function setGovMode(mode) {
      try {
        const res = await fetch(`${API_BASE}/governance/mode`, { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: mode })
        });
        const data = await res.json();
        if (data.ok) {
          document.getElementById('gov-mode').textContent = mode.toUpperCase();
          addActivity(`Modo de gobernanza: ${mode.toUpperCase()}`, 'success');
        } else {
          addActivity(`Error: ${data.error || 'No se pudo cambiar modo'}`, 'error');
        }
      } catch (e) {
        addActivity(`Error: ${e.message}`, 'error');
      }
    }

    async function emergencyStop() {
      if (confirm('‚ö†Ô∏è ¬øConfirmar EMERGENCY STOP?\n\nEsto detendr√° todas las operaciones autom√°ticas.')) {
        try {
          const res = await fetch(`${API_BASE}/governance/emergency`, { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ activate: true, reason: 'Manual emergency stop' })
          });
          const data = await res.json();
          if (data.ok) {
            document.getElementById('gov-mode').textContent = 'EMERGENCY';
            document.getElementById('gov-mode').style.color = 'var(--accent-red)';
            addActivity('üö® EMERGENCY STOP ACTIVADO', 'error');
          } else {
            addActivity(`Error: ${data.error || 'No se pudo activar'}`, 'error');
          }
        } catch (e) {
          addActivity(`Error: ${e.message}`, 'error');
        }
      }
    }

    // Vision
    async function captureSnapshot() {
      if (selectedCamera === null) {
        addActivity('Selecciona una c√°mara primero', 'error');
        return;
      }
      addActivity(`Capturando de c√°mara ${selectedCamera}...`, 'info');
      try {
        const res = await fetch(`${API_BASE}/vision/capture/${selectedCamera}`);
        const data = await res.json();
        if (data.ok && data.image_base64) {
          const preview = document.getElementById('vision-preview');
          preview.innerHTML = `<img src="data:image/jpeg;base64,${data.image_base64}" style="max-width: 100%; border-radius: 8px;">`;
          document.getElementById('camera-info').textContent = `C√°mara ${selectedCamera} - ${data.width}x${data.height}`;
          addActivity('Captura exitosa', 'success');
        } else {
          addActivity(`Error: ${data.error || 'No se pudo capturar'}`, 'error');
        }
      } catch (e) {
        addActivity(`Error: ${e.message}`, 'error');
      }
    }

    function captureSnapshotOld() {
      addActivity('Capturando snapshot...', 'info');
    }

    function startStream() {
      addActivity('Iniciando stream...', 'info');
    }

    function detectFaces() {
      addActivity('Detectando rostros...', 'info');
    }

    // Nervous
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Sistema Nervioso Functions
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    const NERVOUS_NODES = [
      'cerebro', 'cerebelo', 'tronco', 'medula',
      'sensorial', 'motor', 'craneal', 'espinal',
      'simpatico', 'parasimpatico', 'enterico', 'cardiaco'
    ];
    
    let nervousState = {
      mode: 'normal', // normal, stress, calm
      heartbeat: 72,
      signalsPerMin: 0,
      latency: 12,
      uptime: 99.9
    };

    async function refreshNervous() {
      addNervousLog('Actualizando sistema nervioso...', 'info');
      addActivity('Actualizando sistema nervioso...', 'info');
      
      try {
        const res = await fetch(`${API_BASE}/nervous/status`);
        const data = await res.json();
        
        if (data.ok) {
          // Actualizar stats
          document.getElementById('nervous-signals').textContent = data.signals_per_min || Math.floor(Math.random() * 100) + 50;
          document.getElementById('nervous-latency').textContent = data.latency_ms || 12;
          document.getElementById('nervous-uptime').textContent = (data.uptime || '99.9') + '%';
          
          // Actualizar se√±ales
          updateSignalBars();
          
          addNervousLog('Sistema actualizado correctamente', 'success');
          addActivity('Sistema nervioso actualizado', 'success');
        }
      } catch (e) {
        addNervousLog('Error: ' + e.message, 'error');
      }
      
      // Simular actualizaci√≥n de heartbeat
      simulateHeartbeat();
    }

    async function nervousDiagnostic() {
      addNervousLog('Iniciando diagn√≥stico completo...', 'info');
      addActivity('Diagn√≥stico del sistema nervioso...', 'info');
      
      // Animar nodos durante diagn√≥stico
      for (const nodeId of NERVOUS_NODES) {
        const node = document.getElementById(`node-${nodeId}`);
        if (node) {
          node.classList.add('active');
          await sleep(200);
          node.classList.remove('active');
        }
      }
      
      try {
        const res = await fetch(`${API_BASE}/nervous/diagnostic`);
        const data = await res.json();
        
        if (data.ok) {
          addNervousLog(`Diagn√≥stico completo: ${data.health || 100}% salud`, 'success');
          addActivity('Diagn√≥stico completo: Sistema OK', 'success');
          
          // Marcar todos los nodos como conectados
          NERVOUS_NODES.forEach(nodeId => {
            const node = document.getElementById(`node-${nodeId}`);
            if (node) {
              node.classList.remove('error');
              node.classList.add('connected');
            }
          });
        }
      } catch (e) {
        addNervousLog('Error en diagn√≥stico: ' + e.message, 'error');
      }
    }

    function inspectNode(nodeId) {
      const nodeNames = {
        cerebro: 'üß† Cerebro - Procesamiento Principal',
        cerebelo: 'üéØ Cerebelo - Coordinaci√≥n Motora',
        tronco: 'üåâ Tronco Encef√°lico - Funciones Vitales',
        medula: 'ü¶¥ M√©dula Espinal - Conducci√≥n Nerviosa',
        sensorial: 'üëÅÔ∏è Nervios Sensoriales - Entrada de Datos',
        motor: 'üí™ Nervios Motores - Control Muscular',
        craneal: 'üó£Ô∏è Nervios Craneales - Sentidos Especiales',
        espinal: 'üîÄ Nervios Espinales - Reflejos',
        simpatico: '‚ö° Sistema Simp√°tico - Respuesta de Estr√©s',
        parasimpatico: 'üßò Sistema Parasimp√°tico - Descanso',
        enterico: 'ü´É Sistema Ent√©rico - Digesti√≥n',
        cardiaco: 'üíì Sistema Card√≠aco - Ritmo del Coraz√≥n'
      };
      
      const node = document.getElementById(`node-${nodeId}`);
      if (node) {
        // Highlight temporal
        node.classList.add('active');
        setTimeout(() => node.classList.remove('active'), 1000);
      }
      
      addNervousLog(`Inspeccionando: ${nodeNames[nodeId] || nodeId}`, 'info');
      addActivity(`Nodo: ${nodeNames[nodeId] || nodeId}`, 'info');
    }

    async function testReflexes() {
      addNervousLog('Iniciando test de reflejos...', 'info');
      addActivity('Test de reflejos iniciado', 'info');
      
      const reflexNodes = ['sensorial', 'espinal', 'motor'];
      let reflexCount = 0;
      
      for (let i = 0; i < 5; i++) {
        // Simular se√±al sensorial -> espinal -> motor
        for (const nodeId of reflexNodes) {
          const node = document.getElementById(`node-${nodeId}`);
          if (node) {
            node.classList.add('active');
            await sleep(100);
            node.classList.remove('active');
          }
        }
        reflexCount++;
        document.getElementById('nervous-reflexes').textContent = reflexCount;
        await sleep(300);
      }
      
      addNervousLog(`Test completado: ${reflexCount} reflejos verificados`, 'success');
      addActivity(`Reflejos OK: ${reflexCount} verificados`, 'success');
    }

    async function simulateStress() {
      addNervousLog('‚ö†Ô∏è Simulando respuesta de estr√©s...', 'warning');
      addActivity('Simulando estr√©s del sistema', 'info');
      
      nervousState.mode = 'stress';
      
      // Activar sistema simp√°tico
      const simpatico = document.getElementById('node-simpatico');
      const cardiaco = document.getElementById('node-cardiaco');
      
      if (simpatico) simpatico.classList.add('active');
      if (cardiaco) cardiaco.classList.add('active');
      
      // Aumentar heartbeat
      let bpm = 72;
      const interval = setInterval(() => {
        if (nervousState.mode !== 'stress' || bpm >= 120) {
          clearInterval(interval);
          return;
        }
        bpm += 5;
        document.getElementById('nervous-heartbeat').textContent = bpm;
        nervousState.heartbeat = bpm;
      }, 200);
      
      // Cambiar colores de se√±ales a warning
      document.querySelectorAll('.signal-fill').forEach(el => {
        el.classList.add('warning');
      });
      
      // Actualizar badge
      document.getElementById('nervous-main-status').textContent = 'ESTR√âS';
      document.getElementById('nervous-main-status').style.background = 'var(--accent-red)';
      
      addNervousLog('Sistema simp√°tico activado - BPM aumentando', 'warning');
      
      // Auto-calmar despu√©s de 5 segundos
      setTimeout(() => {
        if (nervousState.mode === 'stress') {
          calmSystem();
        }
      }, 5000);
    }

    async function calmSystem() {
      addNervousLog('üßò Activando sistema parasimp√°tico...', 'info');
      addActivity('Calmando sistema...', 'info');
      
      nervousState.mode = 'calm';
      
      // Activar sistema parasimp√°tico
      const parasimpatico = document.getElementById('node-parasimpatico');
      const simpatico = document.getElementById('node-simpatico');
      const cardiaco = document.getElementById('node-cardiaco');
      
      if (simpatico) simpatico.classList.remove('active');
      if (parasimpatico) parasimpatico.classList.add('active');
      
      // Reducir heartbeat gradualmente
      let bpm = nervousState.heartbeat;
      const interval = setInterval(() => {
        if (bpm <= 72) {
          clearInterval(interval);
          nervousState.mode = 'normal';
          if (parasimpatico) parasimpatico.classList.remove('active');
          if (cardiaco) cardiaco.classList.remove('active');
          return;
        }
        bpm -= 3;
        document.getElementById('nervous-heartbeat').textContent = bpm;
        nervousState.heartbeat = bpm;
      }, 150);
      
      // Restaurar colores de se√±ales
      document.querySelectorAll('.signal-fill').forEach(el => {
        el.classList.remove('warning');
      });
      
      // Restaurar badge
      document.getElementById('nervous-main-status').textContent = 'OPERATIVO';
      document.getElementById('nervous-main-status').style.background = 'var(--accent-green)';
      
      addNervousLog('Sistema parasimp√°tico activado - Normalizando', 'success');
    }

    function updateSignalBars() {
      const signals = [
        { id: 'brain', min: 80, max: 95 },
        { id: 'vision', min: 85, max: 98 },
        { id: 'audio', min: 70, max: 90 },
        { id: 'motor', min: 88, max: 99 },
        { id: 'ans', min: 82, max: 95 }
      ];
      
      signals.forEach(s => {
        const value = Math.floor(Math.random() * (s.max - s.min)) + s.min;
        const fill = document.getElementById(`signal-${s.id}`);
        const val = document.getElementById(`signal-${s.id}-val`);
        if (fill) fill.style.width = value + '%';
        if (val) val.textContent = value + '%';
      });
    }

    function simulateHeartbeat() {
      // Simular variaci√≥n natural del heartbeat
      setInterval(() => {
        if (nervousState.mode === 'normal') {
          const variation = Math.floor(Math.random() * 5) - 2; // -2 a +2
          let bpm = nervousState.heartbeat + variation;
          bpm = Math.max(68, Math.min(78, bpm)); // Rango normal
          nervousState.heartbeat = bpm;
          document.getElementById('nervous-heartbeat').textContent = bpm;
        }
      }, 2000);
      
      // Incrementar se√±ales por minuto
      setInterval(() => {
        nervousState.signalsPerMin += Math.floor(Math.random() * 5) + 1;
        document.getElementById('nervous-signals').textContent = nervousState.signalsPerMin;
      }, 1000);
    }

    function addNervousLog(message, type = 'info') {
      const logList = document.getElementById('nervous-log-list');
      if (!logList) return;
      
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `nervous-log-entry ${type}`;
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-msg">${message}</span>
      `;
      
      logList.appendChild(entry);
      logList.scrollTop = logList.scrollHeight;
      
      // Limitar a 50 entradas
      while (logList.children.length > 50) {
        logList.removeChild(logList.firstChild);
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Inicializar sistema nervioso cuando se carga el tab
    function initNervousSystem() {
      updateSignalBars();
      simulateHeartbeat();
      addNervousLog('Sistema nervioso central iniciado', 'success');
    }

    // Llamar cuando se cambia al tab nervioso
    const originalInitTabs = initTabs;
    initTabs = function() {
      originalInitTabs();
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          if (tab.getAttribute('data-tab') === 'nervioso') {
            initNervousSystem();
          }
          if (tab.getAttribute('data-tab') === 'tutorias') {
            initTutorias();
          }
        });
      });
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Sistema de Tutor√≠as y Visitas
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let visitaEnCurso = null;
    let visitaTimer = null;
    let visitaStartTime = null;
    let especialistasCache = [];

    async function initTutorias() {
      await refreshTutorias();
    }

    async function refreshTutorias() {
      addToBitacora('Actualizando sistema de tutor√≠as...', 'info', 'tutorias');
      await Promise.all([
        cargarEstadisticas(),
        cargarEspecialistas(),
        cargarHistorialVisitas(),
        cargarRecomendaciones(),
        cargarSeguimientos()
      ]);
      addToBitacora('Sistema de tutor√≠as actualizado', 'success', 'tutorias');
    }

    async function cargarEstadisticas() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/estadisticas`);
        const data = await res.json();
        if (data.ok) {
          const stats = data.estadisticas;
          document.getElementById('tut-stat-especialistas').textContent = stats.total_especialistas || 0;
          document.getElementById('tut-stat-visitas').textContent = stats.total_visitas || 0;
          document.getElementById('tut-stat-informes').textContent = stats.informes_firmados || 0;
          document.getElementById('tut-stat-puntuacion').textContent = (stats.puntuacion_promedio || 0).toFixed(1);
        }
      } catch (e) {
        console.log('Error cargando estad√≠sticas:', e);
      }
    }

    async function cargarEspecialistas() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/especialistas`);
        const data = await res.json();
        if (data.ok) {
          especialistasCache = data.especialistas || [];
          renderEspecialistas(especialistasCache);
          actualizarSelectEspecialistas(especialistasCache);
        }
      } catch (e) {
        console.log('Error cargando especialistas:', e);
      }
    }

    function renderEspecialistas(especialistas) {
      const container = document.getElementById('lista-especialistas');
      if (!container) return;
      
      if (!especialistas.length) {
        container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 2rem;">
          No hay especialistas registrados a√∫n
        </div>`;
        return;
      }
      
      container.innerHTML = especialistas.map(esp => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem;">
          <div>
            <strong style="color: var(--accent-cyan);">${esp.nombre}</strong>
            <span style="color: var(--text-muted); margin-left: 0.5rem;">${esp.rol}</span>
            <div style="font-size: 0.85rem; color: var(--text-muted);">
              ${esp.especialidad} | ${esp.visitas_realizadas || 0} visitas
            </div>
          </div>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <span style="font-family: monospace; font-size: 0.75rem; color: var(--accent-purple);">
              üîè ${esp.firma_digital?.substring(0, 8) || 'N/A'}
            </span>
          </div>
        </div>
      `).join('');
    }

    function actualizarSelectEspecialistas(especialistas) {
      const select = document.getElementById('visita-especialista');
      if (!select) return;
      
      select.innerHTML = '<option value="">Seleccionar especialista...</option>' +
        especialistas.map(esp => `<option value="${esp.id}">${esp.nombre} (${esp.rol})</option>`).join('');
    }

    async function registrarEspecialista() {
      const nombre = document.getElementById('esp-nombre').value.trim();
      const rol = document.getElementById('esp-rol').value;
      const especialidad = document.getElementById('esp-especialidad').value.trim();
      const email = document.getElementById('esp-email').value.trim();
      
      if (!nombre || !especialidad) {
        alert('Por favor ingrese nombre y especialidad');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/tutorias/especialistas`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre, rol, especialidad, email })
        });
        const data = await res.json();
        
        if (data.ok) {
          addToBitacora(`Especialista registrado: ${nombre}`, 'success', 'tutorias');
          addActivity(`Nuevo especialista: ${nombre}`, 'success');
          
          // Limpiar campos
          document.getElementById('esp-nombre').value = '';
          document.getElementById('esp-especialidad').value = '';
          document.getElementById('esp-email').value = '';
          
          // Recargar lista
          await cargarEspecialistas();
          await cargarEstadisticas();
        } else {
          alert('Error: ' + (data.detail || 'No se pudo registrar'));
        }
      } catch (e) {
        alert('Error de conexi√≥n');
      }
    }

    async function iniciarVisita() {
      const especialistaId = document.getElementById('visita-especialista').value;
      const tipo = document.getElementById('visita-tipo').value;
      const motivo = document.getElementById('visita-motivo').value.trim();
      
      const modulosChecked = document.querySelectorAll('.modulo-check:checked');
      const modulos = Array.from(modulosChecked).map(cb => cb.value);
      
      if (!especialistaId) {
        alert('Por favor seleccione un especialista');
        return;
      }
      if (!motivo) {
        alert('Por favor ingrese el motivo de la visita');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/tutorias/visitas`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tipo,
            especialista_id: especialistaId,
            motivo,
            modulos_revisados: modulos,
            objetivos: []
          })
        });
        const data = await res.json();
        
        if (data.ok) {
          visitaEnCurso = {
            id: data.visita_id,
            tipo,
            especialista: data.especialista,
            inicio: new Date()
          };
          
          // Mostrar panel de visita en curso
          document.getElementById('visita-en-curso').style.display = 'block';
          document.getElementById('visita-actual-tipo').textContent = tipo.toUpperCase();
          document.getElementById('visita-actual-esp').textContent = data.especialista;
          
          // Iniciar timer
          visitaStartTime = Date.now();
          visitaTimer = setInterval(updateVisitaTimer, 1000);
          
          addToBitacora(`Visita iniciada: ${tipo} por ${data.especialista}`, 'success', 'tutorias');
          addActivity(`Visita ${tipo} iniciada`, 'info');
          
          // Limpiar formulario
          document.getElementById('visita-motivo').value = '';
          document.querySelectorAll('.modulo-check').forEach(cb => cb.checked = false);
        } else {
          alert('Error: ' + (data.detail || 'No se pudo iniciar la visita'));
        }
      } catch (e) {
        alert('Error de conexi√≥n');
      }
    }

    function updateVisitaTimer() {
      const elapsed = Date.now() - visitaStartTime;
      const hours = Math.floor(elapsed / 3600000);
      const mins = Math.floor((elapsed % 3600000) / 60000);
      const secs = Math.floor((elapsed % 60000) / 1000);
      document.getElementById('visita-timer').textContent = 
        `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function cancelarVisita() {
      if (confirm('¬øEst√° seguro de cancelar la visita en curso?')) {
        if (visitaTimer) clearInterval(visitaTimer);
        visitaEnCurso = null;
        document.getElementById('visita-en-curso').style.display = 'none';
        addToBitacora('Visita cancelada', 'warning', 'tutorias');
      }
    }

    function mostrarFormularioInforme() {
      const notas = document.getElementById('visita-notas').value;
      
      // Crear modal para informe
      const modal = document.createElement('div');
      modal.id = 'informe-modal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
      `;
      modal.innerHTML = `
        <div style="background: var(--bg-card); border-radius: 16px; padding: 2rem; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border);">
          <h2 style="color: var(--accent-cyan); margin-bottom: 1.5rem;">üìù Crear Informe de Visita</h2>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">T√≠tulo del Informe</label>
            <input type="text" id="inf-titulo" value="Informe de ${visitaEnCurso?.tipo || 'visita'} - ${new Date().toLocaleDateString()}" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Resumen</label>
            <input type="text" id="inf-resumen" placeholder="Resumen breve del informe" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text);">
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Contenido Detallado</label>
            <textarea id="inf-contenido" rows="5" placeholder="Descripci√≥n detallada de la visita...">${notas}</textarea>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-cyan);">üìä Evaluaciones</label>
            <div id="evaluaciones-list">
              <div class="eval-item" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px;">
                <input type="text" class="eval-aspecto" placeholder="Aspecto" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                <select class="eval-nivel" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                  <option value="EXCELENTE">‚≠ê Excelente (5)</option>
                  <option value="BUENO">‚úÖ Bueno (4)</option>
                  <option value="ACEPTABLE" selected>üîµ Aceptable (3)</option>
                  <option value="MEJORABLE">‚ö†Ô∏è Mejorable (2)</option>
                  <option value="CRITICO">üî¥ Cr√≠tico (1)</option>
                </select>
                <input type="text" class="eval-comentario" placeholder="Comentario" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
              </div>
            </div>
            <button onclick="agregarEvaluacion()" style="padding: 0.5rem 1rem; background: var(--bg-elevated); color: var(--accent-cyan); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">+ Agregar Evaluaci√≥n</button>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-orange);">üí° Recomendaciones</label>
            <div id="recomendaciones-list">
              <div class="rec-item" style="padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem;">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <input type="text" class="rec-titulo" placeholder="T√≠tulo de la recomendaci√≥n" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                  <select class="rec-prioridad" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                    <option value="CRITICA">üî¥ Cr√≠tica</option>
                    <option value="ALTA">üü† Alta</option>
                    <option value="MEDIA" selected>üü° Media</option>
                    <option value="BAJA">üü¢ Baja</option>
                    <option value="OPCIONAL">‚ö™ Opcional</option>
                  </select>
                </div>
                <input type="text" class="rec-descripcion" placeholder="Descripci√≥n de la recomendaci√≥n" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 0.5rem;">
                <input type="text" class="rec-modulo" placeholder="M√≥dulo afectado (ej: vision, brain)" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
              </div>
            </div>
            <button onclick="agregarRecomendacion()" style="padding: 0.5rem 1rem; background: var(--bg-elevated); color: var(--accent-orange); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">+ Agregar Recomendaci√≥n</button>
          </div>
          
          <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="enviarInforme()" style="flex: 1;">‚úçÔ∏è Firmar y Enviar Informe</button>
            <button class="btn" onclick="cerrarModalInforme()" style="background: var(--bg-elevated);">Cancelar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function agregarEvaluacion() {
      const list = document.getElementById('evaluaciones-list');
      const item = document.createElement('div');
      item.className = 'eval-item';
      item.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px;';
      item.innerHTML = `
        <input type="text" class="eval-aspecto" placeholder="Aspecto" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
        <select class="eval-nivel" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
          <option value="EXCELENTE">‚≠ê Excelente (5)</option>
          <option value="BUENO">‚úÖ Bueno (4)</option>
          <option value="ACEPTABLE" selected>üîµ Aceptable (3)</option>
          <option value="MEJORABLE">‚ö†Ô∏è Mejorable (2)</option>
          <option value="CRITICO">üî¥ Cr√≠tico (1)</option>
        </select>
        <input type="text" class="eval-comentario" placeholder="Comentario" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
      `;
      list.appendChild(item);
    }

    function agregarRecomendacion() {
      const list = document.getElementById('recomendaciones-list');
      const item = document.createElement('div');
      item.className = 'rec-item';
      item.style.cssText = 'padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem;';
      item.innerHTML = `
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
          <input type="text" class="rec-titulo" placeholder="T√≠tulo de la recomendaci√≥n" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
          <select class="rec-prioridad" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
            <option value="CRITICA">üî¥ Cr√≠tica</option>
            <option value="ALTA">üü† Alta</option>
            <option value="MEDIA" selected>üü° Media</option>
            <option value="BAJA">üü¢ Baja</option>
            <option value="OPCIONAL">‚ö™ Opcional</option>
          </select>
        </div>
        <input type="text" class="rec-descripcion" placeholder="Descripci√≥n de la recomendaci√≥n" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 0.5rem;">
        <input type="text" class="rec-modulo" placeholder="M√≥dulo afectado (ej: vision, brain)" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
      `;
      list.appendChild(item);
    }

    function cerrarModalInforme() {
      const modal = document.getElementById('informe-modal');
      if (modal) modal.remove();
    }

    async function enviarInforme() {
      const titulo = document.getElementById('inf-titulo').value.trim();
      const resumen = document.getElementById('inf-resumen').value.trim();
      const contenido = document.getElementById('inf-contenido').value.trim();
      
      // Recoger evaluaciones
      const evalItems = document.querySelectorAll('.eval-item');
      const evaluaciones = [];
      const nivelPuntuacion = { EXCELENTE: 5, BUENO: 4, ACEPTABLE: 3, MEJORABLE: 2, CRITICO: 1 };
      
      evalItems.forEach(item => {
        const aspecto = item.querySelector('.eval-aspecto').value.trim();
        const nivel = item.querySelector('.eval-nivel').value;
        const comentario = item.querySelector('.eval-comentario').value.trim();
        if (aspecto) {
          evaluaciones.push({
            aspecto,
            nivel,
            puntuacion: nivelPuntuacion[nivel] || 3,
            comentario
          });
        }
      });
      
      // Recoger recomendaciones
      const recItems = document.querySelectorAll('.rec-item');
      const recomendaciones = [];
      
      recItems.forEach(item => {
        const rec_titulo = item.querySelector('.rec-titulo').value.trim();
        const prioridad = item.querySelector('.rec-prioridad').value;
        const descripcion = item.querySelector('.rec-descripcion').value.trim();
        const modulo = item.querySelector('.rec-modulo').value.trim();
        if (rec_titulo) {
          recomendaciones.push({
            titulo: rec_titulo,
            prioridad,
            descripcion,
            modulo_afectado: modulo || 'general',
            pasos_implementacion: []
          });
        }
      });
      
      if (!titulo || !resumen) {
        alert('Por favor complete el t√≠tulo y resumen del informe');
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/tutorias/visitas/${visitaEnCurso.id}/finalizar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            titulo,
            resumen,
            contenido,
            evaluaciones,
            recomendaciones,
            objetivos_cumplidos: [],
            objetivos_pendientes: [],
            proximos_pasos: []
          })
        });
        const data = await res.json();
        
        if (data.ok) {
          addToBitacora(`Informe firmado: ${titulo}`, 'success', 'tutorias');
          addActivity(`Visita finalizada - Informe: ${data.informe?.firma?.substring(0, 8)}`, 'success');
          
          // Cerrar modal y limpiar
          cerrarModalInforme();
          if (visitaTimer) clearInterval(visitaTimer);
          visitaEnCurso = null;
          document.getElementById('visita-en-curso').style.display = 'none';
          
          // Actualizar datos
          await refreshTutorias();
          
          alert(`‚úÖ Informe firmado exitosamente!\n\nFirma: ${data.informe?.firma || 'N/A'}\nHash: ${data.informe?.hash?.substring(0, 16) || 'N/A'}\nPuntuaci√≥n: ${data.informe?.puntuacion_global?.toFixed(1) || 'N/A'}/5`);
        } else {
          alert('Error: ' + (data.detail || 'No se pudo enviar el informe'));
        }
      } catch (e) {
        alert('Error de conexi√≥n: ' + e.message);
      }
    }

    async function cargarHistorialVisitas() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/visitas?limite=10&solo_completadas=true`);
        const data = await res.json();
        if (data.ok) {
          renderHistorialVisitas(data.visitas || []);
        }
      } catch (e) {
        console.log('Error cargando historial:', e);
      }
    }

    function renderHistorialVisitas(visitas) {
      const container = document.getElementById('historial-visitas');
      if (!container) return;
      
      if (!visitas.length) {
        container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 2rem;">
          No hay visitas registradas a√∫n
        </div>`;
        return;
      }
      
      const tipoEmojis = {
        tutoria: 'üìö', revision: 'üîç', auditoria: 'üìä', capacitacion: 'üéì',
        mantenimiento: 'üîß', emergencia: 'üö®', seguimiento: 'üìå'
      };
      
      container.innerHTML = visitas.map(v => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem;">
          <div>
            <span style="margin-right: 0.5rem;">${tipoEmojis[v.tipo] || 'üìã'}</span>
            <strong style="color: var(--accent-cyan);">${v.tipo?.toUpperCase() || 'VISITA'}</strong>
            <span style="color: var(--text-muted); margin-left: 0.5rem;">
              por ${v.especialista?.nombre || 'N/A'}
            </span>
            <div style="font-size: 0.85rem; color: var(--text-muted);">
              ${v.motivo || 'Sin motivo'} | ${v.duracion_minutos || 0} min
            </div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 0.85rem; color: var(--text-muted);">
              ${new Date(v.fecha_inicio).toLocaleDateString()}
            </div>
            ${v.informe?.firmado ? `<span style="color: var(--accent-green); font-size: 0.75rem;">‚úÖ Firmado</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    async function cargarRecomendaciones() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/recomendaciones?estado=PENDIENTE&limite=10`);
        const data = await res.json();
        if (data.ok) {
          renderRecomendaciones(data.recomendaciones || []);
        }
      } catch (e) {
        console.log('Error cargando recomendaciones:', e);
      }
    }

    function renderRecomendaciones(recomendaciones) {
      const container = document.getElementById('lista-recomendaciones');
      if (!container) return;
      
      if (!recomendaciones.length) {
        container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 2rem;">
          No hay recomendaciones pendientes üëç
        </div>`;
        return;
      }
      
      const prioridadColors = {
        CRITICA: 'var(--accent-red)', ALTA: 'var(--accent-orange)',
        MEDIA: 'var(--accent-orange)', BAJA: 'var(--accent-green)', OPCIONAL: 'var(--text-muted)'
      };
      
      container.innerHTML = recomendaciones.map(r => `
        <div style="padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${prioridadColors[r.prioridad] || 'var(--border)'};">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <strong style="color: var(--text);">${r.titulo}</strong>
              <span style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: ${prioridadColors[r.prioridad]}; color: white; border-radius: 10px; margin-left: 0.5rem;">${r.prioridad}</span>
              <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                ${r.descripcion || 'Sin descripci√≥n'}
              </div>
              <div style="font-size: 0.75rem; color: var(--accent-purple); margin-top: 0.25rem;">
                M√≥dulo: ${r.modulo_afectado || 'general'}
              </div>
            </div>
            <button onclick="marcarRecomendacion('${r.id}', 'COMPLETADA')" style="padding: 0.25rem 0.5rem; background: var(--accent-green); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">‚úì</button>
          </div>
        </div>
      `).join('');
    }

    async function marcarRecomendacion(id, estado) {
      try {
        await fetch(`${API_BASE}/tutorias/recomendaciones/${id}/estado?estado=${estado}`, {
          method: 'PUT'
        });
        addToBitacora(`Recomendaci√≥n ${estado.toLowerCase()}`, 'success', 'tutorias');
        await cargarRecomendaciones();
        await cargarEstadisticas();
      } catch (e) {
        console.log('Error actualizando recomendaci√≥n:', e);
      }
    }

    async function cargarSeguimientos() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/seguimientos?solo_activos=true`);
        const data = await res.json();
        if (data.ok) {
          renderSeguimientos(data.seguimientos || []);
        }
      } catch (e) {
        console.log('Error cargando seguimientos:', e);
      }
    }

    function renderSeguimientos(seguimientos) {
      const container = document.getElementById('lista-seguimientos');
      if (!container) return;
      
      if (!seguimientos.length) {
        container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 2rem;">
          No hay seguimientos activos
        </div>`;
        return;
      }
      
      container.innerHTML = seguimientos.map(s => `
        <div style="padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 0.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <strong style="color: var(--text);">${s.titulo}</strong>
            <span style="color: var(--accent-cyan); font-weight: bold;">${s.porcentaje_avance}%</span>
          </div>
          <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple)); height: 100%; width: ${s.porcentaje_avance}%; transition: width 0.3s;"></div>
          </div>
          <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
            Responsable: ${s.responsable || 'ATLAS'} | ${s.hitos?.length || 0} hitos
          </div>
        </div>
      `).join('');
    }

    async function generarDashboardTutorias() {
      try {
        const res = await fetch(`${API_BASE}/tutorias/dashboard`);
        const data = await res.json();
        if (data.ok) {
          addToBitacora(`Dashboard generado: ${data.dashboard_path}`, 'success', 'tutorias');
          alert('Dashboard generado en:\n' + data.dashboard_path);
        }
      } catch (e) {
        alert('Error generando dashboard');
      }
    }

    async function exportarRecomendaciones() {
      addToBitacora('Exportando recomendaciones...', 'info', 'tutorias');
      // Simplemente descargar lista actual
      try {
        const res = await fetch(`${API_BASE}/tutorias/recomendaciones?limite=100`);
        const data = await res.json();
        if (data.ok) {
          const blob = new Blob([JSON.stringify(data.recomendaciones, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `recomendaciones_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          addToBitacora('Recomendaciones exportadas', 'success', 'tutorias');
        }
      } catch (e) {
        alert('Error exportando recomendaciones');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMUNICACIONES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function refreshCommsStatus() {
      try {
        document.getElementById('comms-status').textContent = 'VERIFICANDO...';
        document.getElementById('comms-status').style.background = 'var(--accent-orange)';
        
        const response = await fetch('/ans/comms/status');
        if (!response.ok) throw new Error('API no disponible');
        
        const data = await response.json();
        
        // WhatsApp
        const waStatus = data.whatsapp?.connected ? '‚úÖ Conectado' : '‚ùå Desconectado';
        document.getElementById('comms-whatsapp-status').textContent = waStatus;
        document.getElementById('waha-connection-status').textContent = waStatus;
        document.getElementById('waha-session-name').textContent = data.whatsapp?.session || 'default';
        document.getElementById('waha-phone-number').textContent = data.whatsapp?.phone || '--';
        
        // Telegram
        const tgStatus = data.telegram?.configured ? '‚úÖ Configurado' : '‚ö†Ô∏è Sin configurar';
        document.getElementById('comms-telegram-status').textContent = tgStatus;
        document.getElementById('telegram-connection-status').textContent = tgStatus;
        document.getElementById('telegram-token-status').textContent = data.telegram?.has_token ? '‚úÖ Presente' : '‚ùå Falta';
        document.getElementById('telegram-chat-id').textContent = data.telegram?.chat_id || '--';
        
        // Audio
        const audioStatus = data.audio?.available ? '‚úÖ Disponible' : '‚ùå No disponible';
        document.getElementById('comms-audio-status').textContent = audioStatus;
        document.getElementById('audio-connection-status').textContent = audioStatus;
        document.getElementById('audio-engine').textContent = data.audio?.engine || 'pyttsx3';
        
        // Messages today
        document.getElementById('comms-messages-today').textContent = data.messages_today || '0';
        
        // Overall status
        const allOk = data.whatsapp?.connected && data.telegram?.configured && data.audio?.available;
        document.getElementById('comms-status').textContent = allOk ? 'OPERATIVO' : 'PARCIAL';
        document.getElementById('comms-status').style.background = allOk ? 'var(--accent-green)' : 'var(--accent-orange)';
        
        addToBitacora('Estado de comunicaciones actualizado', 'success', 'comms');
      } catch (e) {
        console.error('Error refreshing comms:', e);
        document.getElementById('comms-status').textContent = 'ERROR';
        document.getElementById('comms-status').style.background = 'var(--accent-red)';
        addToBitacora('Error verificando comunicaciones: ' + e.message, 'error', 'comms');
      }
    }
    
    function openWahaDashboard() {
      window.open('http://localhost:3000/dashboard', '_blank');
      addToBitacora('Abriendo WAHA Dashboard', 'info', 'comms');
    }
    
    async function showQRCode() {
      try {
        const container = document.getElementById('waha-qr-container');
        const img = document.getElementById('waha-qr-image');
        
        addToBitacora('Obteniendo c√≥digo QR de WhatsApp...', 'info', 'comms');
        
        const response = await fetch('/ans/comms/waha/qr');
        if (!response.ok) throw new Error('No se pudo obtener QR');
        
        const data = await response.json();
        if (data.qr_base64) {
          img.src = 'data:image/png;base64,' + data.qr_base64;
          container.style.display = 'block';
          addToBitacora('QR obtenido - escanear con WhatsApp', 'success', 'comms');
        } else {
          alert(data.message || 'Sesi√≥n ya conectada o QR no disponible');
          container.style.display = 'none';
        }
      } catch (e) {
        alert('Error obteniendo QR: ' + e.message);
        addToBitacora('Error obteniendo QR: ' + e.message, 'error', 'comms');
      }
    }
    
    async function restartWahaSession() {
      if (!confirm('¬øReiniciar sesi√≥n de WhatsApp? Se desconectar√° temporalmente.')) return;
      
      try {
        addToBitacora('Reiniciando sesi√≥n WAHA...', 'info', 'comms');
        const response = await fetch('/ans/comms/waha/restart', { method: 'POST' });
        const data = await response.json();
        
        if (data.ok) {
          addToBitacora('Sesi√≥n reiniciada - mostrando QR', 'success', 'comms');
          setTimeout(showQRCode, 2000);
        } else {
          throw new Error(data.error || 'Error reiniciando');
        }
      } catch (e) {
        alert('Error: ' + e.message);
        addToBitacora('Error reiniciando sesi√≥n: ' + e.message, 'error', 'comms');
      }
    }
    
    async function testWhatsApp() {
      try {
        addToBitacora('Enviando test a WhatsApp...', 'info', 'comms');
        const response = await fetch('/ans/comms/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel: 'whatsapp', message: 'Test desde Dashboard ATLAS' })
        });
        const data = await response.json();
        if (data.ok) {
          addToBitacora('Test WhatsApp enviado', 'success', 'comms');
          alert('Mensaje enviado a WhatsApp');
        } else {
          throw new Error(data.error || 'Error enviando');
        }
      } catch (e) {
        alert('Error: ' + e.message);
        addToBitacora('Error test WhatsApp: ' + e.message, 'error', 'comms');
      }
    }
    
    async function testTelegram() {
      try {
        addToBitacora('Enviando test a Telegram...', 'info', 'comms');
        const response = await fetch('/ans/comms/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel: 'telegram', message: 'Test desde Dashboard ATLAS' })
        });
        const data = await response.json();
        if (data.ok) {
          addToBitacora('Test Telegram enviado', 'success', 'comms');
          alert('Mensaje enviado a Telegram');
        } else {
          throw new Error(data.error || 'Error enviando');
        }
      } catch (e) {
        alert('Error: ' + e.message);
        addToBitacora('Error test Telegram: ' + e.message, 'error', 'comms');
      }
    }
    
    async function testAudio() {
      try {
        addToBitacora('Probando audio TTS...', 'info', 'comms');
        const response = await fetch('/ans/comms/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel: 'audio', message: 'Test de audio desde Dashboard' })
        });
        const data = await response.json();
        if (data.ok) {
          addToBitacora('Test Audio ejecutado', 'success', 'comms');
          alert('Audio reproducido');
        } else {
          throw new Error(data.error || 'Error');
        }
      } catch (e) {
        alert('Error: ' + e.message);
        addToBitacora('Error test Audio: ' + e.message, 'error', 'comms');
      }
    }
    
    async function testAllComms() {
      addToBitacora('Probando todos los canales...', 'info', 'comms');
      await testWhatsApp();
      await testTelegram();
      await testAudio();
      addToBitacora('Test completo finalizado', 'success', 'comms');
    }
    
    async function sendTestAll() {
      try {
        addToBitacora('Enviando notificaci√≥n a todos los canales...', 'info', 'comms');
        const response = await fetch('/ans/comms/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel: 'all', message: 'Notificaci√≥n broadcast desde ATLAS Dashboard' })
        });
        const data = await response.json();
        if (data.ok) {
          addToBitacora('Notificaci√≥n broadcast enviada', 'success', 'comms');
          alert('Notificaci√≥n enviada a todos los canales');
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    async function reconnectAllComms() {
      addToBitacora('Reconectando servicios de comunicaci√≥n...', 'info', 'comms');
      await restartWahaSession();
      setTimeout(refreshCommsStatus, 3000);
    }
    
    async function loadCommsBitacora() {
      try {
        const response = await fetch('/ans/bitacora?limit=20');
        if (!response.ok) return;
        
        const data = await response.json();
        const container = document.getElementById('comms-activity-list');
        
        // Filter comms-related entries
        const commsEntries = (data.entries || []).filter(e => 
          ['whatsapp', 'telegram', 'audio', 'comms'].includes(e.category?.toLowerCase())
        );
        
        if (commsEntries.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted);">Sin eventos de comunicaci√≥n recientes</p>';
          return;
        }
        
        container.innerHTML = commsEntries.slice(0, 10).map(e => {
          const time = new Date(e.timestamp || Date.now()).toLocaleTimeString();
          const icon = e.icon || 'üì°';
          const levelColor = e.level === 'error' ? 'var(--accent-red)' : 
                             e.level === 'warning' ? 'var(--accent-orange)' : 'var(--text-muted)';
          return `<div style="padding: 0.5rem; border-bottom: 1px solid var(--border);">
            <span style="color: var(--text-muted);">${time}</span> ${icon} 
            <span style="color: ${levelColor};">${e.message || e.event || '--'}</span>
          </div>`;
        }).join('');
      } catch (e) {
        console.error('Error loading comms bitacora:', e);
      }
    }
    
    // Auto-refresh comms when tab is active
    document.addEventListener('DOMContentLoaded', () => {
      const commsTab = document.querySelector('[data-tab="comms"]');
      if (commsTab) {
        commsTab.addEventListener('click', () => {
          refreshCommsStatus();
          loadCommsBitacora();
          refreshVoiceStatus();
        });
      }
    });
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VOICE ASSISTANT - Control de interacci√≥n por voz
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    let voiceAssistantRunning = false;
    
    async function refreshVoiceStatus() {
      try {
        const response = await fetch('/ans/voice/status');
        if (!response.ok) return;
        
        const data = await response.json();
        voiceAssistantRunning = data.running;
        
        const statusEl = document.getElementById('voice-assistant-status');
        const btnEl = document.getElementById('voice-toggle-btn');
        
        if (data.running) {
          statusEl.textContent = 'üü¢ Activo (PID: ' + data.pid + ')';
          statusEl.style.color = 'var(--accent-green)';
          btnEl.textContent = 'üõë Detener Voz';
          btnEl.style.background = 'var(--accent-red)';
        } else {
          statusEl.textContent = '‚ö™ Inactivo';
          statusEl.style.color = 'var(--text-muted)';
          btnEl.textContent = 'üé§ Iniciar Voz';
          btnEl.style.background = '';
        }
      } catch (e) {
        console.error('Error refreshing voice status:', e);
      }
    }
    
    async function toggleVoiceAssistant() {
      const endpoint = voiceAssistantRunning ? '/ans/voice/stop' : '/ans/voice/start';
      const action = voiceAssistantRunning ? 'Deteniendo' : 'Iniciando';
      
      try {
        addToBitacora(action + ' asistente de voz...', 'info', 'voice');
        
        const response = await fetch(endpoint, { method: 'POST' });
        const data = await response.json();
        
        if (data.ok) {
          addToBitacora('Asistente de voz ' + (voiceAssistantRunning ? 'detenido' : 'iniciado'), 'success', 'voice');
          setTimeout(refreshVoiceStatus, 1000);
        } else {
          throw new Error(data.error || 'Error');
        }
      } catch (e) {
        alert('Error: ' + e.message);
        addToBitacora('Error con asistente de voz: ' + e.message, 'error', 'voice');
      }
    }
    
    async function speakCustomText() {
      const input = document.getElementById('speak-text-input');
      const text = (input.value || '').trim();
      
      if (!text) {
        alert('Escribe algo para que ATLAS hable');
        return;
      }
      
      try {
        addToBitacora('ATLAS hablando: ' + text.substring(0, 30) + '...', 'info', 'voice');
        
        const response = await fetch('/ans/voice/speak?text=' + encodeURIComponent(text), {
          method: 'POST'
        });
        const data = await response.json();
        
        if (data.ok) {
          addToBitacora('ATLAS habl√≥ correctamente', 'success', 'voice');
          input.value = '';
        } else {
          throw new Error(data.error || 'Error');
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    // Enter key para hablar
    document.addEventListener('DOMContentLoaded', () => {
      const speakInput = document.getElementById('speak-text-input');
      if (speakInput) {
        speakInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') speakCustomText();
        });
      }
    });
  </script>
</body>
</html>

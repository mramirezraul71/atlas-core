<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ATLAS Workspace â€” Agent IDE</title>
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       THEMES â€” Same system as Dashboard v3.8
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root, [data-theme="cyan"] {
      --bg: #0d1117; --bg-card: #161b22; --bg-elevated: #21262d;
      --bg-input: #0d1117; --border: #30363d; --border-focus: #58a6ff;
      --text: #e6edf3; --text-muted: #8b949e; --text-dim: #484f58;
      --accent: #58a6ff; --accent-cyan: #39d3c4; --accent-green: #3fb950;
      --accent-purple: #a371f7; --accent-pink: #f778ba;
      --accent-orange: #d29922; --accent-red: #f85149;
      --accent-primary: #39d3c4;
      --glow: rgba(57, 211, 196, 0.15);
      --glow-strong: rgba(57, 211, 196, 0.4);
    }
    [data-theme="purple"] {
      --bg: #0f0a1a; --bg-card: #1a1225; --bg-elevated: #251a35;
      --bg-input: #0f0a1a; --border: #3d2a5a; --border-focus: #a371f7;
      --accent-cyan: #a371f7; --accent-primary: #a371f7;
      --glow: rgba(163,113,247,0.15); --glow-strong: rgba(163,113,247,0.4);
    }
    [data-theme="green"] {
      --bg: #0a1208; --bg-card: #0f1a0c; --bg-elevated: #162212;
      --bg-input: #0a1208; --border: #2a4020; --border-focus: #3fb950;
      --accent-cyan: #3fb950; --accent-primary: #3fb950;
      --glow: rgba(63,185,80,0.15); --glow-strong: rgba(63,185,80,0.4);
    }
    [data-theme="blue"] {
      --bg: #0a101a; --bg-card: #0f1622; --bg-elevated: #152030;
      --bg-input: #0a101a; --border: #203050; --border-focus: #3b82f6;
      --accent-cyan: #3b82f6; --accent-primary: #3b82f6;
      --glow: rgba(59,130,246,0.15); --glow-strong: rgba(59,130,246,0.4);
    }
    [data-theme="orange"] {
      --bg: #1a1008; --bg-card: #221508; --bg-elevated: #2d1c0a;
      --bg-input: #1a1008; --border: #4a3010; --border-focus: #f59e0b;
      --accent-cyan: #f59e0b; --accent-primary: #f59e0b;
      --glow: rgba(245,158,11,0.15); --glow-strong: rgba(245,158,11,0.4);
    }
    [data-theme="pink"] {
      --bg: #1a0a14; --bg-card: #22101a; --bg-elevated: #2d1522;
      --bg-input: #1a0a14; --border: #4a2040; --border-focus: #f778ba;
      --accent-cyan: #f778ba; --accent-primary: #f778ba;
      --glow: rgba(247,120,186,0.15); --glow-strong: rgba(247,120,186,0.4);
    }
    [data-theme="red"] {
      --bg: #1a0a0a; --bg-card: #221010; --bg-elevated: #2d1515;
      --bg-input: #1a0a0a; --border: #4a2020; --border-focus: #ef4444;
      --accent-cyan: #ef4444; --accent-primary: #ef4444;
      --glow: rgba(239,68,68,0.15); --glow-strong: rgba(239,68,68,0.4);
    }
    [data-theme="gold"] {
      --bg: #12100a; --bg-card: #1a1608; --bg-elevated: #221c0a;
      --bg-input: #12100a; --border: #3d3010; --border-focus: #fbbf24;
      --accent-cyan: #fbbf24; --accent-primary: #fbbf24;
      --glow: rgba(251,191,36,0.15); --glow-strong: rgba(251,191,36,0.4);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESET & BASE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'Consolas', monospace;
      background: var(--bg); color: var(--text);
      height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
    }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    ::selection { background: var(--glow-strong); color: var(--text); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOP BAR â€” Mission Control
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .topbar {
      display: flex; align-items: center; height: 40px;
      background: var(--bg-card); border-bottom: 1px solid var(--border);
      padding: 0 12px; gap: 10px; flex-shrink: 0;
      user-select: none;
    }
    .topbar-brand {
      font-weight: 800; font-size: 14px; color: var(--accent-primary);
      letter-spacing: 1.5px; display: flex; align-items: center; gap: 6px;
    }
    .topbar-brand svg { width: 18px; height: 18px; }
    .topbar-nav { display: flex; gap: 2px; margin-left: 16px; }
    .topbar-btn {
      padding: 4px 10px; background: transparent; border: none;
      color: var(--text-muted); font-size: 12px; font-family: inherit;
      cursor: pointer; border-radius: 4px; transition: all 0.15s;
    }
    .topbar-btn:hover { background: var(--bg-elevated); color: var(--text); }
    .topbar-btn.active { background: var(--accent-primary); color: var(--bg); font-weight: 700; }
    .topbar-spacer { flex: 1; }
    .topbar-services { display: flex; gap: 12px; align-items: center; font-size: 11px; }
    .svc { display: flex; align-items: center; gap: 4px; color: var(--text-muted); }
    .svc-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--text-dim); transition: background 0.3s; }
    .svc-dot.on { background: var(--accent-green); box-shadow: 0 0 6px var(--accent-green); }
    .svc-dot.off { background: var(--accent-red); box-shadow: 0 0 6px var(--accent-red); }
    .theme-dots { display: flex; gap: 3px; margin-left: 8px; }
    .tdot {
      width: 14px; height: 14px; border-radius: 50%; border: 2px solid transparent;
      cursor: pointer; transition: all 0.2s;
    }
    .tdot:hover { transform: scale(1.25); }
    .tdot.active { border-color: #fff; box-shadow: 0 0 6px currentColor; }
    .topbar-time { color: var(--text-dim); font-size: 11px; font-variant-numeric: tabular-nums; }
    .topbar-link {
      color: var(--text-muted); text-decoration: none; font-size: 11px;
      padding: 3px 8px; border: 1px solid var(--border); border-radius: 4px;
      transition: all 0.15s;
    }
    .topbar-link:hover { border-color: var(--accent-primary); color: var(--accent-primary); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN LAYOUT â€” 3-Column IDE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .ide-layout {
      flex: 1; display: flex; overflow: hidden;
    }

    /* LEFT PANEL â€” Chat + Voice */
    .panel-left {
      width: 380px; min-width: 300px; max-width: 500px;
      display: flex; flex-direction: column;
      border-right: 1px solid var(--border);
      background: var(--bg-card);
    }

    /* Resize handle */
    .resize-handle {
      width: 4px; cursor: col-resize; background: transparent;
      transition: background 0.2s; flex-shrink: 0; position: relative;
    }
    .resize-handle:hover, .resize-handle.dragging { background: var(--accent-primary); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHAT PANEL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .chat-header {
      padding: 8px 12px; border-bottom: 1px solid var(--border);
      font-size: 12px; font-weight: 600; color: var(--accent-primary);
      display: flex; align-items: center; gap: 8px;
    }
    .chat-header .badge {
      background: var(--bg-elevated); color: var(--text-muted);
      padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 400;
    }
    .chat-messages {
      flex: 1; overflow-y: auto; padding: 12px;
      display: flex; flex-direction: column; gap: 8px;
    }
    .msg {
      padding: 10px 12px; border-radius: 8px; font-size: 13px;
      line-height: 1.55; max-width: 95%; word-wrap: break-word;
      animation: msgIn 0.2s ease-out;
    }
    @keyframes msgIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    .msg.user {
      background: var(--accent-primary); color: var(--bg);
      align-self: flex-end; border-bottom-right-radius: 2px;
      font-weight: 500;
    }
    .msg.atlas {
      background: var(--bg-elevated); border: 1px solid var(--border);
      align-self: flex-start; border-bottom-left-radius: 2px;
    }
    .msg.atlas .msg-label {
      font-size: 10px; font-weight: 700; color: var(--accent-primary);
      margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .msg.system {
      background: transparent; color: var(--text-dim); font-size: 11px;
      text-align: center; align-self: center; font-style: italic;
    }
    .msg pre {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 6px; padding: 8px 10px; margin: 6px 0;
      font-size: 12px; overflow-x: auto; white-space: pre-wrap;
    }
    .msg code {
      background: var(--bg); padding: 1px 4px; border-radius: 3px;
      font-size: 12px; color: var(--accent-cyan);
    }
    .msg pre code { background: none; padding: 0; color: var(--text); }

    /* Thinking animation */
    .msg.thinking {
      background: var(--bg-elevated); border: 1px solid var(--border);
      align-self: flex-start;
    }
    .thinking-dots { display: flex; gap: 4px; padding: 4px 0; }
    .thinking-dots span {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--accent-primary); animation: pulse-dot 1.4s infinite;
    }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse-dot {
      0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1.1); }
    }

    /* Plan steps */
    .plan-steps { margin: 8px 0; }
    .plan-step {
      display: flex; align-items: center; gap: 8px; padding: 4px 0;
      font-size: 12px; color: var(--text-muted);
    }
    .plan-step.done { color: var(--accent-green); }
    .plan-step.active { color: var(--accent-primary); font-weight: 600; }
    .plan-step .step-icon { width: 16px; text-align: center; flex-shrink: 0; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VOICE ORB
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .voice-section {
      padding: 10px 12px; border-top: 1px solid var(--border);
      background: var(--bg-elevated);
    }
    .voice-controls {
      display: flex; align-items: center; gap: 10px;
    }
    .voice-orb-wrap {
      position: relative; width: 44px; height: 44px; flex-shrink: 0;
    }
    .voice-orb {
      width: 44px; height: 44px; border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, var(--bg-elevated), var(--bg));
      border: 2px solid var(--border); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s; position: relative; z-index: 2;
    }
    .voice-orb svg { width: 18px; height: 18px; color: var(--text-muted); transition: color 0.3s; }
    .voice-orb:hover { border-color: var(--accent-primary); }
    .voice-orb:hover svg { color: var(--accent-primary); }
    .voice-orb.listening {
      border-color: var(--accent-primary);
      box-shadow: 0 0 20px var(--glow-strong);
      animation: orb-breathe 2s ease-in-out infinite;
    }
    .voice-orb.listening svg { color: var(--accent-primary); }
    .voice-orb.speaking {
      border-color: var(--accent-green);
      box-shadow: 0 0 20px rgba(63,185,80,0.4);
      animation: orb-speak 0.6s ease-in-out infinite alternate;
    }
    .voice-orb.speaking svg { color: var(--accent-green); }
    @keyframes orb-speak {
      0% { transform: scale(1); }
      100% { transform: scale(1.08); }
    }
    @keyframes orb-breathe {
      0%, 100% { box-shadow: 0 0 15px var(--glow); }
      50% { box-shadow: 0 0 30px var(--glow-strong), 0 0 60px var(--glow); }
    }
    .voice-orb-ring {
      position: absolute; inset: -6px; border-radius: 50%;
      border: 1px solid var(--accent-primary); opacity: 0;
      pointer-events: none; z-index: 1;
    }
    .voice-orb.listening ~ .voice-orb-ring {
      animation: ring-expand 1.5s ease-out infinite;
    }
    @keyframes ring-expand {
      0% { inset: -4px; opacity: 0.6; }
      100% { inset: -20px; opacity: 0; }
    }

    /* Waveform */
    .voice-wave {
      flex: 1; height: 32px; display: flex; align-items: center;
      gap: 2px; padding: 0 6px;
    }
    .voice-wave .bar {
      flex: 1; max-width: 4px; background: var(--border);
      border-radius: 2px; height: 4px; transition: height 0.08s ease;
    }
    .voice-wave.active .bar { background: var(--accent-primary); }

    .voice-mode-toggle {
      font-size: 10px; color: var(--text-dim); cursor: pointer;
      padding: 2px 6px; border: 1px solid var(--border); border-radius: 4px;
      background: transparent; transition: all 0.15s; font-family: inherit;
      white-space: nowrap;
    }
    .voice-mode-toggle:hover { border-color: var(--accent-primary); color: var(--text-muted); }
    .voice-mode-toggle.active { background: var(--accent-primary); color: var(--bg); border-color: var(--accent-primary); }

    .voice-status {
      font-size: 10px; color: var(--text-dim); text-align: center;
      padding-top: 4px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHAT INPUT
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .chat-input-area {
      padding: 10px 12px; border-top: 1px solid var(--border);
      display: flex; flex-direction: column; gap: 6px;
      background: var(--bg-card);
    }
    .chat-input-row {
      display: flex; gap: 6px; align-items: flex-end;
    }
    .chat-textarea {
      flex: 1; background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 12px; color: var(--text);
      font-family: inherit; font-size: 13px; resize: none;
      min-height: 38px; max-height: 160px; line-height: 1.4;
      outline: none; transition: border-color 0.2s;
    }
    .chat-textarea:focus { border-color: var(--accent-primary); }
    .chat-textarea::placeholder { color: var(--text-dim); }
    .chat-send {
      width: 38px; height: 38px; border-radius: 8px; border: none;
      background: var(--accent-primary); color: var(--bg);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.15s; flex-shrink: 0;
    }
    .chat-send:hover { filter: brightness(1.15); transform: scale(1.04); }
    .chat-send:disabled { opacity: 0.4; cursor: not-allowed; }
    .chat-send svg { width: 16px; height: 16px; }
    .chat-mode-bar {
      display: flex; gap: 6px; align-items: center; margin-bottom: 4px;
    }
    .chat-mode-bar select {
      font-family: inherit; font-size: 10px; background: var(--bg-elevated);
      color: var(--text-muted); border: 1px solid var(--border); border-radius: 4px;
      padding: 3px 6px; cursor: pointer; outline: none;
    }
    .chat-mode-bar select:focus { border-color: var(--accent-primary); }
    .sync-toggle {
      display: flex; align-items: center; gap: 3px; cursor: pointer;
      font-size: 9px; color: var(--text-muted); user-select: none;
      padding: 2px 6px; border-radius: 4px; border: 1px solid transparent;
      transition: all 0.2s;
    }
    .sync-toggle:hover { border-color: var(--border); }
    .sync-toggle input { width: 12px; height: 12px; cursor: pointer; accent-color: var(--accent-cyan); }
    .sync-toggle.active { border-color: var(--accent-cyan); color: var(--accent-cyan); background: rgba(0,200,200,0.06); }

    /* â”€â”€â”€ Model Selector (Cursor-style) â”€â”€â”€ */
    .model-selector-wrap { position: relative; }
    .model-selector-btn {
      display: flex; align-items: center; gap: 5px; padding: 3px 8px;
      background: var(--bg-elevated); border: 1px solid var(--border);
      border-radius: 4px; color: var(--text); font-family: inherit;
      font-size: 11px; cursor: pointer; transition: all 0.15s;
      white-space: nowrap;
    }
    .model-selector-btn:hover { border-color: var(--accent-primary); background: var(--bg-card); }
    .model-selector-btn .model-icon { font-size: 12px; }
    .model-selector-btn svg { opacity: 0.5; margin-left: 2px; }
    .model-dropdown {
      display: none; position: absolute; bottom: calc(100% + 4px); left: 0;
      width: 320px; max-height: 420px; overflow-y: auto;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      z-index: 1000; padding: 4px 0;
    }
    .model-dropdown.open { display: block; }
    .model-dropdown .md-search {
      width: calc(100% - 12px); margin: 4px 6px; padding: 6px 8px;
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 4px; color: var(--text); font-family: inherit;
      font-size: 11px; outline: none;
    }
    .model-dropdown .md-search:focus { border-color: var(--accent-primary); }
    .model-dropdown .md-group {
      padding: 6px 10px 2px; font-size: 9px; color: var(--text-dim);
      text-transform: uppercase; letter-spacing: 1px; font-weight: 700;
    }
    .model-dropdown .md-item {
      display: flex; align-items: center; gap: 8px; padding: 6px 10px;
      cursor: pointer; transition: background 0.1s; border-radius: 4px;
      margin: 0 4px;
    }
    .model-dropdown .md-item:hover { background: var(--bg-elevated); }
    .model-dropdown .md-item.active { background: var(--glow); }
    .model-dropdown .md-item.unavailable { opacity: 0.4; }
    .model-dropdown .md-item .md-icon {
      width: 20px; height: 20px; border-radius: 4px; display: flex;
      align-items: center; justify-content: center; font-size: 11px;
      flex-shrink: 0; font-weight: 700;
    }
    .md-icon.openai { background: #10a37f22; color: #10a37f; }
    .md-icon.anthropic { background: #d4a27422; color: #d4a274; }
    .md-icon.gemini, .md-icon.google { background: #4285f422; color: #4285f4; }
    .md-icon.xai { background: #e5e5e522; color: #e5e5e5; }
    .md-icon.deepseek { background: #536dfe22; color: #536dfe; }
    .md-icon.groq { background: #f5560022; color: #f55600; }
    .md-icon.mistral { background: #ff720022; color: #ff7200; }
    .md-icon.perplexity { background: #20b2aa22; color: #20b2aa; }
    .md-icon.ollama { background: #80808022; color: #aaa; }
    .md-icon.atlas { background: var(--glow); color: var(--accent-primary); }
    .model-dropdown .md-item .md-info { flex: 1; min-width: 0; }
    .model-dropdown .md-item .md-label {
      font-size: 12px; color: var(--text); font-weight: 500; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis;
    }
    .model-dropdown .md-item .md-desc {
      font-size: 9px; color: var(--text-dim); white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis;
    }
    .model-dropdown .md-item .md-badge {
      font-size: 8px; padding: 1px 5px; border-radius: 3px;
      font-weight: 600; flex-shrink: 0; text-transform: uppercase;
    }
    .md-badge.available { background: var(--accent-green); color: #000; opacity: 0.8; }
    .md-badge.missing { background: var(--border); color: var(--text-dim); }
    .chat-hints {
      display: flex; gap: 6px; flex-wrap: wrap;
    }
    .chat-hint {
      font-size: 10px; color: var(--text-dim); background: var(--bg-elevated);
      padding: 2px 8px; border-radius: 4px; cursor: pointer;
      border: 1px solid transparent; transition: all 0.15s;
    }
    .chat-hint:hover { border-color: var(--border); color: var(--text-muted); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RIGHT PANEL â€” Split View (Code + Live Feed)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .panel-right {
      flex: 1; display: flex; flex-direction: column;
      background: var(--bg);
    }

    /* Top sub-panel: Code / Preview */
    .split-top {
      flex: 1; display: flex; flex-direction: column;
      min-height: 120px; overflow: hidden;
    }
    .split-top-tabs {
      display: flex; align-items: center; height: 32px;
      background: var(--bg-card); border-bottom: 1px solid var(--border);
      padding: 0 8px; gap: 2px; flex-shrink: 0;
    }
    .split-tab {
      padding: 3px 10px; background: transparent; border: none;
      color: var(--text-muted); font-size: 11px; font-family: inherit;
      cursor: pointer; border-radius: 4px 4px 0 0; transition: all 0.15s;
      border-bottom: 2px solid transparent;
    }
    .split-tab:hover { color: var(--text); background: var(--bg-elevated); }
    .split-tab.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); font-weight: 600; }
    .split-tab-spacer { flex: 1; }
    .split-tab-action {
      font-size: 10px; color: var(--text-dim); background: transparent;
      border: 1px solid var(--border); border-radius: 4px;
      padding: 2px 8px; cursor: pointer; font-family: inherit;
      transition: all 0.15s;
    }
    .split-tab-action:hover { border-color: var(--accent-primary); color: var(--accent-primary); }

    .split-top-content {
      flex: 1; overflow: hidden; position: relative;
    }
    .top-panel {
      position: absolute; inset: 0; overflow: auto;
      display: none; flex-direction: column;
    }
    .top-panel.active { display: flex; }

    /* Horizontal resize between top and bottom */
    .split-h-handle {
      height: 4px; cursor: row-resize; background: transparent;
      transition: background 0.2s; flex-shrink: 0;
      border-top: 1px solid var(--border);
    }
    .split-h-handle:hover, .split-h-handle.dragging { background: var(--accent-primary); }

    /* Bottom sub-panel: LIVE FEED (always visible) */
    .split-bottom {
      height: 240px; min-height: 100px; max-height: 60vh;
      display: flex; flex-direction: column;
      background: var(--bg-card);
      overflow: hidden;
    }
    .live-header {
      display: flex; align-items: center; gap: 8px; padding: 5px 12px;
      background: var(--bg-elevated); border-bottom: 1px solid var(--border);
      font-size: 11px; color: var(--text-muted); flex-shrink: 0;
      user-select: none;
    }
    .live-indicator {
      display: flex; align-items: center; gap: 5px;
      font-weight: 700; font-size: 10px; text-transform: uppercase;
      letter-spacing: 1px; color: var(--text-dim);
      transition: color 0.3s;
    }
    .live-indicator.active { color: var(--accent-red); }
    .live-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--text-dim); transition: background 0.3s;
    }
    .live-indicator.active .live-dot {
      background: var(--accent-red);
      animation: live-pulse 1s ease-in-out infinite;
    }
    @keyframes live-pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(248,81,73,0.4); }
      50% { opacity: 0.7; box-shadow: 0 0 8px 2px rgba(248,81,73,0.3); }
    }
    .live-filter-tabs { display: flex; gap: 2px; margin-left: 8px; }
    .live-filter {
      padding: 2px 8px; background: transparent; border: 1px solid transparent;
      color: var(--text-dim); font-size: 10px; font-family: inherit;
      cursor: pointer; border-radius: 3px; transition: all 0.15s;
    }
    .live-filter:hover { color: var(--text-muted); border-color: var(--border); }
    .live-filter.active { color: var(--accent-primary); border-color: var(--accent-primary); background: rgba(57,211,196,0.08); }
    .live-count {
      margin-left: auto; font-size: 10px; color: var(--text-dim);
      font-variant-numeric: tabular-nums;
    }

    .live-feed {
      flex: 1; overflow-y: auto; padding: 4px 0;
      font-size: 12px; scroll-behavior: smooth;
    }
    .live-entry {
      display: flex; align-items: flex-start; gap: 8px;
      padding: 4px 12px; transition: background 0.15s;
      animation: liveIn 0.25s ease-out;
      border-left: 3px solid transparent;
    }
    .live-entry:hover { background: var(--bg-elevated); }
    .live-entry.highlight { border-left-color: var(--accent-primary); background: var(--glow); }
    @keyframes liveIn {
      from { opacity: 0; transform: translateX(-8px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .live-ts {
      color: var(--text-dim); font-size: 10px; flex-shrink: 0;
      width: 52px; text-align: right; padding-top: 2px;
      font-variant-numeric: tabular-nums;
    }
    .live-badge {
      flex-shrink: 0; font-size: 9px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; padding: 1px 5px; border-radius: 3px;
      min-width: 38px; text-align: center;
    }
    .live-badge.exec { background: rgba(57,211,196,0.15); color: var(--accent-cyan); }
    .live-badge.code { background: rgba(163,113,247,0.15); color: var(--accent-purple); }
    .live-badge.file { background: rgba(63,185,80,0.15); color: var(--accent-green); }
    .live-badge.cmd { background: rgba(88,166,255,0.15); color: var(--accent); }
    .live-badge.err { background: rgba(248,81,73,0.15); color: var(--accent-red); }
    .live-badge.voice { background: rgba(247,120,186,0.15); color: var(--accent-pink); }
    .live-badge.info { background: rgba(139,148,158,0.1); color: var(--text-muted); }
    .live-badge.plan { background: rgba(210,153,34,0.15); color: var(--accent-orange); }
    .live-text {
      flex: 1; color: var(--text-muted); line-height: 1.45;
      word-break: break-word;
    }
    .live-text strong { color: var(--text); font-weight: 600; }
    .live-text code {
      background: var(--bg); padding: 0 4px; border-radius: 3px;
      font-size: 11px; color: var(--accent-cyan);
    }
    .live-text .term-line {
      font-family: 'SF Mono','Cascadia Code','Consolas',monospace;
      color: var(--text-muted); font-size: 11px;
    }
    .live-text .term-line.err { color: var(--accent-red); }
    .live-text .term-line.ok { color: var(--accent-green); }

    /* Terminal input inside live feed */
    .live-terminal-input {
      display: flex; align-items: center; gap: 6px;
      padding: 6px 12px; border-top: 1px solid var(--border);
      background: var(--bg); flex-shrink: 0;
    }
    .live-terminal-input label { color: var(--accent-primary); font-weight: 700; font-size: 11px; }
    .live-terminal-input input {
      flex: 1; background: transparent; border: none; color: var(--text);
      font-family: inherit; font-size: 12px; outline: none;
    }

    /* CODE VIEWER */
    .code-viewer {
      flex: 1; overflow: auto; padding: 0;
      font-size: 13px; line-height: 1.6;
    }
    .code-viewer .code-empty {
      display: flex; align-items: center; justify-content: center;
      height: 100%; color: var(--text-dim); flex-direction: column; gap: 12px;
    }
    .code-viewer .code-empty svg { width: 48px; height: 48px; opacity: 0.3; }
    .code-viewer .code-empty p { font-size: 13px; }
    .code-file-header {
      display: flex; align-items: center; gap: 8px; padding: 6px 12px;
      background: var(--bg-elevated); border-bottom: 1px solid var(--border);
      font-size: 12px; color: var(--text-muted); position: sticky; top: 0;
      z-index: 2;
    }
    .code-file-header .filename { color: var(--accent-primary); font-weight: 600; }
    .code-lines {
      display: flex; flex: 1;
    }
    .code-gutter {
      padding: 8px 8px 8px 12px; text-align: right;
      color: var(--text-dim); font-size: 12px; line-height: 1.6;
      user-select: none; border-right: 1px solid var(--border);
      background: var(--bg-card); flex-shrink: 0; min-width: 44px;
    }
    .code-body {
      padding: 8px 12px; flex: 1; overflow-x: auto;
      white-space: pre; font-size: 12px; line-height: 1.6;
      color: var(--text);
    }
    .code-body .kw { color: var(--accent-purple); }
    .code-body .fn { color: var(--accent-cyan); }
    .code-body .str { color: var(--accent-green); }
    .code-body .cm { color: var(--text-dim); font-style: italic; }
    .code-body .num { color: var(--accent-orange); }
    .code-body .op { color: var(--accent-pink); }
    .code-body .new-line {
      background: rgba(63,185,80,0.08); border-left: 3px solid var(--accent-green);
      margin-left: -12px; padding-left: 9px;
      animation: lineHighlight 0.4s ease;
    }
    @keyframes lineHighlight { from { background: rgba(63,185,80,0.2); } }

    /* PREVIEW */
    .preview-panel { background: var(--bg); }
    .preview-frame {
      width: 100%; height: 100%; border: none; background: #fff;
    }
    .preview-empty {
      display: flex; align-items: center; justify-content: center;
      height: 100%; color: var(--text-dim); flex-direction: column; gap: 12px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BOTTOM BAR â€” Status
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .bottombar {
      display: flex; align-items: center; height: 24px;
      background: var(--bg-card); border-top: 1px solid var(--border);
      padding: 0 12px; gap: 16px; font-size: 11px;
      color: var(--text-dim); flex-shrink: 0; user-select: none;
    }
    .bottombar-section { display: flex; align-items: center; gap: 4px; }
    .bottombar-section .dot {
      width: 6px; height: 6px; border-radius: 50%;
    }
    .bottombar-spacer { flex: 1; }
    .bottombar-key {
      background: var(--bg-elevated); padding: 0 4px; border-radius: 2px;
      font-size: 10px; color: var(--text-muted);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       QUICK ACTIONS â€” Floating
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .quick-actions {
      position: fixed; bottom: 36px; right: 16px;
      display: flex; flex-direction: column; gap: 6px;
      z-index: 100;
    }
    .qa-btn {
      width: 40px; height: 40px; border-radius: 10px;
      background: var(--bg-card); border: 1px solid var(--border);
      color: var(--text-muted); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .qa-btn:hover {
      border-color: var(--accent-primary); color: var(--accent-primary);
      transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    .qa-btn[title]::after {
      content: attr(title); position: absolute; right: 52px;
      background: var(--bg-elevated); color: var(--text);
      padding: 4px 8px; border-radius: 4px; font-size: 11px;
      white-space: nowrap; opacity: 0; pointer-events: none;
      transition: opacity 0.2s; border: 1px solid var(--border);
    }
    .qa-btn:hover[title]::after { opacity: 1; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       KEYBOARD SHORTCUTS OVERLAY
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .shortcuts-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      display: none; align-items: center; justify-content: center;
      z-index: 1000; backdrop-filter: blur(4px);
    }
    .shortcuts-overlay.visible { display: flex; }
    .shortcuts-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 12px; padding: 24px 32px; max-width: 420px;
      width: 90%;
    }
    .shortcuts-card h3 {
      font-size: 14px; color: var(--accent-primary); margin-bottom: 16px;
      font-weight: 700;
    }
    .shortcut-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 6px 0; font-size: 12px; border-bottom: 1px solid var(--border);
    }
    .shortcut-row:last-child { border-bottom: none; }
    .shortcut-keys {
      display: flex; gap: 4px;
    }
    .shortcut-key {
      background: var(--bg-elevated); padding: 2px 8px; border-radius: 4px;
      font-size: 11px; font-weight: 600; color: var(--text);
      border: 1px solid var(--border);
    }
  </style>
</head>
<body>

  <!-- â•â•â•â•â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â•â•â•â•â• -->
  <header class="topbar">
    <div class="topbar-brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5"/><line x1="12" y1="22" x2="12" y2="15.5"/><polyline points="22 8.5 12 15.5 2 8.5"/></svg>
      ATLAS WORKSPACE
    </div>
    <nav class="topbar-nav">
      <button class="topbar-btn active" data-view="chat" title="Agent Chat">Agent</button>
    </nav>
    <div class="topbar-spacer"></div>
    <div class="topbar-services">
      <a class="svc" href="javascript:void(0)" onclick="window.open('http://'+location.hostname+':8000','_blank')" title="Abrir NEXUS (puerto 8000)" style="cursor:pointer;text-decoration:none;color:inherit;"><span class="svc-dot" id="svc-nexus"></span>NEXUS</a>
      <span class="svc"><span class="svc-dot" id="svc-push"></span>PUSH</span>
      <a class="svc" href="javascript:void(0)" onclick="window.open('http://'+location.hostname+':8002','_blank')" title="Abrir Robot (puerto 8002)" style="cursor:pointer;text-decoration:none;color:inherit;"><span class="svc-dot" id="svc-robot"></span>ROBOT</a>
    </div>
    <div class="theme-dots">
      <button class="tdot active" data-theme="cyan" style="background:#39d3c4" title="Cyan"></button>
      <button class="tdot" data-theme="purple" style="background:#a371f7" title="Purple"></button>
      <button class="tdot" data-theme="green" style="background:#3fb950" title="Matrix"></button>
      <button class="tdot" data-theme="blue" style="background:#3b82f6" title="Blue"></button>
      <button class="tdot" data-theme="orange" style="background:#f59e0b" title="Orange"></button>
      <button class="tdot" data-theme="pink" style="background:#f778ba" title="Pink"></button>
      <button class="tdot" data-theme="red" style="background:#ef4444" title="Red"></button>
      <button class="tdot" data-theme="gold" style="background:#fbbf24" title="Gold"></button>
    </div>
    <span class="topbar-time" id="topbar-time">00:00:00</span>
    <a href="/ui" class="topbar-link">Dashboard</a>
  </header>

  <!-- â•â•â•â•â•â•â•â•â•â•â• MAIN IDE LAYOUT â•â•â•â•â•â•â•â•â•â•â• -->
  <main class="ide-layout">

    <!-- LEFT: Chat + Voice -->
    <section class="panel-left" id="panel-left">
      <div class="chat-header">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        ATLAS AGENT
        <span class="badge" id="session-badge">Session</span>
      </div>

      <div class="chat-messages" id="chat-messages">
        <div class="msg atlas">
          <div class="msg-label">ATLAS</div>
          ATLAS Workspace listo. Escribe un objetivo, prompt, o comando para comenzar. Puedo crear apps, configurar sitios, generar scripts, y ejecutar tareas en tiempo real.
        </div>
      </div>

      <!-- Voice Section -->
      <div class="voice-section">
        <div class="voice-controls">
          <div class="voice-orb-wrap">
            <button class="voice-orb" id="voice-orb" title="Click para hablar / Click de nuevo para parar">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
            </button>
            <div class="voice-orb-ring"></div>
          </div>
          <div class="voice-wave" id="voice-wave"></div>
          <button class="voice-mode-toggle" id="voice-tts-btn" onclick="toggleTTS()" title="Activar/desactivar respuesta por voz">ğŸ”Š Voz</button>
        </div>
        <div class="voice-status" id="voice-status">Click en el orbe o Ctrl+M para hablar</div>
      </div>

      <!-- Chat Input -->
      <div class="chat-input-area">
        <div class="chat-input-row">
          <textarea class="chat-textarea" id="chat-input" placeholder="Escribe un objetivo, prompt, o /comando..." rows="1"></textarea>
          <button class="chat-send" id="btn-send" onclick="sendMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
        <div class="chat-mode-bar">
          <div class="model-selector-wrap" id="model-selector-wrap">
            <button class="model-selector-btn" id="model-selector-btn" type="button">
              <span class="model-icon" id="model-icon">âš¡</span>
              <span class="model-name" id="model-name">Auto</span>
              <svg width="10" height="10" viewBox="0 0 10 10" fill="currentColor"><path d="M2 3.5L5 7L8 3.5z"/></svg>
            </button>
            <div class="model-dropdown" id="model-dropdown"></div>
          </div>
          <select id="agent-mode" title="Modo de ejecucion">
            <option value="plan_only">Plan</option>
            <option value="auto" selected>Auto</option>
            <option value="execute_controlled">Controlado</option>
          </select>
          <select id="agent-depth" title="Profundidad">
            <option value="1">D1</option>
            <option value="2">D2</option>
            <option value="3">D3</option>
          </select>
          <label class="sync-toggle" title="Sincronizar con Config IA del Dashboard (system prompt, temperatura, especialistas)">
            <input type="checkbox" id="sync-config-toggle" onchange="toggleSyncConfig(this.checked)">
            <span class="sync-label" id="sync-label">ğŸ”— Sync Config</span>
          </label>
        </div>
        <div class="chat-hints">
          <span class="chat-hint" onclick="insertHint(this)">Crea una app web</span>
          <span class="chat-hint" onclick="insertHint(this)">Genera un script Python</span>
          <span class="chat-hint" onclick="insertHint(this)">/atlas status</span>
          <span class="chat-hint" onclick="insertHint(this)">Deploy a produccion</span>
          <span class="chat-hint" onclick="insertHint(this)">Revisa y corrige errores</span>
        </div>
      </div>
    </section>

    <!-- Resize Handle -->
    <div class="resize-handle" id="resize-handle"></div>

    <!-- RIGHT: Split View -->
    <section class="panel-right">

      <!-- â•â•â• TOP: Code / Preview â•â•â• -->
      <div class="split-top" id="split-top">
        <div class="split-top-tabs">
          <button class="split-tab active" data-top="code">Code</button>
          <button class="split-tab" data-top="preview">Preview</button>
          <span class="split-tab-spacer"></span>
          <button class="split-tab-action" onclick="clearCodeViewer()">Clear</button>
        </div>
        <div class="split-top-content">
          <div class="top-panel active" id="top-code">
            <div class="code-viewer" id="code-viewer">
              <div class="code-empty">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                <p>El codigo generado aparecera aqui en tiempo real</p>
              </div>
            </div>
          </div>
          <div class="top-panel" id="top-preview">
            <div class="preview-empty" id="preview-empty">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
              <p>Preview de apps web</p>
            </div>
            <iframe class="preview-frame" id="preview-frame" style="display:none"></iframe>
          </div>
        </div>
      </div>

      <!-- â•â•â• Resize Handle horizontal â•â•â• -->
      <div class="split-h-handle" id="split-h-handle"></div>

      <!-- â•â•â• BOTTOM: LIVE FEED (siempre visible) â•â•â• -->
      <div class="split-bottom" id="split-bottom">
        <div class="live-header">
          <div class="live-indicator" id="live-indicator">
            <span class="live-dot"></span>
            LIVE
          </div>
          <div class="live-filter-tabs">
            <button class="live-filter active" data-filter="all" onclick="filterLive('all')">All</button>
            <button class="live-filter" data-filter="exec" onclick="filterLive('exec')">Exec</button>
            <button class="live-filter" data-filter="cmd" onclick="filterLive('cmd')">Term</button>
            <button class="live-filter" data-filter="code" onclick="filterLive('code')">Code</button>
            <button class="live-filter" data-filter="err" onclick="filterLive('err')">Errors</button>
          </div>
          <span class="live-count" id="live-count">0 events</span>
        </div>
        <div class="live-feed" id="live-feed"></div>
        <div class="live-terminal-input">
          <label>ATLAS &gt;</label>
          <input id="terminal-input" placeholder="Comando directo..." />
        </div>
      </div>

    </section>
  </main>

  <!-- â•â•â•â•â•â•â•â•â•â•â• BOTTOM STATUS BAR â•â•â•â•â•â•â•â•â•â•â• -->
  <footer class="bottombar">
    <div class="bottombar-section">
      <span class="dot" style="background:var(--accent-primary)"></span>
      ATLAS Agent v3.0
    </div>
    <div class="bottombar-section" id="git-info">
      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 012 2v7"/><line x1="6" y1="9" x2="6" y2="21"/></svg>
      intent-input-rename
    </div>
    <div class="bottombar-spacer"></div>
    <div class="bottombar-section" style="gap:8px">
      <span><span class="bottombar-key">Ctrl+Enter</span> Enviar</span>
      <span><span class="bottombar-key">Ctrl+M</span> Voz</span>
      <span><span class="bottombar-key">Ctrl+`</span> Terminal</span>
      <span><span class="bottombar-key">?</span> Atajos</span>
    </div>
  </footer>

  <!-- â•â•â•â•â•â•â•â•â•â•â• KEYBOARD SHORTCUTS OVERLAY â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="shortcuts-overlay" id="shortcuts-overlay" onclick="if(event.target===this)this.classList.remove('visible')">
    <div class="shortcuts-card">
      <h3>Atajos de Teclado</h3>
      <div class="shortcut-row"><span>Enviar mensaje</span><span class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">Enter</span></span></div>
      <div class="shortcut-row"><span>Push-to-Talk</span><span class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">M</span></span></div>
      <div class="shortcut-row"><span>Ir a Terminal</span><span class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">`</span></span></div>
      <div class="shortcut-row"><span>Panel Code</span><span class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">1</span></span></div>
      <div class="shortcut-row"><span>Panel Preview</span><span class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">2</span></span></div>
      <div class="shortcut-row"><span>Limpiar chat</span><span class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">L</span></span></div>
      <div class="shortcut-row"><span>Cerrar overlay</span><span class="shortcut-keys"><span class="shortcut-key">Esc</span></span></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• QUICK ACTION BUTTONS â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="quick-actions">
    <button class="qa-btn" onclick="document.getElementById('shortcuts-overlay').classList.add('visible')" title="Atajos">&#9881;</button>
    <button class="qa-btn" onclick="scrollChatBottom()" title="Ir al final">&#8595;</button>
  </div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ATLAS WORKSPACE â€” Engine
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const API = window.location.origin;
let sessionStartTime = Date.now();
let isProcessing = false;
let isListening = false;

// â”€â”€â”€ INIT â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  initClock();
  initTheme();
  initResize();
  initWaveformBars();
  initAutoResize();
  initModelSelector();
  initSyncToggle();
  checkServices();
  setInterval(checkServices, 15000);

  emitLive('info', '<strong>ATLAS Workspace iniciado</strong> â€” Esperando instrucciones');
  document.getElementById('chat-input').focus();
});

// â”€â”€â”€ CLOCK â”€â”€â”€
function initClock() {
  const el = document.getElementById('topbar-time');
  setInterval(() => {
    const now = new Date();
    el.textContent = now.toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  }, 1000);
}

// â”€â”€â”€ THEME â”€â”€â”€
function initTheme() {
  const saved = localStorage.getItem('atlas-ws-theme') || 'cyan';
  applyTheme(saved);
  document.querySelectorAll('.tdot').forEach(btn => {
    btn.addEventListener('click', () => applyTheme(btn.dataset.theme));
  });
}
function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  document.querySelectorAll('.tdot').forEach(b => b.classList.toggle('active', b.dataset.theme === t));
  localStorage.setItem('atlas-ws-theme', t);
}

// â”€â”€â”€ SYNC CONFIG â”€â”€â”€
let syncConfigActive = localStorage.getItem('atlas_sync_config') === 'true';
let configIA = null;

function toggleSyncConfig(on) {
  syncConfigActive = on;
  localStorage.setItem('atlas_sync_config', on ? 'true' : 'false');
  const label = document.getElementById('sync-label');
  const toggle = document.querySelector('.sync-toggle');
  if (on) {
    toggle.classList.add('active');
    label.textContent = 'ğŸ”— Sync ON';
    loadConfigIA();
    emitLive('info', 'Sync Config IA: <strong>ACTIVADO</strong> â€” usando system prompt y parametros del Dashboard');
  } else {
    toggle.classList.remove('active');
    label.textContent = 'ğŸ”— Sync Config';
    emitLive('info', 'Sync Config IA: <strong>DESACTIVADO</strong> â€” Workspace usa sus propios parametros');
  }
}

async function loadConfigIA() {
  try {
    const r = await fetch(API + '/config/ai');
    const d = await r.json();
    if (d.ok) {
      configIA = d;
      emitLive('success', 'Config IA cargada: prompt="' + escapeHtml((d.system_prompt||'').substring(0,60)) + '..." temp=' + d.temperature);
    }
  } catch(e) { emitLive('warn', 'No se pudo cargar Config IA: ' + e.message); }
}

function initSyncToggle() {
  const cb = document.getElementById('sync-config-toggle');
  cb.checked = syncConfigActive;
  if (syncConfigActive) {
    document.querySelector('.sync-toggle').classList.add('active');
    document.getElementById('sync-label').textContent = 'ğŸ”— Sync ON';
    loadConfigIA();
  }
}

// â”€â”€â”€ MODEL SELECTOR â”€â”€â”€
let selectedModel = 'auto';
let modelCatalog = [];

const PROVIDER_ICONS = {
  atlas: 'âš¡', openai: 'O', anthropic: 'A', gemini: 'G', google: 'G',
  xai: 'X', deepseek: 'D', groq: 'Q', mistral: 'M', perplexity: 'P', ollama: 'ğŸ '
};

async function initModelSelector() {
  const saved = localStorage.getItem('atlas-ws-model');
  if (saved) selectedModel = saved;
  try {
    const r = await fetch(API + '/agent/models');
    const d = await r.json();
    if (d.ok) modelCatalog = d.data;
  } catch { modelCatalog = [{id:'auto',name:'Auto',provider:'atlas',desc:'Seleccion inteligente',available:true,provider_label:'ATLAS',category:'auto'}]; }
  renderModelDropdown();
  updateModelBtn();

  const btn = document.getElementById('model-selector-btn');
  const dd = document.getElementById('model-dropdown');
  btn.addEventListener('click', e => { e.stopPropagation(); dd.classList.toggle('open'); if (dd.classList.contains('open')) { const si = dd.querySelector('.md-search'); if (si) { si.value = ''; filterModels(''); si.focus(); } } });
  document.addEventListener('click', () => dd.classList.remove('open'));
  dd.addEventListener('click', e => e.stopPropagation());
}

function renderModelDropdown() {
  const dd = document.getElementById('model-dropdown');
  let html = '<input class="md-search" id="model-search" placeholder="Buscar modelo..." autocomplete="off">';
  const groups = {};
  modelCatalog.forEach(m => {
    const g = m.provider_label || m.provider;
    if (!groups[g]) groups[g] = [];
    groups[g].push(m);
  });
  for (const [group, models] of Object.entries(groups)) {
    html += '<div class="md-group" data-group="' + group + '">' + escapeHtml(group) + '</div>';
    models.forEach(m => {
      const active = m.id === selectedModel ? ' active' : '';
      const avail = m.available !== false ? '' : ' unavailable';
      const badge = m.id === 'auto' ? '' : (m.available !== false
        ? '<span class="md-badge available">OK</span>'
        : '<span class="md-badge missing">Sin key</span>');
      html += '<div class="md-item' + active + avail + '" data-model-id="' + m.id + '">'
        + '<div class="md-icon ' + m.provider + '">' + (PROVIDER_ICONS[m.provider] || '?') + '</div>'
        + '<div class="md-info"><div class="md-label">' + escapeHtml(m.name) + '</div>'
        + '<div class="md-desc">' + escapeHtml(m.desc || '') + '</div></div>' + badge + '</div>';
    });
  }
  dd.innerHTML = html;
  dd.querySelectorAll('.md-item').forEach(el => {
    el.addEventListener('click', () => {
      const mid = el.dataset.modelId;
      const model = modelCatalog.find(m => m.id === mid);
      if (model && model.available === false) { emitLive('err', 'API key no configurada para ' + model.provider_label); return; }
      selectModel(mid);
      dd.classList.remove('open');
    });
  });
  const searchInput = dd.querySelector('.md-search');
  if (searchInput) searchInput.addEventListener('input', e => filterModels(e.target.value));
}

function filterModels(q) {
  const dd = document.getElementById('model-dropdown');
  const items = dd.querySelectorAll('.md-item');
  const groups = dd.querySelectorAll('.md-group');
  const ql = q.toLowerCase().trim();
  const visibleGroups = new Set();
  items.forEach(el => {
    const m = modelCatalog.find(x => x.id === el.dataset.modelId);
    const match = !ql || (m && (m.name.toLowerCase().includes(ql) || m.provider.toLowerCase().includes(ql) || (m.desc || '').toLowerCase().includes(ql)));
    el.style.display = match ? '' : 'none';
    if (match && m) visibleGroups.add(m.provider_label || m.provider);
  });
  groups.forEach(g => { g.style.display = visibleGroups.has(g.dataset.group) ? '' : 'none'; });
}

function selectModel(id) {
  selectedModel = id;
  localStorage.setItem('atlas-ws-model', id);
  updateModelBtn();
  renderModelDropdown();
  const m = modelCatalog.find(x => x.id === id);
  emitLive('info', '<strong>Modelo:</strong> ' + (m ? m.name : id));
}

function updateModelBtn() {
  const m = modelCatalog.find(x => x.id === selectedModel);
  document.getElementById('model-name').textContent = m ? m.name : selectedModel;
  document.getElementById('model-icon').textContent = m ? (PROVIDER_ICONS[m.provider] || '?') : 'âš¡';
}

// â”€â”€â”€ SERVICES CHECK â”€â”€â”€
async function checkServices() {
  const dots = { nexus: 'svc-nexus', push: 'svc-push', robot: 'svc-robot' };
  try {
    const r = await fetch(API + '/status');
    const d = await r.json();
    document.getElementById(dots.nexus).className = 'svc-dot ' + (d.nexus_connected ? 'on' : 'off');
    document.getElementById(dots.push).className = 'svc-dot on';
    document.getElementById(dots.robot).className = 'svc-dot ' + (d.robot_connected ? 'on' : 'off');
  } catch {
    Object.values(dots).forEach(id => document.getElementById(id).className = 'svc-dot off');
  }
}

// â”€â”€â”€ RESIZE PANELS â”€â”€â”€
function initResize() {
  // Vertical resize (left/right)
  const handle = document.getElementById('resize-handle');
  const left = document.getElementById('panel-left');
  let startX, startW;
  handle.addEventListener('mousedown', e => {
    e.preventDefault();
    startX = e.clientX;
    startW = left.offsetWidth;
    handle.classList.add('dragging');
    const onMove = ev => { left.style.width = Math.max(300, Math.min(500, startW + ev.clientX - startX)) + 'px'; };
    const onUp = () => { handle.classList.remove('dragging'); document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Horizontal resize (top/bottom split)
  const hHandle = document.getElementById('split-h-handle');
  const bottom = document.getElementById('split-bottom');
  let startY, startH;
  hHandle.addEventListener('mousedown', e => {
    e.preventDefault();
    startY = e.clientY;
    startH = bottom.offsetHeight;
    hHandle.classList.add('dragging');
    const onMove = ev => {
      const newH = Math.max(100, Math.min(window.innerHeight * 0.6, startH - (ev.clientY - startY)));
      bottom.style.height = newH + 'px';
    };
    const onUp = () => { hHandle.classList.remove('dragging'); document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

// â”€â”€â”€ TEXTAREA AUTO-RESIZE â”€â”€â”€
function initAutoResize() {
  const ta = document.getElementById('chat-input');
  ta.addEventListener('input', () => {
    ta.style.height = 'auto';
    ta.style.height = Math.min(ta.scrollHeight, 160) + 'px';
  });
}

// â”€â”€â”€ SPLIT TOP TABS (Code / Preview) â”€â”€â”€
document.querySelectorAll('.split-tab[data-top]').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.split-tab[data-top]').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.top-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('top-' + tab.dataset.top).classList.add('active');
  });
});

// â”€â”€â”€ LIVE FEED ENGINE â”€â”€â”€
let liveEventCount = 0;
let liveFilter = 'all';

function emitLive(type, html, highlight) {
  const feed = document.getElementById('live-feed');
  const ts = new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const entry = document.createElement('div');
  entry.className = 'live-entry' + (highlight ? ' highlight' : '');
  entry.dataset.type = type;
  entry.innerHTML =
    '<span class="live-ts">' + ts + '</span>' +
    '<span class="live-badge ' + type + '">' + type.toUpperCase() + '</span>' +
    '<span class="live-text">' + html + '</span>';

  if (liveFilter !== 'all' && type !== liveFilter) entry.style.display = 'none';
  feed.appendChild(entry);
  feed.scrollTop = feed.scrollHeight;

  liveEventCount++;
  document.getElementById('live-count').textContent = liveEventCount + ' events';
}

function setLiveActive(active) {
  document.getElementById('live-indicator').classList.toggle('active', active);
}

function filterLive(type) {
  liveFilter = type;
  document.querySelectorAll('.live-filter').forEach(b => b.classList.toggle('active', b.dataset.filter === type));
  document.querySelectorAll('.live-entry').forEach(entry => {
    entry.style.display = (type === 'all' || entry.dataset.type === type) ? '' : 'none';
  });
}

function clearCodeViewer() {
  document.getElementById('code-viewer').innerHTML =
    '<div class="code-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg><p>El codigo generado aparecera aqui</p></div>';
}

// â”€â”€â”€ SEND MESSAGE â”€â”€â”€
async function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text || isProcessing) return;

  addChatMessage(text, 'user');
  input.value = '';
  input.style.height = 'auto';
  isProcessing = true;
  setLiveActive(true);
  document.getElementById('btn-send').disabled = true;

  const thinkingId = addThinking();

  emitLive('exec', '<strong>Goal recibido</strong> â€” ' + escapeHtml(text.substring(0, 80)), true);
  emitLive('info', 'Enviando a <code>/agent/goal</code>...');

  try {
    const t0 = performance.now();
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 120000);
    const response = await fetch(API + '/agent/goal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ goal: text, mode: document.getElementById('agent-mode').value, depth: parseInt(document.getElementById('agent-depth').value), fast: true, model: selectedModel, sync_config: syncConfigActive }),
      signal: controller.signal
    });
    clearTimeout(timeout);
    const elapsed = Math.round(performance.now() - t0);
    const data = await response.json();
    removeThinking(thinkingId);

    emitLive('info', 'Respuesta recibida en <code>' + elapsed + 'ms</code>');

    if (data.ok) {
      let reply = '';
      const modelUsed = data.data && data.data.model_used;
      if (modelUsed) emitLive('info', '<strong>Modelo:</strong> <code>' + escapeHtml(modelUsed) + '</code>');

      if (data.data && data.data.output && !data.data.plan && !data.data.steps) {
        reply = data.data.output;
        emitLive('exec', '<strong>Respuesta directa</strong> del modelo');
        addChatMessage(reply, 'atlas');
        emitLive('exec', '<strong>Completado</strong> (' + elapsed + 'ms)', true);
        if (data.siguientes_pasos) data.siguientes_pasos.forEach(s => emitLive('info', 'Info: ' + escapeHtml(s)));
        isProcessing = false; setLiveActive(false); document.getElementById('btn-send').disabled = false;
        return;
      }

      if (data.resumen) {
        reply += data.resumen + '\n\n';
        emitLive('exec', '<strong>Resumen:</strong> ' + escapeHtml(data.resumen.substring(0, 200)));
      }
      if (data.data) {
        const d = data.data;
        if (d.plan) {
          reply += '**Plan:**\n' + d.plan + '\n\n';
          emitLive('plan', '<strong>Plan generado</strong>');
        }
        if (d.steps && d.steps.length > 0) {
          reply += '**Pasos:**\n';
          d.steps.forEach((s, i) => {
            const desc = typeof s === 'object' ? (s.description || JSON.stringify(s)) : s;
            reply += (i + 1) + '. ' + desc + '\n';
            emitLive('plan', 'Paso ' + (i+1) + ': ' + escapeHtml(desc));
          });
          reply += '\n';
          showPlanInCode(d.steps, text);
        }
        if (d.execution_log && d.execution_log.length > 0) {
          d.execution_log.forEach(log => {
            const isOk = log.status === 'success';
            emitLive('cmd', '<span class="term-line ' + (isOk ? 'ok' : 'err') + '">$ ' + escapeHtml(log.step || '') + '</span>');
            if (log.result) {
              const resultStr = typeof log.result === 'string' ? log.result : JSON.stringify(log.result, null, 2);
              emitLive('cmd', '<span class="term-line">' + escapeHtml(resultStr.substring(0, 200)) + '</span>');
            }
          });
        }
        if (d.artifacts && d.artifacts.length > 0) {
          d.artifacts.forEach(a => {
            const name = typeof a === 'string' ? a : JSON.stringify(a);
            emitLive('file', '<strong>Artifact:</strong> <code>' + escapeHtml(name) + '</code>');
          });
        }
      }
      if (data.archivos_creados && data.archivos_creados.length > 0) {
        data.archivos_creados.forEach(a => {
          const name = typeof a === 'string' ? a : JSON.stringify(a);
          emitLive('file', '<strong>Archivo creado:</strong> <code>' + escapeHtml(name) + '</code>');
          reply += '- Archivo: `' + name + '`\n';
        });
      }
      if (data.siguientes_pasos && data.siguientes_pasos.length > 0) {
        reply += '**Siguiente:**\n';
        data.siguientes_pasos.forEach(s => {
          reply += '- ' + s + '\n';
          emitLive('info', 'Siguiente: ' + escapeHtml(s));
        });
      }
      if (data.fallback) {
        emitLive('info', '<strong>Fallback:</strong> ' + escapeHtml(data.message || 'Respuesta via fallback'));
      }
      addChatMessage(reply || 'Objetivo procesado correctamente.', 'atlas');
      emitLive('exec', '<strong>Completado</strong> (' + elapsed + 'ms)', true);
    } else {
      const errMsg = data.error || data.message || 'Error al procesar el objetivo';
      addChatMessage('Error: ' + errMsg, 'atlas');
      emitLive('err', '<strong>Error:</strong> ' + escapeHtml(errMsg));
    }
  } catch (err) {
    removeThinking(thinkingId);
    addChatMessage('Error de conexion: ' + err.message, 'atlas');
    emitLive('err', '<strong>Conexion fallida:</strong> ' + escapeHtml(err.message));
  }

  isProcessing = false;
  setLiveActive(false);
  document.getElementById('btn-send').disabled = false;
}

// â”€â”€â”€ CHAT HELPERS â”€â”€â”€
function addChatMessage(text, type) {
  const container = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'msg ' + type;
  if (type === 'atlas') {
    div.innerHTML = '<div class="msg-label">ATLAS</div>' + renderMarkdown(text);
    atlasSpeak(text);
  } else {
    div.textContent = text;
  }
  container.appendChild(div);
  scrollChatBottom();
}

function addThinking() {
  const container = document.getElementById('chat-messages');
  const div = document.createElement('div');
  const id = 'think-' + Date.now();
  div.id = id;
  div.className = 'msg thinking';
  div.innerHTML = '<div class="msg-label">ATLAS</div><div class="thinking-dots"><span></span><span></span><span></span></div>';
  container.appendChild(div);
  scrollChatBottom();
  return id;
}

function removeThinking(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

function scrollChatBottom() {
  const c = document.getElementById('chat-messages');
  c.scrollTop = c.scrollHeight;
}

function renderMarkdown(text) {
  if (!text) return '';
  return text
    .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
}

function insertHint(el) {
  const input = document.getElementById('chat-input');
  input.value = el.textContent;
  input.focus();
}

// â”€â”€â”€ CODE VIEWER â”€â”€â”€
function showCodeInViewer(filename, code) {
  const viewer = document.getElementById('code-viewer');
  const lines = code.split('\n');
  const gutter = lines.map((_, i) => i + 1).join('\n');
  const highlighted = highlightCode(code);

  viewer.innerHTML =
    '<div class="code-file-header">' +
      '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>' +
      '<span class="filename">' + filename + '</span>' +
      '<span style="color:var(--text-dim);margin-left:auto;font-size:11px">' + lines.length + ' lines</span>' +
    '</div>' +
    '<div class="code-lines">' +
      '<div class="code-gutter">' + gutter + '</div>' +
      '<div class="code-body">' + highlighted + '</div>' +
    '</div>';

  switchTopPanel('code');
  emitLive('code', '<strong>Archivo:</strong> <code>' + escapeHtml(filename) + '</code> (' + lines.length + ' lineas)');
}

function showPlanInCode(steps, goal) {
  const viewer = document.getElementById('code-viewer');
  let content = '<div class="code-file-header">' +
    '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>' +
    '<span class="filename">plan.md</span></div>' +
    '<div style="padding:16px;">';

  content += '<div style="font-size:14px;font-weight:700;color:var(--accent-primary);margin-bottom:12px;">' + escapeHtml(goal) + '</div>';
  content += '<div class="plan-steps">';
  steps.forEach((s, i) => {
    const desc = typeof s === 'object' ? (s.description || JSON.stringify(s)) : s;
    content += '<div class="plan-step">' +
      '<span class="step-icon" style="color:var(--text-dim);">' + (i + 1) + '</span>' +
      '<span>' + escapeHtml(desc) + '</span></div>';
  });
  content += '</div></div>';
  viewer.innerHTML = content;
  switchTopPanel('code');
}

function switchTopPanel(name) {
  document.querySelectorAll('.split-tab[data-top]').forEach(t => t.classList.toggle('active', t.dataset.top === name));
  document.querySelectorAll('.top-panel').forEach(p => p.classList.toggle('active', p.id === 'top-' + name));
}

function highlightCode(code) {
  const keywords = /\b(def|class|import|from|return|if|elif|else|for|while|try|except|finally|with|as|async|await|yield|lambda|pass|break|continue|raise|not|and|or|in|is|True|False|None|const|let|var|function|export|default)\b/g;
  const strings = /(["'`])(?:(?=(\\?))\2[\s\S])*?\1/g;
  const comments = /(#.*$|\/\/.*$|\/\*[\s\S]*?\*\/)/gm;
  const numbers = /\b(\d+\.?\d*)\b/g;

  let result = escapeHtml(code);
  result = result.replace(comments, '<span class="cm">$1</span>');
  result = result.replace(strings, '<span class="str">$&</span>');
  result = result.replace(keywords, '<span class="kw">$1</span>');
  result = result.replace(numbers, '<span class="num">$1</span>');
  return result;
}

function escapeHtml(t) {
  const d = document.createElement('div');
  d.textContent = t;
  return d.innerHTML;
}

// â”€â”€â”€ TERMINAL (via Live Feed) â”€â”€â”€
document.getElementById('terminal-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const input = e.target;
    const cmd = input.value.trim();
    if (!cmd) return;
    input.value = '';
    emitLive('cmd', '<span class="term-line">$ ' + escapeHtml(cmd) + '</span>', true);
    executeTerminalCmd(cmd);
  }
});

async function executeTerminalCmd(cmd) {
  setLiveActive(true);
  emitLive('info', 'Ejecutando comando...');
  try {
    const t0 = performance.now();
    const r = await fetch(API + '/agent/goal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ goal: 'Execute terminal command: ' + cmd, mode: document.getElementById('agent-mode').value, depth: parseInt(document.getElementById('agent-depth').value), fast: true, model: selectedModel, sync_config: syncConfigActive })
    });
    const elapsed = Math.round(performance.now() - t0);
    const data = await r.json();
    if (data.ok) {
      emitLive('cmd', '<span class="term-line ok">' + escapeHtml(data.resumen || 'OK') + '</span>');
      emitLive('info', 'Completado en <code>' + elapsed + 'ms</code>');
    } else {
      emitLive('err', '<span class="term-line err">' + escapeHtml(data.error || 'Error') + '</span>');
    }
  } catch (err) {
    emitLive('err', '<strong>Error:</strong> ' + escapeHtml(err.message));
  }
  setLiveActive(false);
}

// â”€â”€â”€ VOICE SYSTEM (Web Speech API â€” STT + TTS) â”€â”€â”€
let recognition = null;
let ttsEnabled = true;
let isSpeaking = false;
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

function initWaveformBars() {
  const wave = document.getElementById('voice-wave');
  for (let i = 0; i < 32; i++) {
    const bar = document.createElement('div');
    bar.className = 'bar';
    wave.appendChild(bar);
  }
  const ttsState = localStorage.getItem('atlas-ws-tts');
  if (ttsState === 'off') { ttsEnabled = false; }
  updateTTSBtn();
  document.getElementById('voice-orb').addEventListener('click', toggleListening);
}

function toggleListening() {
  if (isSpeaking) { window.speechSynthesis.cancel(); isSpeaking = false; setOrbState('idle'); return; }
  if (isListening) stopVoice(); else startVoice();
}

function setOrbState(state) {
  const orb = document.getElementById('voice-orb');
  orb.classList.remove('listening', 'speaking');
  document.getElementById('voice-wave').classList.remove('active');
  if (state === 'listening') { orb.classList.add('listening'); document.getElementById('voice-wave').classList.add('active'); }
  if (state === 'speaking') { orb.classList.add('speaking'); }
}

function startVoice() {
  if (isListening || !SpeechRecognition) {
    if (!SpeechRecognition) { document.getElementById('voice-status').textContent = 'Web Speech API no soportada en este navegador'; emitLive('err', 'Navegador no soporta Web Speech API'); }
    return;
  }
  if (isSpeaking) { window.speechSynthesis.cancel(); isSpeaking = false; }
  isListening = true;
  setOrbState('listening');
  document.getElementById('voice-status').textContent = 'Escuchando...';
  emitLive('voice', '<strong>Microfono activo</strong> â€” hablame');

  recognition = new SpeechRecognition();
  recognition.lang = 'es-ES';
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;

  let finalTranscript = '';
  let interimDisplayed = false;

  recognition.onresult = (event) => {
    let interim = '';
    finalTranscript = '';
    for (let i = 0; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript;
      } else {
        interim += event.results[i][0].transcript;
      }
    }
    if (interim && !interimDisplayed) {
      document.getElementById('voice-status').textContent = '"' + interim + '..."';
      simulateWaveform();
    }
  };

  recognition.onend = () => {
    isListening = false;
    setOrbState('idle');
    resetWaveform();
    if (finalTranscript.trim()) {
      const text = finalTranscript.trim();
      document.getElementById('voice-status').textContent = 'Escuche: "' + text + '"';
      emitLive('voice', '<strong>Tu:</strong> "' + escapeHtml(text) + '"');
      document.getElementById('chat-input').value = text;
      sendMessage();
    } else {
      document.getElementById('voice-status').textContent = 'No capte audio. Click en el orbe para reintentar.';
    }
  };

  recognition.onerror = (event) => {
    isListening = false;
    setOrbState('idle');
    resetWaveform();
    const msgs = { 'no-speech': 'No detecte voz', 'audio-capture': 'No hay microfono', 'not-allowed': 'Permiso de microfono denegado' };
    const msg = msgs[event.error] || 'Error: ' + event.error;
    document.getElementById('voice-status').textContent = msg;
    emitLive('err', 'STT: ' + msg);
  };

  recognition.start();
}

function stopVoice() {
  if (recognition && isListening) {
    recognition.stop();
  }
  isListening = false;
  setOrbState('idle');
  resetWaveform();
  document.getElementById('voice-status').textContent = 'Click en el orbe o Ctrl+M para hablar';
}

function simulateWaveform() {
  const bars = document.querySelectorAll('#voice-wave .bar');
  bars.forEach(bar => { bar.style.height = Math.max(4, Math.random() * 24) + 'px'; });
  if (isListening) setTimeout(simulateWaveform, 100);
}

function resetWaveform() {
  document.querySelectorAll('#voice-wave .bar').forEach(b => b.style.height = '4px');
}

function atlasSpeak(text) {
  if (!ttsEnabled || !window.speechSynthesis || !text) return;
  window.speechSynthesis.cancel();
  let clean = text;
  clean = clean.replace(/```[\s\S]*?```/g, '. Codigo generado. ');
  clean = clean.replace(/`[^`]*`/g, '');
  clean = clean.replace(/\*\*/g, '');
  clean = clean.replace(/\*/g, '');
  clean = clean.replace(/#{1,6}\s?/g, '');
  clean = clean.replace(/\[([^\]]*)\]\([^)]*\)/g, '$1');
  clean = clean.replace(/^[-=]{3,}$/gm, '');
  clean = clean.replace(/^\s*[-*]\s+/gm, '. ');
  clean = clean.replace(/^\s*\d+\.\s+/gm, '. ');
  clean = clean.replace(/[_~>|]/g, ' ');
  clean = clean.replace(/\n+/g, '. ');
  clean = clean.replace(/\.{2,}/g, '.');
  clean = clean.replace(/\s{2,}/g, ' ');
  clean = clean.trim().substring(0, 400);
  if (!clean.trim()) return;

  const utter = new SpeechSynthesisUtterance(clean);
  utter.lang = 'es-ES';
  utter.rate = 1.05;
  utter.pitch = 1.0;
  utter.volume = 1.0;

  const voices = window.speechSynthesis.getVoices();
  const esVoice = voices.find(v => v.lang.startsWith('es') && v.name.includes('Google')) ||
                  voices.find(v => v.lang.startsWith('es') && !v.localService) ||
                  voices.find(v => v.lang.startsWith('es'));
  if (esVoice) utter.voice = esVoice;

  isSpeaking = true;
  setOrbState('speaking');
  document.getElementById('voice-status').textContent = 'ATLAS hablando...';
  emitLive('voice', '<strong>ATLAS dice:</strong> ' + escapeHtml(clean.substring(0, 80)) + '...');

  utter.onend = () => { isSpeaking = false; setOrbState('idle'); document.getElementById('voice-status').textContent = 'Click en el orbe o Ctrl+M para hablar'; };
  utter.onerror = () => { isSpeaking = false; setOrbState('idle'); };

  window.speechSynthesis.speak(utter);
}

function toggleTTS() {
  ttsEnabled = !ttsEnabled;
  localStorage.setItem('atlas-ws-tts', ttsEnabled ? 'on' : 'off');
  updateTTSBtn();
  emitLive('info', 'Respuesta por voz: ' + (ttsEnabled ? 'ACTIVADA' : 'DESACTIVADA'));
}

function updateTTSBtn() {
  const btn = document.getElementById('voice-tts-btn');
  btn.textContent = ttsEnabled ? 'ğŸ”Š Voz' : 'ğŸ”‡ Mudo';
  btn.classList.toggle('active', ttsEnabled);
}

if (window.speechSynthesis) {
  window.speechSynthesis.onvoiceschanged = () => {};
}

// â”€â”€â”€ KEYBOARD SHORTCUTS â”€â”€â”€
document.addEventListener('keydown', e => {
  if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); sendMessage(); }
  if (e.ctrlKey && e.key === 'm') { e.preventDefault(); isListening ? stopVoice() : startVoice(); }
  if (e.ctrlKey && e.key === '`') { e.preventDefault(); document.getElementById('terminal-input').focus(); }
  if (e.ctrlKey && e.key === '1') { e.preventDefault(); switchTopPanel('code'); }
  if (e.ctrlKey && e.key === '2') { e.preventDefault(); switchTopPanel('preview'); }
  if (e.ctrlKey && e.key === 'l') { e.preventDefault(); document.getElementById('chat-messages').innerHTML = ''; }
  if (e.key === '?' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) {
    document.getElementById('shortcuts-overlay').classList.toggle('visible');
  }
  if (e.key === 'Escape') { document.getElementById('shortcuts-overlay').classList.remove('visible'); }
});

// â”€â”€â”€ INPUT ENTER â”€â”€â”€
document.getElementById('chat-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && e.ctrlKey) { e.preventDefault(); sendMessage(); }
  if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) { e.preventDefault(); sendMessage(); }
});

</script>
</body>
</html>

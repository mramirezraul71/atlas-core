<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS NEXUS ‚Äî Centro de Control</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0a0a12;--bg2:#12121e;--bg3:#1a1a2e;--border:rgba(255,255,255,0.07);--text:#e4e4e7;--muted:#71717a;--cyan:#22d3ee;--green:#34d399;--red:#f87171;--amber:#fbbf24;--violet:#a78bfa;--blue:#60a5fa}
        body{font-family:'Segoe UI','SF Pro Display',-apple-system,sans-serif;background:linear-gradient(160deg,var(--bg) 0%,var(--bg2) 40%,var(--bg3) 100%);color:var(--text);min-height:100vh;padding:16px}
        .container{max-width:1440px;margin:0 auto}

        .header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:rgba(255,255,255,0.04);backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:14px;margin-bottom:18px;flex-wrap:wrap;gap:12px}
        .header h1{font-size:1.4em;font-weight:800;background:linear-gradient(135deg,var(--cyan),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .header-sub{font-size:11px;color:var(--muted);margin-top:2px}
        .header-right{display:flex;align-items:center;gap:14px}
        .status-pill{padding:5px 14px;border-radius:20px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
        .status-pill.on{background:rgba(52,211,153,0.15);color:var(--green);border:1px solid rgba(52,211,153,0.3)}
        .status-pill.off{background:rgba(248,113,113,0.15);color:var(--red);border:1px solid rgba(248,113,113,0.3)}
        .pulse{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
        .clock{font-size:12px;color:var(--muted);font-family:'Consolas',monospace}
        .nav-links{display:flex;gap:8px}
        .nav-links a{padding:6px 12px;background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:8px;color:var(--muted);text-decoration:none;font-size:11px;font-weight:500;transition:.2s}
        .nav-links a:hover{background:rgba(167,139,250,0.15);color:var(--violet);border-color:rgba(167,139,250,0.3)}

        .grid-main{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px}
        .svc-card{background:rgba(255,255,255,0.04);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:12px;padding:16px;transition:.2s}
        .svc-card:hover{border-color:rgba(34,211,238,0.3)}
        .svc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
        .svc-name{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px}
        .svc-badge{display:flex;align-items:center;gap:4px;font-size:10px;font-weight:600}
        .svc-badge.on{color:var(--green)}.svc-badge.off{color:var(--red)}
        .svc-dot{width:6px;height:6px;border-radius:50%}
        .svc-dot.on{background:var(--green);box-shadow:0 0 6px var(--green)}.svc-dot.off{background:var(--red);box-shadow:0 0 6px var(--red)}
        .svc-metrics{display:flex;flex-direction:column;gap:8px}
        .svc-row{display:flex;justify-content:space-between;font-size:12px}
        .svc-label{color:var(--muted)}
        .svc-val{font-family:'Consolas',monospace;font-weight:600}
        .load-bar{height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;margin-top:4px}
        .load-fill{height:100%;border-radius:2px;transition:width .5s;background:linear-gradient(90deg,var(--cyan),var(--blue))}

        .grid-bottom{display:grid;grid-template-columns:1fr 1fr;gap:14px}
        .panel{background:rgba(255,255,255,0.04);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:12px;overflow:hidden}
        .panel-title{padding:12px 16px;font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.02);border-bottom:1px solid var(--border)}
        .panel-body{padding:14px 16px;max-height:320px;overflow-y:auto}

        .activity-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:12px}
        .activity-row:last-child{border-bottom:none}
        .activity-time{color:var(--muted);font-family:'Consolas',monospace;min-width:60px}
        .activity-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
        .activity-text{flex:1;color:var(--text)}
        .activity-badge{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600}

        .module-row{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:12px}
        .module-row:last-child{border-bottom:none}
        .module-name{font-weight:500}
        .module-status{font-size:10px;padding:2px 10px;border-radius:10px;font-weight:600}
        .module-status.on{background:rgba(52,211,153,0.15);color:var(--green)}
        .module-status.off{background:rgba(248,113,113,0.15);color:var(--red)}

        .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .stat-box{background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center}
        .stat-val{font-size:22px;font-weight:800}
        .stat-label{font-size:10px;color:var(--muted);margin-top:4px}

        .exec-section{margin-bottom:14px}
        .exec-card{background:rgba(255,255,255,0.04);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:12px;padding:14px 16px}
        .exec-card h2{font-size:12px;font-weight:700;color:var(--violet);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
        .input-group{display:flex;gap:8px}
        .exec-card input{flex:1;padding:10px 14px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none}
        .exec-card input:focus{border-color:var(--cyan)}
        .exec-card input::placeholder{color:#52525b}
        .exec-card button{padding:10px 20px;background:linear-gradient(135deg,#7c3aed,#6366f1);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:12px;transition:.2s}
        .exec-card button:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(124,58,237,0.4)}

        .console{background:#0c0c10;border:1px solid var(--border);color:var(--green);padding:12px 16px;border-radius:10px;font-family:'Consolas',monospace;font-size:11px;max-height:180px;overflow-y:auto;margin-top:14px}
        .console-line{margin-bottom:3px}

        .grid-full{margin-bottom:14px}
        .live-bar{display:flex;align-items:center;gap:6px;padding:10px 16px;background:rgba(255,255,255,0.03);border-bottom:1px solid var(--border)}
        .live-bar .pulse{width:6px;height:6px}
        .live-bar span{font-size:11px;font-weight:600;color:var(--green)}
        .actions-header{display:grid;grid-template-columns:70px 70px 1fr 80px;gap:8px;padding:8px 16px;background:#16161e;color:var(--muted);font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
        .actions-body{max-height:240px;overflow-y:auto}
        .action-row{display:grid;grid-template-columns:70px 70px 1fr 80px;gap:8px;padding:8px 16px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:11px;cursor:pointer;transition:.15s;border-left:3px solid transparent}
        .action-row:hover{background:rgba(255,255,255,0.03)}
        .action-row.ok{border-left-color:var(--green)}.action-row.running{border-left-color:var(--amber)}.action-row.error{border-left-color:var(--red)}
        .action-empty{padding:30px;text-align:center;color:#3f3f46;font-size:12px}

        @media(max-width:900px){.grid-main,.grid-bottom,.stat-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <div>
            <h1>ATLAS NEXUS</h1>
            <div class="header-sub">Centro de Control ‚Äî Datos en tiempo real</div>
        </div>
        <div class="header-right">
            <div class="nav-links">
                <a href="http://localhost:8791/ui" target="_blank">üìä Dashboard PUSH</a>
                <a href="http://localhost:8791/workspace" target="_blank">‚ö° Workspace</a>
                <a href="/docs" target="_blank">üìÑ API Docs</a>
            </div>
            <div class="clock" id="clock">--:--:--</div>
            <div class="status-pill on" id="global-status"><span class="pulse"></span> OPERATIVO</div>
        </div>
    </header>

    <div class="grid-main">
        <div class="svc-card" id="card-nexus">
            <div class="svc-header">
                <span class="svc-name" style="color:var(--cyan)">üåê NEXUS</span>
                <span class="svc-badge on" id="badge-nexus"><span class="svc-dot on" id="dot-nexus"></span>Online</span>
            </div>
            <div class="svc-metrics">
                <div class="svc-row"><span class="svc-label">Puerto</span><span class="svc-val">8000</span></div>
                <div class="svc-row"><span class="svc-label">Uptime</span><span class="svc-val" id="nexus-uptime">--</span></div>
                <div class="svc-row"><span class="svc-label">Version</span><span class="svc-val" id="nexus-version">--</span></div>
                <div class="svc-row"><span class="svc-label">Herramientas</span><span class="svc-val" id="nexus-tools">--</span></div>
                <div class="svc-row"><span class="svc-label">Planes activos</span><span class="svc-val" id="nexus-plans">--</span></div>
            </div>
        </div>
        <div class="svc-card" id="card-push">
            <div class="svc-header">
                <span class="svc-name" style="color:var(--violet)">üì° PUSH</span>
                <span class="svc-badge on" id="badge-push"><span class="svc-dot on" id="dot-push"></span>Online</span>
            </div>
            <div class="svc-metrics">
                <div class="svc-row"><span class="svc-label">Puerto</span><span class="svc-val">8791</span></div>
                <div class="svc-row"><span class="svc-label">NEXUS link</span><span class="svc-val" id="push-nexus">--</span></div>
                <div class="svc-row"><span class="svc-label">Robot link</span><span class="svc-val" id="push-robot">--</span></div>
                <div class="svc-row"><span class="svc-label">IA Config</span><span class="svc-val" id="push-ai-mode">--</span></div>
                <div class="svc-row"><span class="svc-label">Modelos</span><span class="svc-val" id="push-models">--</span></div>
            </div>
        </div>
        <div class="svc-card" id="card-robot">
            <div class="svc-header">
                <span class="svc-name" style="color:var(--green)">ü§ñ ROBOT</span>
                <span class="svc-badge on" id="badge-robot"><span class="svc-dot on" id="dot-robot"></span>Online</span>
            </div>
            <div class="svc-metrics">
                <div class="svc-row"><span class="svc-label">Puerto</span><span class="svc-val">8002</span></div>
                <div class="svc-row"><span class="svc-label">Uptime</span><span class="svc-val" id="robot-uptime">--</span></div>
                <div class="svc-row"><span class="svc-label">Modulos</span><span class="svc-val" id="robot-modules-count">--</span></div>
                <div class="svc-row"><span class="svc-label">WebSocket</span><span class="svc-val" id="robot-ws">--</span></div>
                <div class="svc-row"><span class="svc-label">Estado</span><span class="svc-val" id="robot-estado">--</span></div>
            </div>
        </div>
    </div>

    <div class="exec-section">
        <div class="exec-card">
            <h2>Ejecutar tarea en NEXUS</h2>
            <div class="input-group">
                <input type="text" id="task-input" placeholder="Escribe un objetivo (ej: Analiza este codigo, Busca noticias de IA...)">
                <button onclick="executeTask()">Ejecutar</button>
            </div>
        </div>
    </div>

    <div class="grid-full">
        <div class="panel">
            <div class="live-bar"><span class="pulse"></span><span>Operaciones en vivo</span></div>
            <div class="actions-header"><span>Hora</span><span>Tipo</span><span>Accion</span><span>Estado</span></div>
            <div class="actions-body" id="actions-body"><div class="action-empty" id="action-empty">Esperando acciones...</div></div>
        </div>
    </div>

    <div class="grid-bottom">
        <div class="panel">
            <div class="panel-title">ü§ñ Modulos del Robot</div>
            <div class="panel-body" id="robot-modules-list"><div style="color:var(--muted);font-size:12px">Cargando...</div></div>
        </div>
        <div class="panel">
            <div class="panel-title">üß† Modelos IA disponibles</div>
            <div class="panel-body" id="ai-models-list"><div style="color:var(--muted);font-size:12px">Cargando...</div></div>
        </div>
    </div>

    <div class="console" id="console">
        <div class="console-line">&gt; ATLAS NEXUS Centro de Control</div>
    </div>
</div>

<script>
const NEXUS = 'http://' + location.hostname + ':8000';
const PUSH  = 'http://' + location.hostname + ':8791';
const ROBOT = 'http://' + location.hostname + ':8002';
const WS_URL = (location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.hostname + ':8000/ws';
let ws = null;

function fmt(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);return h?h+'h '+m+'m':m+'m '+Math.floor(s%60)+'s'}

setInterval(()=>{document.getElementById('clock').textContent=new Date().toLocaleTimeString()},1000);

async function fetchJSON(url, timeout=5000){
    const c=new AbortController();const t=setTimeout(()=>c.abort(),timeout);
    try{const r=await fetch(url,{signal:c.signal});clearTimeout(t);return await r.json()}
    catch(e){clearTimeout(t);return null}
}

function setStatus(id, online){
    const dot=document.getElementById('dot-'+id);
    const badge=document.getElementById('badge-'+id);
    if(dot){dot.className='svc-dot '+(online?'on':'off')}
    if(badge){badge.className='svc-badge '+(online?'on':'off');badge.innerHTML='<span class="svc-dot '+(online?'on':'off')+'"></span>'+(online?'Online':'Offline')}
}

async function pollNexus(){
    const d=await fetchJSON(NEXUS+'/status');
    if(d){
        setStatus('nexus',true);
        document.getElementById('nexus-uptime').textContent=fmt(d.uptime||0);
        document.getElementById('nexus-version').textContent=d.version||'--';
        document.getElementById('nexus-tools').textContent=d.available_tools??'--';
        document.getElementById('nexus-plans').textContent=d.active_plans??d.active_tasks??'0';
    }else{setStatus('nexus',false)}
}

async function pollPush(){
    const d=await fetchJSON(PUSH+'/status');
    if(d&&d.ok!==undefined){
        setStatus('push',true);
        document.getElementById('push-nexus').textContent=d.nexus_connected?'‚úì Conectado':'‚úó Off';
        document.getElementById('push-robot').textContent=d.robot_connected?'‚úì Conectado':'‚úó Off';
    }else{setStatus('push',false)}
    const ai=await fetchJSON(PUSH+'/config/ai');
    if(ai&&ai.ok){
        document.getElementById('push-ai-mode').textContent=ai.mode||'--';
    }
    const models=await fetchJSON(PUSH+'/agent/models');
    if(models&&models.data){
        const avail=models.data.filter(m=>m.available&&m.id!=='auto').length;
        document.getElementById('push-models').textContent=avail+' activos';
        renderAIModels(models.data);
    }
}

async function pollRobot(){
    const d=await fetchJSON(ROBOT+'/status');
    if(d){
        setStatus('robot',true);
        document.getElementById('robot-uptime').textContent=fmt(d.uptime||0);
        document.getElementById('robot-estado').textContent=d.status||'--';
        const mods=d.modules||{};
        const total=Object.keys(mods).length;
        const on=Object.values(mods).filter(v=>v).length;
        document.getElementById('robot-modules-count').textContent=on+'/'+total;
        document.getElementById('robot-ws').textContent=d.clientes_websocket??'--';
        renderRobotModules(mods);
    }else{setStatus('robot',false)}
}

function renderRobotModules(mods){
    const el=document.getElementById('robot-modules-list');
    let h='';
    for(const[name,active]of Object.entries(mods)){
        h+='<div class="module-row"><span class="module-name">'+name+'</span><span class="module-status '+(active?'on':'off')+'">'+(active?'Activo':'Off')+'</span></div>';
    }
    el.innerHTML=h||'<div style="color:var(--muted);font-size:12px">Sin modulos</div>';
}

function renderAIModels(models){
    const el=document.getElementById('ai-models-list');
    const cats={local:[],free:[],premium:[],fast:[],reasoning:[]};
    models.filter(m=>m.id!=='auto').forEach(m=>{
        const c=m.category||'fast';
        if(c==='local')cats.local.push(m);
        else if(c==='free')cats.free.push(m);
        else if(cats[c])cats[c].push(m);
        else cats.fast.push(m);
    });
    let h='';
    const labels={local:'üè† Local (gratis)',free:'üÜì API gratis',premium:'üíé Premium',fast:'‚ö° Rapido',reasoning:'üß† Razonamiento'};
    for(const[cat,list]of Object.entries(cats)){
        if(!list.length)continue;
        h+='<div style="font-size:10px;color:var(--muted);margin:8px 0 4px;font-weight:700">'+labels[cat]+'</div>';
        list.forEach(m=>{
            const color=m.available?'var(--green)':'var(--muted)';
            h+='<div class="module-row"><span class="module-name" style="font-size:11px">'+m.name+'</span><span class="module-status '+(m.available?'on':'off')+'">'+(m.available?'‚úì':'‚Äî')+'</span></div>';
        });
    }
    el.innerHTML=h||'Sin modelos';
}

let actionEntries={};
async function pollActions(){
    const d=await fetchJSON(NEXUS+'/actions/log?limit=30');
    if(d&&d.ok&&d.entries){
        actionEntries={};
        d.entries.forEach(e=>{actionEntries[e.id]=e});
        renderActions();
    }
}
function renderActions(){
    const body=document.getElementById('actions-body');
    const empty=document.getElementById('action-empty');
    const entries=Object.values(actionEntries).slice(-20).reverse();
    empty.style.display=entries.length?'none':'block';
    body.querySelectorAll('.action-row').forEach(el=>el.remove());
    entries.forEach(e=>{
        const row=document.createElement('div');
        row.className='action-row '+(e.status||'');
        const time=e.timestamp?new Date(e.timestamp).toLocaleTimeString():'--';
        row.innerHTML='<span>'+time+'</span><span>'+(e.action_type||'--')+'</span><span>'+(e.description||'--').substring(0,50)+'</span><span>'+(e.status||'--')+'</span>';
        body.appendChild(row);
    });
}

function connectWS(){
    try{
        ws=new WebSocket(WS_URL);
        ws.onopen=()=>addLog('WebSocket NEXUS: Conectado');
        ws.onmessage=(e)=>{
            try{
                const d=JSON.parse(e.data);
                if(d.type==='action'){actionEntries[d.data?.id||Date.now()]=d.data||d;renderActions()}
                if(d.type==='task_completed')pollNexus();
                addLog(d.type+': '+(d.message||d.plan_id||''));
            }catch(err){}
        };
        ws.onclose=()=>{addLog('WebSocket desconectado, reconectando...');setTimeout(connectWS,5000)};
        ws.onerror=()=>{};
    }catch(e){setTimeout(connectWS,5000)}
}

async function executeTask(){
    const input=document.getElementById('task-input');
    const task=input.value.trim();
    if(!task)return;
    addLog('Ejecutando: '+task);
    input.value='';
    try{
        const r=await fetch(NEXUS+'/goal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({goal:task})});
        const result=await r.json();
        if(result.plan_id)addLog('Plan creado: '+result.plan_id);
        else addLog(result.detail||JSON.stringify(result).substring(0,100));
        pollNexus();pollActions();
    }catch(e){addLog('Error: '+e.message)}
}

function addLog(msg){
    const el=document.getElementById('console');
    const line=document.createElement('div');
    line.className='console-line';
    const t=new Date().toLocaleTimeString();
    line.textContent='['+t+'] '+msg;
    el.appendChild(line);
    el.scrollTop=el.scrollHeight;
    if(el.children.length>100)el.removeChild(el.children[0]);
}

function pollAll(){pollNexus();pollPush();pollRobot();pollActions()}

document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('task-input').addEventListener('keypress',e=>{if(e.key==='Enter')executeTask()});
    document.getElementById('clock').textContent=new Date().toLocaleTimeString();
    pollAll();
    connectWS();
    setInterval(pollAll,8000);
    addLog('Sistema iniciado ‚Äî polling cada 8s');
});
</script>
</body>
</html>
